"use strict";(this.webpackChunk_hz_project_x=this.webpackChunk_hz_project_x||[]).push([[15957],{395768:(e,t,r)=>{var s=r(640430).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(154118),n=r(971507),i=r(294462),a=r(617759);function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=d(o),h=d(i);const l={Asset:"asset",Composite:"composite",File:"file",Directory:"directory",Version:"version"};var u,p;t.HeaderKeys=void 0,(u=t.HeaderKeys||(t.HeaderKeys={})).CONTENT_ID="content-id",u.CONTENT_LENGTH="content-length",u.CONTENT_RANGE="content-range",u.CONTENT_TYPE="content-type",u.IF_MATCH="if-match",u.IF_NONE_MATCH="if-none-match",u.AUTHORIZATION="authorization",u.X_API_KEY="x-api-key",t.HTTPMethods=void 0,(p=t.HTTPMethods||(t.HTTPMethods={})).GET="GET",p.PUT="PUT",p.PATCH="PATCH",p.HEAD="HEAD",p.POST="POST",p.DELETE="DELETE";const _={ACCESS_CHECK:"http://ns.adobe.com/adobecloud/rel/ac/check",ACL_POLICY:"http://ns.adobe.com/adobecloud/rel/ac/policy",ANNOTATIONS:"http://ns.adobe.com/adobecloud/rel/annotations",APP_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/application",BASE_DIRECTORY:"http://ns.adobe.com/adobecloud/rel/directory/base",BLOCK_DOWNLOAD:"http://ns.adobe.com/adobecloud/rel/download",BLOCK_EXTEND:"http://ns.adobe.com/adobecloud/rel/block/extend",BLOCK_FINALIZE:"http://ns.adobe.com/adobecloud/rel/block/finalize",BLOCK_TRANSFER:"http://ns.adobe.com/adobecloud/rel/block/transfer",BLOCK_UPLOAD_INIT:"http://ns.adobe.com/adobecloud/rel/block/init",BULK_REQUEST:"http://ns.adobe.com/adobecloud/rel/bulk",COMPONENT:"http://ns.adobe.com/adobecloud/rel/component",CREATE:"http://ns.adobe.com/adobecloud/rel/create",DESCRIBED_BY:"describedBy",DIRECTORY:"http://ns.adobe.com/adobecloud/rel/directory",DISCARD:"http://ns.adobe.com/adobecloud/rel/discard",EFFECTIVE_PRIVILAGES:"http://ns.adobe.com/adobecloud/rel/ac/effective",EMBEDDED_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/embedded",ID:"http://ns.adobe.com/adobecloud/rel/id",MANIFEST:"http://ns.adobe.com/adobecloud/rel/manifest",PAGE:"http://ns.adobe.com/adobecloud/rel/page",PATH:"http://ns.adobe.com/adobecloud/rel/path",PRIMARY:"http://ns.adobe.com/adobecloud/rel/primary",RENDITION:"http://ns.adobe.com/adobecloud/rel/rendition",REPO_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/repository",REPO_OPS:"http://ns.adobe.com/adobecloud/rel/ops",REPOSITORY:"http://ns.adobe.com/adobecloud/rel/repository",RESOLVE_BY_ID:"http://ns.adobe.com/adobecloud/rel/resolve/id",RESOLVE_BY_PATH:"http://ns.adobe.com/adobecloud/rel/resolve/path",RESTORE:"http://ns.adobe.com/adobecloud/rel/restore",VERSION_HISTORY:"version-history"},f="application/vnd.adobecloud.directory+json",g="application/vnd.adobe.dcx-manifest+json",m="application/json",E="application/problem+json",A="application/json-patch+json",y="application/vnd.adobecloud.bulk-transfer+json",D="application/vnd.adobe.asset-operation+json";var C,I,v,b,T,P;t.Properties=void 0,(C=t.Properties||(t.Properties={})).DC_FORMAT="dc:format",C.DC_TITLE="dc:title",C.LINKS="_links",C.PAGE="_page",C.CHILDREN="children",C.EMBEDDED="_embedded",C.REPO_ASSET_ID="repo:assetId",C.REPO_REPOSITORY_ID="repo:repositoryId",C.REPO_REPOSITORY_TYPE="repo:repositoryType",C.REPO_BASE_ASSET_ID="repo:baseAssetId",C.REPO_SIZE="repo:size",C.REPO_NAME="repo:name",C.REPO_PATH="repo:path",C.REPO_ASSET_CLASS="repo:assetClass",C.REPO_CREATE_DATE="repo:createDate",C.REPO_MODIFY_DATE="repo:modifyDate",C.REPO_DISCARD_DATE="repo:discardDate",C.REPO_ETAG="repo:etag",C.REPO_CREATED_BY="repo:createdBy",C.REPO_MODIFIED_BY="repo:modifiedBy",C.REPO_DISCARDED_BY="repo:discardedBy",C.REPO_DEVICE_CREATE_DATE="storage:deviceCreateDate",C.REPO_DEVICE_MODIFY_DATE="storage:deviceModifyDate",C.REPO_DEFAULT_SCHEDULED_DELETION_DURATION="repo:defaultScheduledDeletionDuration",C.REPO_SCHEDULED_DELETION_DATE="repo:scheduledDeletionDate",C.REPO_VERSION="repo:version",C.REPO_STATE="repo:state",C.REPO_AVAILABLE_REGIONS="repo:availableRegions",C.REPO_REGIONS="repo:regions",C.REPO_OWNER="repo:owner",C.REPO_OWNER_ID="id",C.REPO_OWNER_TYPE="type",C.STORAGE_ASSIGNEE="storage:assignee",C.STORAGE_ASSIGNEE_ID="id",C.STORAGE_ASSIGNEE_TYPE="type",C.IMAGE_LENGTH="tiff:imageLength",C.IMAGE_WIDTH="tiff:imageWidth",C.NUM_OF_PAGES="xmpTPg:NPages",C.PAGE_START="start",C.PAGE_ORDER_BY="orderBy",C.PAGE_NEXT="next",C.PAGE_COUNT="count",C.PAGE_LIMIT="limit",t.VersionProperties=void 0,(I=t.VersionProperties||(t.VersionProperties={})).REPO_ID="repo:id",I.CREATED="created",I.CREATED_BY="created_by",I.MILESTONE="milestone",I.VERSION="version",I.TOTAL_CHILDREN="total_children",t.PolicyProperties=void 0,(v=t.PolicyProperties||(t.PolicyProperties={})).REPO_ACL="repo:acl",v.REPO_PRINCIPLE="repo:principal",v.REPO_MODIFIER="repo:modifier",v.REPO_PRIVILEGES="repo:privileges",v.REPO_RELATIONS="repo:relations",v.REPO_INHERITANCE="repo:inheritance",t.PolicyPrincipalProperties=void 0,(b=t.PolicyPrincipalProperties||(t.PolicyPrincipalProperties={})).XDM_PROVIDER="xdm:provider",b.ID="@id",b.TYPE="@type",t.XDMProviderProperties=void 0,(t.XDMProviderProperties||(t.XDMProviderProperties={})).ID="@id",t.EmbeddedMetadataMediaTypes=void 0,(T=t.EmbeddedMetadataMediaTypes||(t.EmbeddedMetadataMediaTypes={})).XML="application/rdf+xml",T.JSON="application/ld+json",t.BlockTransferProperties=void 0,(P=t.BlockTransferProperties||(t.BlockTransferProperties={})).REPO_SIZE="repo:size",P.REPO_BLOCK_SIZE="repo:blocksize",P.REPO_REL_TYPE="repo:reltype",P.COMPONENT_ID="component_id",P.DC_FORMAT="dc:format",P.REPO_MD5="repo:md5",P.REPO_EXPIRES="repo:expires",P.REPO_IF_MATCH="repo:if-match",P.MAX_SINGLE_TRANSFER_SIZE="repo:maxSingleTransferSize",P.REPO_MIN_BLOCK_TRANSFER_SIZE="repo:minBlockTransferSize";const w=["buffer","arraybuffer","string","text","blob","json","stream","defaultbuffer"];function R(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(r[s[o]]=e[s[o]])}return r}function O(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}function k(e){return this instanceof k?(this.v=e,this):new k(e)}function S(e){return a.isObject(e)&&["headers","responseType","statusCode","xhr"].every((t=>t in e))}function N(e){return a.isObject(e)&&S(e.response)}function L(e){return a.isObject(e)&&N(e)&&"result"in e}function M(e){return a.isObject(e)&&a.isAnyFunction(e.slice)}function X(e){return a.isObject(e)&&"resolvePullWithBranch"in e}function B(e){return"undefined"!=typeof Blob&&e instanceof Blob}function x(e){return a.isObject(e)&&("string"==typeof e.repositoryId&&"string"==typeof e.path||"string"==typeof e.assetId)}function j(e){return a.isObject(e)&&("AdobeHTTPService"===e.name||a.isAnyFunction(e.invoke))}function U(e){return a.isObject(e)&&j(e.service)}function V(e){if(!a.isObject(e))return!1;const r=e[t.Properties.LINKS];return!!a.isObject(r)&&!!(r[_.BLOCK_TRANSFER]&&r[_.BLOCK_EXTEND]&&r[_.BLOCK_FINALIZE])}const H=n.newDebug("dcx:assets:service"),F=e=>U(e)?e.service:e,Y=e=>U(e)?e.cache:void 0;function W(e,t){H("constructServiceEndpoint()",e);const r=t._repoAPIBaseUrl;return r&&(e=`${r.endsWith("/")?r.substr(0,r.length-1):r}${e}`),H("cSE()",e),e}const z=(e,t,r)=>{if(null==t&&null==r&&null==e)return o._defaultStatusValidator;const s=r||{},n=t||{},i=e||[];return(e,t)=>{var r,a;if(!e||!t)return new c.default(o.ErrorCodes.NETWORK_ERROR,"Invalid or missing status code",void 0,t);if(i.includes(e))return!0;const d=n[e]||(null===(r=o.HTTP_STATUS_ERROR_MAP.get(e))||void 0===r?void 0:r.message)||"Unexpected response",h=s[e]||(null===(a=o.HTTP_STATUS_ERROR_MAP.get(e))||void 0===a?void 0:a.code),l=o._defaultStatusValidator(e,t);return!0===l&&null==h||(o.isAdobeDCXError(l)?l:!!h&&new c.default(h,d,void 0,t))}},q=(e,t=[],r,s)=>{if(!a.isObject(e))throw new c.default(r||c.default.INVALID_PARAMS,s||"Missing or invalid links on Asset");t.map((t=>{if(!(t in e)||!a.isObject(e[t]))throw new c.default(r||c.default.INVALID_PARAMS,s||`Missing required link: ${t}`)}))},K=(e={},t=[])=>{if(0!==t.length){for(let r=0;r<t.length;r++){const s=t[r];if(s in e&&a.isObject(e[s]))return s}throw new c.default(c.default.INVALID_PARAMS,`Missing links, one required: ${t.join(", ")}`)}},G=(e,t,r,s)=>{const o=a.getLinkProperty(e,t,r);if(!o)throw new c.default(c.default.INVALID_DATA,`Missing ${r} param on Link`);if(o!==s)throw new c.default(c.default.INVALID_DATA,`Invalid ${r} param on Link, expected ${s}`)},$=(e,t=[])=>{try{q(e,t)}catch(e){return!1}return!0},J=(e,t=[])=>!!a.isObject(e)&&$(e.links||e._links,t);function Z(e){if(!x(e))throw new c.default(c.default.INVALID_PARAMS,"Asset must contain links or repositoryId + path or assetId to be resolved.")}function Q(e,t,r){if(!a.isObject(e))throw new c.default(c.default.INVALID_PARAMS,`Invalid parameter. Expected object, encountered "${null===e?"null":typeof e}".`);if(!(t in e))throw new c.default(c.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing key "${String(t)}".`);if(r)try{a.validateParam(t,e[t],r)}catch(s){throw new c.default(c.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing key "${String(t)}" with type "${r}", encountered type "${typeof e[t]}".`)}}function ee(e,t,r){if(!(t.length<1)){for(const s of t)try{return void Q(e,s,r)}catch(e){}throw new c.default(c.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing one of [${t.join(", ")}]`+(r?` with type ${r}, encountered types [${t.map((t=>typeof e[t])).join(", ")}].`:"."))}}const te=n.newDebug("dcx:assets:util:http");function re(e,r,s){return te("headHTTPResource()"),F(e).invoke(t.HTTPMethods.HEAD,r,s,void 0,{isStatusValid:z()})}function se(e,r,s,o){return F(e).invoke(t.HTTPMethods.GET,r,s,void 0,{isStatusValid:z(),responseType:o})}const oe=n.newDebug("dcx:assets:util:link");function ne(e,t){oe("getIndexLinks()");const r=F(e),s=Y(e);if(s){const e=s.getIndexLinks();if(e)return h.default.resolve(e);s.setPending("INDEX")}return re(r,W("/",r),t).then((e=>ae(e))).then((e=>(s&&s.setIndexLinks(e),e))).catch((e=>{throw s&&s.delete("INDEX"),e}))}function ie(e,r){oe("getIndexDocument()");const s=F(e),o=Y(e);if(o){const e=o.getIndexRepository();if(e)return h.default.resolve(e)}const n=W("/",s);return s.invoke(t.HTTPMethods.GET,n,r,void 0,{responseType:"json",isStatusValid:z()}).then((e=>{const r=ae(e),s=e.response,n={};for(const e in s.children){const r=s.children[e],o=r[t.Properties.LINKS];switch(r[t.Properties.REPO_PATH]){case"/Index.json":n.indexLinks=o;break;case"/Assets.json":n.assetLinks=o;break;case"/Repositories.json":n.repositoryLinks=o}}return o&&(o.setIndexLinks(r),o.setIndexRepository(n)),n}))}function ae(e){if(!e.headers||!e.headers.link)throw new o.DCXError(o.DCXError.INVALID_DATA,"Failed to parse, missing link header");return de(e.headers.link)}function de(e){try{const r=a.parse(e),s={};for(const e in r.refs){const o=r.refs[e],{rel:n,uri:i,templated:d,type:c,width:h,height:l}=o,u=R(o,["rel","uri","templated","type","width","height"]),p=a.pruneUndefined({href:i,templated:d?"true"===d:void 0,type:c,width:h,height:l,[t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE]:u[t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE.toLowerCase()],[t.BlockTransferProperties.REPO_MIN_BLOCK_TRANSFER_SIZE]:u[t.BlockTransferProperties.REPO_MIN_BLOCK_TRANSFER_SIZE.toLowerCase()]});["width","height"].filter((e=>e in p)).forEach((e=>{const t=parseInt(p[e],10);isNaN(t)||(p[e]=t)}));const _=s[n];Array.isArray(_)?_.push(p):s[n]=_?[_,p]:p}return Object.assign({},s)}catch(e){throw new o.DCXError(o.DCXError.INVALID_DATA,"Failed to parse, invalid link header",e)}}function ce(e,t){if(a.isObject(this)){if("string"==typeof this.opsHref)return h.default.resolve(this.opsHref);if(a.isFunction(this.opsHref))return h.default.resolve(this.opsHref())}return ne(e,t).then((e=>{try{return a.getLinkHref(e,_.REPO_OPS)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ops href.",e)}}))}const he=n.newDebug("dcx:assets:util:serialization");function le(e,r){he("deserializeAsset()");const s={};s.repositoryId=e.repositoryId||e[t.Properties.REPO_REPOSITORY_ID],s.assetId=e.assetId||e[t.Properties.REPO_ASSET_ID],s.name=e.name||e[t.Properties.REPO_NAME],s.size=null!=e.size?e.size:e[t.Properties.REPO_SIZE],s.path=e.path||e[t.Properties.REPO_PATH],s.assetClass=e.etag||e[t.Properties.REPO_ASSET_CLASS],s.etag=e.etag||e[t.Properties.REPO_ETAG],s.version=e.version||e[t.Properties.REPO_VERSION],s.format=e.format||e[t.Properties.DC_FORMAT],s.md5=e.md5,s.createDate=e.createDate||e[t.Properties.REPO_CREATE_DATE],s.modifyDate=e.modifyDate||e.modifiedDate||e[t.Properties.REPO_MODIFY_DATE],s.discardDate=e.discardDate||e[t.Properties.REPO_DISCARD_DATE],s.createdBy=e.createdBy||e[t.Properties.REPO_CREATED_BY],s.modifiedBy=e.modifiedBy||e[t.Properties.REPO_MODIFIED_BY],s.discardedBy=e.discardedBy||e[t.Properties.REPO_DISCARDED_BY],s.deviceCreateDate=e.deviceCreateDate||e[t.Properties.REPO_DEVICE_CREATE_DATE],s.deviceModifyDate=e.deviceModifyDate||e[t.Properties.REPO_DEVICE_MODIFY_DATE],s.defaultScheduledDeletionDuration=e.defaultScheduledDeletionDuration||e[t.Properties.REPO_DEFAULT_SCHEDULED_DELETION_DURATION],s.scheduledDeletionDate=e.scheduledDeletionDate||e[t.Properties.REPO_SCHEDULED_DELETION_DATE],s.baseAssetId=e.baseAssetId||e[t.Properties.REPO_BASE_ASSET_ID],s.state=e.state||e[t.Properties.REPO_STATE],s.links=e.links||e[t.Properties.LINKS];const o=[r,e._embedded].flat();return s.embedded=Object.entries({EffectivePrivileges:_.EFFECTIVE_PRIVILAGES,RepositoryResource:_.REPOSITORY,AppMetadata:_.APP_METADATA}).reduce(((e,[t,r])=>(o.filter((e=>e&&r in e)).forEach((s=>a.merge(e,{[t]:r===_.REPOSITORY?ue(s):s}))),e)),{}),a.pruneUndefined(s)}function ue(e={}){he("deserializeRepository()");const r=e[_.REPOSITORY]?e[_.REPOSITORY]:e;return{repositoryId:r[t.Properties.REPO_REPOSITORY_ID],repositoryType:r[t.Properties.REPO_REPOSITORY_TYPE],owner:r[t.Properties.REPO_OWNER],createDate:r[t.Properties.REPO_CREATE_DATE],title:r[t.Properties.DC_TITLE],availableRegions:r[t.Properties.REPO_AVAILABLE_REGIONS]}}const pe=n.newDebug("dcx:assets:operations"),_e=n.newDebug("dcx:assets:operations:builder");function fe(e,t,r,s,o,n,i){pe("copyAsset()"),a.validateParams(["svc",e,"object"],["srcAsset",t,"object"],["destAsset",r,"object"],["createIntermediates",s,"boolean"],["overwriteExisting",o,"boolean",!0],["manifestPatch",i,["object","string"],!0]),ee(t,["repo:path","path","assetId","repo:assetId"],"string"),ee(r,["repo:path","path","assetId","repo:assetId"],"string");const d=Se("copy",r,t,{overwriteExisting:o,createIntermediates:s},{"repo:manifestPatch":JSON.stringify(i)}),c=F(e);return ce.call(this,e).then((e=>ve(c,e,d,n))).then(we.bind(void 0,r)).then(Re)}const ge=e=>"string"==typeof e?{reltype:e,component_id:"",revision:""}:e;function me(e,t,r,s,o,n){pe("moveAsset()"),a.validateParams(["svc",e,"object"],["srcAsset",t,"object"],["destAsset",r,"object"],["createIntermediates",s,"boolean"],["overwriteExisting",o,"boolean",!0]),ee(t,["repo:path","path","assetId","repo:assetId"],"string"),ee(r,["repo:path","path","assetId","repo:assetId"],"string");const i=Se("move",r,t,{createIntermediates:s,overwriteExisting:o}),d=F(e);return ce.call(this,e).then((e=>ve(d,e,i,n))).then(we.bind(void 0,r)).then(Re)}function Ee(e,t,r,s,o){pe("discardAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["etag",r,"string",!0],["recursive",s,"boolean",!0]);const n=F(e);ee(t,["repo:path","path","assetId","repo:assetId"],"string");const i=Se("discard",Object.assign(Object.assign({},t),{etag:r}),void 0,{recursive:s});return ce.call(this,e).then((e=>ve(n,e,i,o))).then(Oe)}function Ae(e,r,s="*",o,n){pe("deleteAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["etag",s,"string",!0],["recursive",o,"boolean",!0]);const i=F(e);if(r.format===f&&null==o)throw new c.default(c.default.INVALID_PARAMS,"Recursive flag is required for directory assets.");if(!o&&J(r,[_.REPO_METADATA])){const e=a.getLinkHrefTemplated(r,_.REPO_METADATA,{});return i.invoke("DELETE",e,{[t.HeaderKeys.IF_MATCH]:s},void 0,{isStatusValid:z()}).then(Oe)}ee(r,["repo:path","path","assetId","repo:assetId"],"string");const d=Object.create(Object.getPrototypeOf(r),Object.getOwnPropertyDescriptors(r));d.etag=s;const h=Se("delete",d,void 0,{recursive:o});return ce.call(this,e).then((e=>ve(i,e,h,n))).then(Oe)}function ye(e,t,r){pe("restoreAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"]);const s=F(e);ee(t,["assetId","repo:assetId"],"string");const o=Se("restore",t);return ce.call(this,e).then((e=>ve(s,e,o,r))).then(we.bind(void 0,t)).then(Re)}function De(e,t,r,s,o,n){var i;pe("packageAssets()"),a.validateParams(["svc",e,"object"],["destination",r,"object"]),a.validateParam("sources",t,["object","object[]"]),t=a.isArray(t)?t:[t],i=["repo:path","path","assetId","repo:assetId"],t.map((e=>ee(e,i,"string"))),ee(r,["repo:path","path","assetId","repo:assetId"],"string");const d=Se("package",r,t,{createIntermediates:s,overwriteExisting:o}),c=F(e);return ce.call(this,e).then((e=>ve(c,e,d,n))).then(we.bind(void 0,r)).then(Oe)}function Ce(e){return{result:(a.isArray(e.response)?e.response:[e.response]).map(Ie),response:e}}function Ie(e){if(!e.error)return e;const t=Object.assign({},e),r=z()(e.error.status);return t.error=o.isAdobeDCXError(r)?r:new c.default(c.default.UNEXPECTED,"Unexpected response"),t._additionalData=e.error,t.error._message=e.error.title,t}function ve(e,r,s,o){return pe("doOperation()"),a.validateParams(["svc",e,"object"],["opsEndpoint",r,"string"],["operationDocument",s,["string","object"]],["additionalHeaders",o,"object",!0]),function(e,r,s,o={}){return e.invoke(t.HTTPMethods.POST,r,Object.assign({[t.HeaderKeys.CONTENT_TYPE]:D},o),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z(),responseType:"json",retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"get"}})}(e,r,s,o).then((e=>{if(e.response=e.response||{},e.response.error)throw new c.default(c.default.UNEXPECTED_RESPONSE,e.response.type||"Operation failed.",new Error(e.response.title),e);return e}))}class be{constructor(){this.opBatchLimit=100,this._docs=[]}getDocumentEntry(e){return this._docs[e]}getDocument(){return this._docs}get entryCount(){return this._docs.length}copyResources(e,t,r,s,o,n){_e("copyResource()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const i=this._docs.find(function(e,t){return function(r){return"copy_resources"===r.op&&Pe(r.source,e)&&Pe(r.target,t)}}(e,t));if(i)return i.resources=i.resources.concat(r),o&&(i["repo:manifestPatch"]=JSON.stringify(o)),void 0!==s&&(i.intermediates=s),this;const a=Se("copy_resources",t,e,{createIntermediates:s},{resources:r,"repo:manifestPatch":JSON.stringify(o),additionalHeaders:n});return this._docs.push(a),this}copy(e,t,r,s,o){_e("copy()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const n=Se("copy",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}move(e,t,r,s,o){_e("move()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const n=Se("move",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}package(e,t,r,s,o){_e("package()"),this._assertUnderLimit(),(e=a.isArray(e)?e:[e]).map((e=>{this._checkSourceType(e)})),this._checkTargetType(t);const n=Se("package",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}discard(e,t,r){_e("discard()"),this._assertUnderLimit(),this._checkTargetType(e);const s=Se("discard",e,void 0,{recursive:t},r);return this._docs.push(s),this}restore(e,t){_e("restore()"),this._assertUnderLimit(),ee(e,["assetId","repo:assetId"],"string"),this._checkTargetType(e);const r=Se("restore",e,void 0,void 0,t);return this._docs.push(r),this}delete(e,t,r){_e("delete()"),this._assertUnderLimit(),this._checkTargetType(e);const s=Se("delete",e,void 0,{recursive:t},r);return this._docs.push(s),this}_assertUnderLimit(){if(this._docs.length>=this.opBatchLimit)throw new c.default(c.default.INVALID_STATE,`Exceeds limit of ${this.opBatchLimit} operations in a single batch.`)}_checkTargetType(e){this._checkSourceOrTargetType(e,"Target")}_checkSourceType(e){this._checkSourceOrTargetType(e,"Source")}_checkSourceOrTargetType(e,t){if(0===[!!e.assetId||!!e["repo:assetId"],!!e.path||!!e["repo:path"]].filter((e=>e)).length)throw new c.default(c.default.INVALID_PARAMS,`${t} identifier is underspecified. Exactly one of [href, repo:path, repo:assetId] required.`);const r=this._getSourceType(e),s="Source"===t?this._batchSourceType:this._batchTargetType;if(s){if(r!==s)throw new c.default(c.default.INVALID_PARAMS,`Operation ${t.toLowerCase()} types must all be the same type. Expected ${s}, encountered ${r}.`)}else"Source"===t?this._batchSourceType=r:this._batchTargetType=r}_getSourceType(e){return e.assetId||e["repo:assetId"]?"id":e.path||e["repo:path"]?e.baseAssetId||e["repo:baseAssetId"]?"pathAndBaseAssetId":"path":void 0}}function Te(){return new be}function Pe(e,r){var s,o;return e[t.Properties.REPO_ASSET_ID]===(null!==(s=r[t.Properties.REPO_ASSET_ID])&&void 0!==s?s:r.assetId)&&e[t.Properties.REPO_REPOSITORY_ID]===(null!==(o=r[t.Properties.REPO_REPOSITORY_ID])&&void 0!==o?o:r.repositoryId)}function we(e,t){return t.response.asset=Object.assign(Object.assign({},t.response.asset||{}),{repositoryId:e.repositoryId||e["repo:repositoryId"]}),t}function Re(e){return{response:e,result:le(e.response.asset)}}function Oe(e){return{response:e,result:{success:e.statusCode>199&&e.statusCode<400}}}function ke(e,r,s){if(pe("_convertToACPSource()"),"object"!=typeof r)return;const o={"repo:repositoryId":r.repositoryId||r["repo:repositoryId"],"repo:path":r.path||r["repo:path"],"repo:assetId":r.assetId||r["repo:assetId"],"repo:baseAssetId":r.baseAssetId||r["repo:baseAssetId"]};return"string"==typeof o.href?(delete o["repo:path"],delete o["repo:assetId"],delete o["repo:baseAssetId"]):"string"==typeof o["repo:assetId"]&&(delete o["repo:path"],delete o["repo:baseAssetId"]),"target"===e?!0===s?o[t.HeaderKeys.IF_MATCH]=r.format!==l.Directory&&r["dc:format"]!==l.Directory&&r.etag||"*":!1===s?o[t.HeaderKeys.IF_NONE_MATCH]="*":r.format!==l.Directory&&r["dc:format"]!==l.Directory&&(o[t.HeaderKeys.IF_MATCH]=r.etag):r.format!==l.Directory&&r["dc:format"]!==l.Directory&&(o[t.HeaderKeys.IF_MATCH]=r.etag||"*"),r.version&&(o["repo:version"]=r.version),o["repo:path"]&&Q(o,"repo:repositoryId","string"),pe("_cTACPS() out",o),a.pruneUndefined(o)}function Se(e,t,r,s={},o={}){pe("_buildOperationDoc()");const n=a.pruneUndefined({op:e,target:t,source:a.isArray(r)?[]:r?{}:void 0}),{overwriteExisting:i,createIntermediates:d,recursive:c}=s;if(n.source&&(n.source=a.isArray(r)?r.map((e=>ke("source",e,i))).filter((e=>null!=e)):ke("source",r,i)),"object"==typeof t){const e=ke("target",t,i);e&&(n.target=e)}return null==n.target["repo:assetId"]&&null!=d&&(n.intermediates=d),null!=c&&(n.recursive=c),Object.assign(n,o),pe("_OD() doc",n),n}function Ne(e,t,r,s,n,i,d){a.validateParams(["resources",s,"array",!1]);const c=Te().copyResources(t,r,s,n,i).getDocument();return ce(e).then((t=>ve(F(e),t,c,d))).then(o._handleErrorResponsePayload).then((e=>{const{asset:t,source:r,target:s,resources:o}=e.response[0];return{result:{source:le(r),target:le(s),resources:o,asset:t?le(t):void 0},response:e}}))}const Le=n.newDebug("dcx:assets:block_transfer"),Me=10485760,Xe=52428800,Be=Me/4;let xe=Xe;function je(e,r){const s=function(e){return Ue(e,t.BlockTransferProperties.REPO_MIN_BLOCK_TRANSFER_SIZE)}(e);if(s&&r<s)return!1;const o=Ve(e);return!!(o&&r>o)||r>Me}function Ue(e,t){if(!$(e.links,[_.BLOCK_UPLOAD_INIT]))return;const r=a.getLinkProperty(e.links,_.BLOCK_UPLOAD_INIT,t);return r?parseInt(r):void 0}function Ve(e){return Ue(e,t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE)}const He=e=>"string"==typeof e?e.length>=Be?a.stringToBuffer(e).byteLength:e.length:"size"in e?e.size:e.byteLength,Fe=(e,t)=>{if(!a.isFunction(e))return e;if(e.length<2)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"GetSliceCallback is expected to accept 2 parameters");if(void 0===t||isNaN(t)||t<0)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Size parameter should indicate total number of bytes to be read from GetSliceCallback");return{getSlice:e,size:t}},Ye=()=>xe;function We(e,t,r,s){const o=a.parseHeaders(s);return{id:t,length:r,type:e,links:de(o.link),etag:o.etag,location:o.location,version:o.version,revision:o.revision,md5:o["content-md5"]}}function ze(e){return new Promise((t=>{let r;e.finally((()=>{clearTimeout(r),t(void 0)})),function s(){["blockUpload","blockDownload"].forEach((o=>{if(a.isObject(e[o]))return clearTimeout(r),t(e[o]);clearTimeout(r),r=setTimeout(s,1)}))}()}))}var qe;t.BlockTransferStates=void 0,(qe=t.BlockTransferStates||(t.BlockTransferStates={})).NOT_INITIALIZED="NOT_INITIALIZED",qe.INITIALIZING="INITIALIZING",qe.INITIALIZED="INITIALIZED",qe.WAITING="WAITING",qe.STARTED="STARTED",qe.PAUSING="PAUSING",qe.PAUSED="PAUSED",qe.CANCELED="CANCELED",qe.ERROR="ERROR",qe.FINALIZING="FINALIZING",qe.COMPLETE="COMPLETE";const Ke=new class{constructor(){this._uploads=[],this._downloads=[],this._pendingUploadRequests=[],this._pendingDownloadRequests=[],this._downloadChunkSize=10485760}get downloads(){return this._downloads}get uploads(){return this._uploads}set downloadChunkSize(e){a.validateParams(["downloadChunkSize",e,"+number"]),this._downloadChunkSize=e}get downloadChunkSize(){return this._downloadChunkSize}get pendingUploadRequests(){return this._pendingUploadRequests}get pendingDownloadRequests(){return this._pendingDownloadRequests}resetUploads(){this._uploads=[],this._pendingUploadRequests=[]}addAndStartUpload(e){return this._addAndStart("upload",e)}addAndStartDownload(e){return e.state!==t.BlockTransferStates.INITIALIZED?Promise.resolve(e):this._addAndStart("download",e)}startNextWaiting(e){const r="upload"===e?this._uploads:this._downloads,s=[];let o=!1;for(const e of r)!o&&e&&e.state===t.BlockTransferStates.WAITING?(e.start(),o=!0):e.state!==t.BlockTransferStates.CANCELED&&e.state!==t.BlockTransferStates.ERROR&&e.state!==t.BlockTransferStates.FINALIZING&&e.state!==t.BlockTransferStates.COMPLETE||s.push(e);const n=r.filter((e=>!s.includes(e)));"download"===e?this._downloads=n:this._uploads=n}_addAndStart(e,r){const s="upload"===e?this._uploads:this._downloads;return 0===s.filter((e=>e&&(e.state===t.BlockTransferStates.NOT_INITIALIZED||e.state===t.BlockTransferStates.INITIALIZED||e.state===t.BlockTransferStates.INITIALIZING||e.state===t.BlockTransferStates.STARTED))).length?r.start():r._setWaiting(),s.push(r),r.promise}},Ge=n.newDebug("dcx:assets:blockdownload"),$e=n.newDebug("dcx:assets:blockdownload:leaf"),Je=function*(){let e=0;for(;;)yield e++}();class Ze extends a.EventEmitter{constructor(e,r,s={}){super(["stateChanged"]),this._state=t.BlockTransferStates.NOT_INITIALIZED,this._cachedBlocks=new Map,this._blockRequestIndex=0,this._blockHandledIndex=0,this._currentByteRange=[void 0,void 0],this._pending=[],Ge("constructor");const{startByte:o,blockSize:n,endByte:i,url:d,totalSize:c,maxConcurrentRequests:l}=Object.assign({blockSize:Ke.downloadChunkSize,maxConcurrentRequests:4},a.pruneUndefined(s));a.validateParams(["svc",e,"object"],["responseType",r,"enum",!1,["buffer"]],["blockSize",n,"+number"],["url",d,"string",!0],["startByte",o,"number",!0],["endByte",i,"number",!0],["totalSize",c,"number",!0],["maxConcurrentRequests",l,"+number"]),this._dbgId=Je.next().value,this._maxConcurrentRequests=l,this._blockSize=Math.round(n),this._service=e,this._url=d,this._startByte=o,this._endByte=i,this._totalSize=c,this._bytes=new Uint8Array,this._promise=new h.default(((e,t)=>{this._resolve=()=>{Ge(this._dbgId,"resolving"),this.removeAllHandlers(),e(this)},this._reject=e=>{Ge(this._dbgId,"rejecting: ",e),this.removeAllHandlers(),t(e)}}))}get contentType(){var e;return null!==(e=this._contentType)&&void 0!==e?e:""}get totalSize(){return this._totalSize}get buffer(){return this._bytes}get state(){return this._state}get promise(){return this._promise}_requestBlock(e,r,s,o){Ge(this._dbgId,"_requestBlock(): ",e,r,s,o);const n=rt(e,r);return this._service.invoke(t.HTTPMethods.GET,this._url,n,void 0,{responseType:"defaultbuffer",isStatusValid:z(),isExternalRequest:!0}).then((e=>({response:e,index:s,lane:o}))).catch(this._handleErrorAndThrow.bind(this))}init(e=this._url,r=this._totalSize){if(Ge(this._dbgId,"init(): ",e,r),this._state===t.BlockTransferStates.INITIALIZED&&e===this._url&&r===this._totalSize)return h.default.resolve(this);if(this._assertStateIsValid("init"),this._shiftState(t.BlockTransferStates.INITIALIZING),this._url=e,this._initByteRange(r),this._totalSize!==1/0||null==this._currentByteRange[0])return this._shiftState(t.BlockTransferStates.INITIALIZED),h.default.resolve(this);const{startByte:s,endByte:o,blockIndex:n}=this._nextBlockData();let i=t.BlockTransferStates.INITIALIZED;return this._requestBlock(s,o,n,0).then((e=>(this._updateTotalSize(e),(!o||o>this._endByte)&&(i=t.BlockTransferStates.FINALIZING),e))).then(this._handleBlock.bind(this)).then((()=>this._shiftState(i))).catch(this._handleErrorAndThrow.bind(this))}start(){if(Ge(this._dbgId,"start()"),this._assertStateIsValid("start"),this._shiftState(t.BlockTransferStates.STARTED),null!=this._currentByteRange[0])return this._start(),this._promise;const[e,r]=this._currentByteRange,s=this._blockRequestIndex;return this._blockRequestIndex+=1,this._currentByteRange=[r+1,r],this._requestBlock(e,r,s,0).then(this._handleBlock.bind(this)).catch(this._handleError.bind(this)),this._promise}pause(){return Ge(this._dbgId,"pause()"),this._assertStateIsValid("pause"),this._shiftState(t.BlockTransferStates.PAUSING),h.default.allSettled(this._pending).then((()=>(this._shiftState(t.BlockTransferStates.PAUSED),Ke.startNextWaiting("download"),this)))}resume(){return Ge(this._dbgId,"resume()"),this.state===t.BlockTransferStates.PAUSED&&(this._shiftState(t.BlockTransferStates.STARTED),this._start()),this}cancel(){return Ge(this._dbgId,"cancel()"),this._assertStateIsValid("cancel"),this._shiftState(t.BlockTransferStates.CANCELED),this._reject(new c.default(c.default.ABORTED,"BlockDownload aborted.")),Ke.startNextWaiting("download"),this._promise}_setWaiting(){this._shiftState(t.BlockTransferStates.WAITING)}_start(){Ge(this._dbgId,"_start()");for(let e=0;e<this._maxConcurrentRequests;e++)this._loop(e).catch(this._handleError.bind(this))}get _loopShouldContinue(){const e=this._state===t.BlockTransferStates.STARTED&&this._currentByteRange[0]<=this._endByte;return Ge(this._dbgId,"_loopShouldContinue() ",e,this._currentByteRange,this._endByte),e}_loop(e){return O(this,void 0,void 0,(function*(){Ge(this._dbgId,"_loop(): ",e);let r=!1;for(;this._loopShouldContinue&&!r;){const{startByte:t,endByte:s,blockIndex:o,done:n}=this._nextBlockData();r=n;const i=this._requestBlock(t,s,o,e).then(this._handleBlock.bind(this)).catch(this._handleError.bind(this));this._pending[e]=i,yield i}Ge(this._dbgId,`_loop(${e}) done, ${r}`),r&&(Ge(this._dbgId,`_loop(${e}) finalize`),this._shiftState(t.BlockTransferStates.FINALIZING))}))}_nextBlockData(){Ge(this._dbgId,"_nextBlockData()");const e=this._blockRequestIndex;this._blockRequestIndex+=1;const[t,r]=this._currentByteRange;return this._currentByteRange[0]+=this._blockSize,this._currentByteRange[1]=Math.min(this._currentByteRange[1]+this._blockSize,this._endByte),{startByte:t,endByte:r,blockIndex:e,done:r>=this._endByte}}_initByteRange(e=this._totalSize){if(Ge(this._dbgId,"_initByteRange(): ",e),this._totalSize=e,null!=this._totalSize&&this._totalSize<0)throw new c.default(c.default.INVALID_PARAMS,"Total size must be positive.");if(this._totalSize||(this._totalSize=1/0),this._endByte||(this._endByte=this._totalSize),!this._startByte&&this._endByte===this._totalSize)return this._startByte=0,void(this._currentByteRange=[0,this._blockSize-1]);if(!this._startByte&&this._endByte<0&&this._totalSize!==1/0?(this._startByte=Math.max(0,this._totalSize+this._endByte),this._endByte=this._totalSize):!this._startByte&&this._endByte>0&&(this._startByte=0),null!=this._startByte&&(this._currentByteRange[0]=Math.max(this._startByte,0)),(null==this._endByte||this._endByte>0)&&(this._currentByteRange[1]=Math.min(this._endByte,(this._startByte||0)+this._blockSize-1)),null!=this._startByte||this._endByte===1/0)return;if(this._totalSize===1/0){if(-this._endByte>this._blockSize)throw new c.default(c.default.INVALID_PARAMS,"Cannot download last N bytes without a total size.");return void(this._currentByteRange=[void 0,this._endByte])}this._startByte=Math.max(0,this._totalSize+this._endByte),this._endByte=this._totalSize;const t=Math.min(this._startByte+this._blockSize-1,this._endByte);this._currentByteRange=[this._startByte,t]}_finalize(){return Ge(this._dbgId,"_finalize() start"),Ke.startNextWaiting("download"),h.default.allSettled(this._pending).then((()=>{this._checkCachedBlocks(),this._shiftState(t.BlockTransferStates.COMPLETE)}))}_updateTotalSize(e){if(Ge(this._dbgId,"_updateTotalSize()"),null==this._totalSize||this._totalSize===1/0)try{const t=e.response.headers["content-range"],r=parseInt(t.split("/")[1]);a.assert((()=>!isNaN(r)),"Invalid number."),this._totalSize=r,this._endByte===1/0&&(this._endByte=this._totalSize)}catch(t){throw new c.default(c.default.INVALID_DATA,"Could not determine total size.",t,e.response)}return Ge(this._dbgId,"_uTS(): ",this._totalSize,this._endByte),e}_handleError(e){Ge(this._dbgId,"_handleError(): ",e),this._shiftState(t.BlockTransferStates.ERROR),this._error=e,o.isAdobeDCXError(e)||(this._error=new c.default(c.default.UNEXPECTED,"An unexpected error occurred.",e)),this._reject(this._error)}_handleErrorAndThrow(e){throw this._handleError(e),this._error}_handleBlock(e){this._endByte===1/0&&this._updateTotalSize(e);const{index:t,response:r}=e;if(Ge(this._dbgId,`_handleBlock(${t})`),t!==this._blockHandledIndex)return Ge(this._dbgId,`_handleBlock(${t}) cached`),void this._cachedBlocks.set(t,e);Ge(this._dbgId,`_handleBlock(${t}) handled`),this._pushBlockData(r),this._markCurrentBlockHandled()}_markCurrentBlockHandled(){this._cachedBlocks.delete(this._blockHandledIndex),this._blockHandledIndex+=1,this._checkCachedBlocks()}_checkCachedBlocks(){const e=this._cachedBlocks.get(this._blockHandledIndex);e&&this._handleBlock(e)}_pushBlockData(e){if(this._state===t.BlockTransferStates.ERROR)return;this._contentType=this._contentType||e.headers[t.HeaderKeys.CONTENT_TYPE];const r=void 0!==s&&e.response instanceof s?e.response:new Uint8Array(e.response);this._bytes=a.concatUint8Arrays(this._bytes,r)}_shiftState(e){return Ge(this._dbgId,"_shiftState(): ",e),this._state===t.BlockTransferStates.COMPLETE||this._state===t.BlockTransferStates.ERROR||this._state===t.BlockTransferStates.CANCELED||(this._state=e,this.emit("stateChanged",[this._state,this]),e===t.BlockTransferStates.FINALIZING&&this._finalize(),e===t.BlockTransferStates.COMPLETE&&Promise.all(this._pending).then(this._resolve.bind(this))),this}_assertStateIsValid(e,r=this._state){Ge(this._dbgId,"_assertStateIsValid() ",e,r);let s=!1;const o="Invalid state transition.";switch(e){case"init":r===t.BlockTransferStates.NOT_INITIALIZED&&(s=!0);break;case"start":r!==t.BlockTransferStates.INITIALIZED&&r!==t.BlockTransferStates.WAITING&&r!==t.BlockTransferStates.STARTED||(s=!0);break;case"pause":r!==t.BlockTransferStates.INITIALIZING&&r!==t.BlockTransferStates.STARTED||(s=!0);break;case"cancel":s=!0}if(!s)throw Ge(this._dbgId,"_aSIV() throw ",o),new c.default(c.default.INVALID_STATE,o,void 0,void 0,{method:e,currentState:r})}}function Qe(e,t,r){return new Ze(e,t,r)}function et(e,r,s,o,n="defaultbuffer",i,d,l){$e("_doBlockDownload()");const u="stream"===n?void 0:Qe(e,"buffer",{startByte:s,endByte:o});(null!=this?this:{}).blockDownload=u;let p=h.default.resolve(r,void 0!==this?this:{});return i||(p=p.then((()=>e.invoke(t.HTTPMethods.GET,r,Object.assign({priority:"u=1"},l),void 0,{responseType:"text",isStatusValid:z(),retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"GET"}}))).then((e=>{const t=e.response.indexOf("href")>0?a.getFirstRegexpCapture(e.response,'"href":\\s*"([^;"]*)"'):"";if("string"!=typeof t||""===t)throw new c.default(c.default.UNEXPECTED_RESPONSE,"No block download href found in response.",void 0,e);return d=d||parseInt(a.getFirstRegexpCapture(e.response,'"size":\\s*(\\d+)')),t}))),p.then((r=>O(this,void 0,void 0,(function*(){return u?Promise.race([u.init(r,d).then((()=>Ke.addAndStartDownload(u))),u.promise]).then((()=>({statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:u.contentType,[t.HeaderKeys.CONTENT_LENGTH]:u.totalSize}),responseType:n,response:tt(u.buffer,n,u.contentType),message:"OK"}))):e.invoke(t.HTTPMethods.GET,r,rt(s,o),void 0,{responseType:"stream",isExternalRequest:!0})}))))}function tt(e,t,r){if("defaultbuffer"===t||"buffer"===t||"arraybuffer"===t)return e.buffer;if("blob"===t)return new Blob([e],{type:r});const s=a.arrayBufferToString(e);if("text"===t)return s;try{return JSON.parse(s)}catch(e){return s}}function rt(e,t){return null==e&&null==t?{}:{range:`bytes=${null!=e?e:null!=t&&t>0?"0":""}-${null!=t?Math.abs(t):""}`}}const st=n.newDebug("dcx:assets:private");function ot(e,r,s,n,i="defaultbuffer",d,c,l={},u=!1){let p;st("_getUrlFallbackDirect()");const f=void 0!==this?this:{};return h.default.resolve(void 0,f).then((()=>e.invoke(t.HTTPMethods.GET,s,Object.assign({priority:"u=1"},l),void 0,{responseType:i,isStatusValid:z([400])}))).then((e=>(st("_gUFD() status code",e.statusCode),p=e,400===e.statusCode&&e.xhr?e.xhr.getResponseDataAsJSON():e))).then((e=>{const t=a.isObject(e)&&(400===p.statusCode||400===e.status)&&e.type===o.ProblemTypes.RESPONSE_TOO_LARGE;if(st("_gUFD() do direct",t),!t&&400===p.statusCode)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response",void 0,p);return t})).then((s=>{if(!s)return p;if(!("location"in p.headers)||"string"!=typeof p.headers.location){if(!$(r.links,[_.BLOCK_DOWNLOAD]))throw new o.DCXError(o.DCXError.INVALID_DATA,"Resource too large and missing download link.");const s=a.pruneUndefined({reltype:n,component_id:d,revision:c}),h=a.getLinkHrefTemplated(r.links,_.BLOCK_DOWNLOAD,{resource:n?JSON.stringify(s):void 0});return u?{statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:p.headers["content-type"],[t.HeaderKeys.CONTENT_LENGTH]:p.headers["content-length"]}),responseType:i,response:{href:h},message:"OK"}:et.call(f,e,h,void 0,void 0,i,!1,void 0,l)}return u?{statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:p.headers["content-type"],[t.HeaderKeys.CONTENT_LENGTH]:p.headers["content-length"]}),responseType:i,response:{href:p.headers.location},message:"OK"}:et.call(f,e,p.headers.location,void 0,void 0,i,!0,void 0,l)}))}function nt({additionalHeaders:e={},asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:h,relation:l,service:u},p=!1){if(st("_doUpload()"),a.validateParams(["service",u,"object"],["asset",r,"object"],["href",c,"string"],["headHref",d,"string"],["contentType",s,"string",!0],["maybeIsNew",h,"boolean",!0],["etag",i,"string",!0],["isRetry",p,"boolean",!0],["additionalHeaders",e,"object",!0]),null==h)return u.invoke(t.HTTPMethods.HEAD,d,e,void 0,{isStatusValid:z([404])}).then((t=>{const o=200!==t.statusCode;return nt({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:o,relation:l,service:u},p)}));const _=h;return _?delete e[t.HeaderKeys.IF_MATCH]:e[t.HeaderKeys.IF_MATCH]=i||"*",s&&(e[t.HeaderKeys.CONTENT_TYPE]=s),u.invoke(t.HTTPMethods.PUT,c,e,n,{isStatusValid:z([404,409,412]),retryOptions:{pollHeader:"location",pollCodes:[202]}}).then((t=>{const a=t.statusCode;if(a>400&&!p){if(null!=i)throw z()(a,t);if(!_&&404===a)return nt({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:!0,relation:l,service:u},!0);if(404===a)throw new o.DCXError(o.DCXError.NOT_FOUND,"Unexpected response",void 0,t);if(409===a||412===a)return nt({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:void 0,relation:l,service:u},!0)}return t}))}const it=n.newDebug("dcx:assets:bulk");function at(e,r){const s="\r\n";let o=Uint8Array.from([]);for(let n=0;n<e.length;n++){const i=e[n];o=0===n?a.concatUint8Arrays(o,a.stringToBuffer(`--${r}${s}`)):a.concatUint8Arrays(o,a.stringToBuffer(`${s}--${r}${s}`)),o=a.concatUint8Arrays(o,a.stringToBuffer(`${[t.HeaderKeys.CONTENT_TYPE]}: application/http${s}`)),o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}${i.method} ${i.href}`));let d=!1;for(const e in i.headers){const t=e.toLowerCase();"content-length"===t&&(d=!0),o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}${t}: ${i.headers[e]}`))}if(i.body){const e=dt(i.body);d||(o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}content-length: ${e.length}`))),o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}${s}`)),o=a.concatUint8Arrays(o,e)}}return o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}--${r}--${s}`)),o}function dt(e){if("string"==typeof e)return a.stringToBuffer(e);if(a.isArrayBuffer(e))return new Uint8Array(e);if(M(e))return e;throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Bulk subrequest body expecting string | ArrayBuffer | Buffer")}function ct(e,r){const s=e.headers[t.HeaderKeys.CONTENT_TYPE];if(!s)throw new o.AdobeDCXError(o.AdobeDCXError.UNEXPECTED_RESPONSE,"Missing boundary header in multipart response");const n=s.split("=")[1],i=function(e,t){const r=new Uint8Array(e),s=a.stringToBuffer(`--${t}`);return lt(r,ht(r,s),s.byteLength).map((e=>ut(e,!0)))}(e.response,n);if(r&&i.length!==r)throw new o.AdobeDCXError(o.AdobeDCXError.UNEXPECTED_RESPONSE,`Unexpected number of parts; Expected ${r}, Received ${i.length}`);return i}function ht(e,t){const r=new Array(256).fill(-1),s=[];for(let e=0;e<t.length;e++)r[t[e]]=e;let o=0;for(;o<=e.length-t.length;){let n=t.length-1;for(;n>=0&&t[n]===e[o+n];)n--;n<0?(s.push(o),o+=o+t.length<e.length?t.length-r[e[o+t.length]]:1):o+=Math.max(1,n-r[e[o+n]])}return s}function lt(e,t,r,s=!1){let o=s?0:void 0;const n=[];for(const s of t)void 0!==o&&n.push(e.subarray(o,s)),o=s+r;return s&&n.push(e.subarray(o)),n}function ut(e,r=!1){const s=a.stringToBuffer("\r\n\r\n"),o=ht(e,s).slice(0,2),n=a.stringToBuffer("\n\n"),i=lt(e,...o.length>0?[o,s.byteLength]:[ht(e,n).slice(0,2),n.byteLength],!0),d=i.slice(0,r||i.length>1?2:1).reduce(((e,t)=>Object.assign(e,a.parseHeaders(a.arrayBufferToString(t)))),{}),c=i.length>1?i[i.length-1]:void 0,h=parseInt(a.arrayBufferToString(i[r?1:0]).split("\r\n",1)[0].split(" ")[1]),l=parseInt(d["content-length"],10);let u;return u=isNaN(l)?0===(null==c?void 0:c.length)?new Uint8Array([]):c:0===l?new Uint8Array([]):null==c?void 0:c.subarray(0,l),{headers:d,response:d[t.HeaderKeys.CONTENT_TYPE]===E&&void 0!==u?JSON.parse(a.arrayBufferToString(u)):u,statusCode:h}}function pt(e){if(e.length>10)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A single bulk request can only contain a maximum of 10 sub-requests.");const{writeOperations:r,readOperations:s}=e.reduce(((e,r)=>{if("string"!=typeof r.href)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation is missing an href");if("string"!=typeof r.method)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation is missing the HTTP method");const s=r.method.toUpperCase();if(!Object.values(t.HTTPMethods).includes(s))throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation includes an invalid HTTP method");return[t.HTTPMethods.GET,t.HTTPMethods.HEAD].includes(s)?e.readOperations.push(r):e.writeOperations.push(r),e}),{readOperations:[],writeOperations:[]});if(r.length>0&&s.length>0)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Cannot mix READ and WRITE operations in bulk sub requests.")}function _t(e,t,r,s="id",o={},n=!1){return it("performBulkRequest()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["requests",r,"array"],["linkMode",s,"string",!0,["id","path"]]),q(t.links,[_.BULK_REQUEST]),pt(r),ft(e,t,r,s,o).then((({response:i,subresponses:a})=>O(this,void 0,void 0,(function*(){const d=gt(a,r);return{result:n?yield mt(e,t,d,s,o,a):a,response:i}}))))}function ft(e,r,s,o="id",n={}){const i=`boundary-${Date.now()}`,d=at(s,i),c=Object.assign(Object.assign({},n),{[t.HeaderKeys.CONTENT_TYPE]:`multipart/mixed;boundary=${i}`}),h=a.getLinkHref(r.links,_.BULK_REQUEST,o);return e.invoke(t.HTTPMethods.POST,h,c,d,{isStatusValid:z(),responseType:"defaultbuffer",retryOptions:{pollHeader:"location",pollCodes:[202],pollMethod:t.HTTPMethods.GET}}).then((e=>({response:e,subresponses:ct(e,s.length)})))}function gt(e,t){return e.filter((({statusCode:e})=>a.checkRetriable(e))).map((e=>t.find((({href:t})=>t===e.headers["content-id"])))).filter((e=>e))}function mt(e,r,s,o="id",n={},i,a=5){return O(this,void 0,void 0,(function*(){if(0===s.length||a<=0)return i;if(1===s.length){const[r]=s,o=yield F(e).invoke(r.method,r.href,r.headers,r.body,{isStatusValid:z(),responseType:"defaultbuffer",retryOptions:{pollHeader:"location",pollCodes:[202],pollMethod:t.HTTPMethods.GET}});return o.headers["content-id"]=r.href,i.map((e=>"content-id"in e.headers&&e.headers["content-id"]===o.headers["content-id"]?o:e))}const d=yield ft(e,r,s,o,n).then((t=>O(this,void 0,void 0,(function*(){const i=gt(t.subresponses,s);return i.length?yield mt(e,r,i,o,n,t.subresponses,a-1):t.subresponses}))));return i.map((e=>d.find((t=>t.headers["content-id"]===e.headers["content-id"]))||e))}))}const Et=n.newDebug("dcx:assets:asset"),At=n.newDebug("dcx:assets:asset:leaf");class yt{constructor(e,t,r={}){this.type=l.Asset,this._data={},this._data=le(e),this._svc=F(t),this._cache=Y(t),this._links=a.merge({},e.links||{},e._links||{},r)}setLinks(e){this._links=e,this._updateCachedLinks()}get links(){return this._links}set links(e){this.setLinks(e)}setLink(e,t){this._links[e]=t,this._updateCachedLinks()}getLink(e){return this._links[e]}removeLink(e){delete this._links[e],this._updateCachedLinks()}_updateCachedLinks(){this._cache&&this._cache.setValueWithAsset(this.links,this.asset)}getLinkProperty(e,t,r="id"){return Et("getLinkProperty()"),a.getLinkProperty({_links:this._links},e,t,r)}getLinkHrefTemplated(e,t,r="id"){return Et("getLinkHrefTemplated()"),a.getLinkHrefTemplated({_links:this._links},e,t,r)}getLinkHref(e,t="id"){return Et("getLinkHref()"),a.getLinkHref({_links:this._links},e,t)}get asset(){return Object.assign(Object.assign({},this._data),this.links)}get serviceConfig(){return{service:this._svc,cache:this._cache}}get repositoryId(){return this._data.repositoryId}set repositoryId(e){this._data.repositoryId=e}get assetId(){return this._data.assetId}set assetId(e){this._data.assetId=e}get path(){return this._data.path}set path(e){this._data.path=e}get name(){return this._data.name}get etag(){return this._data.etag}set etag(e){this._data.etag=e}get version(){return this._data.version}set version(e){this._data.version=e}get format(){return this._data.format}set format(e){this._data.format=e}get assetClass(){return this._data.assetClass}get createDate(){return this._data.createDate}get modifyDate(){return this._data.modifyDate}get discardDate(){return this._data.discardDate}get createdBy(){return this._data.createdBy}get modifiedBy(){return this._data.modifiedBy}get discardedBy(){return this._data.discardedBy}get deviceCreateDate(){return this._data.deviceCreateDate}get deviceModifyDate(){return this._data.deviceModifyDate}get baseAssetId(){return this._data.baseAssetId}set baseAssetId(e){this._data.baseAssetId=e}get state(){return this._data.state}get size(){return this._data.size}set size(e){this._data.size=e}get md5(){return this._data.md5}set defaultScheduledDeletionDuration(e){this._data.defaultScheduledDeletionDuration=e}get defaultScheduledDeletionDuration(){return this._data.defaultScheduledDeletionDuration}set scheduledDeletionDate(e){this._data.scheduledDeletionDate=e}get scheduledDeletionDate(){return this._data.scheduledDeletionDate}fetchLinksIfMissing(e=[],t){return Et("fetchLinksIfMissing()"),Ht(this.serviceConfig,this,e,void 0,t).then((({result:e,response:t})=>(this._updateDataWithResponse(t),this)))}useLinkOrResolveResource(e,t){return Et("useLinkOrResolveResource()"),jt(this.serviceConfig,this,e,t).then((e=>(this._updateDataWithResponse(e.response),this.setLinks(a.merge(this.links,e.result.links)),e)))}headPrimaryResource(e){return Et("headPrimaryResource()"),this.fetchLinksIfMissing([_.PRIMARY],e).then((()=>Ct(this.serviceConfig,this,e))).then((e=>(this._updateDataWithResponse(e),e)))}getRepoMetadata(){return Et("getRepoMetadata()"),this.useLinkOrResolveResource(_.REPO_METADATA,"json").then((e=>{this._data=a.merge(this._data,e.result,le(e.response.response));const t=e.response.response;return t&&t._links&&this.setLinks(a.merge(this.links,t._links)),{result:this._data,response:e.response}}))}headAppMetadata(e){return Et("headAppMetadata()"),this.fetchLinksIfMissing([_.APP_METADATA],e).then((()=>Ot(this.serviceConfig,this)))}getAppMetadata(e,t){return Et("getAppMetadata()"),a.validateParams(["etag",e,"string",!0]),this.fetchLinksIfMissing([_.APP_METADATA],t).then((()=>kt(this._svc,this,e,t)))}putAppMetadata(e,t,r){return Et("putAppMetadata()"),a.validateParams(["etag",t,"string",!0],["metadata",e,["object","string"]]),this.fetchLinksIfMissing([_.APP_METADATA],r).then((()=>St(this._svc,this,e,t,r)))}patchAppMetadata(e,t,r){return Et("patchAppMetadata()"),a.validateParams(["patchDoc",e,["string","object[]"]],["etag",t,"string"]),this.fetchLinksIfMissing([_.APP_METADATA],r).then((()=>Nt(this._svc,this,e,t,r)))}getBaseDirectoryMetadata(){return Et("getBaseDirectoryMetadata()"),wt(this._svc)}getLinks(e){return Et("getLinks()"),a.isObject(this.links)&&Object.keys(this.links).length>0?h.default.resolve(this.links):Pt(this._svc,this,e).then((e=>(this.setLinks(e),e)))}getRepositoryResource(e){return Et("getRepositoryResource()"),this.fetchLinksIfMissing([_.REPOSITORY],e).then((()=>Rt(this._svc,this,e))).then((e=>(this.repositoryId=e.result["repo:repositoryId"],e)))}getEffectivePrivileges(e){return Et("getEffectivePrivileges()"),this.fetchLinksIfMissing([_.EFFECTIVE_PRIVILAGES],e).then((()=>Lt(this._svc,this)))}performBulkRequest(e,t,r){return Et("performBulkRequest()"),a.validateParams(["requests",e,"array"],["linkMode",t,"string",!0,["id","path"]]),this.fetchLinksIfMissing([_.BULK_REQUEST],r).then((()=>_t(this._svc,this,e,t,r)))}getACLPolicy(e){return Et("getACLPolicy()"),this.fetchLinksIfMissing([_.ACL_POLICY],e).then((()=>Mt(this._svc,this)))}checkACLPrivilege(e,t,r){return Et("checkACLPrivilege()"),a.validateParams(["privilege",e,"string"],["relation",t,"string"]),this.fetchLinksIfMissing([_.ACCESS_CHECK],r).then((()=>Xt(this._svc,this,e,t)))}patchACLPolicy(e,t,r){return Et("patchACLPolicy()"),a.validateParams(["policy",e,["string","object"]]),this.fetchLinksIfMissing([_.ACL_POLICY],r).then((()=>Bt(this._svc,this,e,t)))}deleteACLPolicy(e){return Et("deleteACLPolicy()"),this.fetchLinksIfMissing([_.ACL_POLICY],e).then((()=>xt(this._svc,this)))}getPrimaryResource(e,t){Et("getPrimaryResource()"),a.validateParams(["responseType",e,"string"]);const r={};return this._withSourcePromise(r).then((()=>this.fetchLinksIfMissing([_.PRIMARY],t))).then((()=>Dt.call(r,this._svc,this,e,t)))}copy(e,t,r,s,o){return Et("copy()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"],["manifestPatch",o,["object","string"],!0]),fe(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r,s,o).then((({response:e,result:t})=>({response:e,result:new yt(t,this.serviceConfig)})))}copyResources(e,t,r,s,o){return Et("copyResources()"),a.validateParams(["targetAsset",e,"object"],["resources",t,"array"],["manifestPatch",s,["object","string"],!0],["intermediates",r,"boolean",!0]),Ne(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path,version:this.version},e,t,r,s,o)}move(e,t,r,s){return Et("move()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"]),me(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r,s).then((({response:e,result:t})=>(this._data=Object.assign(Object.assign({},this._data),a.pruneUndefined(t)),{response:e,result:this})))}delete(e,t=!1,r){return Et("delete()"),a.validateParams(["etag",e,"string",!0],["recursive",t,"boolean"]),Ae(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r).then((e=>(this._data.state="DELETED",e)))}discard(e,t=!1,r){return Et("discard()"),a.validateParams(["etag",e,"string",!0],["recursive",t,"boolean"]),Ee(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r).then((e=>(this._data.state="DISCARDED",e)))}package(e,t,r,s){return Et("package()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"]),De(this._svc,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r,s)}restore(e){return Et("restore()"),ye(this._svc,{repositoryId:this.repositoryId,assetId:this.assetId},e).then((({response:e,result:t})=>(this._data=Object.assign(Object.assign(Object.assign({},this._data),a.pruneUndefined(t)),{state:"ACTIVE"}),{response:e,result:this})))}_updateDataWithResponse(e){return e?(this._data.etag=e.headers.etag||this._data.etag,this._data.version=e.headers.version||this._data.version,this._data.assetId=e.headers["asset-id"]||this._data.assetId,this._data.md5=e.headers["content-md5"]||this._data.md5,this._data.repositoryId=e.headers["repository-id"]||this._data.repositoryId,e):e}_withSourcePromise(e){return h.default.resolve(void 0,e)}}function Dt(e,t,r,s){Et("getPrimaryResource()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["responseType",r,"enum",!0,w]),q(t.links,[_.PRIMARY]);const o=a.getLinkHref(t.links,_.PRIMARY);return ot.call({},e,t,o,_.PRIMARY,r,void 0,void 0,s)}function Ct(e,r,s){Et("headPrimaryResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.PRIMARY]);const o=a.getLinkHref(r.links,_.PRIMARY);return F(e).invoke(t.HTTPMethods.HEAD,o,s,void 0,{isStatusValid:z()}).then((t=>{const s=ae(t);r.links=a.merge(r.links||{},s);const o=Y(e);return o&&o.setValueWithAsset(r.links||{},r),t}))}function It(e,t,r="id",s,o){At("getResolveLinkForAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["mode",r,"enum",!1,["id","path"]],["resource",s,["string","object"],!0]),Z(t);const n={repositoryId:t.repositoryId,id:t.assetId,path:t.path,mode:r,resource:a.isObject(s)?JSON.stringify(s):s},i=F(e),d=W(t.assetId?"/content/directory/resolve{?repositoryId,id,resource,mode}":"/content/directory/resolve{?repositoryId,path,resource,mode}",i);return h.default.resolve(a.expandURITemplate(d,a.pruneUndefined(n)))}function vt(e,t,r="id",s,o,n){At("resolveAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["mode",r,"enum",!0,["id","path"]],["resource",s,["string","object"],!0]),Z(t);const i=F(e),d=Y(e),c=d&&t.assetId&&t.repositoryId&&"id"===r;return c&&(At("rA() set pending"),d.setPending(t.assetId,t.repositoryId)),It(e,t,r,s).then((e=>null==s?re(i,e,n):se(i,e,n,o))).then((e=>({response:e,result:Yt(t,e,"id"===r,d)}))).catch((e=>{throw c&&d.deleteWithAsset(t),e}))}function bt(e,t,r){return At("fetchLinksForAsset()"),Tt(e,t,r).then((e=>e.result.links))}function Tt(e,r,s){if(At("fetchAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),x(r))return vt(e,r,"id",void 0,void 0,s).then((e=>e));let n;try{n=K(r.links,[_.ID,_.REPO_METADATA,_.PRIMARY,_.PATH])}catch(e){throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset is not resolvable. Must contain repositoryId & path, assetId, or links.",e)}const i=a.getLinkHref(r.links,n),d=F(e),c=Y(e);return d.invoke(t.HTTPMethods.HEAD,i,s,void 0,{isStatusValid:z()}).then((e=>({result:Yt(r,e,n===_.ID,c),response:e})))}function Pt(e,r,s){At("getLinksForAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]);const o=r.links||r[t.Properties.LINKS];if(a.isObject(o)&&0!==Object.keys(o).length)return h.default.resolve(o);const n=Y(e);if(n){const e=n.getValueWithAsset(r);if(e)return h.default.resolve(e)}return bt(e,r,s)}function wt(e,t){throw At("getBaseDirectoryMetadata()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}function Rt(e,r,s){At("getRepositoryResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.REPOSITORY]);const o=a.getLinkHref(r.links,_.REPOSITORY);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function Ot(e,r,s){Et("headAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.APP_METADATA]);const o=a.getLinkHref(r.links,_.APP_METADATA);return F(e).invoke(t.HTTPMethods.HEAD,o,s,void 0,{isStatusValid:z()}).then((t=>{const s=ae(t);r.links=a.merge(r.links||{},s);const o=Y(e);return o&&o.setValueWithAsset(r.links,r),t}))}function kt(e,r,s,o={}){At("getAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["etag",s,"string",!0]);const n=a.getLinkHref(r.links,_.APP_METADATA),i=Object.assign({},o);return s&&(i[t.HeaderKeys.IF_NONE_MATCH]=s),e.invoke(t.HTTPMethods.GET,n,i,void 0,{responseType:"json",isStatusValid:z([304])}).then((e=>{let t=e.response,r=e.headers.etag;return 304===e.statusCode&&(t=null,r=s),{result:t,response:e,etag:r}}))}function St(e,r,s,o,n={}){At("putAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["metadata",s,["object","string"]],["etag",o,"string",!0]),q(r.links,[_.APP_METADATA]);const i=a.getLinkHref(r.links,_.APP_METADATA);return e.invoke(t.HTTPMethods.PUT,i,a.pruneUndefined(Object.assign(n,{[t.HeaderKeys.IF_MATCH]:o,[t.HeaderKeys.CONTENT_TYPE]:m})),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z()}).then((e=>({response:e,result:{etag:e.headers.etag}})))}function Nt(e,r,s,o,n={}){At("patchAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["metadata",s,["object[]","string"]],["etag",o,"string"]),q(r.links,[_.APP_METADATA]);const i=a.getLinkHref(r.links,_.APP_METADATA);return e.invoke(t.HTTPMethods.PATCH,i,a.pruneUndefined(Object.assign(n,{[t.HeaderKeys.IF_MATCH]:o,[t.HeaderKeys.CONTENT_TYPE]:A})),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z()}).then((e=>({response:e,result:{etag:e.headers.etag}})))}function Lt(e,r,s){At("getEffectivePrivileges()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.EFFECTIVE_PRIVILAGES]);const o=a.getLinkHref(r.links,_.EFFECTIVE_PRIVILAGES);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function Mt(e,r,s){At("getACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.ACL_POLICY]);const o=a.getLinkHref(r.links,_.ACL_POLICY);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function Xt(e,r,s,o,n={}){At("checkACLPrivilege()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["privilege",s,"string",!1,["ack","read","write","delete"]]),q(r.links,[_.ACCESS_CHECK]);const i=a.getLinkHrefTemplated(r.links,_.ACCESS_CHECK,{privilege:s.toString(),relation:o});return e.invoke(t.HTTPMethods.GET,i,Object.assign({directive:"acl-check-no-body"},n),void 0,{responseType:"json",isStatusValid:z([403])}).then((e=>({result:403!==e.statusCode,response:e})))}function Bt(e,r,s,o,n={}){At("patchACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["policy",s,["string","object"]],["etag",o,"string",!0]),q(r.links,[_.ACL_POLICY]);const i=a.pruneUndefined(Object.assign(n,{[t.HeaderKeys.CONTENT_TYPE]:A,[t.HeaderKeys.IF_MATCH]:o})),d=a.getLinkHref(r.links,_.ACL_POLICY);return F(e).invoke(t.HTTPMethods.PATCH,d,i,"string"==typeof s?s:JSON.stringify(s),{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function xt(e,r,s={}){At("deleteACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.ACL_POLICY]);const o=a.getLinkHref(r.links,_.ACL_POLICY);return F(e).invoke(t.HTTPMethods.DELETE,o,s,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function jt(e,r,s,n,i){At("useLinkOrResolveResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["resource",s,"string"]);const d=F(e);let c;try{c=a.getLinkHref(r.links,s)}catch(e){}return h.default.resolve(c).then((t=>{if("string"==typeof t)return At("uLORR() asset has link"),t;const o=Y(e);return Ft(r,o,[s])})).then((e=>{if("string"==typeof e)return e;try{return a.getLinkHref(e,s)}catch(e){return}})).then((a=>{if("string"==typeof a)return At("uLORR() cache or asset had link"),d.invoke(t.HTTPMethods.GET,a,i,void 0,{isStatusValid:z(),responseType:n});if(!x(r))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset is not resolvable. Must contain repository ID + path/id or links.");return vt(e,r,"id",s,n,i)})).then((e=>L(e)?e:{result:r,response:e}))}function Ut(e,t,r=[],s=!1,o){return Ht(e,t,r,s,o).then((({result:e})=>e))}const Vt=new Set([_.BASE_DIRECTORY,_.RESOLVE_BY_ID,_.RESOLVE_BY_PATH,_.REPO_OPS,_.REPOSITORY,_.DIRECTORY,_.DISCARD,_.RESTORE,_.PATH,_.ANNOTATIONS]);function Ht(e,r,s=[],n=!1,i){if(At("fetchLinksIfMissing()",s),a.validateParams(["svc",e,"object"],["asset",r,"object"],["linksToPopulate",s,"string[]"],["suppressMissingErrors",n,"boolean",!0]),$(r.links,s))return At("fLIM() links exist"),h.default.resolve({result:r.links});const d=Y(e);return Ft(r,d,s,!0).then((o=>o||(function(e,t){return"string"==typeof e.assetId&&e.assetId.length>0&&t.every((e=>!Vt.has(e)))}(r,s)?function(e,r,s){const o=function(e,t){At("getLinksAPIUrlForAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"]);const r=W("/links{?assetId,repositoryId,clientRegion}",F(e)),{assetId:s,repositoryId:o,contentRegion:n}=t,i=a.pruneUndefined({assetId:s,repositoryId:o,contentRegion:n});return a.expandURITemplate(r,i)}(e,r);return F(e).invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json"}).then((t=>{const s=Y(e);return r.links=Object.assign({},r.links,t.response._links),null==s||s.setValueWithAsset(r.links,r),{response:t,result:r}}))}(e,r,i):(At("fLIM() fetching links"),Tt(e,r,i))))).then((t=>{let i,d,c=t;if(L(t)&&(i=t.response,c=t.result.links,d=t.result),r.links!==c){r.links=a.merge(r.links||{},c);const t=Y(e);t&&t.setValueWithAsset(r.links,r)}if(!n&&!$(c,s))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Required links could not be fetched for asset.",void 0,i,a.pruneUndefined({required:s,asset:d}));return At("fLIM() fetchedOCached exists"),{result:c||r.links,response:i}}))}function Ft(e,t,r,s){if(At("getLinksFromCache()"),!t)return h.default.resolve(void 0);const o=t.getValueWithAsset(e);return null==o?(s&&t.setPending(e.assetId,e.repositoryId),h.default.resolve(void 0)):h.default.resolve(o).then((o=>r?$(o,r)?o:void(s&&t.setPending(e.assetId,e.repositoryId)):o))}function Yt(e,r,s,o){const n=ae(r),i=Object.assign(Object.assign(Object.assign({},function(e){return a.isObject(e.asset)?e.asset:e}(e)),a.pruneUndefined({assetId:r.headers["asset-id"]||r.headers["x-resource-id"],format:r.headers[t.HeaderKeys.CONTENT_TYPE],md5:r.headers["content-md5"],etag:r.headers.etag,version:r.headers.version,repositoryId:r.headers["repository-id"]})),{links:n});return s&&n&&Object.keys(n).length>0&&o&&o.setValueWithAsset(n,i),i}const Wt=n.newDebug("dcx:assets:blockupload"),zt=n.newDebug("dcx:assets:blockupload:leaf");class qt extends a.EventEmitter{constructor(e,r,s,n,i,d,c,l,u,p,f,g,m){super(["stateChanged"]),this._internalBlockUploadId=a.generateUuid(),this._state=t.BlockTransferStates.NOT_INITIALIZED,this._currentBlockIndex=0,this._pendingBlockRequests=[],this._bytesUploaded=0,this._totalBlocksUploaded=0,this._indeterminateTransfer=!1,this._service=e,this._getSliceCallback=r,V(s)?(a.validateParams([t.BlockTransferProperties.REPO_SIZE,s[t.BlockTransferProperties.REPO_SIZE],"number"]),this._blockTransferDocument=s,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][_.BLOCK_TRANSFER],this._dataSize=this._blockTransferDocument[t.BlockTransferProperties.REPO_SIZE],this._relationType=this._blockTransferDocument[t.BlockTransferProperties.REPO_REL_TYPE],this._shiftState(t.BlockTransferStates.INITIALIZED),Wt(`BlockUpload Initialized: Transfer document found with ${this._transferBlockLinks.length} links. BlockUploadId: ${this._internalBlockUploadId}`)):(a.validateParams(["relationType",n,"string"],["dataSize",i,"number"],["contentType",d,"string"],["componentId",c,"string",!0],["etag",u,"string",!0]),this._asset=s,q(this._asset.links,[_.BLOCK_UPLOAD_INIT],o.DCXError.UNEXPECTED,"/rel/block/init missing from BlockTransferDocument."),this._relationType=n,this._dataSize=i,this._contentType=d,this._componentId=c,this._md5=l,this._ifMatch=u),this._relPath=p,this._createIntermediates=f,this._respondWith=g,this._repoMetaPatch=m,this._promise=new h.default(((e,t)=>{this._reject=t,this._resolve=e})),Ke.uploads.push(this)}init(e){if(this._assertStateIsValid("init"),!this._blockTransferDocument||!this._blockTransferDocument[t.Properties.LINKS]){this._shiftState(t.BlockTransferStates.INITIALIZING);const r=a.pruneUndefined(Object.assign({[t.BlockTransferProperties.REPO_REL_TYPE]:this._relationType,[t.BlockTransferProperties.REPO_IF_MATCH]:this._ifMatch,[t.BlockTransferProperties.REPO_SIZE]:this._dataSize,[t.BlockTransferProperties.DC_FORMAT]:this._contentType,[t.BlockTransferProperties.COMPONENT_ID]:this._componentId,[t.BlockTransferProperties.REPO_MD5]:this._md5},this._blockTransferDocument));return Kt(this._service,this._asset,r,e).then((e=>(this._blockTransferDocument=e.result,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][_.BLOCK_TRANSFER],this._shiftState(t.BlockTransferStates.INITIALIZED),Wt(`BlockUpload Initialized: Transfer document found with ${this._transferBlockLinks.length} links. BlockUploadId: ${this._internalBlockUploadId}`),this)))}return h.default.resolve(this)}get state(){return this._state}get promise(){return this._promise}start(){return this._assertStateIsValid("start"),Ke.uploads[0]!==this||this._state!==t.BlockTransferStates.INITIALIZED&&this._state!==t.BlockTransferStates.PAUSED||(Wt(`Starting the transfer of BlockUpload: ${this._internalBlockUploadId}`),this._shiftState(t.BlockTransferStates.STARTED),this._uploadLoop()),this._promise}pause(){return this._assertStateIsValid("pause"),this._shiftState(t.BlockTransferStates.PAUSING),h.default.allSettled(this._pendingBlockRequests).then((()=>(this._shiftState(t.BlockTransferStates.PAUSED),Wt(`BlockUploading has been paused.  BlockUploadId: ${this._internalBlockUploadId}`),this)))}resume(){return this._assertStateIsValid("resume"),Wt(`BlockUploading has been resumed.  BlockUploadId: ${this._internalBlockUploadId}`),this.start(),this}cancel(){this._assertStateIsValid("cancel"),this._shiftState(t.BlockTransferStates.CANCELED),Wt(`A BlockUpload has been canceled... BlockUploadId: ${this._internalBlockUploadId}`),this._promise.cancel(),this._cancel()}_setWaiting(){this._shiftState(t.BlockTransferStates.WAITING)}uploadNextBlock(e){if(this._assertStateIsValid("uploadNextBlock"),this._isEmptyBlock(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Trying to upload empty data block.");const r=this._blockTransferDocument[t.Properties.LINKS][_.BLOCK_TRANSFER][this._currentBlockIndex].href;let s;Wt(`Uploading a block... BlockUploadId: ${this._internalBlockUploadId}`);const n=He(e),i=this._uploadBlock(e,r).then((e=>(this._totalBlocksUploaded++,this._updateProgress(n),s(),Wt(`A block has completed... ${this._pendingBlocksCount} requests still active. BlockUploadId: ${this._internalBlockUploadId}`),e))).catch((e=>{Wt(`A block upload has failed. BlockUploadId: ${this._internalBlockUploadId}`),s(),this._shiftState(t.BlockTransferStates.ERROR),this._reject(new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"A block has failed during upload",e,e.response)),this.cancel()}));return s=this._pushPendingBlockRequest(i),i}get _pendingBlocksCount(){return Ke.pendingUploadRequests.filter((e=>!!e)).length}_nextBlockLock(){return this._pendingBlocksCount<4?Promise.resolve():Promise.race(Ke.pendingUploadRequests.filter((e=>!!e)))}_handleAssetMoved(e){throw Wt("_handleAssetMoved"),this._pendingBlockRequests.forEach((e=>{e.abort()})),this._pendingBlockRequests.length=0,this._transferBlockLinks.length=0,this._asset.links=Object.assign(Object.assign({},this._asset.links),ae(e.response)),this._currentBlockIndex=0,this._bytesUploaded=0,this._state=t.BlockTransferStates.NOT_INITIALIZED,this._blockTransferDocument[t.Properties.LINKS]=void 0,this.init().then((()=>this.start())),t.BlockTransferStates.INITIALIZING}_uploadLoop(){this._nextBlockLock().then((()=>{if(this._state===t.BlockTransferStates.FINALIZING||this._state===t.BlockTransferStates.COMPLETE)throw t.BlockTransferStates.COMPLETE;if(this._state===t.BlockTransferStates.PAUSING||this._state===t.BlockTransferStates.PAUSED)throw t.BlockTransferStates.PAUSED;if(this._state===t.BlockTransferStates.CANCELED)throw t.BlockTransferStates.CANCELED;if(this._state===t.BlockTransferStates.ERROR)throw t.BlockTransferStates.ERROR})).then((()=>this._getBlockAtIndex(this._currentBlockIndex))).then((e=>this._isEmptyBlock(e)?(Wt(`No more blocks.  BlockUploadId: ${this._internalBlockUploadId}`),Promise.all(this._pendingBlockRequests).then(this._finalize.bind(this))):e&&He(e)>0&&this._currentBlockIndex>=this._transferBlockLinks.length?this._extend().then((()=>e)):e)).then((e=>{if(!e)throw t.BlockTransferStates.COMPLETE;this.uploadNextBlock(e),this._currentBlockIndex++})).then((()=>{this._uploadLoop()})).catch((e=>{if("string"!=typeof e&&(this._continueBlockUploads(),this._reject(e)),e!==t.BlockTransferStates.INITIALIZING)if(e!==t.BlockTransferStates.COMPLETE){if(e!==t.BlockTransferStates.PAUSED)return e===t.BlockTransferStates.CANCELED?(Wt(`BlockUpload loop is terminated due to the upload being canceled. BlockUploadId: ${this._internalBlockUploadId}`),void this._continueBlockUploads()):e===t.BlockTransferStates.ERROR?(Wt(`BlockUpload loop is terminated due to error state. BlockUploadId: ${this._internalBlockUploadId}`),void this._continueBlockUploads()):void 0;Wt(`BlockUpload loop is terminated due to paused state. BlockUploadId: ${this._internalBlockUploadId}`)}else Wt(`BlockUpload loop is complete. BlockUploadId: ${this._internalBlockUploadId}`);else Wt(`BlockUpload loop must be re-started due to assetmoved BlockUploadId: ${this._internalBlockUploadId}`)}))}_getBlockAtIndex(e){Wt(`_getBlockAtIndex(${e})`);const r=Math.min(this._dataSize,this._blockTransferDocument[t.BlockTransferProperties.REPO_BLOCK_SIZE]);if(this._state===t.BlockTransferStates.STARTED){const t=e*r;return Wt("calling _getSliceCallback",t,t+r),this._getSliceCallback(t,t+r).catch((e=>{throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"The getSliceCallback threw an unexpected error.",e)}))}}_uploadBlock(e,r){return this._service.invoke(t.HTTPMethods.PUT,r,void 0,e,{isStatusValid:z(),isExternalRequest:!0})}_isEmptyBlock(e){return"string"==typeof e?0===e.length:B(e)?0===e.size:!e||0===e.byteLength}_extend(){q(this._blockTransferDocument[t.Properties.LINKS],[_.BLOCK_EXTEND],o.DCXError.UNEXPECTED,"The transfer document does not contain an extend href");const e=Math.ceil(1.5*this._blockTransferDocument[t.BlockTransferProperties.REPO_SIZE]),r=a.getLinkHrefTemplated(this._blockTransferDocument[t.Properties.LINKS],_.BLOCK_EXTEND,{size:e});return this._service.invoke(t.HTTPMethods.POST,r,{},void 0,{isStatusValid:z(),responseType:"json"}).then((e=>(this._indeterminateTransfer=!0,this._blockTransferDocument=e.response,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][_.BLOCK_TRANSFER],Wt(`Transfer document was extended to ${this._transferBlockLinks.length} transfer links. BlockUploadId: ${this._internalBlockUploadId}`),e))).catch((e=>{throw o.isAdobeDCXError(e)&&e.problemType===o.ProblemTypes.ASSET_MOVED&&this._handleAssetMoved(e),new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"An unexpected error occurred while extending the block transfer document.",e,e.response)}))}_pushPendingBlockRequest(e){const t=this._pendingBlockRequests.push(e),r=Ke.pendingUploadRequests.push(e);return()=>{delete this._pendingBlockRequests[t-1],delete Ke.pendingUploadRequests[r-1]}}_updateProgress(e){if(Wt("_updateProgress()",e),"number"==typeof e&&(this._bytesUploaded+=e),this.onProgress&&a.isAnyFunction(this.onProgress))try{this.onProgress(this._bytesUploaded,Math.max(this._blockTransferDocument[t.BlockTransferProperties.REPO_SIZE],this._bytesUploaded),this._indeterminateTransfer)}catch(e){console.error("Error in onProgress callback",e)}}_cancel(){this._pendingBlockRequests.map((e=>{e&&e.cancel()})),this._state!==t.BlockTransferStates.ERROR&&this._resolve(this)}_assertStateIsValid(e,r){const s=r||this._state;switch(e){case"init":if(s!==t.BlockTransferStates.NOT_INITIALIZED&&s!==t.BlockTransferStates.INITIALIZED)throw new o.DCXError(o.DCXError.INVALID_STATE,"BlockUpload has already been initialized");break;case"start":if(s===t.BlockTransferStates.NOT_INITIALIZED)throw new o.DCXError(o.DCXError.INVALID_STATE,"Please call init before starting the block upload");break;case"uploadNextBlock":if(s===t.BlockTransferStates.PAUSED||s===t.BlockTransferStates.CANCELED)throw new o.DCXError(o.DCXError.INVALID_STATE,"Cannot add block when Paused or Cancelled");break;case"getBlockAtIndex":if(s!==t.BlockTransferStates.STARTED)throw new o.DCXError(o.DCXError.INVALID_STATE,`Cannot fetch block while in the ${s} state`);break;case"cancel":if(s!==t.BlockTransferStates.STARTED&&s!==t.BlockTransferStates.FINALIZING&&s!==t.BlockTransferStates.PAUSING&&s!==t.BlockTransferStates.PAUSED&&s!==t.BlockTransferStates.ERROR)throw new o.DCXError(o.DCXError.INVALID_STATE,`Trying to cancel while in an invalid state ${s}`)}}_continueBlockUploads(){if(Wt("continueBlockUploads()"),Ke.uploads[0]===this)if(Ke.uploads.shift(),Ke.uploads.length>0){const e=Ke.uploads[0];Wt("Another block upload found in the queue, starting..."),e.start()}else 0===this._pendingBlocksCount&&(Wt("There are no more pending block transfers.. Clean up blockUploadManager.."),Ke.resetUploads())}_finalize(){Wt(`Finalizing block transfer.  BlockUploadId: ${this._internalBlockUploadId}`),this._shiftState(t.BlockTransferStates.FINALIZING);const e=a.getLinkHrefTemplated(this._blockTransferDocument[t.Properties.LINKS],_.BLOCK_FINALIZE,a.pruneUndefined({path:this._relPath,intermediates:this._createIntermediates,respondWith:a.isObject(this._respondWith)?JSON.stringify(this._respondWith):this._respondWith,repoMetaPatch:this._repoMetaPatch}));return this._blockTransferDocument[t.Properties.LINKS][_.BLOCK_TRANSFER]=this._transferBlockLinks.slice(0,this._totalBlocksUploaded),this._service.invoke(t.HTTPMethods.POST,e,{[t.HeaderKeys.CONTENT_TYPE]:y},JSON.stringify(a.pruneUndefined(this._blockTransferDocument)),{isStatusValid:z(),retryOptions:{pollHeader:"location",pollCodes:[202],timeoutAfter:12e4},responseType:"arraybuffer"}).then((e=>{if(200===e.statusCode||201===e.statusCode){Wt(`Finalize complete.  BlockUploadId: ${this._internalBlockUploadId}`);const r=ut(new Uint8Array(e.response));if(this._relationType===_.PRIMARY){if(this.finalizeResponse=r,this.createdAsset=a.pruneUndefined({assetId:r.headers["asset-id"],repositoryId:r.headers["repository-id"],links:de(r.headers.link),etag:r.headers.etag,md5:r.headers["content-md5"]}),r.response&&this._respondWith)try{const e=JSON.parse(a.arrayBufferToString(r.response));r.response=e,this.createdAsset=a.mergeDeep(this.createdAsset,le(e))}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected error parsing respondWith parameter",e)}}else{this.finalizeResponse=e;try{this.uploadRecord=We(this._blockTransferDocument[t.BlockTransferProperties.DC_FORMAT],this._blockTransferDocument[t.BlockTransferProperties.COMPONENT_ID],this._bytesUploaded,a.arrayBufferToString(e.response))}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"An error occurred while deserializing upload component record.",e,r)}}this._shiftState(t.BlockTransferStates.COMPLETE),this._updateProgress(!0),this._resolve(this)}this._continueBlockUploads()})).catch((e=>{o.isAdobeDCXError(e)&&e.problemType===o.ProblemTypes.ASSET_MOVED&&this._handleAssetMoved(e),Wt("Error occurred finalizing the block transfer.. Rejecting"),this._reject(new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"An error occurred while finalizing the block transfer.",e,e.response)),this._continueBlockUploads()}))}_shiftState(e){return Wt(`_shiftState(): ${e}`),this._state===t.BlockTransferStates.COMPLETE||this._state===t.BlockTransferStates.ERROR||this._state===t.BlockTransferStates.CANCELED||(this._state=e,this.emit("stateChanged",[this._state])),this}}function Kt(e,r,s,n={}){if(a.validateParams(["svc",e,"object"],["asset",r,"object"],["transferDocument",s,"object"],["additionalHeaders",n,"object",!0]),q(r.links,[_.BLOCK_UPLOAD_INIT]),s["repo:resource"]){if(!s["repo:resource"].reltype)throw new o.DCXError(o.DCXError.INVALID_DATA,"reltype param is required in the Resource Designator");s[t.BlockTransferProperties.REPO_REL_TYPE]=s["repo:resource"].reltype,s["repo:resource"].component_id&&(s[t.BlockTransferProperties.COMPONENT_ID]=s["repo:resource"].component_id),s["repo:resource"].etag&&(s[t.BlockTransferProperties.REPO_IF_MATCH]=s["repo:resource"].etag),delete s["repo:resource"]}if(s[t.BlockTransferProperties.REPO_REL_TYPE]===_.COMPONENT&&!s[t.BlockTransferProperties.COMPONENT_ID])throw new o.DCXError(o.DCXError.INVALID_DATA,"Component Id required to block upload to a component");const i=a.getLinkHref(r.links,_.BLOCK_UPLOAD_INIT);n[t.HeaderKeys.CONTENT_TYPE]=y;const d=a.normalizeHeaders(n);return d.priority=d.priority||"u=1",e.invoke(t.HTTPMethods.POST,i,d,JSON.stringify(s),{responseType:"json",isStatusValid:z()}).then((e=>({response:e,result:e.response})))}function Gt({additionalHeaders:e,asset:t,componentId:r,contentType:s,dataOrSliceCallback:o,etag:n,maybeIsNew:i,md5:d,progressCb:c,relation:l,size:u,svc:p,blockSize:_}){zt("_upload()"),a.validateParams(["svc",p,"object"],["asset",t,"object"],["size",u,"number",!0],["md5",d,"string",!0],["etag",n,"string",!0]);const f=Fe(o,u),g=He(f),m=F(p);if(je(t,g))return $t({asset:t,additionalHeaders:e,componentId:r,contentType:s,dataOrSliceCallback:o,etag:n,md5:d,progressCb:c,relation:l,size:u,service:m,blockSize:_});q(t.links,[l]);const E=a.getLinkHrefTemplated(t.links,l,{component_id:r});return h.default.resolve(void 0,{blockUpload:void 0,progress:c}).then((()=>Promise.resolve(a.isAnyFunction(o)?o(0,g):o))).then((r=>nt({asset:t,additionalHeaders:e,contentType:s,data:r,etag:n,headHref:E,href:E,maybeIsNew:i,relation:l,service:m}))).then((e=>{let r={};try{r=ae(e),t.links=a.merge(t.links||{},r);const s=Y(p);s&&s.setValueWithAsset(t.links,t)}catch(e){}return{response:e,result:{revision:e.headers.revision||e.headers.version,location:e.headers.location,links:r,etag:e.headers.etag,version:e.headers.version||e.headers.revision,md5:e.headers.md5||e.headers["content-md5"],length:g,type:s},isBlockUpload:!1,asset:{assetId:t.assetId||e.headers["asset-id"],repositoryId:t.repositoryId||e.headers["repository-id"],links:t.links||r}}})).catch((e=>{throw e}))}function $t({service:e,asset:r,additionalHeaders:s,dataOrSliceCallback:n,contentType:i,progressCb:d,relation:c,size:h,componentId:l,md5:u,etag:p,relPath:f,createIntermediates:g,respondWith:m,blockSize:E,repoMetaPatch:A}){if(!h)throw new o.DCXError(o.DCXError.INVALID_DATA,"A size estimate is required when a GetSliceCallback is provided. The size is used to determine the number of requests required to block transfer the asset.");const y=a.isAnyFunction(n)?n:function(e){if(!a.isFunction(e.slice))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Data cannot be sliced");return function(t,r){return O(this,void 0,void 0,(function*(){return e.slice(t,r)}))}}(n);q(r.links,[_.BLOCK_UPLOAD_INIT]);const D=Kt(e,r,a.pruneUndefined({[t.BlockTransferProperties.REPO_REL_TYPE]:c,[t.BlockTransferProperties.REPO_IF_MATCH]:p,[t.BlockTransferProperties.REPO_SIZE]:h,[t.BlockTransferProperties.DC_FORMAT]:i,[t.BlockTransferProperties.COMPONENT_ID]:l,[t.BlockTransferProperties.REPO_MD5]:u,[t.BlockTransferProperties.REPO_BLOCK_SIZE]:E}),s);return D.then((t=>{const r=new qt(e,y,t.result,c,h,i,l,u,p,f,g,m,A);return r.onProgress=d,Object.assign(D,{blockUpload:r}),r.init(s)})).then((e=>e.start())).then((e=>{const t=e.finalizeResponse||{headers:{}};return{response:t,result:e.uploadRecord||e.createdAsset,blockUpload:e,isBlockUpload:!0,asset:{assetId:t.headers["asset-id"]||r.assetId,repositoryId:t.headers["repository-id"]||r.repositoryId,etag:t.headers.etag,links:r.links}}}))}const Jt=Ke;function Zt(e){return e||"defaultbuffer"}function Qt(e,r,s="json",o={}){a.validateParams(["svc",e,"object"],["asset",r,"object"],["format",s,"enum",!1,["json","xml"]]),q(r.links,[_.EMBEDDED_METADATA]);const n=a.getLinkHref(r.links,_.EMBEDDED_METADATA);return e.invoke(t.HTTPMethods.GET,n,Object.assign(Object.assign({},o),{accept:t.EmbeddedMetadataMediaTypes[s.toUpperCase()],vary:"accept"}),void 0,{isStatusValid:z(),responseType:"json"===s?"json":"text"}).then((e=>({result:e.response,response:e})))}function er(e,r,s,o,n="json",i={}){a.validateParams(["svc",e,"object"],["asset",r,"object"],["data",s,["string","object","object[]"]],["etag",o,"string",!0],["format",n,"enum",!1,["json","xml"]]),q(r.links,[_.EMBEDDED_METADATA]);const d=a.getLinkHref(r.links,_.EMBEDDED_METADATA),c=Object.assign(Object.assign({},i),{[t.HeaderKeys.CONTENT_TYPE]:t.EmbeddedMetadataMediaTypes[n.toUpperCase()],[t.HeaderKeys.IF_MATCH]:o});return e.invoke(t.HTTPMethods.PUT,d,c,"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z()})}function tr(e,r,s,o,n={}){a.validateParams(["svc",e,"object"],["asset",r,"object"],["data",s,["string","object","object[]"]],["etag",o,"string",!0]),q(r.links,[_.EMBEDDED_METADATA]);const i=a.getLinkHref(r.links,_.EMBEDDED_METADATA);return e.invoke(t.HTTPMethods.PATCH,i,Object.assign(n,{[t.HeaderKeys.CONTENT_TYPE]:A,[t.HeaderKeys.IF_MATCH]:o}),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z(),retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"GET"}})}const rr=n.newDebug("dcx:assets:filebase"),sr=n.newDebug("dcx:assets:filebase:leaf"),or="application/vnd.adobe.versions+json";class nr extends yt{constructor(e,r,s){super(e,r,s),this._data.width=null!=e.width?e.width:e[t.Properties.IMAGE_WIDTH],this._data.length=null!=e.length?e.length:e[t.Properties.IMAGE_LENGTH],this._data.renderable=null!=e.renderable?e.renderable:"object"==typeof this._data.links?_.RENDITION in this._data.links:void 0}get width(){return this._data.width}get length(){return this._data.length}get renderable(){return this._data.renderable}getRendition(e,t,r,s){return rr("getRendition()"),a.validateParams(["opts",e,"object",!0],["responseType",t,"string",!0],["linkProvider",r,"object",!0]),this.fetchLinksIfMissing([_.RENDITION],s).then((()=>ir(this._svc,this,e,t,r,s)))}getEmbeddedMetadata(e="json",t){return rr("getEmbeddedMetadata()"),a.validateParams(["format",e,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([_.EMBEDDED_METADATA],t).then((()=>Qt(this._svc,this,e,t)))}putEmbeddedMetadata(e,t,r="json",s){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0],["format",r,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([_.EMBEDDED_METADATA],s).then((()=>er(this._svc,this,e,t,r,s)))}patchEmbeddedMetadata(e,t,r){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([_.EMBEDDED_METADATA],r).then((()=>tr(this._svc,this,e,t,r)))}blockDownload(e,t,r,s,o,n,i){rr("blockDownload()"),a.validateParams(["startByte",e,"number",!0],["endByte",t,"number",!0],["resource",r,"string",!0],["componentId",s,"string",!0],["version",o,"string",!0],["responseType",n,"enum",!0,w]),a.assert((()=>null==e||null==t||e<t),"endByte must be greater than startByte");const d={};return this._withSourcePromise(d).then((()=>this.fetchLinksIfMissing([_.BLOCK_DOWNLOAD]))).then((()=>ar.call(d,this._svc,this,e,t,r,s,o,n,i)))}updatePrimaryResource(e,t,r,s,o,n){rr("updatePrimaryResource()");const i=a.isAnyFunction(e)?_.BLOCK_UPLOAD_INIT:_.PRIMARY;return this.fetchLinksIfMissing([i],n).then((()=>dr(this.serviceConfig,this,e,t,r,s,o,n))).then((e=>(this._data.etag=e.result.etag,this._data.md5=e.result.md5,this._data.length=e.result.length,this._data.version=e.result.version,e)))}}function ir(e,r,s,o="defaultbuffer",n,i){sr("getRendition()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["renditionOptions",s,"object",!0],["linkProvider",n,"object",!0]),q(r.links,[_.RENDITION]);const d=n?a.provideLink(r.links[_.RENDITION],n,s):a.getLinkHrefTemplated(r.links,_.RENDITION,Object.assign({},s));return e.invoke(t.HTTPMethods.GET,d,i,void 0,{responseType:Zt(o),isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function ar(e,t,r,s,o,n,i,d,c){sr("doBlockDownload()"),a.validateParams(["svc",e,"object"],["assetOrPresignedUrl",t,["object","string"]],["startByte",r,"number",!0],["endByte",s,"number",!0],["resource",o,"string",!0],["componentId",n,"string",!0],["version",i,"string",!0],["responseType",d,"enum",!0,w]),a.assert((()=>null==r||null==s||r<s),"endByte must be greater than startByte");const h=null!=this?this:{};if("string"==typeof t)return et.call(h,e,t,r,s,d,!0,void 0,c);const l=t;q(l.links,[_.BLOCK_DOWNLOAD]);const u=a.pruneUndefined({reltype:o,component_id:n,revision:i}),p=a.getLinkHrefTemplated(l.links,_.BLOCK_DOWNLOAD,{resource:void 0!==o?JSON.stringify(u):void 0});return et.call(h,e,p,r,s,d,!1,void 0,c)}function dr(e,t,r,s,o,n,i,d){return sr("updatePrimaryResource()"),a.validateParams(["service",e,"object"],["asset",t,"object"],["dataOrSliceCallback",r,["function","object","string"]],["contentType",s,"string"],["size",o,"number",!0],["md5",i,"string",!0]),q(t.links,[_.PRIMARY]),Gt({svc:e,asset:t,dataOrSliceCallback:r,contentType:s,relation:_.PRIMARY,size:o,md5:i,maybeIsNew:!1,etag:n,additionalHeaders:d}).catch((a=>{var c;if(413===(null===(c=a.response)||void 0===c?void 0:c.statusCode))return $t({service:F(e),asset:t,dataOrSliceCallback:r,contentType:s,relation:_.PRIMARY,size:o,md5:i,etag:n,additionalHeaders:d});throw a}))}const cr=n.newDebug("dcx:assets:pagination");class hr{constructor(e,t,r,s){if(this._links=e,this._svc=t,this._transformer=r,this._items={},this.ListResource=s,!e||!e[_.PAGE])throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset must have links that contain a page relation.")}get items(){return Object.values(this._items)}get data(){return this._data}getPage(e={},r){cr("getPage()");const{embed:s}=e,o=R(e,["embed"]);s&&(o.embed=s.some((e=>"object"==typeof e))?JSON.stringify(s):s.join(",")),this.ListResource&&Object.assign(o,{resource:this.ListResource});const n=a.getLinkHrefTemplated(this._links,_.PAGE,o);return this._svc.invoke(t.HTTPMethods.GET,n,r,void 0,{isStatusValid:z(),responseType:"json"}).then((e=>{const t=this.parseResponse(e);return this._data=t,{paged:this,result:this._data,response:e}}))}getNextPage(){if(cr("getNextPage()"),this.hasNextPage()&&this._nextPageLink)return this._svc.invoke(t.HTTPMethods.GET,this._nextPageLink.href,void 0,void 0,{isStatusValid:z(),responseType:"json"}).then((e=>{const t=this.parseResponse(e);return this._data=t,{paged:this,result:this._data,response:e}}))}hasNextPage(){return cr("hasNextPage() ",void 0!==this._nextPageLink),void 0!==this._nextPageLink}*[Symbol.iterator](){for(const e in this._items)yield this._items[e]}[Symbol.asyncIterator](){return function(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,o=r.apply(e,t||[]),n=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){o[e]&&(s[e]=function(t){return new Promise((function(r,s){n.push([e,t,r,s])>1||a(e,t)}))})}function a(e,t){try{(r=o[e](t)).value instanceof k?Promise.resolve(r.value.v).then(d,c):h(n[0][2],r)}catch(e){h(n[0][3],e)}var r}function d(e){a("next",e)}function c(e){a("throw",e)}function h(e,t){e(t),n.shift(),n.length&&a(n[0][0],n[0][1])}}(this,arguments,(function*(){for(const e in this._items)yield yield k(this._items[e]);for(;this.hasNextPage();){const e=yield k(this.next());for(const t of e.value.paged)yield yield k(t)}}))}next(){return O(this,void 0,void 0,(function*(){if(cr("next()"),!this.hasNextPage())return{done:!0,value:void 0};const e=yield this.getNextPage();return e?{done:!1,value:e}:{done:!0,value:void 0}}))}parseResponse(e){cr("parseResponse()"),this._items={};const r=e.response;for(const e in r[t.Properties.CHILDREN]){const s=r[t.Properties.CHILDREN][e],[o,n]=this._transformer(s,this._svc);this._items[o]=n}return this._nextPageLink=r[t.Properties.LINKS].next,this.currentPage=r[t.Properties.PAGE],r}}const lr=n.newDebug("dcx:assets:version"),ur=n.newDebug("dcx:assets:version:leaf");class pr extends nr{constructor(e,t,r){super(e,t,r),this._svc=t,this.type=l.Version,this._data=gr(e)}get milestone(){return this._data.milestone}getRepositoryResource(){throw lr("getRepositoryResource()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}getEffectivePrivileges(){throw lr("getEffectivePrivileges()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}performBulkRequest(e,t){throw lr("performBulkRequest()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}checkACLPrivilege(e,t){throw lr("checkACLPrivilege()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}getACLPolicy(){throw lr("getACLPolicy()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}}function _r(e){ur("adobeVersionTransformer()");const t=gr(e);return t.links=a.merge({},e.links,e._links),[t.version,t]}function fr(e,t){ur("versionTransformer()");const r=new pr(e,t);return[r.version,r]}function gr(e){return ur("deserializeVersion()"),{version:e.version||e[t.VersionProperties.VERSION],createDate:e.created||e[t.VersionProperties.CREATED],createdBy:e.createdBy||e[t.VersionProperties.CREATED_BY],milestone:e.milestone||e[t.VersionProperties.MILESTONE],links:e._links}}const mr=n.newDebug("dcx:assets:file"),Er=n.newDebug("dcx:assets:file:leaf");class Ar extends nr{constructor(e,t,r){super(e,t,r),this.type=l.File}getPagedVersions(e={itemTransformer:fr},t){return mr("getPagedVersions()"),a.validateParams(["pageOpts",e,"object",!0]),this.fetchLinksIfMissing([_.PAGE],t).then((()=>Cr(this._svc,this,e,t)))}getVersionResource(e,t){return mr("getVersionResource()"),a.validateParams(["version",e,"string"]),this.fetchLinksIfMissing([_.PAGE],t).then((()=>Dr(this._svc,this,e,t).then((e=>({result:e.result?new pr(e.result,this._svc):void 0,response:e.response})))))}patchVersions(e,t,r){return mr("patchVersions()"),a.validateParams(["patchDoc",e,["string","array"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([_.VERSION_HISTORY],r).then((()=>yr(this._svc,this,e,t,r)))}initBlockUpload(e,t){return a.validateParams(["transferDocument",e,"object"],["additionalHeaders",t,"object",!0]),this.fetchLinksIfMissing([_.BLOCK_UPLOAD_INIT],t).then((()=>Kt(this._svc,this,e,t)))}copy(e,t,r,s,o){return super.copy(e,t,r,s,o).then((({response:e,result:t})=>({response:e,result:new Ar(t,this.serviceConfig)})))}}function yr(e,r,s,o,n){Er("patchVersions()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["patchDoc",s,["string","array"]],["etag",o,"string",!0]),q(r.links,[_.VERSION_HISTORY]);const i=Object.assign(Object.assign({},n),{[t.HeaderKeys.CONTENT_TYPE]:A});o&&(i[t.HeaderKeys.IF_MATCH]=o);const d=a.getLinkHref(r.links,_.VERSION_HISTORY);return e.invoke(t.HTTPMethods.PATCH,d,i,"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z()})}function Dr(e,r,s,o){Er("getVersionResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["version",s,"string"]),q(r.links,[_.PAGE]),G(r.links,_.PAGE,"type",or);const n=a.getLinkHrefTemplated(r.links,_.PAGE,{version:s});return e.invoke(t.HTTPMethods.GET,n,o,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response[t.VersionProperties.TOTAL_CHILDREN]>0?e.response[t.Properties.CHILDREN][0]:void 0,response:e})))}function Cr(e,t,r={},s){return Er("getPagedVersions()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["pageOpts",r,"object"]),q(t.links,[_.PAGE]),G(t.links,_.PAGE,"type",or),new hr(t.links,e,r.itemTransformer||_r,_.VERSION_HISTORY).getPage(r,s)}const Ir=n.newDebug("dcx:assets:composite"),vr=n.newDebug("dcx:assets:composite:leaf"),br=n.AdobeDCXLogger.getInstance();class Tr extends Ar{constructor(e,t,r){super(e,t,r),this.type=l.Composite}headManifest(e){return Ir("headManifest()"),this.fetchLinksIfMissing([_.MANIFEST],e).then((()=>Pr(this._svc,this,e))).then((e=>this._updateDataWithResponse(e)))}getManifest(e,t,r){return Ir("getManifest()"),a.validateParams(["version",e,"string",!0],["etag",t,"string",!0]),this.fetchLinksIfMissing([_.MANIFEST],r).then((()=>wr(this._svc,this,e,t,r)))}getManifestUrl(e){Ir("getManifestUrl()");const t=null==e?_.MANIFEST:_.PAGE;return this.fetchLinksIfMissing([t]).then((()=>Rr(this._svc,this,e)))}getManifestAndComponentsByPath(e,t,r,s){return vr("getManifestAndComponentsByPath()"),Sr(this._svc,this,e,t,r,s)}getComponent(e,t,r,s,o){Ir("getComponent()");const n={};return this._withSourcePromise(n).then((()=>jr.call(n,this._svc,this,e,t,r,s,o)))}getComponentByPath(e,t="defaultbuffer",r){return Ir("getComponentByPath()"),xr(this.serviceConfig,this,e,t,r)}getComponentUrl(e,t,r){return Ir("getComponentUrl()"),this.fetchLinksIfMissing([_.COMPONENT],r).then((()=>Mr(this._svc,this,e,t)))}updateManifest(e,t,r,s,o){return Ir("updateManifest()"),this.fetchLinksIfMissing([_.MANIFEST],o).then((()=>Ur(this._svc,this,e,t,r,s,o))).then(this._updateDataWithResponse.bind(this))}putComponent(e,t,r,s,n,i,d,c){if(Ir("putComponent()"),s&&!a.verifyUuid(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Component id is not a uuid");return a.verifyUuid(e)||br.warn("Existing component id is not a uuid"),this.fetchLinksIfMissing([_.COMPONENT],c).then((()=>Vr(this.serviceConfig,this,e,t,r,s,n,i,d,c)))}putEmbeddedMetadata(e,t,r="json",s){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0],["format",r,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([_.EMBEDDED_METADATA],s).then((()=>er(this._svc,this,e,t,r,s))).then((e=>O(this,void 0,void 0,(function*(){return yield this.headManifest(s),e}))))}patchEmbeddedMetadata(e,t,r){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([_.EMBEDDED_METADATA],r).then((()=>tr(this._svc,this,e,t,r))).then((e=>O(this,void 0,void 0,(function*(){return yield this.headManifest(),e}))))}copy(e,t,r,s,o){return super.copy(e,t,r,s,o).then((({response:e,result:t})=>({response:e,result:new Tr(t,this.serviceConfig)})))}}function Pr(e,r,s){vr("headCompositeManifest()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.MANIFEST]);const o=a.getLinkHref(r.links,_.MANIFEST);return e.invoke(t.HTTPMethods.HEAD,o,s,void 0,{responseType:"json",isStatusValid:z()})}function wr(e,r,s,o,n){return vr("getCompositeManifest()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["version",s,"string",!0],["etag",o,"string",!0]),q(r.links,[_.MANIFEST]),Rr(e,r,s,n).then((r=>e.invoke(t.HTTPMethods.GET,r,Object.assign(null!=n?n:{},o?{[t.HeaderKeys.IF_NONE_MATCH]:o}:{}),void 0,{responseType:"json",isStatusValid:z([304])}))).then((e=>({manifestData:e.response||null,manifestEtag:e.headers.etag,response:e})))}function Rr(e,t,r,s){return vr("getCompositeManifestUrl()"),kr(e,t,_.MANIFEST,r,s)}function Or(e,t,r,s){return vr("_getComponentPathUrl()"),kr(e,t,_.COMPONENT,t.version,s).then((e=>a.expandURITemplate(e,a.pruneUndefined({component_path:r}))))}function kr(e,r,s,n,i){return vr("_getUrl()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["versionId",n,"string",!0]),h.default.resolve().then((()=>{if(n)return Dr(e,r,n,i)})).then((e=>{if(null!=n){if(!e||!a.isObject(e)||"object"!=typeof e.result)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Invalid version resource.",void 0,e?e.response:void 0);return q(e.result[t.Properties.LINKS],[s]),a.getLinkHref(e.result[t.Properties.LINKS],s)}return a.getLinkHref(r.links,s)}))}function Sr(e,r,s,n,i,d){a.validateParams(["svc",e,"object"],["asset",r,"object"],["components",s,"array"],["version",n,"string",!0],["etag",i,"string",!0]);const c=[_.MANIFEST,_.COMPONENT,_.BULK_REQUEST,_.BLOCK_DOWNLOAD];return n&&c.push(_.PAGE),Ut(e,r,c,void 0,d).then((c=>O(this,void 0,void 0,(function*(){r.links=Object.assign({},r.links,c);const l=F(e),u=s.map((({component_path:e,responseType:s})=>({method:t.HTTPMethods.GET,href:a.getLinkHrefTemplated(r.links,_.COMPONENT,{component_path:e}),headers:d,component_path:e,responseType:s})));u.unshift({method:t.HTTPMethods.GET,href:yield Rr(l,r,n,d),headers:Object.assign(i?{[t.HeaderKeys.IF_NONE_MATCH]:i}:{},d)});const p=yield Promise.all(a.chunkArray(u,10).map((e=>_t(l,r,e,void 0,d,!0))));return h.default.resolve(yield p.reduce(((n,i)=>O(this,void 0,void 0,(function*(){var c,h;const p=yield n;if(p.responses.push(i.response),200!==i.response.statusCode)return p;const{componentResponses:f,manifestResponse:g}=function(e,r){return e.reduce(((e,s)=>{const n=r.find((e=>e.href===s.headers[t.HeaderKeys.CONTENT_ID]));if(!n)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Bulk sub-response content-id did not match any bulk request",void 0,s);return"component_path"in n?e.componentResponses.push(s):e.manifestResponse=s,e}),{componentResponses:[]})}(i.result,u),m={};if(s.forEach((e=>{e.hasOwnProperty("skipBlockDownload")&&(m[e.component_path]=e.skipBlockDownload)})),Object.assign(p.components,yield function(e,r,s,n,i,d){return O(this,void 0,void 0,(function*(){return(yield Promise.all(r.map((r=>O(this,void 0,void 0,(function*(){if(r.headers[t.HeaderKeys.CONTENT_TYPE]===E&&r.response.type===o.ProblemTypes.RESPONSE_TOO_LARGE){const o=Nr(r,e),c=r.headers.location?r.headers.location:a.getLinkHrefTemplated(n,_.BLOCK_DOWNLOAD,{resource:JSON.stringify({component_path:o.component_path})});if(d&&d[o.component_path])return{statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:r.headers["content-type"],[t.HeaderKeys.CONTENT_LENGTH]:r.headers["content-length"],[t.HeaderKeys.CONTENT_ID]:r.headers[t.HeaderKeys.CONTENT_ID]}),responseType:"application/json",response:{href:c},message:"OK"};const h=yield et(F(s),c,void 0,void 0,"defaultbuffer",!0,void 0,i);return Object.assign(h.headers,{[t.HeaderKeys.CONTENT_ID]:r.headers[t.HeaderKeys.CONTENT_ID]}),h}return r})))))).reduce(((t,r)=>{const s=Nr(r,e);try{const e=o._responseToError(r);t[s.component_path]=Object.assign({},s,{response:r,[e?"error":"data"]:e||Lr(r.response,s.responseType||"defaultbuffer",r.headers["content-type"])})}catch(e){t[s.component_path]=Object.assign({},s,{response:r,error:new o.DCXError(o.DCXError.UNEXPECTED,"Error parsing sub-response into requested responseType",e)})}return t}),{})}))}(u.slice(1),f,e,r.links,d,m)),!g)return p;if(200===g.statusCode){p.manifest.data=Lr(g.response,"json"),p.manifest.response=g,X(r)&&"function"==typeof(null===(c=r.current)||void 0===c?void 0:c.parse)&&(r.current.parse(a.arrayBufferToString(g.response)),r.current.versionId=g.headers.version),r.links=ae(g);const t=Y(e);return t&&t.setValueWithAsset(r.links,r),p}if(304===g.statusCode)return p.manifest.response=g,p;if(404===g.statusCode)return p.manifest.error=new o.DCXError(o.DCXError.NO_COMPOSITE,a.arrayBufferToString(g.response)||"Composite missing or deleted",void 0,g),p;if(g.headers[t.HeaderKeys.CONTENT_TYPE]===E&&g.response.type===o.ProblemTypes.RESPONSE_TOO_LARGE){try{const e=g.headers.location?g.headers.location:a.getLinkHrefTemplated(r.links,_.BLOCK_DOWNLOAD,{resource:JSON.stringify({reltype:_.MANIFEST})}),t=yield et(l,e,void 0,void 0,"json",!0,void 0,d);p.manifest.data=t.response,p.manifest.response=t,X(r)&&"function"==typeof(null===(h=r.current)||void 0===h?void 0:h.parse)&&r.current.parse(JSON.stringify(t.response)),r.links=ae(t)}catch(e){p.manifest.error=e instanceof o.DCXError?e:new o.DCXError(o.DCXError.UNEXPECTED,"Error fetching manifest via block download",e)}return p}return p.manifest.error=o._responseToError(g)||new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,g.response.title||"Failed to fetch manifest. Operation failed.",void 0,g),p}))),Promise.resolve({manifest:{},components:{},responses:[]})))}))))}function Nr(e,r){if(!e.headers[t.HeaderKeys.CONTENT_ID])throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Sub-response is missing content-id header",void 0,e);const s=r.find((({href:r})=>r===e.headers[t.HeaderKeys.CONTENT_ID]));if(!s)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Bulk sub-response content-id did not match any bulk request",void 0,e);return s}function Lr(e,t,r){if(!M(e))return e;switch(t){case"text":return a.arrayBufferToString(e);case"json":return JSON.parse(a.arrayBufferToString(e));case"blob":return new Blob([e],{type:r});case"buffer":case"defaultbuffer":return e;case"arraybuffer":return e.buffer}throw new o.DCXError(o.DCXError.INVALID_PARAMS,"requested response type is not supported")}function Mr(e,t,r,s){return vr("getCompositeComponentUrl()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["componentRevision",s,"string",!0]),q(t.links,[_.COMPONENT]),a.getLinkHrefTemplated(t.links,_.COMPONENT,{component_id:r,revision:s})}function Xr(e,r,s,n){return vr("getPresignedUrl()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),Ut(e,r,[_.BLOCK_DOWNLOAD],void 0,n).then((r=>{const o=s?JSON.stringify(s):void 0,i=a.getLinkHrefTemplated(r,_.BLOCK_DOWNLOAD,{resource:o});return(U(e)?e.service:e).invoke(t.HTTPMethods.GET,i,Object.assign({priority:"u=1"},n),void 0,{isStatusValid:z(),responseType:"json",retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:t.HTTPMethods.GET}})})).then((e=>{if("string"!=typeof e.response.href)throw new o.DCXError(o.DCXError.INVALID_DATA,"Direct download URL not found.",void 0,e);return{response:e,result:e.response.href}}))}function Br(e,t,r,s,o){return vr("getCompositeComponentPresignedUrl()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["componentRevision",s,"string"]),Xr(e,t,{reltype:_.COMPONENT,revision:s,component_id:r},o)}function xr(e,t,r,s="defaultbuffer",o,n){return a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentPath",r,"string"],["responseType",s,"string",!0],["additionalHeaders",o,"object",!0]),Ut(e,t,[_.COMPONENT,_.PAGE],void 0,o).then((s=>{if(t.links=s,t.version)return Or(F(e),t,r)})).then((i=>ot(F(e),t,null!=i?i:a.getLinkHrefTemplated(t.links,_.COMPONENT,{component_path:r}),_.COMPONENT,s,void 0,void 0,o,n)))}function jr(e,t,r,s,o="defaultbuffer",n,i){vr("getCompositeComponent()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["componentRevision",s,"string"],["responseType",o,"string",!0],["additionalHeaders",n,"object",!0],["componentSize",i,"number",!0]);const d={};if(!i||i<Ye()){const i=Mr(e,t,r,s);return ot.call(d,e,t,i,_.COMPONENT,o,r,s,n)}return Br(e,t,r,s,n).then((({response:t,result:r})=>et.call(d,e,r,void 0,void 0,o,!0,t.response.size,n)))}function Ur(e,r,s,n,i=1,d,c={}){if(vr("updateCompositeManifest() ",n,d),a.validateParams(["svc",e,"object"],["asset",r,"object"],["manifest",s,["object","string"]],["overwrite",n,"boolean"],["validationLevel",i,"+number"],["etag",d,"string",!0]),i<1)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"ValidationLevel must be >=1");return q(r.links,[_.BULK_REQUEST,_.REPO_METADATA]),Rr(e,r,void 0,c).then((h=>O(this,void 0,void 0,(function*(){const l=Object.assign({},c);n?l[t.HeaderKeys.IF_MATCH]="*":d&&(l[t.HeaderKeys.IF_MATCH]=d);const u=`${g}; validation-level=${i}`;l[t.HeaderKeys.CONTENT_TYPE]=u;const p="string"==typeof s?s:JSON.stringify(s),f=[{method:t.HTTPMethods.PUT,href:h,headers:l,body:p}];if(r.deviceModifyDate){const e=JSON.stringify([{op:"add",path:`/${[t.Properties.REPO_DEVICE_MODIFY_DATE]}`,value:r.deviceModifyDate}]),s={[t.HeaderKeys.CONTENT_TYPE]:A};f.push({method:t.HTTPMethods.PATCH,href:a.getLinkHref(r.links,_.REPO_METADATA),headers:s,body:e})}const{result:m,response:E}=yield _t(e,r,f,void 0,c,!0),{manifestResponse:y,repoMetadataResponse:D}=function(e,r){const s={manifestResponse:{},repoMetadataResponse:{}};return r.forEach((r=>{const n=e.find((e=>e.headers[t.HeaderKeys.CONTENT_ID]===r.href));if(!n)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Bulk sub-response content-id did not match any bulk request",void 0,n);r.href.includes(":repometadata")?s.repoMetadataResponse=n:s.manifestResponse=n})),s}(m,f);if(vr("uCM() status code for manifest response: ",y.statusCode),412===y.statusCode&&n)return vr("uCM() retry 412 without overwrite"),Ur(e,r,s,!1,i,void 0,c);if(409===y.statusCode&&n)return vr("uCM() retry 409 without overwrite"),Ur(e,r,s,!1,i,d,c);if(409===y.statusCode)throw new o.DCXError(o.DCXError.UPDATE_CONFLICT,"Manifest has been changed",void 0,y);if(412===y.statusCode)throw new o.DCXError(o.DCXError.PRECONDITION_FAILED,"Precondition failed",void 0,y);if(400===y.statusCode){const e=o._responseToError(y);throw new o.DCXError(null==e?void 0:e.code,null==e?void 0:e.message,void 0,y)}{const e=z()(y.statusCode,y);if(!0!==e)throw new o.DCXError(e.code||o.DCXError.UNEXPECTED_RESPONSE,e._message||e.message,e.underlyingError,y)}if(vr("uCM() status code for metadata response: ",D.statusCode),r.deviceModifyDate&&200!==D.statusCode&&201!==D.statusCode&&204!==D.statusCode)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected HTTP Response",void 0,D);return y.xhr=E.xhr,y}))))}function Vr(e,t,r,s,n,i,d,c,h,l,u){if(a.validateParams(["service",e,"object"],["asset",t,"object"],["componentId",r,"string"],["contentType",n,"string"],["maybeIsNew",i,"boolean",!0],["size",d,"number",!0],["blockSize",u,"number",!0],["md5",c,"string",!0]),i&&!a.verifyUuid(r))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Component id is not a uuid");return a.verifyUuid(r)||br.warn("Existing component id is not a uuid"),Gt({svc:e,asset:t,dataOrSliceCallback:s,contentType:n,relation:_.COMPONENT,size:d,componentId:r,md5:c,maybeIsNew:i,additionalHeaders:l,progressCb:h,blockSize:u}).then((({response:e,result:t,isBlockUpload:s,asset:o})=>{const i={response:e,result:Object.assign(Object.assign({},t),{id:r,type:n}),isBlockUpload:s,asset:o};return Object.defineProperty(i,"compositeAsset",{get:()=>o}),i}))}const Hr=n.newDebug("dcx:assets:directory"),Fr=n.newDebug("dcx:assets:directory:leaf");class Yr extends yt{constructor(e,r,s){super(e,r,s),this.type=l.Directory,this.children=[],this.children=e[t.Properties.CHILDREN]}getPagedChildren(e,t){return Hr("getPagedChildren()"),this.fetchLinksIfMissing([_.PAGE],t).then((()=>qr(this._svc,this,e,t)))}createAsset(e,t,r,s,o,n,i,a,d){return Hr("createAsset()"),Kr(this._svc,this,e,t,r,s,o,n,i,a,d).then((e=>({result:new yt(e.result,this.serviceConfig),response:e.response})))}copy(e,t,r){return super.copy(e,t,r).then((({response:e,result:t})=>({response:e,result:new Yr(t,this.serviceConfig)})))}}function Wr(e){var r;Fr("directoryTransformer()");const s=le(e,null===(r=e[t.Properties.PAGE])||void 0===r?void 0:r.embed);s.links=a.merge({},e.links,e._links);const o=e.children||e[t.Properties.CHILDREN];return o&&o.length>0?s.children=o.map((e=>le(e))):s.children=[],[s.assetId,s]}function zr(e,r){return Fr("getDirectoryByURL()"),e.invoke(t.HTTPMethods.GET,r,void 0,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function qr(e,t,r={},s){if(Fr("getPagedChildren()"),q(t.links,[_.PAGE]),r&&r.embed&&r.embed.includes(_.REPOSITORY))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Repository Resource embeds on directory listings are not supported");try{return new hr(t.links,e,Wr,"api:primary").getPage(r,s)}catch(e){return h.default.reject(e)}}function Kr(e,r,s,n,i,d,l={},u,p,f,g){Fr("createAsset()"),a.validateParams(["service",e,"object"],["parentDir",r,"object"],["relPath",s,"string"],["createIntermediates",n,"boolean"],["contentType",i,"string"],["respondWith",d,["string","object"],!0],["additionalHeaders",l,"object",!0],["repoMetaPatch",f,"object",!0]);const m=a.isObject(d)?JSON.stringify(d):d;return Ut(e,r,[_.CREATE]).then((E=>{const A=a.getLinkHrefTemplated(E,_.CREATE,{path:s,intermediates:n.toString(),respondWith:m,mode:"id",repoMetaPatch:f}),y=Object.assign({},{[t.HeaderKeys.CONTENT_TYPE]:i},l),D=F(e),C=u?Fe(u,p):void 0,I=C?He(C):0;return u&&je(r,I)?$t({service:D,contentType:i,relation:_.PRIMARY,asset:r,dataOrSliceCallback:u,size:I,relPath:s,createIntermediates:n,respondWith:d,repoMetaPatch:f,additionalHeaders:l,progressCb:g}).then((({result:e,response:t})=>{const r=s.split("/").slice(-1);return{result:a.pruneUndefined(a.mergeDeep({name:r},e)),response:t}})):h.default.resolve().then((()=>O(this,void 0,void 0,(function*(){const h=a.isAnyFunction(u)?yield u(0,I):C;return D.invoke(t.HTTPMethods.POST,A,y,h,{responseType:"json",isStatusValid:z([413]),reuseRequestDesc:{id:"createAsset",method:t.HTTPMethods.POST,href:A,headers:y,progress:g}}).then((h=>{var m;if(413===h.statusCode)return $t({service:D,contentType:i,relation:_.PRIMARY,asset:r,dataOrSliceCallback:u,size:He(Fe(u,p)),relPath:s,createIntermediates:n,respondWith:d,repoMetaPatch:f,additionalHeaders:l,progressCb:g}).catch((e=>{var t;if(e.problemType===o.ProblemTypes.ASSET_NAME_CONFLICT){const r={assetId:null===(t=e.response.response)||void 0===t?void 0:t["repo:assetId"],links:ae(e.response)};return $t({service:D,contentType:i,relation:_.PRIMARY,asset:r,dataOrSliceCallback:u,size:He(Fe(u,p)),relPath:s,createIntermediates:n,respondWith:d,repoMetaPatch:f,additionalHeaders:l,progressCb:g})}throw e})).then((({result:e,response:t})=>{const r=s.split("/")[s.split("/").length-1];return{result:a.pruneUndefined(a.mergeDeep({name:r},e)),response:t}}));const E=s.split("/")[s.split("/").length-1];let A;r.path&&(A=a.appendPathElements(r.path,s));const y=ae(h),C=h.headers;if(null===(m=C[t.HeaderKeys.CONTENT_TYPE])||void 0===m?void 0:m.includes("multipart/mixed")){const e=ct(h)[1];throw 404===e.statusCode?new c.default(o.DCXError.ASSET_NOT_FOUND,"Asset was created successfully but repository metadata could not be found.",void 0,h):403===e.statusCode?new c.default(o.DCXError.FORBIDDEN,"Asset was created successfully but Permission denied for fetching repository metadata.",void 0,h):o.unexpectedResponse("Unexpected Server Response",void 0,h)}const I=a.isObject(h.response)?h.response:{etag:"",md5:""},v=C["asset-id"]||C["x-resource-id"],b=r.repositoryId;let T=I.etag,P=I.md5;null==d&&(T=C.etag,P=C["content-md5"]);const w=a.isObject(h.response)&&d&&(d===_.REPO_METADATA||a.isObject(d)&&d.reltype===_.REPO_METADATA)?le(h.response):{},R=Y(e);return R&&R.setValueWithAsset(y,w),{result:a.pruneUndefined(a.mergeDeep({name:E},w,a.pruneUndefined({links:y,assetId:v,etag:T,md5:P,repositoryId:b,format:i,path:A}))),response:h}}))}))))}))}const Gr=n.newDebug("dcx:assets:discoverable");function $r(e){Gr("discoverableAssetTransformer()");const r=e[t.Properties.EMBEDDED][_.REPO_METADATA],s=le(r,e[t.Properties.EMBEDDED]);return s.links=a.merge({},e.links,r._links),[s.assetId,s]}function Jr(e){Gr("discoverableReposTransformer()");const r=e[t.Properties.EMBEDDED][_.PRIMARY],s=ue(r);return s.links=r._links,[s.repositoryId,s]}const Zr=n.newDebug("dcx:assets:factory");function Qr(e,t){Zr("hydrateAsset()"),a.validateParams(["asset",e,"object"],["svc",t,"object"]);const r=e.format||"",s=r.endsWith("+dcx")?l.Composite:r===f?l.Directory:r.split("/").length>1?l.File:l.Asset;switch(s){case l.Directory:return e.type===s&&e instanceof Yr?e:new Yr(e,t);case l.Composite:return e.type===s&&e instanceof Tr?e:new Tr(e,t);case l.File:return e.type===s&&e instanceof Ar?e:new Ar(e,t);case l.Asset:return e.type===s&&e instanceof yt?e:new yt(e,t);default:return new yt(e,t)}}const es=n.newDebug("dcx:assets:indexdocument");function ts(e){es("deserializeIndexDocument()");const r=e.children.map((e=>{const r=le(e[t.Properties.EMBEDDED][_.REPO_METADATA]),s=ue(e[t.Properties.EMBEDDED][_.REPOSITORY]);return r.embedded={RepositoryResource:s},r}));return{regions:e[t.Properties.REPO_REGIONS],assignedDirectories:r,links:e._links}}const rs=1e5;class ss{constructor(e=1e5,t="SESSION"){if(this.values={},this.maxEntries=rs,this.promiseToResolveMap=new Map,e<=0)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Cache Max enteries must be great than 0.");this.maxEntries=e,this.defaultSessionKey=t}clear(){this.promiseToResolveMap.forEach((e=>{e.call(void 0)}));for(const e in this.values)this.values[e].clear();this.values={}}getKey(e){if(e.assetId||"object"!=typeof e)return e.assetId}getValueWithAsset(e){if(!e.assetId&&"object"==typeof e)return;const t=this.getKey(e);return t?this.get(t,e.repositoryId):void 0}setPending(e,t=this.defaultSessionKey){let r;this.values[t]||(this.values[t]=new Map);const s=this.values[t].get(e);if(s&&s instanceof Promise)return this.promiseToResolveMap.get(s);const o=new Promise((e=>{r=e}));return this.values[t].set(e,o),this.promiseToResolveMap.set(o,r),o.then((()=>this.promiseToResolveMap.delete(o))).catch((()=>this.promiseToResolveMap.delete(o))),r}get(e,t=this.defaultSessionKey){if(this.values[t]&&t in this.values)return this.values[t].get(e)}setValueWithAsset(e,t){if(!e)return;const r=this.getKey(t);if(r){const s=t.repositoryId||this.defaultSessionKey;this.set(e,r,s)}}set(e,t,r=this.defaultSessionKey){if(this.values[r]){if(this.values[r]&&this.values[r].get(t)instanceof Promise){const s=this.values[r].get(t),o=this.promiseToResolveMap.get(s);this.promiseToResolveMap.delete(s),o&&o(e)}}else this.values[r]=new Map;if(this.values[r].size>=this.maxEntries){const e=this.values[r].keys().next().value;this.values[r].delete(e)}this.values[r].set(t,Promise.resolve(e))}delete(e,t=this.defaultSessionKey){this.values[t]&&this.values[t].delete(e)}deleteWithAsset(e){const t=this.getKey(e);t&&this.delete(t,e.repositoryId)}}var os;t.RenditionType=void 0,(os=t.RenditionType||(t.RenditionType={})).IMAGE_JPG="image/jpg",os.IMAGE_PNG="image/png",os.IMAGE_GIF="image/gif",os.VIDEO_MP4="video/mp4",os.VIDEO_METADATA="application/vnd.adobe.ccv.videometadata";const ns=n.newDebug("dcx:assets:versionset"),is=n.newDebug("dcx:assets:versionset:leaf");Object.defineProperty(t,"ProblemTypes",{enumerable:!0,get:function(){return o.ProblemTypes}}),t.ACLPolicyMediaType="application/vnd.adobecloud.accesscontrolpolicy+json",t.Asset=yt,t.AssetFactory=class{constructor(e){this._svc=e}hydrate(e){return Qr(e,this._svc)}},t.AssetTypes=l,t.BlockTransferMediaType=y,t.BlockUpload=qt,t.COPY_RESOURCES_RESOURCE_LIMIT=30,t.Composite=Tr,t.DEFAULT_BLOCK_DOWNLOAD_THRESHOLD=Xe,t.DEFAULT_BLOCK_UPLOAD_THRESHOLD=Me,t.DEFAULT_CACHE_MAX_ENTRIES=rs,t.DEFAULT_MAX_CONCURRENT_REQUESTS=4,t.DEFAULT_STRING_LENGTH_CHECK=Be,t.Directory=Yr,t.DirectoryMediaType=f,t.File=Ar,t.GenericCache=ss,t.JSONLDMediaType="application/ld+json",t.JSONMediaType=m,t.JSONPatchMediaType=A,t.JSONProblemMediaType=E,t.LinkRelation=_,t.MAX_CACHE_PERIOD_MS=2592e6,t.ManifestMediaType=g,t.OperationDocumentBuilder=be,t.OperationDocumentMediaType=D,t.PageResource=hr,t.RepositoryLinksCache=class extends ss{constructor(e=1e5,t=2592e6){super(e,"SESSION"),this.timestampsOnLinkCreation=0,this.maxCachePeriodMS=0,this.maxCachePeriodMS=t}isLinkExpired(){return this.maxCachePeriodMS<Date.now()-this.timestampsOnLinkCreation}setIndexLinks(e){this.set(e,"INDEX","SESSION"),this.timestampsOnLinkCreation=Date.now()}getIndexLinks(){if(!this.isLinkExpired())return this.get("INDEX","SESSION")}setIndexRepository(e){this.indexRepository=e}getIndexRepository(){return this.indexRepository}setRepositoryLinks(e){this.set(e,"/Repositories","SESSION"),this.timestampsOnLinkCreation=Date.now()}getRepositoryLinks(){if(!this.isLinkExpired())return this.get("/Repositories","SESSION")}},t.STREAMABLE_RESPONSE_TYPES=w,t.Version=pr,t.VersionSet=class{constructor(e,r,s){this._svc=r,this.versionCount=e.versionCount||e[t.VersionProperties.TOTAL_CHILDREN],this.repositoryId=e.repositoryId||e[t.Properties.REPO_REPOSITORY_ID],this.assetId=e.assetId||e[t.Properties.REPO_ASSET_ID],this.versions=[];for(const s in e.versions||e[t.Properties.CHILDREN])this.versions.push(new pr(e.versions&&e.versions[s]?e.versions[s]:e[t.Properties.CHILDREN][s],r));this.links=a.merge({},e.links,e._links,s)}versionByVersionId(e){return ns("versionByVersionId()"),this.versions.find((t=>t.version===e))}versionsByLabel(e){return ns("versionsByLabel()"),this.versions.filter((t=>!(!t.milestone||t.milestone.label!==e)))}},t._copyResources=Ne,t._getComponentPathUrl=Or,t._getUrl=kr,t._parseUploadableData=Fe,t.adobeVersionTransformer=_r,t.assertLinksContain=q,t.assertLinksContainAny=K,t.assertValidBulkRequest=pt,t.assetTransformer=function(e){At("assetTransformer()");const t=le(e);return t.links=a.merge({},e.links,e._links),[t.assetId,t]},t.blockTransferManager=Jt,t.bodyToUint8Array=dt,t.buildRangeHeader=rt,t.checkACLPrivilege=Xt,t.constructMultipartRequestBody=at,t.constructServiceEndpoint=W,t.convertToACPRepoMetadataResource=function(e){he("convertToACPRepoMetadataResource()");const r={};return r[t.Properties.REPO_REPOSITORY_ID]=e[t.Properties.REPO_REPOSITORY_ID]||e.repositoryId,r[t.Properties.REPO_ASSET_ID]=e[t.Properties.REPO_ASSET_ID]||e.assetId,r[t.Properties.REPO_NAME]=e[t.Properties.REPO_NAME]||e.name,r[t.Properties.REPO_SIZE]=null!=e[t.Properties.REPO_SIZE]?e[t.Properties.REPO_SIZE]:e.size,r[t.Properties.REPO_PATH]=e[t.Properties.REPO_PATH]||e.path,r[t.Properties.REPO_ASSET_CLASS]=e[t.Properties.REPO_ASSET_CLASS]||e.etag,r[t.Properties.REPO_ETAG]=e[t.Properties.REPO_ETAG]||e.etag,r[t.Properties.REPO_VERSION]=e[t.Properties.REPO_VERSION]||e.version,r[t.Properties.DC_FORMAT]=e[t.Properties.DC_FORMAT]||e.format,r[t.Properties.REPO_CREATE_DATE]=e[t.Properties.REPO_CREATE_DATE]||e.createDate,r[t.Properties.REPO_MODIFY_DATE]=e[t.Properties.REPO_MODIFY_DATE]||e.modifyDate||e.modifiedDate,r[t.Properties.REPO_DISCARD_DATE]=e[t.Properties.REPO_DISCARD_DATE]||e.discardDate,r[t.Properties.REPO_CREATED_BY]=e[t.Properties.REPO_CREATED_BY]||e.createdBy,r[t.Properties.REPO_MODIFIED_BY]=e[t.Properties.REPO_MODIFIED_BY]||e.modifiedBy,r[t.Properties.REPO_DISCARDED_BY]=e[t.Properties.REPO_DISCARDED_BY]||e.discardedBy,r[t.Properties.REPO_DEVICE_CREATE_DATE]=e[t.Properties.REPO_DEVICE_CREATE_DATE]||e.deviceCreateDate,r[t.Properties.REPO_DEVICE_MODIFY_DATE]=e[t.Properties.REPO_DEVICE_MODIFY_DATE]||e.deviceModifyDate,r[t.Properties.REPO_DEFAULT_SCHEDULED_DELETION_DURATION]=e[t.Properties.REPO_DEFAULT_SCHEDULED_DELETION_DURATION]||e.defaultScheduledDeletionDuration,r[t.Properties.REPO_SCHEDULED_DELETION_DATE]=e[t.Properties.REPO_SCHEDULED_DELETION_DATE]||e.scheduledDeletionDate,r[t.Properties.REPO_BASE_ASSET_ID]=e[t.Properties.REPO_BASE_ASSET_ID]||e.baseAssetId,r[t.Properties.REPO_STATE]=e[t.Properties.REPO_STATE]||e.state,r[t.Properties.LINKS]=e[t.Properties.LINKS]||e.links,a.pruneUndefined(r)},t.copyAsset=fe,t.copyAssetResources=function(e,t,r,s,o,n,i){return Ne(e,t,r,s,o,n,i)},t.copyResources=function(e,t,r,s,o,n,i){return pe("copyResource()"),Ne(e,t,r,s,o,n,i).then((e=>e.response)).then(Oe)},t.createAsset=Kr,t.defaultBufferResponseType=Zt,t.deleteACLPolicy=xt,t.deleteAsset=Ae,t.deserializeAsset=le,t.deserializeIndexDocument=ts,t.deserializeRepository=ue,t.deserializeUploadComponentRecord=We,t.deserializeVersion=gr,t.deserializeVersionSet=function(e){is("deserializeVersionSet()");const r={versionCount:e[t.VersionProperties.TOTAL_CHILDREN],repositoryId:e[t.VersionProperties.REPO_ID],assetId:e[t.Properties.REPO_ASSET_ID],links:{},versions:[]},s=e.children||e[t.Properties.CHILDREN];return s&&s.length>0&&(r.versions=s.map((e=>gr(e)))),r.links=e._links,r},t.directoryTransformer=Wr,t.discardAsset=Ee,t.discoverableAssetTransformer=$r,t.discoverableReposTransformer=Jr,t.doBatchOperation=function(e,t,r,s){return ve(e,t,r,s).then(Ce)},t.doBlockDownload=ar,t.doLinksContain=$,t.doOperation=ve,t.doesAssetContainLinks=J,t.fetchLinksForAsset=bt,t.fetchLinksForAssetWithResponse=Tt,t.fetchLinksIfMissing=Ut,t.getACLPolicy=Mt,t.getAppMetadata=kt,t.getBaseDirectoryMetadata=wt,t.getBlockDownloadThreshold=Ye,t.getCompositeComponent=jr,t.getCompositeComponentByPath=xr,t.getCompositeComponentPresignedUrl=Br,t.getCompositeComponentUrl=Mr,t.getCompositeComponentsUrlsForUpload=function(e,r,s,n){return Ut(e,r,[_.COMPONENT,_.BLOCK_UPLOAD_INIT],void 0,n).then((i=>{var d;const c=F(e);null===(d=Y(e))||void 0===d||d.setValueWithAsset(i,r),r.links=Object.assign(Object.assign({},r.links),i);const l=a.normalizeHeaders(a.pruneUndefined(Object.assign(Object.assign({},n),{[t.HeaderKeys.AUTHORIZATION]:c.authProvider.authToken,[t.HeaderKeys.X_API_KEY]:c.authProvider.apiKey})));return Promise.all(s.map((e=>je(r,e.size)?function(e,r,s,n){return Kt(e,r,a.pruneUndefined({"repo:reltype":_.COMPONENT,"repo:size":s.size,"dc:format":s.contentType,component_id:s.componentId}),n).then((e=>{if(200!==e.response.statusCode)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from block upload init",e.response);const r=e.result;return{blockSize:r[t.BlockTransferProperties.REPO_BLOCK_SIZE],uploadRequestParameters:r[t.Properties.LINKS][_.BLOCK_TRANSFER].map((({href:e})=>({href:e,method:t.HTTPMethods.PUT}))),finalizeRequestParameters:{href:a.getLinkHrefTemplated(r[t.Properties.LINKS],_.BLOCK_FINALIZE,{}),method:t.HTTPMethods.POST,headers:n,body:`${JSON.stringify(r)}`}}})).catch((e=>{throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from block upload init",e)}))}(c,r,e,l):function(e,r,s,o){return h.default.resolve({blockSize:s.size,uploadRequestParameters:[{href:Mr(e,r,s.componentId),method:t.HTTPMethods.PUT,headers:o}]})}(c,r,e,l))))}))},t.getCompositeManifest=wr,t.getCompositeManifestUrl=Rr,t.getDataLength=He,t.getDirectory=function(e,t){return Fr("directoryTransformer()"),Ut(e,t,[_.PRIMARY]).then((t=>zr(F(e),a.getLinkHref(t,_.PRIMARY))))},t.getDirectoryByURL=zr,t.getDiscoverableAssets=function(e,t={},r){Gr("getDiscoverableAssets()"),a.validateParams(["svc",e,"object"],["pageOpts",t,"object"]);const s=F(e);return ie(e,r).then((e=>new hr(e.assetLinks,s,$r,"api:primary").getPage(t,r))).then((e=>({result:e.response.response,paged:e.paged,response:e.response})))},t.getDiscoverableRepos=function(e,r={},s){Gr("getDiscoverableRepos()"),a.validateParams(["svc",e,"object"],["pageOpts",r,"object"]);const o=F(e),n=W("/repositories",o);return h.default.resolve(void 0).then((()=>O(this,void 0,void 0,(function*(){const i=Y(e);let a;return i&&(a=yield i.getRepositoryLinks()),a||(a=ae(yield o.invoke(t.HTTPMethods.HEAD,n,s,void 0,{isStatusValid:z()}))),i&&i.setRepositoryLinks(a),new hr(a,o,Jr).getPage(r,s)})))).then((e=>({result:e.response.response,paged:e.paged,response:e.response})))},t.getEffectivePrivileges=Lt,t.getEmbeddedMetadata=Qt,t.getHTTPResource=se,t.getIndexDocument=function(e,r){es("getIndexDocument()"),a.validateParams(["svc",e,"object"]);const s=F(e),o=W("/index",s);return s.invoke(t.HTTPMethods.GET,o,r,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:ts(e.response),response:e.response})))},t.getIndexLinks=ne,t.getIndexRepository=ie,t.getLinksForAsset=Pt,t.getLinksFromCache=Ft,t.getManifestAndComponentsByPath=Sr,t.getOpsHref=ce,t.getPagedChildren=qr,t.getPagedVersions=Cr,t.getPresignedUrl=Xr,t.getPrimaryResource=Dt,t.getRendition=ir,t.getRepoMetadata=function(e,r,s){At("getRepoMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.REPO_METADATA]);const o=a.getLinkHref(r.links,_.REPO_METADATA);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:z()}).then((e=>{const r=ae(e),s=e.response;return s[t.Properties.LINKS]=a.merge({},s[t.Properties.LINKS],r),{result:s,response:e}}))},t.getRepositoryResource=Rt,t.getReposityLinksCache=Y,t.getResolveByIdHref=function(e){if(a.isObject(this)){if("string"==typeof this.resolveByIdHref)return h.default.resolve(this.resolveByIdHref);if(a.isFunction(this.resolveByIdHref))return h.default.resolve(this.resolveByIdHref())}return ne(e).then((e=>{try{return a.getLinkHref(e,_.RESOLVE_BY_ID)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ResolveByID href.",e)}}))},t.getResolveByPathHref=function(e){if(a.isObject(this)){if("string"==typeof this.resolveByPathHref)return h.default.resolve(this.resolveByPathHref);if(a.isFunction(this.resolveByPathHref))return h.default.resolve(this.resolveByPathHref())}return ne(e).then((e=>{try{return a.getLinkHref(e,_.RESOLVE_BY_PATH)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ResolveByPath href.",e)}}))},t.getResolveLinkForAsset=It,t.getService=F,t.getVersionResource=Dr,t.headAppMetadata=Ot,t.headCompositeManifest=Pr,t.headHTTPResource=re,t.headPrimaryResource=Ct,t.hydrateAsset=Qr,t.isAdobeCopyResourcesDocument=e=>"copy_resources"===e.op,t.isAdobeDCXBranchLike=function(e){return a.isObject(e)&&(["compositeId","compositeAssetId","compositeRepositoryId"].some((t=>t in e))||a.isObject(e._core))},t.isAdobeDCXCompositeLike=X,t.isAdobeResponseLike=S,t.isBlob=B,t.isBufferLike=M,t.isComponentResourceDesignator=function(e){return a.isObject(e)&&"component_id"in e},t.isHttpService=j,t.isMinimalAdobeAsset=function(e){return a.isObject(e)&&(a.isObject(e.links)||"string"==typeof e.repositoryId&&("string"==typeof e.path||"string"==typeof e.assetId))},t.isRepoResponseLike=N,t.isRepoResponseResultLike=L,t.isResolvableAsset=x,t.isServiceConfig=U,t.isTransferDocument=V,t.maybeGetBlockTransfer=ze,t.moveAsset=me,t.newBlockDownload=Qe,t.newOperationDocBuilder=Te,t.normalizeCopyResourcesDesignator=e=>{if((e=>e.hasOwnProperty("source")&&e.hasOwnProperty("target"))(e))return{source:ge(e.source),target:ge(e.target)};const t=ge(e);return{source:t,target:t}},t.packageAssets=De,t.parseHttpResponseContent=ut,t.parseLinkString=de,t.parseLinksFromResponseHeader=ae,t.parseMultipartResponseParts=ct,t.patchACLPolicy=Bt,t.patchAppMetadata=Nt,t.patchEmbeddedMetadata=tr,t.patchVersions=yr,t.pauseBlockTransfer=function(e,t){return O(this,void 0,void 0,(function*(){const r=yield ze(e);if(r)return t&&r.on("stateChanged",t),yield r.pause(),r}))},t.performBulkRequest=_t,t.putAppMetadata=St,t.putCompositeComponent=Vr,t.putEmbeddedMetadata=er,t.resolveAsset=vt,t.restoreAsset=ye,t.setBlockDownloadThreshold=e=>{if(Number.isNaN(e)||"number"!=typeof e||e<=0)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Invalid block download threshold, must be positive integer");xe=e},t.shouldUseBlockTransferForDownload=(e,t=52428800)=>((e,t)=>e>=t)(e,t),t.shouldUseBlockTransferForUpload=je,t.streamToGetSliceCallback=function(e,t,r,s=4){var n;const i=null!==(n=Ve(r))&&void 0!==n?n:Me,d=i*s,c=new ArrayBuffer(d),h=new Uint8Array(c);let l=0;const u=a.isWHATWGReadableStream(e)?e.pipeThrough(function(e,t){let r;const s=new ByteLengthQueuingStrategy({highWaterMark:e*t});return{writable:new WritableStream({write(t){if(Le("Chunk Received:",t.byteLength),t.byteLength<e)r.enqueue(t);else{const s=Math.ceil(t.byteLength/e),o=[...Array(s).keys()].map((r=>t.subarray(r*e,Math.min((r+1)*e,t.byteLength))));for(const e of o)Le("enqueue smaller chunk:",e.byteLength),r.enqueue(e)}},close(){r.close()}},s),readable:new ReadableStream({start(e){r=e}},s)}}(i,s)).getReader():e;let p=!1,_=Promise.resolve();return function(e,t){return O(this,void 0,void 0,(function*(){if(p)return new Uint8Array([]);try{let r;const s=new Promise(((o,n)=>O(this,void 0,void 0,(function*(){function i(r){const s=l%d;if(r.byteLength+s>d){const e=d-s;h.set(r.subarray(0,e),s),h.set(r.subarray(e),0)}else h.set(r,s);if(l+=r.byteLength,Le(`chunk ${e}-${t} progress: ${l-e}/${t-e}`),l>=t){const r=h.subarray(e%d,t%d||t);Le(`resolving slice - start:  ${e}, end: ${t}, length: ${r.byteLength}`),o(r)}}if(a.isNodeReadableStream(u)){function c(){return O(this,void 0,void 0,(function*(){const e=u.read(t-l);null!==e&&i(e)}))}const f=()=>{p=!0,o(h.subarray(e%d,l%d||d))},g=()=>{u.off("readable",c),u.off("end",f),u.off("error",n)},m=()=>{u.on("readable",c),u.on("end",f),u.on("error",n)};r=()=>O(this,void 0,void 0,(function*(){m(),yield c(),s.finally(g)}))}else{function E(){return O(this,void 0,void 0,(function*(){const{value:r,done:s}=yield u.read();return s?(p=!0,Le("End of stream",e,l),o(h.subarray(e%d,l%d||d))):(i(r),l<=t?yield E():void 0)}))}r=()=>(Le("starting read for slice",e,t),E())}_=_.then((()=>O(this,void 0,void 0,(function*(){r(),yield s}))))}))));return s}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,e.message,e)}}))}},t.updateCompositeManifest=Ur,t.updatePrimaryResource=dr,t.useLinkOrResolveResource=jt,t.versionTransformer=fr,t.waitForBlockDownloadToStart=function(e){return O(this,void 0,void 0,(function*(){yield ze(e)}))}},935341:(e,t,r)=>{var s=r(640430).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(45276),n=r(200334),i=r(310799),a=r(499164);function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=d(o),h=d(i);const l={Asset:"asset",Composite:"composite",File:"file",Directory:"directory",Version:"version"};var u,p;t.HeaderKeys=void 0,(u=t.HeaderKeys||(t.HeaderKeys={})).CONTENT_ID="content-id",u.CONTENT_LENGTH="content-length",u.CONTENT_RANGE="content-range",u.CONTENT_TYPE="content-type",u.IF_MATCH="if-match",u.IF_NONE_MATCH="if-none-match",u.AUTHORIZATION="authorization",u.X_API_KEY="x-api-key",t.HTTPMethods=void 0,(p=t.HTTPMethods||(t.HTTPMethods={})).GET="GET",p.PUT="PUT",p.PATCH="PATCH",p.HEAD="HEAD",p.POST="POST",p.DELETE="DELETE";const _={ACCESS_CHECK:"http://ns.adobe.com/adobecloud/rel/ac/check",ACL_POLICY:"http://ns.adobe.com/adobecloud/rel/ac/policy",ANNOTATIONS:"http://ns.adobe.com/adobecloud/rel/annotations",APP_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/application",BASE_DIRECTORY:"http://ns.adobe.com/adobecloud/rel/directory/base",BLOCK_DOWNLOAD:"http://ns.adobe.com/adobecloud/rel/download",BLOCK_EXTEND:"http://ns.adobe.com/adobecloud/rel/block/extend",BLOCK_FINALIZE:"http://ns.adobe.com/adobecloud/rel/block/finalize",BLOCK_TRANSFER:"http://ns.adobe.com/adobecloud/rel/block/transfer",BLOCK_UPLOAD_INIT:"http://ns.adobe.com/adobecloud/rel/block/init",BULK_REQUEST:"http://ns.adobe.com/adobecloud/rel/bulk",COMPONENT:"http://ns.adobe.com/adobecloud/rel/component",CREATE:"http://ns.adobe.com/adobecloud/rel/create",DESCRIBED_BY:"describedBy",DIRECTORY:"http://ns.adobe.com/adobecloud/rel/directory",DISCARD:"http://ns.adobe.com/adobecloud/rel/discard",EFFECTIVE_PRIVILAGES:"http://ns.adobe.com/adobecloud/rel/ac/effective",EMBEDDED_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/embedded",ID:"http://ns.adobe.com/adobecloud/rel/id",MANIFEST:"http://ns.adobe.com/adobecloud/rel/manifest",PAGE:"http://ns.adobe.com/adobecloud/rel/page",PATH:"http://ns.adobe.com/adobecloud/rel/path",PRIMARY:"http://ns.adobe.com/adobecloud/rel/primary",RENDITION:"http://ns.adobe.com/adobecloud/rel/rendition",REPO_METADATA:"http://ns.adobe.com/adobecloud/rel/metadata/repository",REPO_OPS:"http://ns.adobe.com/adobecloud/rel/ops",REPOSITORY:"http://ns.adobe.com/adobecloud/rel/repository",RESOLVE_BY_ID:"http://ns.adobe.com/adobecloud/rel/resolve/id",RESOLVE_BY_PATH:"http://ns.adobe.com/adobecloud/rel/resolve/path",RESTORE:"http://ns.adobe.com/adobecloud/rel/restore",VERSION_HISTORY:"version-history"},f="application/vnd.adobecloud.directory+json",g="application/vnd.adobe.dcx-manifest+json",m="application/json",E="application/problem+json",A="application/json-patch+json",y="application/vnd.adobecloud.bulk-transfer+json",D="application/vnd.adobe.asset-operation+json";var C,I,v,b,T,P;t.Properties=void 0,(C=t.Properties||(t.Properties={})).DC_FORMAT="dc:format",C.DC_TITLE="dc:title",C.LINKS="_links",C.PAGE="_page",C.CHILDREN="children",C.EMBEDDED="_embedded",C.REPO_ASSET_ID="repo:assetId",C.REPO_REPOSITORY_ID="repo:repositoryId",C.REPO_REPOSITORY_TYPE="repo:repositoryType",C.REPO_BASE_ASSET_ID="repo:baseAssetId",C.REPO_SIZE="repo:size",C.REPO_NAME="repo:name",C.REPO_PATH="repo:path",C.REPO_ASSET_CLASS="repo:assetClass",C.REPO_CREATE_DATE="repo:createDate",C.REPO_MODIFY_DATE="repo:modifyDate",C.REPO_DISCARD_DATE="repo:discardDate",C.REPO_ETAG="repo:etag",C.REPO_CREATED_BY="repo:createdBy",C.REPO_MODIFIED_BY="repo:modifiedBy",C.REPO_DISCARDED_BY="repo:discardedBy",C.REPO_DEVICE_CREATE_DATE="storage:deviceCreateDate",C.REPO_DEVICE_MODIFY_DATE="storage:deviceModifyDate",C.REPO_DEFAULT_SCHEDULED_DELETION_DURATION="repo:defaultScheduledDeletionDuration",C.REPO_SCHEDULED_DELETION_DATE="repo:scheduledDeletionDate",C.REPO_VERSION="repo:version",C.REPO_STATE="repo:state",C.REPO_AVAILABLE_REGIONS="repo:availableRegions",C.REPO_REGIONS="repo:regions",C.REPO_OWNER="repo:owner",C.REPO_OWNER_ID="id",C.REPO_OWNER_TYPE="type",C.STORAGE_ASSIGNEE="storage:assignee",C.STORAGE_ASSIGNEE_ID="id",C.STORAGE_ASSIGNEE_TYPE="type",C.IMAGE_LENGTH="tiff:imageLength",C.IMAGE_WIDTH="tiff:imageWidth",C.NUM_OF_PAGES="xmpTPg:NPages",C.PAGE_START="start",C.PAGE_ORDER_BY="orderBy",C.PAGE_NEXT="next",C.PAGE_COUNT="count",C.PAGE_LIMIT="limit",t.VersionProperties=void 0,(I=t.VersionProperties||(t.VersionProperties={})).REPO_ID="repo:id",I.CREATED="created",I.CREATED_BY="created_by",I.MILESTONE="milestone",I.VERSION="version",I.TOTAL_CHILDREN="total_children",t.PolicyProperties=void 0,(v=t.PolicyProperties||(t.PolicyProperties={})).REPO_ACL="repo:acl",v.REPO_PRINCIPLE="repo:principal",v.REPO_MODIFIER="repo:modifier",v.REPO_PRIVILEGES="repo:privileges",v.REPO_RELATIONS="repo:relations",v.REPO_INHERITANCE="repo:inheritance",t.PolicyPrincipalProperties=void 0,(b=t.PolicyPrincipalProperties||(t.PolicyPrincipalProperties={})).XDM_PROVIDER="xdm:provider",b.ID="@id",b.TYPE="@type",t.XDMProviderProperties=void 0,(t.XDMProviderProperties||(t.XDMProviderProperties={})).ID="@id",t.EmbeddedMetadataMediaTypes=void 0,(T=t.EmbeddedMetadataMediaTypes||(t.EmbeddedMetadataMediaTypes={})).XML="application/rdf+xml",T.JSON="application/ld+json",t.BlockTransferProperties=void 0,(P=t.BlockTransferProperties||(t.BlockTransferProperties={})).REPO_SIZE="repo:size",P.REPO_BLOCK_SIZE="repo:blocksize",P.REPO_REL_TYPE="repo:reltype",P.COMPONENT_ID="component_id",P.DC_FORMAT="dc:format",P.REPO_MD5="repo:md5",P.REPO_EXPIRES="repo:expires",P.REPO_IF_MATCH="repo:if-match",P.MAX_SINGLE_TRANSFER_SIZE="repo:maxSingleTransferSize",P.REPO_MIN_BLOCK_TRANSFER_SIZE="repo:minBlockTransferSize";const w=["buffer","arraybuffer","string","text","blob","json","stream","defaultbuffer"];function R(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(r[s[o]]=e[s[o]])}return r}function O(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}function k(e){return this instanceof k?(this.v=e,this):new k(e)}function S(e){return a.isObject(e)&&["headers","responseType","statusCode","xhr"].every((t=>t in e))}function N(e){return a.isObject(e)&&S(e.response)}function L(e){return a.isObject(e)&&N(e)&&"result"in e}function M(e){return a.isObject(e)&&a.isAnyFunction(e.slice)}function X(e){return a.isObject(e)&&"resolvePullWithBranch"in e}function B(e){return"undefined"!=typeof Blob&&e instanceof Blob}function x(e){return a.isObject(e)&&("string"==typeof e.repositoryId&&"string"==typeof e.path||"string"==typeof e.assetId)}function j(e){return a.isObject(e)&&("AdobeHTTPService"===e.name||a.isAnyFunction(e.invoke))}function U(e){return a.isObject(e)&&j(e.service)}function V(e){if(!a.isObject(e))return!1;const r=e[t.Properties.LINKS];return!!a.isObject(r)&&!!(r[_.BLOCK_TRANSFER]&&r[_.BLOCK_EXTEND]&&r[_.BLOCK_FINALIZE])}const H=n.newDebug("dcx:assets:service"),F=e=>U(e)?e.service:e,Y=e=>U(e)?e.cache:void 0;function W(e,t){H("constructServiceEndpoint()",e);const r=t._repoAPIBaseUrl;return r&&(e=`${r.endsWith("/")?r.substr(0,r.length-1):r}${e}`),H("cSE()",e),e}const z=(e,t,r)=>{if(null==t&&null==r&&null==e)return o._defaultStatusValidator;const s=r||{},n=t||{},i=e||[];return(e,t)=>{var r,a;if(!e||!t)return new c.default(o.ErrorCodes.NETWORK_ERROR,"Invalid or missing status code",void 0,t);if(i.includes(e))return!0;const d=n[e]||(null===(r=o.HTTP_STATUS_ERROR_MAP.get(e))||void 0===r?void 0:r.message)||"Unexpected response",h=s[e]||(null===(a=o.HTTP_STATUS_ERROR_MAP.get(e))||void 0===a?void 0:a.code),l=o._defaultStatusValidator(e,t);return!0===l&&null==h||(o.isAdobeDCXError(l)?l:!!h&&new c.default(h,d,void 0,t))}},q=(e,t=[],r,s)=>{if(!a.isObject(e))throw new c.default(r||c.default.INVALID_PARAMS,s||"Missing or invalid links on Asset");t.map((t=>{if(!(t in e)||!a.isObject(e[t]))throw new c.default(r||c.default.INVALID_PARAMS,s||`Missing required link: ${t}`)}))},K=(e={},t=[])=>{if(0!==t.length){for(let r=0;r<t.length;r++){const s=t[r];if(s in e&&a.isObject(e[s]))return s}throw new c.default(c.default.INVALID_PARAMS,`Missing links, one required: ${t.join(", ")}`)}},G=(e,t,r,s)=>{const o=a.getLinkProperty(e,t,r);if(!o)throw new c.default(c.default.INVALID_DATA,`Missing ${r} param on Link`);if(o!==s)throw new c.default(c.default.INVALID_DATA,`Invalid ${r} param on Link, expected ${s}`)},$=(e,t=[])=>{try{q(e,t)}catch(e){return!1}return!0},J=(e,t=[])=>!!a.isObject(e)&&$(e.links||e._links,t);function Z(e){if(!x(e))throw new c.default(c.default.INVALID_PARAMS,"Asset must contain links or repositoryId + path or assetId to be resolved.")}function Q(e,t,r){if(!a.isObject(e))throw new c.default(c.default.INVALID_PARAMS,`Invalid parameter. Expected object, encountered "${null===e?"null":typeof e}".`);if(!(t in e))throw new c.default(c.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing key "${String(t)}".`);if(r)try{a.validateParam(t,e[t],r)}catch(s){throw new c.default(c.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing key "${String(t)}" with type "${r}", encountered type "${typeof e[t]}".`)}}function ee(e,t,r){if(!(t.length<1)){for(const s of t)try{return void Q(e,s,r)}catch(e){}throw new c.default(c.default.INVALID_PARAMS,`Invalid parameter object. Expected object containing one of [${t.join(", ")}]`+(r?` with type ${r}, encountered types [${t.map((t=>typeof e[t])).join(", ")}].`:"."))}}const te=n.newDebug("dcx:assets:util:http");function re(e,r,s){return te("headHTTPResource()"),F(e).invoke(t.HTTPMethods.HEAD,r,s,void 0,{isStatusValid:z()})}function se(e,r,s,o){return F(e).invoke(t.HTTPMethods.GET,r,s,void 0,{isStatusValid:z(),responseType:o})}const oe=n.newDebug("dcx:assets:util:link");function ne(e,t){oe("getIndexLinks()");const r=F(e),s=Y(e);if(s){const e=s.getIndexLinks();if(e)return h.default.resolve(e);s.setPending("INDEX")}return re(r,W("/",r),t).then((e=>ae(e))).then((e=>(s&&s.setIndexLinks(e),e))).catch((e=>{throw s&&s.delete("INDEX"),e}))}function ie(e,r){oe("getIndexDocument()");const s=F(e),o=Y(e);if(o){const e=o.getIndexRepository();if(e)return h.default.resolve(e)}const n=W("/",s);return s.invoke(t.HTTPMethods.GET,n,r,void 0,{responseType:"json",isStatusValid:z()}).then((e=>{const r=ae(e),s=e.response,n={};for(const e in s.children){const r=s.children[e],o=r[t.Properties.LINKS];switch(r[t.Properties.REPO_PATH]){case"/Index.json":n.indexLinks=o;break;case"/Assets.json":n.assetLinks=o;break;case"/Repositories.json":n.repositoryLinks=o}}return o&&(o.setIndexLinks(r),o.setIndexRepository(n)),n}))}function ae(e){if(!e.headers||!e.headers.link)throw new o.DCXError(o.DCXError.INVALID_DATA,"Failed to parse, missing link header");return de(e.headers.link)}function de(e){try{const r=a.parse(e),s={};for(const e in r.refs){const o=r.refs[e],{rel:n,uri:i,templated:d,type:c,width:h,height:l}=o,u=R(o,["rel","uri","templated","type","width","height"]),p=a.pruneUndefined({href:i,templated:d?"true"===d:void 0,type:c,width:h,height:l,[t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE]:u[t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE.toLowerCase()],[t.BlockTransferProperties.REPO_MIN_BLOCK_TRANSFER_SIZE]:u[t.BlockTransferProperties.REPO_MIN_BLOCK_TRANSFER_SIZE.toLowerCase()]});["width","height"].filter((e=>e in p)).forEach((e=>{const t=parseInt(p[e],10);isNaN(t)||(p[e]=t)}));const _=s[n];Array.isArray(_)?_.push(p):s[n]=_?[_,p]:p}return Object.assign({},s)}catch(e){throw new o.DCXError(o.DCXError.INVALID_DATA,"Failed to parse, invalid link header",e)}}function ce(e,t){if(a.isObject(this)){if("string"==typeof this.opsHref)return h.default.resolve(this.opsHref);if(a.isFunction(this.opsHref))return h.default.resolve(this.opsHref())}return ne(e,t).then((e=>{try{return a.getLinkHref(e,_.REPO_OPS)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ops href.",e)}}))}const he=n.newDebug("dcx:assets:util:serialization");function le(e,r){he("deserializeAsset()");const s={};s.repositoryId=e.repositoryId||e[t.Properties.REPO_REPOSITORY_ID],s.assetId=e.assetId||e[t.Properties.REPO_ASSET_ID],s.name=e.name||e[t.Properties.REPO_NAME],s.size=null!=e.size?e.size:e[t.Properties.REPO_SIZE],s.path=e.path||e[t.Properties.REPO_PATH],s.assetClass=e.etag||e[t.Properties.REPO_ASSET_CLASS],s.etag=e.etag||e[t.Properties.REPO_ETAG],s.version=e.version||e[t.Properties.REPO_VERSION],s.format=e.format||e[t.Properties.DC_FORMAT],s.md5=e.md5,s.createDate=e.createDate||e[t.Properties.REPO_CREATE_DATE],s.modifyDate=e.modifyDate||e.modifiedDate||e[t.Properties.REPO_MODIFY_DATE],s.discardDate=e.discardDate||e[t.Properties.REPO_DISCARD_DATE],s.createdBy=e.createdBy||e[t.Properties.REPO_CREATED_BY],s.modifiedBy=e.modifiedBy||e[t.Properties.REPO_MODIFIED_BY],s.discardedBy=e.discardedBy||e[t.Properties.REPO_DISCARDED_BY],s.deviceCreateDate=e.deviceCreateDate||e[t.Properties.REPO_DEVICE_CREATE_DATE],s.deviceModifyDate=e.deviceModifyDate||e[t.Properties.REPO_DEVICE_MODIFY_DATE],s.defaultScheduledDeletionDuration=e.defaultScheduledDeletionDuration||e[t.Properties.REPO_DEFAULT_SCHEDULED_DELETION_DURATION],s.scheduledDeletionDate=e.scheduledDeletionDate||e[t.Properties.REPO_SCHEDULED_DELETION_DATE],s.baseAssetId=e.baseAssetId||e[t.Properties.REPO_BASE_ASSET_ID],s.state=e.state||e[t.Properties.REPO_STATE],s.links=e.links||e[t.Properties.LINKS],s.width=e.width||e[t.Properties.IMAGE_WIDTH],s.length=e.length||e[t.Properties.IMAGE_LENGTH];const o=[r,e._embedded].flat();return s.embedded=Object.entries({EffectivePrivileges:_.EFFECTIVE_PRIVILAGES,RepositoryResource:_.REPOSITORY,AppMetadata:_.APP_METADATA}).reduce(((e,[t,r])=>(o.filter((e=>e&&r in e)).forEach((s=>a.merge(e,{[t]:r===_.REPOSITORY?ue(s):s}))),e)),{}),a.pruneUndefined(s)}function ue(e={}){he("deserializeRepository()");const r=e[_.REPOSITORY]?e[_.REPOSITORY]:e;return{repositoryId:r[t.Properties.REPO_REPOSITORY_ID],repositoryType:r[t.Properties.REPO_REPOSITORY_TYPE],owner:r[t.Properties.REPO_OWNER],createDate:r[t.Properties.REPO_CREATE_DATE],title:r[t.Properties.DC_TITLE],availableRegions:r[t.Properties.REPO_AVAILABLE_REGIONS]}}const pe=n.newDebug("dcx:assets:operations"),_e=n.newDebug("dcx:assets:operations:builder");function fe(e,t,r,s,o,n,i){pe("copyAsset()"),a.validateParams(["svc",e,"object"],["srcAsset",t,"object"],["destAsset",r,"object"],["createIntermediates",s,"boolean"],["overwriteExisting",o,"boolean",!0],["manifestPatch",i,["object","string"],!0]),ee(t,["repo:path","path","assetId","repo:assetId"],"string"),ee(r,["repo:path","path","assetId","repo:assetId"],"string");const d=Se("copy",r,t,{overwriteExisting:o,createIntermediates:s},{"repo:manifestPatch":JSON.stringify(i)}),c=F(e);return ce.call(this,e).then((e=>ve(c,e,d,n))).then(we.bind(void 0,r)).then(Re)}const ge=e=>"string"==typeof e?{reltype:e,component_id:"",revision:""}:e;function me(e,t,r,s,o,n){pe("moveAsset()"),a.validateParams(["svc",e,"object"],["srcAsset",t,"object"],["destAsset",r,"object"],["createIntermediates",s,"boolean"],["overwriteExisting",o,"boolean",!0]),ee(t,["repo:path","path","assetId","repo:assetId"],"string"),ee(r,["repo:path","path","assetId","repo:assetId"],"string");const i=Se("move",r,t,{createIntermediates:s,overwriteExisting:o}),d=F(e);return ce.call(this,e).then((e=>ve(d,e,i,n))).then(we.bind(void 0,r)).then(Re)}function Ee(e,t,r,s,o){pe("discardAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["etag",r,"string",!0],["recursive",s,"boolean",!0]);const n=F(e);ee(t,["repo:path","path","assetId","repo:assetId"],"string");const i=Se("discard",Object.assign(Object.assign({},t),{etag:r}),void 0,{recursive:s});return ce.call(this,e).then((e=>ve(n,e,i,o))).then(Oe)}function Ae(e,r,s="*",o,n){pe("deleteAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["etag",s,"string",!0],["recursive",o,"boolean",!0]);const i=F(e);if(r.format===f&&null==o)throw new c.default(c.default.INVALID_PARAMS,"Recursive flag is required for directory assets.");if(!o&&J(r,[_.REPO_METADATA])){const e=a.getLinkHrefTemplated(r,_.REPO_METADATA,{});return i.invoke("DELETE",e,{[t.HeaderKeys.IF_MATCH]:s},void 0,{isStatusValid:z()}).then(Oe)}ee(r,["repo:path","path","assetId","repo:assetId"],"string");const d=Object.create(Object.getPrototypeOf(r),Object.getOwnPropertyDescriptors(r));d.etag=s;const h=Se("delete",d,void 0,{recursive:o});return ce.call(this,e).then((e=>ve(i,e,h,n))).then(Oe)}function ye(e,t,r){pe("restoreAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"]);const s=F(e);ee(t,["assetId","repo:assetId"],"string");const o=Se("restore",t);return ce.call(this,e).then((e=>ve(s,e,o,r))).then(we.bind(void 0,t)).then(Re)}function De(e,t,r,s,o,n){var i;pe("packageAssets()"),a.validateParams(["svc",e,"object"],["destination",r,"object"]),a.validateParam("sources",t,["object","object[]"]),t=a.isArray(t)?t:[t],i=["repo:path","path","assetId","repo:assetId"],t.map((e=>ee(e,i,"string"))),ee(r,["repo:path","path","assetId","repo:assetId"],"string");const d=Se("package",r,t,{createIntermediates:s,overwriteExisting:o}),c=F(e);return ce.call(this,e).then((e=>ve(c,e,d,n))).then(we.bind(void 0,r)).then(Oe)}function Ce(e){return{result:(a.isArray(e.response)?e.response:[e.response]).map(Ie),response:e}}function Ie(e){if(!e.error)return e;const t=Object.assign({},e),r=z()(e.error.status);return t.error=o.isAdobeDCXError(r)?r:new c.default(c.default.UNEXPECTED,"Unexpected response"),t._additionalData=e.error,t.error._message=e.error.title,t}function ve(e,r,s,o){return pe("doOperation()"),a.validateParams(["svc",e,"object"],["opsEndpoint",r,"string"],["operationDocument",s,["string","object"]],["additionalHeaders",o,"object",!0]),function(e,r,s,o={}){return e.invoke(t.HTTPMethods.POST,r,Object.assign({[t.HeaderKeys.CONTENT_TYPE]:D},o),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z(),responseType:"json",retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"get"}})}(e,r,s,o).then((e=>{if(e.response=e.response||{},e.response.error)throw new c.default(c.default.UNEXPECTED_RESPONSE,e.response.type||"Operation failed.",new Error(e.response.title),e);return e}))}class be{constructor(){this.opBatchLimit=100,this._docs=[]}getDocumentEntry(e){return this._docs[e]}getDocument(){return this._docs}get entryCount(){return this._docs.length}copyResources(e,t,r,s,o,n){_e("copyResource()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const i=this._docs.find(function(e,t){return function(r){return"copy_resources"===r.op&&Pe(r.source,e)&&Pe(r.target,t)}}(e,t));if(i)return i.resources=i.resources.concat(r),o&&(i["repo:manifestPatch"]=JSON.stringify(o)),void 0!==s&&(i.intermediates=s),this;const a=Se("copy_resources",t,e,{createIntermediates:s},{resources:r,"repo:manifestPatch":JSON.stringify(o),additionalHeaders:n});return this._docs.push(a),this}copy(e,t,r,s,o){_e("copy()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const n=Se("copy",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}move(e,t,r,s,o){_e("move()"),this._assertUnderLimit(),this._checkSourceType(e),this._checkTargetType(t);const n=Se("move",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}package(e,t,r,s,o){_e("package()"),this._assertUnderLimit(),(e=a.isArray(e)?e:[e]).map((e=>{this._checkSourceType(e)})),this._checkTargetType(t);const n=Se("package",t,e,{createIntermediates:r,overwriteExisting:s},o);return this._docs.push(n),this}discard(e,t,r){_e("discard()"),this._assertUnderLimit(),this._checkTargetType(e);const s=Se("discard",e,void 0,{recursive:t},r);return this._docs.push(s),this}restore(e,t){_e("restore()"),this._assertUnderLimit(),ee(e,["assetId","repo:assetId"],"string"),this._checkTargetType(e);const r=Se("restore",e,void 0,void 0,t);return this._docs.push(r),this}delete(e,t,r){_e("delete()"),this._assertUnderLimit(),this._checkTargetType(e);const s=Se("delete",e,void 0,{recursive:t},r);return this._docs.push(s),this}_assertUnderLimit(){if(this._docs.length>=this.opBatchLimit)throw new c.default(c.default.INVALID_STATE,`Exceeds limit of ${this.opBatchLimit} operations in a single batch.`)}_checkTargetType(e){this._checkSourceOrTargetType(e,"Target")}_checkSourceType(e){this._checkSourceOrTargetType(e,"Source")}_checkSourceOrTargetType(e,t){if(0===[!!e.assetId||!!e["repo:assetId"],!!e.path||!!e["repo:path"]].filter((e=>e)).length)throw new c.default(c.default.INVALID_PARAMS,`${t} identifier is underspecified. Exactly one of [href, repo:path, repo:assetId] required.`);const r=this._getSourceType(e),s="Source"===t?this._batchSourceType:this._batchTargetType;if(s){if(r!==s)throw new c.default(c.default.INVALID_PARAMS,`Operation ${t.toLowerCase()} types must all be the same type. Expected ${s}, encountered ${r}.`)}else"Source"===t?this._batchSourceType=r:this._batchTargetType=r}_getSourceType(e){return e.assetId||e["repo:assetId"]?"id":e.path||e["repo:path"]?e.baseAssetId||e["repo:baseAssetId"]?"pathAndBaseAssetId":"path":void 0}}function Te(){return new be}function Pe(e,r){var s,o;return e[t.Properties.REPO_ASSET_ID]===(null!==(s=r[t.Properties.REPO_ASSET_ID])&&void 0!==s?s:r.assetId)&&e[t.Properties.REPO_REPOSITORY_ID]===(null!==(o=r[t.Properties.REPO_REPOSITORY_ID])&&void 0!==o?o:r.repositoryId)}function we(e,t){return t.response.asset=Object.assign(Object.assign({},t.response.asset||{}),{repositoryId:e.repositoryId||e["repo:repositoryId"]}),t}function Re(e){return{response:e,result:le(e.response.asset)}}function Oe(e){return{response:e,result:{success:e.statusCode>199&&e.statusCode<400}}}function ke(e,r,s){if(pe("_convertToACPSource()"),"object"!=typeof r)return;const o={"repo:repositoryId":r.repositoryId||r["repo:repositoryId"],"repo:path":r.path||r["repo:path"],"repo:assetId":r.assetId||r["repo:assetId"],"repo:baseAssetId":r.baseAssetId||r["repo:baseAssetId"]};return"string"==typeof o.href?(delete o["repo:path"],delete o["repo:assetId"],delete o["repo:baseAssetId"]):"string"==typeof o["repo:assetId"]&&(delete o["repo:path"],delete o["repo:baseAssetId"]),"target"===e?!0===s?o[t.HeaderKeys.IF_MATCH]=r.format!==l.Directory&&r["dc:format"]!==l.Directory&&r.etag||"*":!1===s?o[t.HeaderKeys.IF_NONE_MATCH]="*":r.format!==l.Directory&&r["dc:format"]!==l.Directory&&(o[t.HeaderKeys.IF_MATCH]=r.etag):r.format!==l.Directory&&r["dc:format"]!==l.Directory&&(o[t.HeaderKeys.IF_MATCH]=r.etag||"*"),r.version&&(o["repo:version"]=r.version),o["repo:path"]&&Q(o,"repo:repositoryId","string"),pe("_cTACPS() out",o),a.pruneUndefined(o)}function Se(e,t,r,s={},o={}){pe("_buildOperationDoc()");const n=a.pruneUndefined({op:e,target:t,source:a.isArray(r)?[]:r?{}:void 0}),{overwriteExisting:i,createIntermediates:d,recursive:c}=s;if(n.source&&(n.source=a.isArray(r)?r.map((e=>ke("source",e,i))).filter((e=>null!=e)):ke("source",r,i)),"object"==typeof t){const e=ke("target",t,i);e&&(n.target=e)}return null==n.target["repo:assetId"]&&null!=d&&(n.intermediates=d),null!=c&&(n.recursive=c),Object.assign(n,o),pe("_OD() doc",n),n}function Ne(e,t,r,s,n,i,d){a.validateParams(["resources",s,"array",!1]);const c=Te().copyResources(t,r,s,n,i).getDocument();return ce(e).then((t=>ve(F(e),t,c,d))).then(o._handleErrorResponsePayload).then((e=>{const{asset:t,source:r,target:s,resources:o}=e.response[0];return{result:{source:le(r),target:le(s),resources:o,asset:t?le(t):void 0},response:e}}))}const Le=n.newDebug("dcx:assets:block_transfer"),Me=10485760,Xe=52428800,Be=Me/4;let xe=Xe;function je(e,r){const s=function(e){return Ue(e,t.BlockTransferProperties.REPO_MIN_BLOCK_TRANSFER_SIZE)}(e);if(s&&r<s)return!1;const o=Ve(e);return!!(o&&r>o)||r>Me}function Ue(e,t){if(!$(e.links,[_.BLOCK_UPLOAD_INIT]))return;const r=a.getLinkProperty(e.links,_.BLOCK_UPLOAD_INIT,t);return r?parseInt(r):void 0}function Ve(e){return Ue(e,t.BlockTransferProperties.MAX_SINGLE_TRANSFER_SIZE)}const He=e=>"string"==typeof e?e.length>=Be?a.stringToBuffer(e).byteLength:e.length:"size"in e?e.size:e.byteLength,Fe=(e,t)=>{if(!a.isFunction(e))return e;if(e.length<2)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"GetSliceCallback is expected to accept 2 parameters");if(void 0===t||isNaN(t)||t<0)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Size parameter should indicate total number of bytes to be read from GetSliceCallback");return{getSlice:e,size:t}},Ye=()=>xe;function We(e,t,r,s){const o=a.parseHeaders(s);return{id:t,length:r,type:e,links:de(o.link),etag:o.etag,location:o.location,version:o.version,revision:o.revision,md5:o["content-md5"]}}function ze(e){return new Promise((t=>{let r;e.finally((()=>{clearTimeout(r),t(void 0)})),function s(){["blockUpload","blockDownload"].forEach((o=>{if(a.isObject(e[o]))return clearTimeout(r),t(e[o]);clearTimeout(r),r=setTimeout(s,1)}))}()}))}var qe;t.BlockTransferStates=void 0,(qe=t.BlockTransferStates||(t.BlockTransferStates={})).NOT_INITIALIZED="NOT_INITIALIZED",qe.INITIALIZING="INITIALIZING",qe.INITIALIZED="INITIALIZED",qe.WAITING="WAITING",qe.STARTED="STARTED",qe.PAUSING="PAUSING",qe.PAUSED="PAUSED",qe.CANCELED="CANCELED",qe.ERROR="ERROR",qe.FINALIZING="FINALIZING",qe.COMPLETE="COMPLETE";const Ke=new class{constructor(){this._uploads=[],this._downloads=[],this._pendingUploadRequests=[],this._pendingDownloadRequests=[],this._downloadChunkSize=10485760}get downloads(){return this._downloads}get uploads(){return this._uploads}set downloadChunkSize(e){a.validateParams(["downloadChunkSize",e,"+number"]),this._downloadChunkSize=e}get downloadChunkSize(){return this._downloadChunkSize}get pendingUploadRequests(){return this._pendingUploadRequests}get pendingDownloadRequests(){return this._pendingDownloadRequests}resetUploads(){this._uploads=[],this._pendingUploadRequests=[]}addAndStartUpload(e){return this._addAndStart("upload",e)}addAndStartDownload(e){return e.state!==t.BlockTransferStates.INITIALIZED?Promise.resolve(e):this._addAndStart("download",e)}startNextWaiting(e){const r="upload"===e?this._uploads:this._downloads,s=[];let o=!1;for(const e of r)!o&&e&&e.state===t.BlockTransferStates.WAITING?(e.start(),o=!0):e.state!==t.BlockTransferStates.CANCELED&&e.state!==t.BlockTransferStates.ERROR&&e.state!==t.BlockTransferStates.FINALIZING&&e.state!==t.BlockTransferStates.COMPLETE||s.push(e);const n=r.filter((e=>!s.includes(e)));"download"===e?this._downloads=n:this._uploads=n}_addAndStart(e,r){const s="upload"===e?this._uploads:this._downloads;return 0===s.filter((e=>e&&(e.state===t.BlockTransferStates.NOT_INITIALIZED||e.state===t.BlockTransferStates.INITIALIZED||e.state===t.BlockTransferStates.INITIALIZING||e.state===t.BlockTransferStates.STARTED))).length?r.start():r._setWaiting(),s.push(r),r.promise}},Ge=n.newDebug("dcx:assets:blockdownload"),$e=n.newDebug("dcx:assets:blockdownload:leaf"),Je=function*(){let e=0;for(;;)yield e++}();class Ze extends a.EventEmitter{constructor(e,r,s={}){super(["stateChanged"]),this._state=t.BlockTransferStates.NOT_INITIALIZED,this._cachedBlocks=new Map,this._blockRequestIndex=0,this._blockHandledIndex=0,this._currentByteRange=[void 0,void 0],this._pending=[],Ge("constructor");const{startByte:o,blockSize:n,endByte:i,url:d,totalSize:c,maxConcurrentRequests:l}=Object.assign({blockSize:Ke.downloadChunkSize,maxConcurrentRequests:4},a.pruneUndefined(s));a.validateParams(["svc",e,"object"],["responseType",r,"enum",!1,["buffer"]],["blockSize",n,"+number"],["url",d,"string",!0],["startByte",o,"number",!0],["endByte",i,"number",!0],["totalSize",c,"number",!0],["maxConcurrentRequests",l,"+number"]),this._dbgId=Je.next().value,this._maxConcurrentRequests=l,this._blockSize=Math.round(n),this._service=e,this._url=d,this._startByte=o,this._endByte=i,this._totalSize=c,this._bytes=new Uint8Array,this._promise=new h.default(((e,t)=>{this._resolve=()=>{Ge(this._dbgId,"resolving"),this.removeAllHandlers(),e(this)},this._reject=e=>{Ge(this._dbgId,"rejecting: ",e),this.removeAllHandlers(),t(e)}}))}get contentType(){var e;return null!==(e=this._contentType)&&void 0!==e?e:""}get totalSize(){return this._totalSize}get buffer(){return this._bytes}get state(){return this._state}get promise(){return this._promise}_requestBlock(e,r,s,o){Ge(this._dbgId,"_requestBlock(): ",e,r,s,o);const n=rt(e,r);return this._service.invoke(t.HTTPMethods.GET,this._url,n,void 0,{responseType:"defaultbuffer",isStatusValid:z(),isExternalRequest:!0}).then((e=>({response:e,index:s,lane:o}))).catch(this._handleErrorAndThrow.bind(this))}init(e=this._url,r=this._totalSize){if(Ge(this._dbgId,"init(): ",e,r),this._state===t.BlockTransferStates.INITIALIZED&&e===this._url&&r===this._totalSize)return h.default.resolve(this);if(this._assertStateIsValid("init"),this._shiftState(t.BlockTransferStates.INITIALIZING),this._url=e,this._initByteRange(r),this._totalSize!==1/0||null==this._currentByteRange[0])return this._shiftState(t.BlockTransferStates.INITIALIZED),h.default.resolve(this);const{startByte:s,endByte:o,blockIndex:n}=this._nextBlockData();let i=t.BlockTransferStates.INITIALIZED;return this._requestBlock(s,o,n,0).then((e=>(this._updateTotalSize(e),(!o||o>this._endByte)&&(i=t.BlockTransferStates.FINALIZING),e))).then(this._handleBlock.bind(this)).then((()=>this._shiftState(i))).catch(this._handleErrorAndThrow.bind(this))}start(){if(Ge(this._dbgId,"start()"),this._assertStateIsValid("start"),this._shiftState(t.BlockTransferStates.STARTED),null!=this._currentByteRange[0])return this._start(),this._promise;const[e,r]=this._currentByteRange,s=this._blockRequestIndex;return this._blockRequestIndex+=1,this._currentByteRange=[r+1,r],this._requestBlock(e,r,s,0).then(this._handleBlock.bind(this)).catch(this._handleError.bind(this)),this._promise}pause(){return Ge(this._dbgId,"pause()"),this._assertStateIsValid("pause"),this._shiftState(t.BlockTransferStates.PAUSING),h.default.allSettled(this._pending).then((()=>(this._shiftState(t.BlockTransferStates.PAUSED),Ke.startNextWaiting("download"),this)))}resume(){return Ge(this._dbgId,"resume()"),this.state===t.BlockTransferStates.PAUSED&&(this._shiftState(t.BlockTransferStates.STARTED),this._start()),this}cancel(){return Ge(this._dbgId,"cancel()"),this._assertStateIsValid("cancel"),this._shiftState(t.BlockTransferStates.CANCELED),this._reject(new c.default(c.default.ABORTED,"BlockDownload aborted.")),Ke.startNextWaiting("download"),this._promise}_setWaiting(){this._shiftState(t.BlockTransferStates.WAITING)}_start(){Ge(this._dbgId,"_start()");for(let e=0;e<this._maxConcurrentRequests;e++)this._loop(e).catch(this._handleError.bind(this))}get _loopShouldContinue(){const e=this._state===t.BlockTransferStates.STARTED&&this._currentByteRange[0]<=this._endByte;return Ge(this._dbgId,"_loopShouldContinue() ",e,this._currentByteRange,this._endByte),e}_loop(e){return O(this,void 0,void 0,(function*(){Ge(this._dbgId,"_loop(): ",e);let r=!1;for(;this._loopShouldContinue&&!r;){const{startByte:t,endByte:s,blockIndex:o,done:n}=this._nextBlockData();r=n;const i=this._requestBlock(t,s,o,e).then(this._handleBlock.bind(this)).catch(this._handleError.bind(this));this._pending[e]=i,yield i}Ge(this._dbgId,`_loop(${e}) done, ${r}`),r&&(Ge(this._dbgId,`_loop(${e}) finalize`),this._shiftState(t.BlockTransferStates.FINALIZING))}))}_nextBlockData(){Ge(this._dbgId,"_nextBlockData()");const e=this._blockRequestIndex;this._blockRequestIndex+=1;const[t,r]=this._currentByteRange;return this._currentByteRange[0]+=this._blockSize,this._currentByteRange[1]=Math.min(this._currentByteRange[1]+this._blockSize,this._endByte),{startByte:t,endByte:r,blockIndex:e,done:r>=this._endByte}}_initByteRange(e=this._totalSize){if(Ge(this._dbgId,"_initByteRange(): ",e),this._totalSize=e,null!=this._totalSize&&this._totalSize<0)throw new c.default(c.default.INVALID_PARAMS,"Total size must be positive.");if(this._totalSize||(this._totalSize=1/0),this._endByte||(this._endByte=this._totalSize),!this._startByte&&this._endByte===this._totalSize)return this._startByte=0,void(this._currentByteRange=[0,this._blockSize-1]);if(!this._startByte&&this._endByte<0&&this._totalSize!==1/0?(this._startByte=Math.max(0,this._totalSize+this._endByte),this._endByte=this._totalSize):!this._startByte&&this._endByte>0&&(this._startByte=0),null!=this._startByte&&(this._currentByteRange[0]=Math.max(this._startByte,0)),(null==this._endByte||this._endByte>0)&&(this._currentByteRange[1]=Math.min(this._endByte,(this._startByte||0)+this._blockSize-1)),null!=this._startByte||this._endByte===1/0)return;if(this._totalSize===1/0){if(-this._endByte>this._blockSize)throw new c.default(c.default.INVALID_PARAMS,"Cannot download last N bytes without a total size.");return void(this._currentByteRange=[void 0,this._endByte])}this._startByte=Math.max(0,this._totalSize+this._endByte),this._endByte=this._totalSize;const t=Math.min(this._startByte+this._blockSize-1,this._endByte);this._currentByteRange=[this._startByte,t]}_finalize(){return Ge(this._dbgId,"_finalize() start"),Ke.startNextWaiting("download"),h.default.allSettled(this._pending).then((()=>{this._checkCachedBlocks(),this._shiftState(t.BlockTransferStates.COMPLETE)}))}_updateTotalSize(e){if(Ge(this._dbgId,"_updateTotalSize()"),null==this._totalSize||this._totalSize===1/0)try{const t=e.response.headers["content-range"],r=parseInt(t.split("/")[1]);a.assert((()=>!isNaN(r)),"Invalid number."),this._totalSize=r,this._endByte===1/0&&(this._endByte=this._totalSize)}catch(t){throw new c.default(c.default.INVALID_DATA,"Could not determine total size.",t,e.response)}return Ge(this._dbgId,"_uTS(): ",this._totalSize,this._endByte),e}_handleError(e){Ge(this._dbgId,"_handleError(): ",e),this._shiftState(t.BlockTransferStates.ERROR),this._error=e,o.isAdobeDCXError(e)||(this._error=new c.default(c.default.UNEXPECTED,"An unexpected error occurred.",e)),this._reject(this._error)}_handleErrorAndThrow(e){throw this._handleError(e),this._error}_handleBlock(e){this._endByte===1/0&&this._updateTotalSize(e);const{index:t,response:r}=e;if(Ge(this._dbgId,`_handleBlock(${t})`),t!==this._blockHandledIndex)return Ge(this._dbgId,`_handleBlock(${t}) cached`),void this._cachedBlocks.set(t,e);Ge(this._dbgId,`_handleBlock(${t}) handled`),this._pushBlockData(r),this._markCurrentBlockHandled()}_markCurrentBlockHandled(){this._cachedBlocks.delete(this._blockHandledIndex),this._blockHandledIndex+=1,this._checkCachedBlocks()}_checkCachedBlocks(){const e=this._cachedBlocks.get(this._blockHandledIndex);e&&this._handleBlock(e)}_pushBlockData(e){if(this._state===t.BlockTransferStates.ERROR)return;this._contentType=this._contentType||e.headers[t.HeaderKeys.CONTENT_TYPE];const r=void 0!==s&&e.response instanceof s?e.response:new Uint8Array(e.response);this._bytes=a.concatUint8Arrays(this._bytes,r)}_shiftState(e){return Ge(this._dbgId,"_shiftState(): ",e),this._state===t.BlockTransferStates.COMPLETE||this._state===t.BlockTransferStates.ERROR||this._state===t.BlockTransferStates.CANCELED||(this._state=e,this.emit("stateChanged",[this._state,this]),e===t.BlockTransferStates.FINALIZING&&this._finalize(),e===t.BlockTransferStates.COMPLETE&&Promise.all(this._pending).then(this._resolve.bind(this))),this}_assertStateIsValid(e,r=this._state){Ge(this._dbgId,"_assertStateIsValid() ",e,r);let s=!1;const o="Invalid state transition.";switch(e){case"init":r===t.BlockTransferStates.NOT_INITIALIZED&&(s=!0);break;case"start":r!==t.BlockTransferStates.INITIALIZED&&r!==t.BlockTransferStates.WAITING&&r!==t.BlockTransferStates.STARTED||(s=!0);break;case"pause":r!==t.BlockTransferStates.INITIALIZING&&r!==t.BlockTransferStates.STARTED||(s=!0);break;case"cancel":s=!0}if(!s)throw Ge(this._dbgId,"_aSIV() throw ",o),new c.default(c.default.INVALID_STATE,o,void 0,void 0,{method:e,currentState:r})}}function Qe(e,t,r){return new Ze(e,t,r)}function et(e,r,s,o,n="defaultbuffer",i,d,l){$e("_doBlockDownload()");const u="stream"===n?void 0:Qe(e,"buffer",{startByte:s,endByte:o});(null!=this?this:{}).blockDownload=u;let p=h.default.resolve(r,void 0!==this?this:{});return i||(p=p.then((()=>e.invoke(t.HTTPMethods.GET,r,Object.assign({priority:"u=1"},l),void 0,{responseType:"text",isStatusValid:z(),retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"GET"}}))).then((e=>{const t=e.response.indexOf("href")>0?a.getFirstRegexpCapture(e.response,'"href":\\s*"([^;"]*)"'):"";if("string"!=typeof t||""===t)throw new c.default(c.default.UNEXPECTED_RESPONSE,"No block download href found in response.",void 0,e);return d=d||parseInt(a.getFirstRegexpCapture(e.response,'"size":\\s*(\\d+)')),t}))),p.then((r=>O(this,void 0,void 0,(function*(){return u?Promise.race([u.init(r,d).then((()=>Ke.addAndStartDownload(u))),u.promise]).then((()=>({statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:u.contentType,[t.HeaderKeys.CONTENT_LENGTH]:u.totalSize}),responseType:n,response:tt(u.buffer,n,u.contentType),message:"OK"}))):e.invoke(t.HTTPMethods.GET,r,rt(s,o),void 0,{responseType:"stream",isExternalRequest:!0})}))))}function tt(e,t,r){if("defaultbuffer"===t||"buffer"===t||"arraybuffer"===t)return e.buffer;if("blob"===t)return new Blob([e],{type:r});const s=a.arrayBufferToString(e);if("text"===t)return s;try{return JSON.parse(s)}catch(e){return s}}function rt(e,t){return null==e&&null==t?{}:{range:`bytes=${null!=e?e:null!=t&&t>0?"0":""}-${null!=t?Math.abs(t):""}`}}const st=n.newDebug("dcx:assets:private");function ot(e,r,s,n,i="defaultbuffer",d,c,l={},u=!1){let p;st("_getUrlFallbackDirect()");const f=void 0!==this?this:{};return h.default.resolve(void 0,f).then((()=>e.invoke(t.HTTPMethods.GET,s,Object.assign({priority:"u=1"},l),void 0,{responseType:i,isStatusValid:z([400])}))).then((e=>(st("_gUFD() status code",e.statusCode),p=e,400===e.statusCode&&e.xhr?e.xhr.getResponseDataAsJSON():e))).then((e=>{const t=a.isObject(e)&&(400===p.statusCode||400===e.status)&&e.type===o.ProblemTypes.RESPONSE_TOO_LARGE;if(st("_gUFD() do direct",t),!t&&400===p.statusCode)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response",void 0,p);return t})).then((s=>{if(!s)return p;if(!("location"in p.headers)||"string"!=typeof p.headers.location){if(!$(r.links,[_.BLOCK_DOWNLOAD]))throw new o.DCXError(o.DCXError.INVALID_DATA,"Resource too large and missing download link.");const s=a.pruneUndefined({reltype:n,component_id:d,revision:c}),h=a.getLinkHrefTemplated(r.links,_.BLOCK_DOWNLOAD,{resource:n?JSON.stringify(s):void 0});return u?{statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:p.headers["content-type"],[t.HeaderKeys.CONTENT_LENGTH]:p.headers["content-length"]}),responseType:i,response:{href:h},message:"OK"}:et.call(f,e,h,void 0,void 0,i,!1,void 0,l)}return u?{statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:p.headers["content-type"],[t.HeaderKeys.CONTENT_LENGTH]:p.headers["content-length"]}),responseType:i,response:{href:p.headers.location},message:"OK"}:et.call(f,e,p.headers.location,void 0,void 0,i,!0,void 0,l)}))}function nt({additionalHeaders:e={},asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:h,relation:l,service:u},p=!1){if(st("_doUpload()"),a.validateParams(["service",u,"object"],["asset",r,"object"],["href",c,"string"],["headHref",d,"string"],["contentType",s,"string",!0],["maybeIsNew",h,"boolean",!0],["etag",i,"string",!0],["isRetry",p,"boolean",!0],["additionalHeaders",e,"object",!0]),null==h)return u.invoke(t.HTTPMethods.HEAD,d,e,void 0,{isStatusValid:z([404])}).then((t=>{const o=200!==t.statusCode;return nt({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:o,relation:l,service:u},p)}));const _=h;return _?delete e[t.HeaderKeys.IF_MATCH]:e[t.HeaderKeys.IF_MATCH]=i||"*",s&&(e[t.HeaderKeys.CONTENT_TYPE]=s),u.invoke(t.HTTPMethods.PUT,c,e,n,{isStatusValid:z([404,409,412]),retryOptions:{pollHeader:"location",pollCodes:[202]}}).then((t=>{const a=t.statusCode;if(a>400&&!p){if(null!=i)throw z()(a,t);if(!_&&404===a)return nt({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:!0,relation:l,service:u},!0);if(404===a)throw new o.DCXError(o.DCXError.NOT_FOUND,"Unexpected response",void 0,t);if(409===a||412===a)return nt({additionalHeaders:e,asset:r,contentType:s,data:n,etag:i,headHref:d,href:c,maybeIsNew:void 0,relation:l,service:u},!0)}return t}))}const it=n.newDebug("dcx:assets:bulk");function at(e,r){const s="\r\n";let o=Uint8Array.from([]);for(let n=0;n<e.length;n++){const i=e[n];o=0===n?a.concatUint8Arrays(o,a.stringToBuffer(`--${r}${s}`)):a.concatUint8Arrays(o,a.stringToBuffer(`${s}--${r}${s}`)),o=a.concatUint8Arrays(o,a.stringToBuffer(`${[t.HeaderKeys.CONTENT_TYPE]}: application/http${s}`)),o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}${i.method} ${i.href}`));let d=!1;for(const e in i.headers){const t=e.toLowerCase();"content-length"===t&&(d=!0),o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}${t}: ${i.headers[e]}`))}if(i.body){const e=dt(i.body);d||(o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}content-length: ${e.length}`))),o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}${s}`)),o=a.concatUint8Arrays(o,e)}}return o=a.concatUint8Arrays(o,a.stringToBuffer(`${s}--${r}--${s}`)),o}function dt(e){if("string"==typeof e)return a.stringToBuffer(e);if(a.isArrayBuffer(e))return new Uint8Array(e);if(M(e))return e;throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Bulk subrequest body expecting string | ArrayBuffer | Buffer")}function ct(e,r){const s=e.headers[t.HeaderKeys.CONTENT_TYPE];if(!s)throw new o.AdobeDCXError(o.AdobeDCXError.UNEXPECTED_RESPONSE,"Missing boundary header in multipart response");const n=s.split("=")[1],i=function(e,t){const r=new Uint8Array(e),s=a.stringToBuffer(`--${t}`);return lt(r,ht(r,s),s.byteLength).map((e=>ut(e,!0)))}(e.response,n);if(r&&i.length!==r)throw new o.AdobeDCXError(o.AdobeDCXError.UNEXPECTED_RESPONSE,`Unexpected number of parts; Expected ${r}, Received ${i.length}`);return i}function ht(e,t){const r=new Array(256).fill(-1),s=[];for(let e=0;e<t.length;e++)r[t[e]]=e;let o=0;for(;o<=e.length-t.length;){let n=t.length-1;for(;n>=0&&t[n]===e[o+n];)n--;n<0?(s.push(o),o+=o+t.length<e.length?t.length-r[e[o+t.length]]:1):o+=Math.max(1,n-r[e[o+n]])}return s}function lt(e,t,r,s=!1){let o=s?0:void 0;const n=[];for(const s of t)void 0!==o&&n.push(e.subarray(o,s)),o=s+r;return s&&n.push(e.subarray(o)),n}function ut(e,r=!1){const s=a.stringToBuffer("\r\n\r\n"),o=ht(e,s).slice(0,2),n=a.stringToBuffer("\n\n"),i=lt(e,...o.length>0?[o,s.byteLength]:[ht(e,n).slice(0,2),n.byteLength],!0),d=i.slice(0,r||i.length>1?2:1).reduce(((e,t)=>Object.assign(e,a.parseHeaders(a.arrayBufferToString(t)))),{}),c=i.length>1?i[i.length-1]:void 0,h=parseInt(a.arrayBufferToString(i[r?1:0]).split("\r\n",1)[0].split(" ")[1]),l=parseInt(d["content-length"],10);let u;return u=isNaN(l)?0===(null==c?void 0:c.length)?new Uint8Array([]):c:0===l?new Uint8Array([]):null==c?void 0:c.subarray(0,l),{headers:d,response:d[t.HeaderKeys.CONTENT_TYPE]===E&&void 0!==u?JSON.parse(a.arrayBufferToString(u)):u,statusCode:h}}function pt(e){if(e.length>10)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A single bulk request can only contain a maximum of 10 sub-requests.");const{writeOperations:r,readOperations:s}=e.reduce(((e,r)=>{if("string"!=typeof r.href)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation is missing an href");if("string"!=typeof r.method)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation is missing the HTTP method");const s=r.method.toUpperCase();if(!Object.values(t.HTTPMethods).includes(s))throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"A sub-request of the bulk operation includes an invalid HTTP method");return[t.HTTPMethods.GET,t.HTTPMethods.HEAD].includes(s)?e.readOperations.push(r):e.writeOperations.push(r),e}),{readOperations:[],writeOperations:[]});if(r.length>0&&s.length>0)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Cannot mix READ and WRITE operations in bulk sub requests.")}function _t(e,t,r,s="id",o={},n=!1){return it("performBulkRequest()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["requests",r,"array"],["linkMode",s,"string",!0,["id","path"]]),q(t.links,[_.BULK_REQUEST]),pt(r),ft(e,t,r,s,o).then((({response:i,subresponses:a})=>O(this,void 0,void 0,(function*(){const d=gt(a,r);return{result:n?yield mt(e,t,d,s,o,a):a,response:i}}))))}function ft(e,r,s,o="id",n={}){const i=`boundary-${Date.now()}`,d=at(s,i),c=Object.assign(Object.assign({},n),{[t.HeaderKeys.CONTENT_TYPE]:`multipart/mixed;boundary=${i}`}),h=a.getLinkHref(r.links,_.BULK_REQUEST,o);return e.invoke(t.HTTPMethods.POST,h,c,d,{isStatusValid:z(),responseType:"defaultbuffer",retryOptions:{pollHeader:"location",pollCodes:[202],pollMethod:t.HTTPMethods.GET}}).then((e=>({response:e,subresponses:ct(e,s.length)})))}function gt(e,t){return e.filter((({statusCode:e})=>a.checkRetriable(e))).map((e=>t.find((({href:t})=>t===e.headers["content-id"])))).filter((e=>e))}function mt(e,r,s,o="id",n={},i,a=5){return O(this,void 0,void 0,(function*(){if(0===s.length||a<=0)return i;if(1===s.length){const[r]=s,o=yield F(e).invoke(r.method,r.href,r.headers,r.body,{isStatusValid:z(),responseType:"defaultbuffer",retryOptions:{pollHeader:"location",pollCodes:[202],pollMethod:t.HTTPMethods.GET}});return o.headers["content-id"]=r.href,i.map((e=>"content-id"in e.headers&&e.headers["content-id"]===o.headers["content-id"]?o:e))}const d=yield ft(e,r,s,o,n).then((t=>O(this,void 0,void 0,(function*(){const i=gt(t.subresponses,s);return i.length?yield mt(e,r,i,o,n,t.subresponses,a-1):t.subresponses}))));return i.map((e=>d.find((t=>t.headers["content-id"]===e.headers["content-id"]))||e))}))}const Et=n.newDebug("dcx:assets:asset"),At=n.newDebug("dcx:assets:asset:leaf");class yt{constructor(e,t,r={}){this.type=l.Asset,this._data={},this._data=le(e),this._svc=F(t),this._cache=Y(t),this._links=a.merge({},e.links||{},e._links||{},r)}setLinks(e){this._links=e,this._updateCachedLinks()}get links(){return this._links}set links(e){this.setLinks(e)}setLink(e,t){this._links[e]=t,this._updateCachedLinks()}getLink(e){return this._links[e]}removeLink(e){delete this._links[e],this._updateCachedLinks()}_updateCachedLinks(){this._cache&&this._cache.setValueWithAsset(this.links,this.asset)}getLinkProperty(e,t,r="id"){return Et("getLinkProperty()"),a.getLinkProperty({_links:this._links},e,t,r)}getLinkHrefTemplated(e,t,r="id"){return Et("getLinkHrefTemplated()"),a.getLinkHrefTemplated({_links:this._links},e,t,r)}getLinkHref(e,t="id"){return Et("getLinkHref()"),a.getLinkHref({_links:this._links},e,t)}get asset(){return Object.assign(Object.assign({},this._data),this.links)}get serviceConfig(){return{service:this._svc,cache:this._cache}}get repositoryId(){return this._data.repositoryId}set repositoryId(e){this._data.repositoryId=e}get assetId(){return this._data.assetId}set assetId(e){this._data.assetId=e}get path(){return this._data.path}set path(e){this._data.path=e}get name(){return this._data.name}get etag(){return this._data.etag}set etag(e){this._data.etag=e}get version(){return this._data.version}set version(e){this._data.version=e}get format(){return this._data.format}set format(e){this._data.format=e}get assetClass(){return this._data.assetClass}get createDate(){return this._data.createDate}get modifyDate(){return this._data.modifyDate}get discardDate(){return this._data.discardDate}get createdBy(){return this._data.createdBy}get modifiedBy(){return this._data.modifiedBy}get discardedBy(){return this._data.discardedBy}get deviceCreateDate(){return this._data.deviceCreateDate}get deviceModifyDate(){return this._data.deviceModifyDate}get baseAssetId(){return this._data.baseAssetId}set baseAssetId(e){this._data.baseAssetId=e}get state(){return this._data.state}get size(){return this._data.size}set size(e){this._data.size=e}get md5(){return this._data.md5}set defaultScheduledDeletionDuration(e){this._data.defaultScheduledDeletionDuration=e}get defaultScheduledDeletionDuration(){return this._data.defaultScheduledDeletionDuration}set scheduledDeletionDate(e){this._data.scheduledDeletionDate=e}get scheduledDeletionDate(){return this._data.scheduledDeletionDate}set width(e){this._data.width=e}get width(){return this._data.width}set length(e){this._data.length=e}get length(){return this._data.length}fetchLinksIfMissing(e=[],t){return Et("fetchLinksIfMissing()"),Ht(this.serviceConfig,this,e,void 0,t).then((({result:e,response:t})=>(this._updateDataWithResponse(t),this)))}useLinkOrResolveResource(e,t){return Et("useLinkOrResolveResource()"),jt(this.serviceConfig,this,e,t).then((e=>(this._updateDataWithResponse(e.response),this.setLinks(a.merge(this.links,e.result.links)),e)))}headPrimaryResource(e){return Et("headPrimaryResource()"),this.fetchLinksIfMissing([_.PRIMARY],e).then((()=>Ct(this.serviceConfig,this,e))).then((e=>(this._updateDataWithResponse(e),e)))}getRepoMetadata(){return Et("getRepoMetadata()"),this.useLinkOrResolveResource(_.REPO_METADATA,"json").then((e=>{this._data=a.merge(this._data,e.result,le(e.response.response));const t=e.response.response;return t&&t._links&&this.setLinks(a.merge(this.links,t._links)),{result:this._data,response:e.response}}))}headAppMetadata(e){return Et("headAppMetadata()"),this.fetchLinksIfMissing([_.APP_METADATA],e).then((()=>Ot(this.serviceConfig,this)))}getAppMetadata(e,t){return Et("getAppMetadata()"),a.validateParams(["etag",e,"string",!0]),this.fetchLinksIfMissing([_.APP_METADATA],t).then((()=>kt(this._svc,this,e,t)))}putAppMetadata(e,t,r){return Et("putAppMetadata()"),a.validateParams(["etag",t,"string",!0],["metadata",e,["object","string"]]),this.fetchLinksIfMissing([_.APP_METADATA],r).then((()=>St(this._svc,this,e,t,r)))}patchAppMetadata(e,t,r){return Et("patchAppMetadata()"),a.validateParams(["patchDoc",e,["string","object[]"]],["etag",t,"string"]),this.fetchLinksIfMissing([_.APP_METADATA],r).then((()=>Nt(this._svc,this,e,t,r)))}getBaseDirectoryMetadata(){return Et("getBaseDirectoryMetadata()"),wt(this._svc)}getLinks(e){return Et("getLinks()"),a.isObject(this.links)&&Object.keys(this.links).length>0?h.default.resolve(this.links):Pt(this._svc,this,e).then((e=>(this.setLinks(e),e)))}getRepositoryResource(e){return Et("getRepositoryResource()"),this.fetchLinksIfMissing([_.REPOSITORY],e).then((()=>Rt(this._svc,this,e))).then((e=>(this.repositoryId=e.result["repo:repositoryId"],e)))}getEffectivePrivileges(e){return Et("getEffectivePrivileges()"),this.fetchLinksIfMissing([_.EFFECTIVE_PRIVILAGES],e).then((()=>Lt(this._svc,this)))}performBulkRequest(e,t,r){return Et("performBulkRequest()"),a.validateParams(["requests",e,"array"],["linkMode",t,"string",!0,["id","path"]]),this.fetchLinksIfMissing([_.BULK_REQUEST],r).then((()=>_t(this._svc,this,e,t,r)))}getACLPolicy(e){return Et("getACLPolicy()"),this.fetchLinksIfMissing([_.ACL_POLICY],e).then((()=>Mt(this._svc,this)))}checkACLPrivilege(e,t,r){return Et("checkACLPrivilege()"),a.validateParams(["privilege",e,"string"],["relation",t,"string"]),this.fetchLinksIfMissing([_.ACCESS_CHECK],r).then((()=>Xt(this._svc,this,e,t)))}patchACLPolicy(e,t,r){return Et("patchACLPolicy()"),a.validateParams(["policy",e,["string","object"]]),this.fetchLinksIfMissing([_.ACL_POLICY],r).then((()=>Bt(this._svc,this,e,t)))}deleteACLPolicy(e){return Et("deleteACLPolicy()"),this.fetchLinksIfMissing([_.ACL_POLICY],e).then((()=>xt(this._svc,this)))}getPrimaryResource(e,t){Et("getPrimaryResource()"),a.validateParams(["responseType",e,"string"]);const r={};return this._withSourcePromise(r).then((()=>this.fetchLinksIfMissing([_.PRIMARY],t))).then((()=>Dt.call(r,this._svc,this,e,t)))}copy(e,t,r,s,o){return Et("copy()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"],["manifestPatch",o,["object","string"],!0]),fe(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r,s,o).then((({response:e,result:t})=>({response:e,result:new yt(t,this.serviceConfig)})))}copyResources(e,t,r,s,o){return Et("copyResources()"),a.validateParams(["targetAsset",e,"object"],["resources",t,"array"],["manifestPatch",s,["object","string"],!0],["intermediates",r,"boolean",!0]),Ne(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path,version:this.version},e,t,r,s,o)}move(e,t,r,s){return Et("move()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"]),me(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r,s).then((({response:e,result:t})=>(this._data=Object.assign(Object.assign({},this._data),a.pruneUndefined(t)),{response:e,result:this})))}delete(e,t=!1,r){return Et("delete()"),a.validateParams(["etag",e,"string",!0],["recursive",t,"boolean"]),Ae(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r).then((e=>(this._data.state="DELETED",e)))}discard(e,t=!1,r){return Et("discard()"),a.validateParams(["etag",e,"string",!0],["recursive",t,"boolean"]),Ee(this.serviceConfig,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r).then((e=>(this._data.state="DISCARDED",e)))}package(e,t,r,s){return Et("package()"),a.validateParams(["destination",e,["object","string"]],["createIntermediates",t,"boolean"],["overwriteExisting",r,"boolean"]),De(this._svc,{repositoryId:this.repositoryId,assetId:this.assetId,path:this.path},e,t,r,s)}restore(e){return Et("restore()"),ye(this._svc,{repositoryId:this.repositoryId,assetId:this.assetId},e).then((({response:e,result:t})=>(this._data=Object.assign(Object.assign(Object.assign({},this._data),a.pruneUndefined(t)),{state:"ACTIVE"}),{response:e,result:this})))}_updateDataWithResponse(e){return e?(this._data.etag=e.headers.etag||this._data.etag,this._data.version=e.headers.version||this._data.version,this._data.assetId=e.headers["asset-id"]||this._data.assetId,this._data.md5=e.headers["content-md5"]||this._data.md5,this._data.repositoryId=e.headers["repository-id"]||this._data.repositoryId,e):e}_withSourcePromise(e){return h.default.resolve(void 0,e)}}function Dt(e,t,r,s){Et("getPrimaryResource()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["responseType",r,"enum",!0,w]),q(t.links,[_.PRIMARY]);const o=a.getLinkHref(t.links,_.PRIMARY);return ot.call({},e,t,o,_.PRIMARY,r,void 0,void 0,s)}function Ct(e,r,s){Et("headPrimaryResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.PRIMARY]);const o=a.getLinkHref(r.links,_.PRIMARY);return F(e).invoke(t.HTTPMethods.HEAD,o,s,void 0,{isStatusValid:z()}).then((t=>{const s=ae(t);r.links=a.merge(r.links||{},s);const o=Y(e);return o&&o.setValueWithAsset(r.links||{},r),t}))}function It(e,t,r="id",s,o){At("getResolveLinkForAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["mode",r,"enum",!1,["id","path"]],["resource",s,["string","object"],!0]),Z(t);const n={repositoryId:t.repositoryId,id:t.assetId,path:t.path,mode:r,resource:a.isObject(s)?JSON.stringify(s):s},i=F(e),d=W(t.assetId?"/content/directory/resolve{?repositoryId,id,resource,mode}":"/content/directory/resolve{?repositoryId,path,resource,mode}",i);return h.default.resolve(a.expandURITemplate(d,a.pruneUndefined(n)))}function vt(e,t,r="id",s,o,n){At("resolveAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["mode",r,"enum",!0,["id","path"]],["resource",s,["string","object"],!0]),Z(t);const i=F(e),d=Y(e),c=d&&t.assetId&&t.repositoryId&&"id"===r;return c&&(At("rA() set pending"),d.setPending(t.assetId,t.repositoryId)),It(e,t,r,s).then((e=>null==s?re(i,e,n):se(i,e,n,o))).then((e=>({response:e,result:Yt(t,e,"id"===r,d)}))).catch((e=>{throw c&&d.deleteWithAsset(t),e}))}function bt(e,t,r){return At("fetchLinksForAsset()"),Tt(e,t,r).then((e=>e.result.links))}function Tt(e,r,s){if(At("fetchAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),x(r))return vt(e,r,"id",void 0,void 0,s).then((e=>e));let n;try{n=K(r.links,[_.ID,_.REPO_METADATA,_.PRIMARY,_.PATH])}catch(e){throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset is not resolvable. Must contain repositoryId & path, assetId, or links.",e)}const i=a.getLinkHref(r.links,n),d=F(e),c=Y(e);return d.invoke(t.HTTPMethods.HEAD,i,s,void 0,{isStatusValid:z()}).then((e=>({result:Yt(r,e,n===_.ID,c),response:e})))}function Pt(e,r,s){At("getLinksForAsset()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]);const o=r.links||r[t.Properties.LINKS];if(a.isObject(o)&&0!==Object.keys(o).length)return h.default.resolve(o);const n=Y(e);if(n){const e=n.getValueWithAsset(r);if(e)return h.default.resolve(e)}return bt(e,r,s)}function wt(e,t){throw At("getBaseDirectoryMetadata()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}function Rt(e,r,s){At("getRepositoryResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.REPOSITORY]);const o=a.getLinkHref(r.links,_.REPOSITORY);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function Ot(e,r,s){Et("headAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.APP_METADATA]);const o=a.getLinkHref(r.links,_.APP_METADATA);return F(e).invoke(t.HTTPMethods.HEAD,o,s,void 0,{isStatusValid:z()}).then((t=>{const s=ae(t);r.links=a.merge(r.links||{},s);const o=Y(e);return o&&o.setValueWithAsset(r.links,r),t}))}function kt(e,r,s,o={}){At("getAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["etag",s,"string",!0]);const n=a.getLinkHref(r.links,_.APP_METADATA),i=Object.assign({},o);return s&&(i[t.HeaderKeys.IF_NONE_MATCH]=s),e.invoke(t.HTTPMethods.GET,n,i,void 0,{responseType:"json",isStatusValid:z([304])}).then((e=>{let t=e.response,r=e.headers.etag;return 304===e.statusCode&&(t=null,r=s),{result:t,response:e,etag:r}}))}function St(e,r,s,o,n={}){At("putAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["metadata",s,["object","string"]],["etag",o,"string",!0]),q(r.links,[_.APP_METADATA]);const i=a.getLinkHref(r.links,_.APP_METADATA);return e.invoke(t.HTTPMethods.PUT,i,a.pruneUndefined(Object.assign(n,{[t.HeaderKeys.IF_MATCH]:o,[t.HeaderKeys.CONTENT_TYPE]:m})),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z()}).then((e=>({response:e,result:{etag:e.headers.etag}})))}function Nt(e,r,s,o,n={}){At("patchAppMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["metadata",s,["object[]","string"]],["etag",o,"string"]),q(r.links,[_.APP_METADATA]);const i=a.getLinkHref(r.links,_.APP_METADATA);return e.invoke(t.HTTPMethods.PATCH,i,a.pruneUndefined(Object.assign(n,{[t.HeaderKeys.IF_MATCH]:o,[t.HeaderKeys.CONTENT_TYPE]:A})),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z()}).then((e=>({response:e,result:{etag:e.headers.etag}})))}function Lt(e,r,s){At("getEffectivePrivileges()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.EFFECTIVE_PRIVILAGES]);const o=a.getLinkHref(r.links,_.EFFECTIVE_PRIVILAGES);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function Mt(e,r,s){At("getACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.ACL_POLICY]);const o=a.getLinkHref(r.links,_.ACL_POLICY);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function Xt(e,r,s,o,n={}){At("checkACLPrivilege()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["privilege",s,"string",!1,["ack","read","write","delete"]]),q(r.links,[_.ACCESS_CHECK]);const i=a.getLinkHrefTemplated(r.links,_.ACCESS_CHECK,{privilege:s.toString(),relation:o});return e.invoke(t.HTTPMethods.GET,i,Object.assign({directive:"acl-check-no-body"},n),void 0,{responseType:"json",isStatusValid:z([403])}).then((e=>({result:403!==e.statusCode,response:e})))}function Bt(e,r,s,o,n={}){At("patchACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["policy",s,["string","object"]],["etag",o,"string",!0]),q(r.links,[_.ACL_POLICY]);const i=a.pruneUndefined(Object.assign(n,{[t.HeaderKeys.CONTENT_TYPE]:A,[t.HeaderKeys.IF_MATCH]:o})),d=a.getLinkHref(r.links,_.ACL_POLICY);return F(e).invoke(t.HTTPMethods.PATCH,d,i,"string"==typeof s?s:JSON.stringify(s),{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function xt(e,r,s={}){At("deleteACLPolicy()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.ACL_POLICY]);const o=a.getLinkHref(r.links,_.ACL_POLICY);return F(e).invoke(t.HTTPMethods.DELETE,o,s,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function jt(e,r,s,n,i){At("useLinkOrResolveResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["resource",s,"string"]);const d=F(e);let c;try{c=a.getLinkHref(r.links,s)}catch(e){}return h.default.resolve(c).then((t=>{if("string"==typeof t)return At("uLORR() asset has link"),t;const o=Y(e);return Ft(r,o,[s])})).then((e=>{if("string"==typeof e)return e;try{return a.getLinkHref(e,s)}catch(e){return}})).then((a=>{if("string"==typeof a)return At("uLORR() cache or asset had link"),d.invoke(t.HTTPMethods.GET,a,i,void 0,{isStatusValid:z(),responseType:n});if(!x(r))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset is not resolvable. Must contain repository ID + path/id or links.");return vt(e,r,"id",s,n,i)})).then((e=>L(e)?e:{result:r,response:e}))}function Ut(e,t,r=[],s=!1,o){return Ht(e,t,r,s,o).then((({result:e})=>e))}const Vt=new Set([_.BASE_DIRECTORY,_.RESOLVE_BY_ID,_.RESOLVE_BY_PATH,_.REPO_OPS,_.REPOSITORY,_.DIRECTORY,_.DISCARD,_.RESTORE,_.PATH,_.ANNOTATIONS]);function Ht(e,r,s=[],n=!1,i){if(At("fetchLinksIfMissing()",s),a.validateParams(["svc",e,"object"],["asset",r,"object"],["linksToPopulate",s,"string[]"],["suppressMissingErrors",n,"boolean",!0]),$(r.links,s))return At("fLIM() links exist"),h.default.resolve({result:r.links});const d=Y(e);return Ft(r,d,s,!0).then((o=>o||(function(e,t){return"string"==typeof e.assetId&&e.assetId.length>0&&t.every((e=>!Vt.has(e)))}(r,s)?function(e,r,s){const o=function(e,t){At("getLinksAPIUrlForAsset()"),a.validateParams(["svc",e,"object"],["asset",t,"object"]);const r=W("/links{?assetId,repositoryId,clientRegion}",F(e)),{assetId:s,repositoryId:o,contentRegion:n}=t,i=a.pruneUndefined({assetId:s,repositoryId:o,contentRegion:n});return a.expandURITemplate(r,i)}(e,r);return F(e).invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json"}).then((t=>{const s=Y(e);return r.links=Object.assign({},r.links,t.response._links),null==s||s.setValueWithAsset(r.links,r),{response:t,result:r}}))}(e,r,i):(At("fLIM() fetching links"),Tt(e,r,i))))).then((t=>{let i,d,c=t;if(L(t)&&(i=t.response,c=t.result.links,d=t.result),r.links!==c){r.links=a.merge(r.links||{},c);const t=Y(e);t&&t.setValueWithAsset(r.links,r)}if(!n&&!$(c,s))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Required links could not be fetched for asset.",void 0,i,a.pruneUndefined({required:s,asset:d}));return At("fLIM() fetchedOCached exists"),{result:c||r.links,response:i}}))}function Ft(e,t,r,s){if(At("getLinksFromCache()"),!t)return h.default.resolve(void 0);const o=t.getValueWithAsset(e);return null==o?(s&&t.setPending(e.assetId,e.repositoryId),h.default.resolve(void 0)):h.default.resolve(o).then((o=>r?$(o,r)?o:void(s&&t.setPending(e.assetId,e.repositoryId)):o))}function Yt(e,r,s,o){const n=ae(r),i=Object.assign(Object.assign(Object.assign({},function(e){return a.isObject(e.asset)?e.asset:e}(e)),a.pruneUndefined({assetId:r.headers["asset-id"]||r.headers["x-resource-id"],format:r.headers[t.HeaderKeys.CONTENT_TYPE],md5:r.headers["content-md5"],etag:r.headers.etag,version:r.headers.version,repositoryId:r.headers["repository-id"]})),{links:n});return s&&n&&Object.keys(n).length>0&&o&&o.setValueWithAsset(n,i),i}const Wt=n.newDebug("dcx:assets:blockupload"),zt=n.newDebug("dcx:assets:blockupload:leaf");class qt extends a.EventEmitter{constructor(e,r,s,n,i,d,c,l,u,p,f,g,m){super(["stateChanged"]),this._internalBlockUploadId=a.generateUuid(),this._state=t.BlockTransferStates.NOT_INITIALIZED,this._currentBlockIndex=0,this._pendingBlockRequests=[],this._bytesUploaded=0,this._totalBlocksUploaded=0,this._indeterminateTransfer=!1,this._service=e,this._getSliceCallback=r,V(s)?(a.validateParams([t.BlockTransferProperties.REPO_SIZE,s[t.BlockTransferProperties.REPO_SIZE],"number"]),this._blockTransferDocument=s,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][_.BLOCK_TRANSFER],this._dataSize=this._blockTransferDocument[t.BlockTransferProperties.REPO_SIZE],this._relationType=this._blockTransferDocument[t.BlockTransferProperties.REPO_REL_TYPE],this._shiftState(t.BlockTransferStates.INITIALIZED),Wt(`BlockUpload Initialized: Transfer document found with ${this._transferBlockLinks.length} links. BlockUploadId: ${this._internalBlockUploadId}`)):(a.validateParams(["relationType",n,"string"],["dataSize",i,"number"],["contentType",d,"string"],["componentId",c,"string",!0],["etag",u,"string",!0]),this._asset=s,q(this._asset.links,[_.BLOCK_UPLOAD_INIT],o.DCXError.UNEXPECTED,"/rel/block/init missing from BlockTransferDocument."),this._relationType=n,this._dataSize=i,this._contentType=d,this._componentId=c,this._md5=l,this._ifMatch=u),this._relPath=p,this._createIntermediates=f,this._respondWith=g,this._repoMetaPatch=m,this._promise=new h.default(((e,t)=>{this._reject=t,this._resolve=e})),Ke.uploads.push(this)}init(e){if(this._assertStateIsValid("init"),!this._blockTransferDocument||!this._blockTransferDocument[t.Properties.LINKS]){this._shiftState(t.BlockTransferStates.INITIALIZING);const r=a.pruneUndefined(Object.assign({[t.BlockTransferProperties.REPO_REL_TYPE]:this._relationType,[t.BlockTransferProperties.REPO_IF_MATCH]:this._ifMatch,[t.BlockTransferProperties.REPO_SIZE]:this._dataSize,[t.BlockTransferProperties.DC_FORMAT]:this._contentType,[t.BlockTransferProperties.COMPONENT_ID]:this._componentId,[t.BlockTransferProperties.REPO_MD5]:this._md5},this._blockTransferDocument));return Kt(this._service,this._asset,r,e).then((e=>(this._blockTransferDocument=e.result,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][_.BLOCK_TRANSFER],this._shiftState(t.BlockTransferStates.INITIALIZED),Wt(`BlockUpload Initialized: Transfer document found with ${this._transferBlockLinks.length} links. BlockUploadId: ${this._internalBlockUploadId}`),this)))}return h.default.resolve(this)}get state(){return this._state}get promise(){return this._promise}start(){return this._assertStateIsValid("start"),Ke.uploads[0]!==this||this._state!==t.BlockTransferStates.INITIALIZED&&this._state!==t.BlockTransferStates.PAUSED||(Wt(`Starting the transfer of BlockUpload: ${this._internalBlockUploadId}`),this._shiftState(t.BlockTransferStates.STARTED),this._uploadLoop()),this._promise}pause(){return this._assertStateIsValid("pause"),this._shiftState(t.BlockTransferStates.PAUSING),h.default.allSettled(this._pendingBlockRequests).then((()=>(this._shiftState(t.BlockTransferStates.PAUSED),Wt(`BlockUploading has been paused.  BlockUploadId: ${this._internalBlockUploadId}`),this)))}resume(){return this._assertStateIsValid("resume"),Wt(`BlockUploading has been resumed.  BlockUploadId: ${this._internalBlockUploadId}`),this.start(),this}cancel(){this._assertStateIsValid("cancel"),this._shiftState(t.BlockTransferStates.CANCELED),Wt(`A BlockUpload has been canceled... BlockUploadId: ${this._internalBlockUploadId}`),this._promise.cancel(),this._cancel()}_setWaiting(){this._shiftState(t.BlockTransferStates.WAITING)}uploadNextBlock(e){if(this._assertStateIsValid("uploadNextBlock"),this._isEmptyBlock(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Trying to upload empty data block.");const r=this._blockTransferDocument[t.Properties.LINKS][_.BLOCK_TRANSFER][this._currentBlockIndex].href;let s;Wt(`Uploading a block... BlockUploadId: ${this._internalBlockUploadId}`);const n=He(e),i=this._uploadBlock(e,r).then((e=>(this._totalBlocksUploaded++,this._updateProgress(n),s(),Wt(`A block has completed... ${this._pendingBlocksCount} requests still active. BlockUploadId: ${this._internalBlockUploadId}`),e))).catch((e=>{Wt(`A block upload has failed. BlockUploadId: ${this._internalBlockUploadId}`),s(),this._shiftState(t.BlockTransferStates.ERROR),this._reject(new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"A block has failed during upload",e,e.response)),this.cancel()}));return s=this._pushPendingBlockRequest(i),i}get _pendingBlocksCount(){return Ke.pendingUploadRequests.filter((e=>!!e)).length}_nextBlockLock(){return this._pendingBlocksCount<4?Promise.resolve():Promise.race(Ke.pendingUploadRequests.filter((e=>!!e)))}_handleAssetMoved(e){throw Wt("_handleAssetMoved"),this._pendingBlockRequests.forEach((e=>{e.abort()})),this._pendingBlockRequests.length=0,this._transferBlockLinks.length=0,this._asset.links=Object.assign(Object.assign({},this._asset.links),ae(e.response)),this._currentBlockIndex=0,this._bytesUploaded=0,this._state=t.BlockTransferStates.NOT_INITIALIZED,this._blockTransferDocument[t.Properties.LINKS]=void 0,this.init().then((()=>this.start())),t.BlockTransferStates.INITIALIZING}_uploadLoop(){this._nextBlockLock().then((()=>{if(this._state===t.BlockTransferStates.FINALIZING||this._state===t.BlockTransferStates.COMPLETE)throw t.BlockTransferStates.COMPLETE;if(this._state===t.BlockTransferStates.PAUSING||this._state===t.BlockTransferStates.PAUSED)throw t.BlockTransferStates.PAUSED;if(this._state===t.BlockTransferStates.CANCELED)throw t.BlockTransferStates.CANCELED;if(this._state===t.BlockTransferStates.ERROR)throw t.BlockTransferStates.ERROR})).then((()=>this._getBlockAtIndex(this._currentBlockIndex))).then((e=>this._isEmptyBlock(e)?(Wt(`No more blocks.  BlockUploadId: ${this._internalBlockUploadId}`),Promise.all(this._pendingBlockRequests).then(this._finalize.bind(this))):e&&He(e)>0&&this._currentBlockIndex>=this._transferBlockLinks.length?this._extend().then((()=>e)):e)).then((e=>{if(!e)throw t.BlockTransferStates.COMPLETE;this.uploadNextBlock(e),this._currentBlockIndex++})).then((()=>{this._uploadLoop()})).catch((e=>{if("string"!=typeof e&&(this._continueBlockUploads(),this._reject(e)),e!==t.BlockTransferStates.INITIALIZING)if(e!==t.BlockTransferStates.COMPLETE){if(e!==t.BlockTransferStates.PAUSED)return e===t.BlockTransferStates.CANCELED?(Wt(`BlockUpload loop is terminated due to the upload being canceled. BlockUploadId: ${this._internalBlockUploadId}`),void this._continueBlockUploads()):e===t.BlockTransferStates.ERROR?(Wt(`BlockUpload loop is terminated due to error state. BlockUploadId: ${this._internalBlockUploadId}`),void this._continueBlockUploads()):void 0;Wt(`BlockUpload loop is terminated due to paused state. BlockUploadId: ${this._internalBlockUploadId}`)}else Wt(`BlockUpload loop is complete. BlockUploadId: ${this._internalBlockUploadId}`);else Wt(`BlockUpload loop must be re-started due to assetmoved BlockUploadId: ${this._internalBlockUploadId}`)}))}_getBlockAtIndex(e){Wt(`_getBlockAtIndex(${e})`);const r=Math.min(this._dataSize,this._blockTransferDocument[t.BlockTransferProperties.REPO_BLOCK_SIZE]);if(this._state===t.BlockTransferStates.STARTED){const t=e*r;return Wt("calling _getSliceCallback",t,t+r),this._getSliceCallback(t,t+r).catch((e=>{throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"The getSliceCallback threw an unexpected error.",e)}))}}_uploadBlock(e,r){return this._service.invoke(t.HTTPMethods.PUT,r,void 0,e,{isStatusValid:z(),isExternalRequest:!0})}_isEmptyBlock(e){return"string"==typeof e?0===e.length:B(e)?0===e.size:!e||0===e.byteLength}_extend(){q(this._blockTransferDocument[t.Properties.LINKS],[_.BLOCK_EXTEND],o.DCXError.UNEXPECTED,"The transfer document does not contain an extend href");const e=Math.ceil(1.5*this._blockTransferDocument[t.BlockTransferProperties.REPO_SIZE]),r=a.getLinkHrefTemplated(this._blockTransferDocument[t.Properties.LINKS],_.BLOCK_EXTEND,{size:e});return this._service.invoke(t.HTTPMethods.POST,r,{},void 0,{isStatusValid:z(),responseType:"json"}).then((e=>(this._indeterminateTransfer=!0,this._blockTransferDocument=e.response,this._transferBlockLinks=this._blockTransferDocument[t.Properties.LINKS][_.BLOCK_TRANSFER],Wt(`Transfer document was extended to ${this._transferBlockLinks.length} transfer links. BlockUploadId: ${this._internalBlockUploadId}`),e))).catch((e=>{throw o.isAdobeDCXError(e)&&e.problemType===o.ProblemTypes.ASSET_MOVED&&this._handleAssetMoved(e),new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"An unexpected error occurred while extending the block transfer document.",e,e.response)}))}_pushPendingBlockRequest(e){const t=this._pendingBlockRequests.push(e),r=Ke.pendingUploadRequests.push(e);return()=>{delete this._pendingBlockRequests[t-1],delete Ke.pendingUploadRequests[r-1]}}_updateProgress(e){if(Wt("_updateProgress()",e),"number"==typeof e&&(this._bytesUploaded+=e),this.onProgress&&a.isAnyFunction(this.onProgress))try{this.onProgress(this._bytesUploaded,Math.max(this._blockTransferDocument[t.BlockTransferProperties.REPO_SIZE],this._bytesUploaded),this._indeterminateTransfer)}catch(e){console.error("Error in onProgress callback",e)}}_cancel(){this._pendingBlockRequests.map((e=>{e&&e.cancel()})),this._state!==t.BlockTransferStates.ERROR&&this._resolve(this)}_assertStateIsValid(e,r){const s=r||this._state;switch(e){case"init":if(s!==t.BlockTransferStates.NOT_INITIALIZED&&s!==t.BlockTransferStates.INITIALIZED)throw new o.DCXError(o.DCXError.INVALID_STATE,"BlockUpload has already been initialized");break;case"start":if(s===t.BlockTransferStates.NOT_INITIALIZED)throw new o.DCXError(o.DCXError.INVALID_STATE,"Please call init before starting the block upload");break;case"uploadNextBlock":if(s===t.BlockTransferStates.PAUSED||s===t.BlockTransferStates.CANCELED)throw new o.DCXError(o.DCXError.INVALID_STATE,"Cannot add block when Paused or Cancelled");break;case"getBlockAtIndex":if(s!==t.BlockTransferStates.STARTED)throw new o.DCXError(o.DCXError.INVALID_STATE,`Cannot fetch block while in the ${s} state`);break;case"cancel":if(s!==t.BlockTransferStates.STARTED&&s!==t.BlockTransferStates.FINALIZING&&s!==t.BlockTransferStates.PAUSING&&s!==t.BlockTransferStates.PAUSED&&s!==t.BlockTransferStates.ERROR)throw new o.DCXError(o.DCXError.INVALID_STATE,`Trying to cancel while in an invalid state ${s}`)}}_continueBlockUploads(){if(Wt("continueBlockUploads()"),Ke.uploads[0]===this)if(Ke.uploads.shift(),Ke.uploads.length>0){const e=Ke.uploads[0];Wt("Another block upload found in the queue, starting..."),e.start()}else 0===this._pendingBlocksCount&&(Wt("There are no more pending block transfers.. Clean up blockUploadManager.."),Ke.resetUploads())}_finalize(){Wt(`Finalizing block transfer.  BlockUploadId: ${this._internalBlockUploadId}`),this._shiftState(t.BlockTransferStates.FINALIZING);const e=a.getLinkHrefTemplated(this._blockTransferDocument[t.Properties.LINKS],_.BLOCK_FINALIZE,a.pruneUndefined({path:this._relPath,intermediates:this._createIntermediates,respondWith:a.isObject(this._respondWith)?JSON.stringify(this._respondWith):this._respondWith,repoMetaPatch:this._repoMetaPatch}));return this._blockTransferDocument[t.Properties.LINKS][_.BLOCK_TRANSFER]=this._transferBlockLinks.slice(0,this._totalBlocksUploaded),this._service.invoke(t.HTTPMethods.POST,e,{[t.HeaderKeys.CONTENT_TYPE]:y},JSON.stringify(a.pruneUndefined(this._blockTransferDocument)),{isStatusValid:z(),retryOptions:{pollHeader:"location",pollCodes:[202],timeoutAfter:12e4},responseType:"arraybuffer"}).then((e=>{if(200===e.statusCode||201===e.statusCode){Wt(`Finalize complete.  BlockUploadId: ${this._internalBlockUploadId}`);const r=ut(new Uint8Array(e.response));if(this._relationType===_.PRIMARY){if(this.finalizeResponse=r,this.createdAsset=a.pruneUndefined({assetId:r.headers["asset-id"],repositoryId:r.headers["repository-id"],links:de(r.headers.link),etag:r.headers.etag,md5:r.headers["content-md5"]}),r.response&&this._respondWith)try{const e=JSON.parse(a.arrayBufferToString(r.response));r.response=e,this.createdAsset=a.mergeDeep(this.createdAsset,le(e))}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected error parsing respondWith parameter",e)}}else{this.finalizeResponse=e;try{this.uploadRecord=We(this._blockTransferDocument[t.BlockTransferProperties.DC_FORMAT],this._blockTransferDocument[t.BlockTransferProperties.COMPONENT_ID],this._bytesUploaded,a.arrayBufferToString(e.response))}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"An error occurred while deserializing upload component record.",e,r)}}this._shiftState(t.BlockTransferStates.COMPLETE),this._updateProgress(!0),this._resolve(this)}this._continueBlockUploads()})).catch((e=>{o.isAdobeDCXError(e)&&e.problemType===o.ProblemTypes.ASSET_MOVED&&this._handleAssetMoved(e),Wt("Error occurred finalizing the block transfer.. Rejecting"),this._reject(new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"An error occurred while finalizing the block transfer.",e,e.response)),this._continueBlockUploads()}))}_shiftState(e){return Wt(`_shiftState(): ${e}`),this._state===t.BlockTransferStates.COMPLETE||this._state===t.BlockTransferStates.ERROR||this._state===t.BlockTransferStates.CANCELED||(this._state=e,this.emit("stateChanged",[this._state])),this}}function Kt(e,r,s,n={}){if(a.validateParams(["svc",e,"object"],["asset",r,"object"],["transferDocument",s,"object"],["additionalHeaders",n,"object",!0]),q(r.links,[_.BLOCK_UPLOAD_INIT]),s["repo:resource"]){if(!s["repo:resource"].reltype)throw new o.DCXError(o.DCXError.INVALID_DATA,"reltype param is required in the Resource Designator");s[t.BlockTransferProperties.REPO_REL_TYPE]=s["repo:resource"].reltype,s["repo:resource"].component_id&&(s[t.BlockTransferProperties.COMPONENT_ID]=s["repo:resource"].component_id),s["repo:resource"].etag&&(s[t.BlockTransferProperties.REPO_IF_MATCH]=s["repo:resource"].etag),delete s["repo:resource"]}if(s[t.BlockTransferProperties.REPO_REL_TYPE]===_.COMPONENT&&!s[t.BlockTransferProperties.COMPONENT_ID])throw new o.DCXError(o.DCXError.INVALID_DATA,"Component Id required to block upload to a component");const i=a.getLinkHref(r.links,_.BLOCK_UPLOAD_INIT);n[t.HeaderKeys.CONTENT_TYPE]=y;const d=a.normalizeHeaders(n);return d.priority=d.priority||"u=1",e.invoke(t.HTTPMethods.POST,i,d,JSON.stringify(s),{responseType:"json",isStatusValid:z()}).then((e=>({response:e,result:e.response})))}function Gt({additionalHeaders:e,asset:t,componentId:r,contentType:s,dataOrSliceCallback:o,etag:n,maybeIsNew:i,md5:d,progressCb:c,relation:l,size:u,svc:p,blockSize:_}){zt("_upload()"),a.validateParams(["svc",p,"object"],["asset",t,"object"],["size",u,"number",!0],["md5",d,"string",!0],["etag",n,"string",!0]);const f=Fe(o,u),g=He(f),m=F(p);if(je(t,g))return $t({asset:t,additionalHeaders:e,componentId:r,contentType:s,dataOrSliceCallback:o,etag:n,md5:d,progressCb:c,relation:l,size:u,service:m,blockSize:_});q(t.links,[l]);const E=a.getLinkHrefTemplated(t.links,l,{component_id:r});return h.default.resolve(void 0,{blockUpload:void 0,progress:c}).then((()=>Promise.resolve(a.isAnyFunction(o)?o(0,g):o))).then((r=>nt({asset:t,additionalHeaders:e,contentType:s,data:r,etag:n,headHref:E,href:E,maybeIsNew:i,relation:l,service:m}))).then((e=>{let r={};try{r=ae(e),t.links=a.merge(t.links||{},r);const s=Y(p);s&&s.setValueWithAsset(t.links,t)}catch(e){}return{response:e,result:{revision:e.headers.revision||e.headers.version,location:e.headers.location,links:r,etag:e.headers.etag,version:e.headers.version||e.headers.revision,md5:e.headers.md5||e.headers["content-md5"],length:g,type:s},isBlockUpload:!1,asset:{assetId:t.assetId||e.headers["asset-id"],repositoryId:t.repositoryId||e.headers["repository-id"],links:t.links||r}}})).catch((e=>{throw e}))}function $t({service:e,asset:r,additionalHeaders:s,dataOrSliceCallback:n,contentType:i,progressCb:d,relation:c,size:h,componentId:l,md5:u,etag:p,relPath:f,createIntermediates:g,respondWith:m,blockSize:E,repoMetaPatch:A}){if(!h)throw new o.DCXError(o.DCXError.INVALID_DATA,"A size estimate is required when a GetSliceCallback is provided. The size is used to determine the number of requests required to block transfer the asset.");const y=a.isAnyFunction(n)?n:function(e){if(!a.isFunction(e.slice))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Data cannot be sliced");return function(t,r){return O(this,void 0,void 0,(function*(){return e.slice(t,r)}))}}(n);q(r.links,[_.BLOCK_UPLOAD_INIT]);const D=Kt(e,r,a.pruneUndefined({[t.BlockTransferProperties.REPO_REL_TYPE]:c,[t.BlockTransferProperties.REPO_IF_MATCH]:p,[t.BlockTransferProperties.REPO_SIZE]:h,[t.BlockTransferProperties.DC_FORMAT]:i,[t.BlockTransferProperties.COMPONENT_ID]:l,[t.BlockTransferProperties.REPO_MD5]:u,[t.BlockTransferProperties.REPO_BLOCK_SIZE]:E}),s);return D.then((t=>{const r=new qt(e,y,t.result,c,h,i,l,u,p,f,g,m,A);return r.onProgress=d,Object.assign(D,{blockUpload:r}),r.init(s)})).then((e=>e.start())).then((e=>{const t=e.finalizeResponse||{headers:{}};return{response:t,result:e.uploadRecord||e.createdAsset,blockUpload:e,isBlockUpload:!0,asset:{assetId:t.headers["asset-id"]||r.assetId,repositoryId:t.headers["repository-id"]||r.repositoryId,etag:t.headers.etag,links:r.links}}}))}const Jt=Ke;function Zt(e){return e||"defaultbuffer"}function Qt(e,r,s="json",o={}){a.validateParams(["svc",e,"object"],["asset",r,"object"],["format",s,"enum",!1,["json","xml"]]),q(r.links,[_.EMBEDDED_METADATA]);const n=a.getLinkHref(r.links,_.EMBEDDED_METADATA);return e.invoke(t.HTTPMethods.GET,n,Object.assign(Object.assign({},o),{accept:t.EmbeddedMetadataMediaTypes[s.toUpperCase()],vary:"accept"}),void 0,{isStatusValid:z(),responseType:"json"===s?"json":"text"}).then((e=>({result:e.response,response:e})))}function er(e,r,s,o,n="json",i={}){a.validateParams(["svc",e,"object"],["asset",r,"object"],["data",s,["string","object","object[]"]],["etag",o,"string",!0],["format",n,"enum",!1,["json","xml"]]),q(r.links,[_.EMBEDDED_METADATA]);const d=a.getLinkHref(r.links,_.EMBEDDED_METADATA),c=Object.assign(Object.assign({},i),{[t.HeaderKeys.CONTENT_TYPE]:t.EmbeddedMetadataMediaTypes[n.toUpperCase()],[t.HeaderKeys.IF_MATCH]:o});return e.invoke(t.HTTPMethods.PUT,d,c,"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z()})}function tr(e,r,s,o,n={}){a.validateParams(["svc",e,"object"],["asset",r,"object"],["data",s,["string","object","object[]"]],["etag",o,"string",!0]),q(r.links,[_.EMBEDDED_METADATA]);const i=a.getLinkHref(r.links,_.EMBEDDED_METADATA);return e.invoke(t.HTTPMethods.PATCH,i,Object.assign(n,{[t.HeaderKeys.CONTENT_TYPE]:A,[t.HeaderKeys.IF_MATCH]:o}),"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z(),retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:"GET"}})}const rr=n.newDebug("dcx:assets:filebase"),sr=n.newDebug("dcx:assets:filebase:leaf"),or="application/vnd.adobe.versions+json";class nr extends yt{constructor(e,r,s){super(e,r,s),this._data.width=null!=e.width?e.width:e[t.Properties.IMAGE_WIDTH],this._data.length=null!=e.length?e.length:e[t.Properties.IMAGE_LENGTH],this._data.renderable=null!=e.renderable?e.renderable:"object"==typeof this._data.links?_.RENDITION in this._data.links:void 0}get width(){return this._data.width}get length(){return this._data.length}get renderable(){return this._data.renderable}getRendition(e,t,r,s){return rr("getRendition()"),a.validateParams(["opts",e,"object",!0],["responseType",t,"string",!0],["linkProvider",r,"object",!0]),this.fetchLinksIfMissing([_.RENDITION],s).then((()=>ir(this._svc,this,e,t,r,s)))}getEmbeddedMetadata(e="json",t){return rr("getEmbeddedMetadata()"),a.validateParams(["format",e,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([_.EMBEDDED_METADATA],t).then((()=>Qt(this._svc,this,e,t)))}putEmbeddedMetadata(e,t,r="json",s){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0],["format",r,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([_.EMBEDDED_METADATA],s).then((()=>er(this._svc,this,e,t,r,s)))}patchEmbeddedMetadata(e,t,r){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([_.EMBEDDED_METADATA],r).then((()=>tr(this._svc,this,e,t,r)))}blockDownload(e,t,r,s,o,n,i){rr("blockDownload()"),a.validateParams(["startByte",e,"number",!0],["endByte",t,"number",!0],["resource",r,"string",!0],["componentId",s,"string",!0],["version",o,"string",!0],["responseType",n,"enum",!0,w]),a.assert((()=>null==e||null==t||e<t),"endByte must be greater than startByte");const d={};return this._withSourcePromise(d).then((()=>this.fetchLinksIfMissing([_.BLOCK_DOWNLOAD]))).then((()=>ar.call(d,this._svc,this,e,t,r,s,o,n,i)))}updatePrimaryResource(e,t,r,s,o,n){rr("updatePrimaryResource()");const i=a.isAnyFunction(e)?_.BLOCK_UPLOAD_INIT:_.PRIMARY;return this.fetchLinksIfMissing([i],n).then((()=>dr(this.serviceConfig,this,e,t,r,s,o,n))).then((e=>(this._data.etag=e.result.etag,this._data.md5=e.result.md5,this._data.length=e.result.length,this._data.version=e.result.version,e)))}}function ir(e,r,s,o="defaultbuffer",n,i){sr("getRendition()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["renditionOptions",s,"object",!0],["linkProvider",n,"object",!0]),q(r.links,[_.RENDITION]);const d=n?a.provideLink(r.links[_.RENDITION],n,s):a.getLinkHrefTemplated(r.links,_.RENDITION,Object.assign({},s));return e.invoke(t.HTTPMethods.GET,d,i,void 0,{responseType:Zt(o),isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function ar(e,t,r,s,o,n,i,d,c){sr("doBlockDownload()"),a.validateParams(["svc",e,"object"],["assetOrPresignedUrl",t,["object","string"]],["startByte",r,"number",!0],["endByte",s,"number",!0],["resource",o,"string",!0],["componentId",n,"string",!0],["version",i,"string",!0],["responseType",d,"enum",!0,w]),a.assert((()=>null==r||null==s||r<s),"endByte must be greater than startByte");const h=null!=this?this:{};if("string"==typeof t)return et.call(h,e,t,r,s,d,!0,void 0,c);const l=t;q(l.links,[_.BLOCK_DOWNLOAD]);const u=a.pruneUndefined({reltype:o,component_id:n,revision:i}),p=a.getLinkHrefTemplated(l.links,_.BLOCK_DOWNLOAD,{resource:void 0!==o?JSON.stringify(u):void 0});return et.call(h,e,p,r,s,d,!1,void 0,c)}function dr(e,t,r,s,o,n,i,d){return sr("updatePrimaryResource()"),a.validateParams(["service",e,"object"],["asset",t,"object"],["dataOrSliceCallback",r,["function","object","string"]],["contentType",s,"string"],["size",o,"number",!0],["md5",i,"string",!0]),q(t.links,[_.PRIMARY]),Gt({svc:e,asset:t,dataOrSliceCallback:r,contentType:s,relation:_.PRIMARY,size:o,md5:i,maybeIsNew:!1,etag:n,additionalHeaders:d}).catch((a=>{var c;if(413===(null===(c=a.response)||void 0===c?void 0:c.statusCode))return $t({service:F(e),asset:t,dataOrSliceCallback:r,contentType:s,relation:_.PRIMARY,size:o,md5:i,etag:n,additionalHeaders:d});throw a}))}const cr=n.newDebug("dcx:assets:pagination");class hr{constructor(e,t,r,s){if(this._links=e,this._svc=t,this._transformer=r,this._items={},this.ListResource=s,!e||!e[_.PAGE])throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Asset must have links that contain a page relation.")}get items(){return Object.values(this._items)}get data(){return this._data}getPage(e={},r){cr("getPage()");const{embed:s}=e,o=R(e,["embed"]);s&&(o.embed=s.some((e=>"object"==typeof e))?JSON.stringify(s):s.join(",")),this.ListResource&&Object.assign(o,{resource:this.ListResource});const n=a.getLinkHrefTemplated(this._links,_.PAGE,o);return this._svc.invoke(t.HTTPMethods.GET,n,r,void 0,{isStatusValid:z(),responseType:"json"}).then((e=>{const t=this.parseResponse(e);return this._data=t,{paged:this,result:this._data,response:e}}))}getNextPage(){if(cr("getNextPage()"),this.hasNextPage()&&this._nextPageLink)return this._svc.invoke(t.HTTPMethods.GET,this._nextPageLink.href,void 0,void 0,{isStatusValid:z(),responseType:"json"}).then((e=>{const t=this.parseResponse(e);return this._data=t,{paged:this,result:this._data,response:e}}))}hasNextPage(){return cr("hasNextPage() ",void 0!==this._nextPageLink),void 0!==this._nextPageLink}*[Symbol.iterator](){for(const e in this._items)yield this._items[e]}[Symbol.asyncIterator](){return function(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,o=r.apply(e,t||[]),n=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){o[e]&&(s[e]=function(t){return new Promise((function(r,s){n.push([e,t,r,s])>1||a(e,t)}))})}function a(e,t){try{(r=o[e](t)).value instanceof k?Promise.resolve(r.value.v).then(d,c):h(n[0][2],r)}catch(e){h(n[0][3],e)}var r}function d(e){a("next",e)}function c(e){a("throw",e)}function h(e,t){e(t),n.shift(),n.length&&a(n[0][0],n[0][1])}}(this,arguments,(function*(){for(const e in this._items)yield yield k(this._items[e]);for(;this.hasNextPage();){const e=yield k(this.next());for(const t of e.value.paged)yield yield k(t)}}))}next(){return O(this,void 0,void 0,(function*(){if(cr("next()"),!this.hasNextPage())return{done:!0,value:void 0};const e=yield this.getNextPage();return e?{done:!1,value:e}:{done:!0,value:void 0}}))}parseResponse(e){cr("parseResponse()"),this._items={};const r=e.response;for(const e in r[t.Properties.CHILDREN]){const s=r[t.Properties.CHILDREN][e],[o,n]=this._transformer(s,this._svc);this._items[o]=n}return this._nextPageLink=r[t.Properties.LINKS].next,this.currentPage=r[t.Properties.PAGE],r}}const lr=n.newDebug("dcx:assets:version"),ur=n.newDebug("dcx:assets:version:leaf");class pr extends nr{constructor(e,t,r){super(e,t,r),this._svc=t,this.type=l.Version,this._data=gr(e)}get milestone(){return this._data.milestone}getRepositoryResource(){throw lr("getRepositoryResource()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}getEffectivePrivileges(){throw lr("getEffectivePrivileges()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}performBulkRequest(e,t){throw lr("performBulkRequest()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}checkACLPrivilege(e,t){throw lr("checkACLPrivilege()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}getACLPolicy(){throw lr("getACLPolicy()"),new o.DCXError(o.DCXError.NOT_IMPLEMENTED,"Method not implemented.")}}function _r(e){ur("adobeVersionTransformer()");const t=gr(e);return t.links=a.merge({},e.links,e._links),[t.version,t]}function fr(e,t){ur("versionTransformer()");const r=new pr(e,t);return[r.version,r]}function gr(e){return ur("deserializeVersion()"),{version:e.version||e[t.VersionProperties.VERSION],createDate:e.created||e[t.VersionProperties.CREATED],createdBy:e.createdBy||e[t.VersionProperties.CREATED_BY],milestone:e.milestone||e[t.VersionProperties.MILESTONE],links:e._links}}const mr=n.newDebug("dcx:assets:file"),Er=n.newDebug("dcx:assets:file:leaf");class Ar extends nr{constructor(e,t,r){super(e,t,r),this.type=l.File}getPagedVersions(e={itemTransformer:fr},t){return mr("getPagedVersions()"),a.validateParams(["pageOpts",e,"object",!0]),this.fetchLinksIfMissing([_.PAGE],t).then((()=>Cr(this._svc,this,e,t)))}getVersionResource(e,t){return mr("getVersionResource()"),a.validateParams(["version",e,"string"]),this.fetchLinksIfMissing([_.PAGE],t).then((()=>Dr(this._svc,this,e,t).then((e=>({result:e.result?new pr(e.result,this._svc):void 0,response:e.response})))))}patchVersions(e,t,r){return mr("patchVersions()"),a.validateParams(["patchDoc",e,["string","array"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([_.VERSION_HISTORY],r).then((()=>yr(this._svc,this,e,t,r)))}initBlockUpload(e,t){return a.validateParams(["transferDocument",e,"object"],["additionalHeaders",t,"object",!0]),this.fetchLinksIfMissing([_.BLOCK_UPLOAD_INIT],t).then((()=>Kt(this._svc,this,e,t)))}copy(e,t,r,s,o){return super.copy(e,t,r,s,o).then((({response:e,result:t})=>({response:e,result:new Ar(t,this.serviceConfig)})))}}function yr(e,r,s,o,n){Er("patchVersions()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["patchDoc",s,["string","array"]],["etag",o,"string",!0]),q(r.links,[_.VERSION_HISTORY]);const i=Object.assign(Object.assign({},n),{[t.HeaderKeys.CONTENT_TYPE]:A});o&&(i[t.HeaderKeys.IF_MATCH]=o);const d=a.getLinkHref(r.links,_.VERSION_HISTORY);return e.invoke(t.HTTPMethods.PATCH,d,i,"string"==typeof s?s:JSON.stringify(s),{isStatusValid:z()})}function Dr(e,r,s,o){Er("getVersionResource()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["version",s,"string"]),q(r.links,[_.PAGE]),G(r.links,_.PAGE,"type",or);const n=a.getLinkHrefTemplated(r.links,_.PAGE,{version:s});return e.invoke(t.HTTPMethods.GET,n,o,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response[t.VersionProperties.TOTAL_CHILDREN]>0?e.response[t.Properties.CHILDREN][0]:void 0,response:e})))}function Cr(e,t,r={},s){return Er("getPagedVersions()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["pageOpts",r,"object"]),q(t.links,[_.PAGE]),G(t.links,_.PAGE,"type",or),new hr(t.links,e,r.itemTransformer||_r,_.VERSION_HISTORY).getPage(r,s)}const Ir=n.newDebug("dcx:assets:composite"),vr=n.newDebug("dcx:assets:composite:leaf"),br=n.AdobeDCXLogger.getInstance();class Tr extends Ar{constructor(e,t,r){super(e,t,r),this.type=l.Composite}headManifest(e){return Ir("headManifest()"),this.fetchLinksIfMissing([_.MANIFEST],e).then((()=>Pr(this._svc,this,e))).then((e=>this._updateDataWithResponse(e)))}getManifest(e,t,r){return Ir("getManifest()"),a.validateParams(["version",e,"string",!0],["etag",t,"string",!0]),this.fetchLinksIfMissing([_.MANIFEST],r).then((()=>wr(this._svc,this,e,t,r)))}getManifestUrl(e){Ir("getManifestUrl()");const t=null==e?_.MANIFEST:_.PAGE;return this.fetchLinksIfMissing([t]).then((()=>Rr(this._svc,this,e)))}getManifestAndComponentsByPath(e,t,r,s){return vr("getManifestAndComponentsByPath()"),Sr(this._svc,this,e,t,r,s)}getComponent(e,t,r,s,o){Ir("getComponent()");const n={};return this._withSourcePromise(n).then((()=>jr.call(n,this._svc,this,e,t,r,s,o)))}getComponentByPath(e,t="defaultbuffer",r){return Ir("getComponentByPath()"),xr(this.serviceConfig,this,e,t,r)}getComponentUrl(e,t,r){return Ir("getComponentUrl()"),this.fetchLinksIfMissing([_.COMPONENT],r).then((()=>Mr(this._svc,this,e,t)))}updateManifest(e,t,r,s,o){return Ir("updateManifest()"),this.fetchLinksIfMissing([_.MANIFEST],o).then((()=>Ur(this._svc,this,e,t,r,s,o))).then(this._updateDataWithResponse.bind(this))}putComponent(e,t,r,s,n,i,d,c){if(Ir("putComponent()"),s&&!a.verifyUuid(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Component id is not a uuid");return a.verifyUuid(e)||br.warn("Existing component id is not a uuid"),this.fetchLinksIfMissing([_.COMPONENT],c).then((()=>Vr(this.serviceConfig,this,e,t,r,s,n,i,d,c)))}putEmbeddedMetadata(e,t,r="json",s){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0],["format",r,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing([_.EMBEDDED_METADATA],s).then((()=>er(this._svc,this,e,t,r,s))).then((e=>O(this,void 0,void 0,(function*(){return yield this.headManifest(s),e}))))}patchEmbeddedMetadata(e,t,r){return a.validateParams(["data",e,["object","object[]","string"]],["etag",t,"string",!0]),this.fetchLinksIfMissing([_.EMBEDDED_METADATA],r).then((()=>tr(this._svc,this,e,t,r))).then((e=>O(this,void 0,void 0,(function*(){return yield this.headManifest(),e}))))}copy(e,t,r,s,o){return super.copy(e,t,r,s,o).then((({response:e,result:t})=>({response:e,result:new Tr(t,this.serviceConfig)})))}}function Pr(e,r,s){vr("headCompositeManifest()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.MANIFEST]);const o=a.getLinkHref(r.links,_.MANIFEST);return e.invoke(t.HTTPMethods.HEAD,o,s,void 0,{responseType:"json",isStatusValid:z()})}function wr(e,r,s,o,n){return vr("getCompositeManifest()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["version",s,"string",!0],["etag",o,"string",!0]),q(r.links,[_.MANIFEST]),Rr(e,r,s,n).then((r=>e.invoke(t.HTTPMethods.GET,r,Object.assign(null!=n?n:{},o?{[t.HeaderKeys.IF_NONE_MATCH]:o}:{}),void 0,{responseType:"json",isStatusValid:z([304])}))).then((e=>({manifestData:e.response||null,manifestEtag:e.headers.etag,response:e})))}function Rr(e,t,r,s){return vr("getCompositeManifestUrl()"),kr(e,t,_.MANIFEST,r,s)}function Or(e,t,r,s){return vr("_getComponentPathUrl()"),kr(e,t,_.COMPONENT,t.version,s).then((e=>a.expandURITemplate(e,a.pruneUndefined({component_path:r}))))}function kr(e,r,s,n,i){return vr("_getUrl()"),a.validateParams(["svc",e,"object"],["asset",r,"object"],["versionId",n,"string",!0]),h.default.resolve().then((()=>{if(n)return Dr(e,r,n,i)})).then((e=>{if(null!=n){if(!e||!a.isObject(e)||"object"!=typeof e.result)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Invalid version resource.",void 0,e?e.response:void 0);return q(e.result[t.Properties.LINKS],[s]),a.getLinkHref(e.result[t.Properties.LINKS],s)}return a.getLinkHref(r.links,s)}))}function Sr(e,r,s,n,i,d){a.validateParams(["svc",e,"object"],["asset",r,"object"],["components",s,"array"],["version",n,"string",!0],["etag",i,"string",!0]);const c=[_.MANIFEST,_.COMPONENT,_.BULK_REQUEST,_.BLOCK_DOWNLOAD];return n&&c.push(_.PAGE),Ut(e,r,c,void 0,d).then((c=>O(this,void 0,void 0,(function*(){r.links=Object.assign({},r.links,c);const l=F(e),u=s.map((({component_path:e,responseType:s,subrequestHeaders:o})=>({method:t.HTTPMethods.GET,href:a.getLinkHrefTemplated(r.links,_.COMPONENT,{component_path:e}),headers:Object.assign(o||{},d),component_path:e,responseType:s})));u.unshift({method:t.HTTPMethods.GET,href:yield Rr(l,r,n,d),headers:Object.assign(i?{[t.HeaderKeys.IF_NONE_MATCH]:i}:{},d)});const p=yield Promise.all(a.chunkArray(u,10).map((e=>_t(l,r,e,void 0,d,!0))));return h.default.resolve(yield p.reduce(((n,i)=>O(this,void 0,void 0,(function*(){var c,h;const p=yield n;if(p.responses.push(i.response),200!==i.response.statusCode)return p;const{componentResponses:f,manifestResponse:g}=function(e,r){return e.reduce(((e,s)=>{const n=r.find((e=>e.href===s.headers[t.HeaderKeys.CONTENT_ID]));if(!n)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Bulk sub-response content-id did not match any bulk request",void 0,s);return"component_path"in n?e.componentResponses.push(s):e.manifestResponse=s,e}),{componentResponses:[]})}(i.result,u),m={};if(s.forEach((e=>{e.hasOwnProperty("skipBlockDownload")&&(m[e.component_path]=e.skipBlockDownload)})),Object.assign(p.components,yield function(e,r,s,n,i,d){return O(this,void 0,void 0,(function*(){return(yield Promise.all(r.map((r=>O(this,void 0,void 0,(function*(){if(r.headers[t.HeaderKeys.CONTENT_TYPE]===E&&r.response.type===o.ProblemTypes.RESPONSE_TOO_LARGE){const o=Nr(r,e),c=r.headers.location?r.headers.location:a.getLinkHrefTemplated(n,_.BLOCK_DOWNLOAD,{resource:JSON.stringify({component_path:o.component_path})});if(d&&d[o.component_path])return{statusCode:200,headers:a.pruneUndefined({[t.HeaderKeys.CONTENT_TYPE]:r.headers["content-type"],[t.HeaderKeys.CONTENT_LENGTH]:r.headers["content-length"],[t.HeaderKeys.CONTENT_ID]:r.headers[t.HeaderKeys.CONTENT_ID]}),responseType:"application/json",response:{href:c},message:"OK"};const h=yield et(F(s),c,void 0,void 0,"defaultbuffer",!0,void 0,i);return Object.assign(h.headers,{[t.HeaderKeys.CONTENT_ID]:r.headers[t.HeaderKeys.CONTENT_ID]}),h}return r})))))).reduce(((t,r)=>{const s=Nr(r,e);try{const e=o._responseToError(r);t[s.component_path]=Object.assign({},s,{response:r,[e?"error":"data"]:e||Lr(r.response,s.responseType||"defaultbuffer",r.headers["content-type"])})}catch(e){t[s.component_path]=Object.assign({},s,{response:r,error:new o.DCXError(o.DCXError.UNEXPECTED,"Error parsing sub-response into requested responseType",e)})}return t}),{})}))}(u.slice(1),f,e,r.links,d,m)),!g)return p;if(200===g.statusCode){p.manifest.data=Lr(g.response,"json"),p.manifest.response=g,X(r)&&"function"==typeof(null===(c=r.current)||void 0===c?void 0:c.parse)&&(r.current.parse(a.arrayBufferToString(g.response)),r.current.versionId=g.headers.version),r.links=ae(g);const t=Y(e);return t&&t.setValueWithAsset(r.links,r),p}if(304===g.statusCode)return p.manifest.response=g,p;if(404===g.statusCode)return p.manifest.error=o._responseToError(g)||new o.DCXError(o.DCXError.NO_COMPOSITE,"Composite missing or deleted",void 0,g),p;if(g.headers[t.HeaderKeys.CONTENT_TYPE]===E&&g.response.type===o.ProblemTypes.RESPONSE_TOO_LARGE){try{const e=g.headers.location?g.headers.location:a.getLinkHrefTemplated(r.links,_.BLOCK_DOWNLOAD,{resource:JSON.stringify({reltype:_.MANIFEST})}),t=yield et(l,e,void 0,void 0,"json",!0,void 0,d);p.manifest.data=t.response,p.manifest.response=t,X(r)&&"function"==typeof(null===(h=r.current)||void 0===h?void 0:h.parse)&&r.current.parse(JSON.stringify(t.response)),r.links=ae(t)}catch(e){p.manifest.error=e instanceof o.DCXError?e:new o.DCXError(o.DCXError.UNEXPECTED,"Error fetching manifest via block download",e)}return p}return p.manifest.error=o._responseToError(g)||new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,g.response.title||"Failed to fetch manifest. Operation failed.",void 0,g),p}))),Promise.resolve({manifest:{},components:{},responses:[]})))}))))}function Nr(e,r){if(!e.headers[t.HeaderKeys.CONTENT_ID])throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Sub-response is missing content-id header",void 0,e);const s=r.find((({href:r})=>r===e.headers[t.HeaderKeys.CONTENT_ID]));if(!s)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Bulk sub-response content-id did not match any bulk request",void 0,e);return s}function Lr(e,t,r){if(!M(e))return e;switch(t){case"text":return a.arrayBufferToString(e);case"json":return JSON.parse(a.arrayBufferToString(e));case"blob":return new Blob([e],{type:r});case"buffer":case"defaultbuffer":return e;case"arraybuffer":return e.buffer}throw new o.DCXError(o.DCXError.INVALID_PARAMS,"requested response type is not supported")}function Mr(e,t,r,s){return vr("getCompositeComponentUrl()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["componentRevision",s,"string",!0]),q(t.links,[_.COMPONENT]),a.getLinkHrefTemplated(t.links,_.COMPONENT,{component_id:r,revision:s})}function Xr(e,r,s,n){return vr("getPresignedUrl()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),Ut(e,r,[_.BLOCK_DOWNLOAD],void 0,n).then((r=>{const o=s?JSON.stringify(s):void 0,i=a.getLinkHrefTemplated(r,_.BLOCK_DOWNLOAD,{resource:o});return(U(e)?e.service:e).invoke(t.HTTPMethods.GET,i,Object.assign({priority:"u=1"},n),void 0,{isStatusValid:z(),responseType:"json",retryOptions:{pollCodes:[202],pollHeader:"location",pollMethod:t.HTTPMethods.GET}})})).then((e=>{if("string"!=typeof e.response.href)throw new o.DCXError(o.DCXError.INVALID_DATA,"Direct download URL not found.",void 0,e);return{response:e,result:e.response.href}}))}function Br(e,t,r,s,o){return vr("getCompositeComponentPresignedUrl()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["componentRevision",s,"string"]),Xr(e,t,{reltype:_.COMPONENT,revision:s,component_id:r},o)}function xr(e,t,r,s="defaultbuffer",o,n){return a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentPath",r,"string"],["responseType",s,"string",!0],["additionalHeaders",o,"object",!0]),Ut(e,t,[_.COMPONENT,_.PAGE],void 0,o).then((s=>{if(t.links=s,t.version)return Or(F(e),t,r)})).then((i=>ot(F(e),t,null!=i?i:a.getLinkHrefTemplated(t.links,_.COMPONENT,{component_path:r}),_.COMPONENT,s,void 0,void 0,o,n)))}function jr(e,t,r,s,o="defaultbuffer",n,i){vr("getCompositeComponent()"),a.validateParams(["svc",e,"object"],["asset",t,"object"],["componentId",r,"string"],["componentRevision",s,"string"],["responseType",o,"string",!0],["additionalHeaders",n,"object",!0],["componentSize",i,"number",!0]);const d={};if(!i||i<Ye()){const i=Mr(e,t,r,s);return ot.call(d,e,t,i,_.COMPONENT,o,r,s,n)}return Br(e,t,r,s,n).then((({response:t,result:r})=>et.call(d,e,r,void 0,void 0,o,!0,t.response.size,n)))}function Ur(e,r,s,n,i=1,d,c={}){if(vr("updateCompositeManifest() ",n,d),a.validateParams(["svc",e,"object"],["asset",r,"object"],["manifest",s,["object","string"]],["overwrite",n,"boolean"],["validationLevel",i,"+number"],["etag",d,"string",!0]),i<1)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"ValidationLevel must be >=1");return q(r.links,[_.BULK_REQUEST,_.REPO_METADATA]),Rr(e,r,void 0,c).then((h=>O(this,void 0,void 0,(function*(){const l=Object.assign({},c);n?l[t.HeaderKeys.IF_MATCH]="*":d&&(l[t.HeaderKeys.IF_MATCH]=d);const u=`${g}; validation-level=${i}`;l[t.HeaderKeys.CONTENT_TYPE]=u;const p="string"==typeof s?s:JSON.stringify(s),f=[{method:t.HTTPMethods.PUT,href:h,headers:l,body:p}];if(r.deviceModifyDate){const e=JSON.stringify([{op:"add",path:`/${[t.Properties.REPO_DEVICE_MODIFY_DATE]}`,value:r.deviceModifyDate}]),s={[t.HeaderKeys.CONTENT_TYPE]:A};f.push({method:t.HTTPMethods.PATCH,href:a.getLinkHref(r.links,_.REPO_METADATA),headers:s,body:e})}const{result:m,response:E}=yield _t(e,r,f,void 0,c,!0),{manifestResponse:y,repoMetadataResponse:D}=function(e,r){const s={manifestResponse:{},repoMetadataResponse:{}};return r.forEach((r=>{const n=e.find((e=>e.headers[t.HeaderKeys.CONTENT_ID]===r.href));if(!n)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Bulk sub-response content-id did not match any bulk request",void 0,n);r.href.includes(":repometadata")?s.repoMetadataResponse=n:s.manifestResponse=n})),s}(m,f);if(vr("uCM() status code for manifest response: ",y.statusCode),412===y.statusCode&&n)return vr("uCM() retry 412 without overwrite"),Ur(e,r,s,!1,i,void 0,c);if(409===y.statusCode&&n)return vr("uCM() retry 409 without overwrite"),Ur(e,r,s,!1,i,d,c);if(409===y.statusCode)throw new o.DCXError(o.DCXError.UPDATE_CONFLICT,"Manifest has been changed",void 0,y);if(412===y.statusCode)throw new o.DCXError(o.DCXError.PRECONDITION_FAILED,"Precondition failed",void 0,y);if(400===y.statusCode){const e=o._responseToError(y);throw new o.DCXError(null==e?void 0:e.code,null==e?void 0:e.message,void 0,y)}{const e=z()(y.statusCode,y);if(!0!==e)throw new o.DCXError(e.code||o.DCXError.UNEXPECTED_RESPONSE,e._message||e.message,e.underlyingError,y)}if(vr("uCM() status code for metadata response: ",D.statusCode),r.deviceModifyDate&&200!==D.statusCode&&201!==D.statusCode&&204!==D.statusCode)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected HTTP Response",void 0,D);return y.xhr=E.xhr,y}))))}function Vr(e,t,r,s,n,i,d,c,h,l,u){if(a.validateParams(["service",e,"object"],["asset",t,"object"],["componentId",r,"string"],["contentType",n,"string"],["maybeIsNew",i,"boolean",!0],["size",d,"number",!0],["blockSize",u,"number",!0],["md5",c,"string",!0]),i&&!a.verifyUuid(r))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Component id is not a uuid");return a.verifyUuid(r)||br.warn("Existing component id is not a uuid"),Gt({svc:e,asset:t,dataOrSliceCallback:s,contentType:n,relation:_.COMPONENT,size:d,componentId:r,md5:c,maybeIsNew:i,additionalHeaders:l,progressCb:h,blockSize:u}).then((({response:e,result:t,isBlockUpload:s,asset:o})=>{const i={response:e,result:Object.assign(Object.assign({},t),{id:r,type:n}),isBlockUpload:s,asset:o};return Object.defineProperty(i,"compositeAsset",{get:()=>o}),i}))}const Hr=n.newDebug("dcx:assets:directory"),Fr=n.newDebug("dcx:assets:directory:leaf");class Yr extends yt{constructor(e,r,s){super(e,r,s),this.type=l.Directory,this.children=[],this.children=e[t.Properties.CHILDREN]}getPagedChildren(e,t){return Hr("getPagedChildren()"),this.fetchLinksIfMissing([_.PAGE],t).then((()=>qr(this._svc,this,e,t)))}createAsset(e,t,r,s,o,n,i,a,d){return Hr("createAsset()"),Kr(this._svc,this,e,t,r,s,o,n,i,a,d).then((e=>({result:new yt(e.result,this.serviceConfig),response:e.response})))}copy(e,t,r){return super.copy(e,t,r).then((({response:e,result:t})=>({response:e,result:new Yr(t,this.serviceConfig)})))}}function Wr(e){var r;Fr("directoryTransformer()");const s=le(e,null===(r=e[t.Properties.PAGE])||void 0===r?void 0:r.embed);s.links=a.merge({},e.links,e._links);const o=e.children||e[t.Properties.CHILDREN];return o&&o.length>0?s.children=o.map((e=>le(e))):s.children=[],[s.assetId,s]}function zr(e,r){return Fr("getDirectoryByURL()"),e.invoke(t.HTTPMethods.GET,r,void 0,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:e.response,response:e})))}function qr(e,t,r={},s){if(Fr("getPagedChildren()"),q(t.links,[_.PAGE]),r&&r.embed&&r.embed.includes(_.REPOSITORY))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Repository Resource embeds on directory listings are not supported");try{return new hr(t.links,e,Wr,"api:primary").getPage(r,s)}catch(e){return h.default.reject(e)}}function Kr(e,r,s,n,i,d,l={},u,p,f,g){Fr("createAsset()"),a.validateParams(["service",e,"object"],["parentDir",r,"object"],["relPath",s,"string"],["createIntermediates",n,"boolean"],["contentType",i,"string"],["respondWith",d,["string","object"],!0],["additionalHeaders",l,"object",!0],["repoMetaPatch",f,"object",!0]);const m=a.isObject(d)?JSON.stringify(d):d;return Ut(e,r,[_.CREATE]).then((E=>{const A=a.getLinkHrefTemplated(E,_.CREATE,{path:s,intermediates:n.toString(),respondWith:m,mode:"id",repoMetaPatch:f}),y=Object.assign({},{[t.HeaderKeys.CONTENT_TYPE]:i},l),D=F(e),C=u?Fe(u,p):void 0,I=C?He(C):0;return u&&je(r,I)?$t({service:D,contentType:i,relation:_.PRIMARY,asset:r,dataOrSliceCallback:u,size:I,relPath:s,createIntermediates:n,respondWith:d,repoMetaPatch:f,additionalHeaders:l,progressCb:g}).then((({result:e,response:t})=>{const r=s.split("/").slice(-1);return{result:a.pruneUndefined(a.mergeDeep({name:r},e)),response:t}})):h.default.resolve().then((()=>O(this,void 0,void 0,(function*(){const h=a.isAnyFunction(u)?yield u(0,I):C;return D.invoke(t.HTTPMethods.POST,A,y,h,{responseType:"json",isStatusValid:z([413]),reuseRequestDesc:{id:"createAsset",method:t.HTTPMethods.POST,href:A,headers:y,progress:g}}).then((h=>{var m;if(413===h.statusCode)return $t({service:D,contentType:i,relation:_.PRIMARY,asset:r,dataOrSliceCallback:u,size:He(Fe(u,p)),relPath:s,createIntermediates:n,respondWith:d,repoMetaPatch:f,additionalHeaders:l,progressCb:g}).catch((e=>{var t;if(e.problemType===o.ProblemTypes.ASSET_NAME_CONFLICT){const r={assetId:null===(t=e.response.response)||void 0===t?void 0:t["repo:assetId"],links:ae(e.response)};return $t({service:D,contentType:i,relation:_.PRIMARY,asset:r,dataOrSliceCallback:u,size:He(Fe(u,p)),relPath:s,createIntermediates:n,respondWith:d,repoMetaPatch:f,additionalHeaders:l,progressCb:g})}throw e})).then((({result:e,response:t})=>{const r=s.split("/")[s.split("/").length-1];return{result:a.pruneUndefined(a.mergeDeep({name:r},e)),response:t}}));const E=s.split("/")[s.split("/").length-1];let A;r.path&&(A=a.appendPathElements(r.path,s));const y=ae(h),C=h.headers;if(null===(m=C[t.HeaderKeys.CONTENT_TYPE])||void 0===m?void 0:m.includes("multipart/mixed")){const e=ct(h)[1];throw 404===e.statusCode?new c.default(o.DCXError.ASSET_NOT_FOUND,"Asset was created successfully but repository metadata could not be found.",void 0,h):403===e.statusCode?new c.default(o.DCXError.FORBIDDEN,"Asset was created successfully but Permission denied for fetching repository metadata.",void 0,h):o.unexpectedResponse("Unexpected Server Response",void 0,h)}const I=a.isObject(h.response)?h.response:{etag:"",md5:""},v=C["asset-id"]||C["x-resource-id"],b=r.repositoryId;let T=I.etag,P=I.md5;null==d&&(T=C.etag,P=C["content-md5"]);const w=a.isObject(h.response)&&d&&(d===_.REPO_METADATA||a.isObject(d)&&d.reltype===_.REPO_METADATA)?le(h.response):{},R=Y(e);return R&&R.setValueWithAsset(y,w),{result:a.pruneUndefined(a.mergeDeep({name:E},w,a.pruneUndefined({links:y,assetId:v,etag:T,md5:P,repositoryId:b,format:i,path:A}))),response:h}}))}))))}))}const Gr=n.newDebug("dcx:assets:discoverable");function $r(e){Gr("discoverableAssetTransformer()");const r=e[t.Properties.EMBEDDED][_.REPO_METADATA],s=le(r,e[t.Properties.EMBEDDED]);return s.links=a.merge({},e.links,r._links),[s.assetId,s]}function Jr(e){Gr("discoverableReposTransformer()");const r=e[t.Properties.EMBEDDED][_.PRIMARY],s=ue(r);return s.links=r._links,[s.repositoryId,s]}const Zr=n.newDebug("dcx:assets:factory");function Qr(e,t){Zr("hydrateAsset()"),a.validateParams(["asset",e,"object"],["svc",t,"object"]);const r=e.format||"",s=r.endsWith("+dcx")?l.Composite:r===f?l.Directory:r.split("/").length>1?l.File:l.Asset;switch(s){case l.Directory:return e.type===s&&e instanceof Yr?e:new Yr(e,t);case l.Composite:return e.type===s&&e instanceof Tr?e:new Tr(e,t);case l.File:return e.type===s&&e instanceof Ar?e:new Ar(e,t);case l.Asset:return e.type===s&&e instanceof yt?e:new yt(e,t);default:return new yt(e,t)}}const es=n.newDebug("dcx:assets:indexdocument");function ts(e){es("deserializeIndexDocument()");const r=e.children.map((e=>{const r=le(e[t.Properties.EMBEDDED][_.REPO_METADATA]),s=ue(e[t.Properties.EMBEDDED][_.REPOSITORY]);return r.embedded={RepositoryResource:s},r}));return{regions:e[t.Properties.REPO_REGIONS],assignedDirectories:r,links:e._links}}const rs=1e5;class ss{constructor(e=1e5,t="SESSION"){if(this.values={},this.maxEntries=rs,this.promiseToResolveMap=new Map,e<=0)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Cache Max enteries must be great than 0.");this.maxEntries=e,this.defaultSessionKey=t}clear(){this.promiseToResolveMap.forEach((e=>{e.call(void 0)}));for(const e in this.values)this.values[e].clear();this.values={}}getKey(e){if(e.assetId||"object"!=typeof e)return e.assetId}getValueWithAsset(e){if(!e.assetId&&"object"==typeof e)return;const t=this.getKey(e);return t?this.get(t,e.repositoryId):void 0}setPending(e,t=this.defaultSessionKey){let r;this.values[t]||(this.values[t]=new Map);const s=this.values[t].get(e);if(s&&s instanceof Promise)return this.promiseToResolveMap.get(s);const o=new Promise((e=>{r=e}));return this.values[t].set(e,o),this.promiseToResolveMap.set(o,r),o.then((()=>this.promiseToResolveMap.delete(o))).catch((()=>this.promiseToResolveMap.delete(o))),r}get(e,t=this.defaultSessionKey){if(this.values[t]&&t in this.values)return this.values[t].get(e)}setValueWithAsset(e,t){if(!e)return;const r=this.getKey(t);if(r){const s=t.repositoryId||this.defaultSessionKey;this.set(e,r,s)}}set(e,t,r=this.defaultSessionKey){if(this.values[r]){if(this.values[r]&&this.values[r].get(t)instanceof Promise){const s=this.values[r].get(t),o=this.promiseToResolveMap.get(s);this.promiseToResolveMap.delete(s),o&&o(e)}}else this.values[r]=new Map;if(this.values[r].size>=this.maxEntries){const e=this.values[r].keys().next().value;this.values[r].delete(e)}this.values[r].set(t,Promise.resolve(e))}delete(e,t=this.defaultSessionKey){this.values[t]&&this.values[t].delete(e)}deleteWithAsset(e){const t=this.getKey(e);t&&this.delete(t,e.repositoryId)}}var os;t.RenditionType=void 0,(os=t.RenditionType||(t.RenditionType={})).IMAGE_JPG="image/jpg",os.IMAGE_PNG="image/png",os.IMAGE_GIF="image/gif",os.VIDEO_MP4="video/mp4",os.VIDEO_METADATA="application/vnd.adobe.ccv.videometadata";const ns=n.newDebug("dcx:assets:versionset"),is=n.newDebug("dcx:assets:versionset:leaf");Object.defineProperty(t,"ProblemTypes",{enumerable:!0,get:function(){return o.ProblemTypes}}),t.ACLPolicyMediaType="application/vnd.adobecloud.accesscontrolpolicy+json",t.Asset=yt,t.AssetFactory=class{constructor(e){this._svc=e}hydrate(e){return Qr(e,this._svc)}},t.AssetTypes=l,t.BlockTransferMediaType=y,t.BlockUpload=qt,t.COPY_RESOURCES_RESOURCE_LIMIT=30,t.Composite=Tr,t.DEFAULT_BLOCK_DOWNLOAD_THRESHOLD=Xe,t.DEFAULT_BLOCK_UPLOAD_THRESHOLD=Me,t.DEFAULT_CACHE_MAX_ENTRIES=rs,t.DEFAULT_MAX_CONCURRENT_REQUESTS=4,t.DEFAULT_STRING_LENGTH_CHECK=Be,t.Directory=Yr,t.DirectoryMediaType=f,t.File=Ar,t.GenericCache=ss,t.JSONLDMediaType="application/ld+json",t.JSONMediaType=m,t.JSONPatchMediaType=A,t.JSONProblemMediaType=E,t.LinkRelation=_,t.MAX_CACHE_PERIOD_MS=2592e6,t.ManifestMediaType=g,t.OperationDocumentBuilder=be,t.OperationDocumentMediaType=D,t.PageResource=hr,t.RepositoryLinksCache=class extends ss{constructor(e=1e5,t=2592e6){super(e,"SESSION"),this.timestampsOnLinkCreation=0,this.maxCachePeriodMS=0,this.maxCachePeriodMS=t}isLinkExpired(){return this.maxCachePeriodMS<Date.now()-this.timestampsOnLinkCreation}setIndexLinks(e){this.set(e,"INDEX","SESSION"),this.timestampsOnLinkCreation=Date.now()}getIndexLinks(){if(!this.isLinkExpired())return this.get("INDEX","SESSION")}setIndexRepository(e){this.indexRepository=e}getIndexRepository(){return this.indexRepository}setRepositoryLinks(e){this.set(e,"/Repositories","SESSION"),this.timestampsOnLinkCreation=Date.now()}getRepositoryLinks(){if(!this.isLinkExpired())return this.get("/Repositories","SESSION")}},t.STREAMABLE_RESPONSE_TYPES=w,t.Version=pr,t.VersionSet=class{constructor(e,r,s){this._svc=r,this.versionCount=e.versionCount||e[t.VersionProperties.TOTAL_CHILDREN],this.repositoryId=e.repositoryId||e[t.Properties.REPO_REPOSITORY_ID],this.assetId=e.assetId||e[t.Properties.REPO_ASSET_ID],this.versions=[];for(const s in e.versions||e[t.Properties.CHILDREN])this.versions.push(new pr(e.versions&&e.versions[s]?e.versions[s]:e[t.Properties.CHILDREN][s],r));this.links=a.merge({},e.links,e._links,s)}versionByVersionId(e){return ns("versionByVersionId()"),this.versions.find((t=>t.version===e))}versionsByLabel(e){return ns("versionsByLabel()"),this.versions.filter((t=>!(!t.milestone||t.milestone.label!==e)))}},t._copyResources=Ne,t._getComponentPathUrl=Or,t._getUrl=kr,t._parseUploadableData=Fe,t.adobeVersionTransformer=_r,t.assertLinksContain=q,t.assertLinksContainAny=K,t.assertValidBulkRequest=pt,t.assetTransformer=function(e){At("assetTransformer()");const t=le(e);return t.links=a.merge({},e.links,e._links),[t.assetId,t]},t.blockTransferManager=Jt,t.bodyToUint8Array=dt,t.buildRangeHeader=rt,t.checkACLPrivilege=Xt,t.constructMultipartRequestBody=at,t.constructServiceEndpoint=W,t.convertToACPRepoMetadataResource=function(e){he("convertToACPRepoMetadataResource()");const r={};return r[t.Properties.REPO_REPOSITORY_ID]=e[t.Properties.REPO_REPOSITORY_ID]||e.repositoryId,r[t.Properties.REPO_ASSET_ID]=e[t.Properties.REPO_ASSET_ID]||e.assetId,r[t.Properties.REPO_NAME]=e[t.Properties.REPO_NAME]||e.name,r[t.Properties.REPO_SIZE]=null!=e[t.Properties.REPO_SIZE]?e[t.Properties.REPO_SIZE]:e.size,r[t.Properties.REPO_PATH]=e[t.Properties.REPO_PATH]||e.path,r[t.Properties.REPO_ASSET_CLASS]=e[t.Properties.REPO_ASSET_CLASS]||e.etag,r[t.Properties.REPO_ETAG]=e[t.Properties.REPO_ETAG]||e.etag,r[t.Properties.REPO_VERSION]=e[t.Properties.REPO_VERSION]||e.version,r[t.Properties.DC_FORMAT]=e[t.Properties.DC_FORMAT]||e.format,r[t.Properties.REPO_CREATE_DATE]=e[t.Properties.REPO_CREATE_DATE]||e.createDate,r[t.Properties.REPO_MODIFY_DATE]=e[t.Properties.REPO_MODIFY_DATE]||e.modifyDate||e.modifiedDate,r[t.Properties.REPO_DISCARD_DATE]=e[t.Properties.REPO_DISCARD_DATE]||e.discardDate,r[t.Properties.REPO_CREATED_BY]=e[t.Properties.REPO_CREATED_BY]||e.createdBy,r[t.Properties.REPO_MODIFIED_BY]=e[t.Properties.REPO_MODIFIED_BY]||e.modifiedBy,r[t.Properties.REPO_DISCARDED_BY]=e[t.Properties.REPO_DISCARDED_BY]||e.discardedBy,r[t.Properties.REPO_DEVICE_CREATE_DATE]=e[t.Properties.REPO_DEVICE_CREATE_DATE]||e.deviceCreateDate,r[t.Properties.REPO_DEVICE_MODIFY_DATE]=e[t.Properties.REPO_DEVICE_MODIFY_DATE]||e.deviceModifyDate,r[t.Properties.REPO_DEFAULT_SCHEDULED_DELETION_DURATION]=e[t.Properties.REPO_DEFAULT_SCHEDULED_DELETION_DURATION]||e.defaultScheduledDeletionDuration,r[t.Properties.REPO_SCHEDULED_DELETION_DATE]=e[t.Properties.REPO_SCHEDULED_DELETION_DATE]||e.scheduledDeletionDate,r[t.Properties.REPO_BASE_ASSET_ID]=e[t.Properties.REPO_BASE_ASSET_ID]||e.baseAssetId,r[t.Properties.REPO_STATE]=e[t.Properties.REPO_STATE]||e.state,r[t.Properties.LINKS]=e[t.Properties.LINKS]||e.links,r[t.Properties.IMAGE_WIDTH]=e[t.Properties.IMAGE_WIDTH]||e.width,r[t.Properties.IMAGE_LENGTH]=e[t.Properties.IMAGE_LENGTH]||e.length,a.pruneUndefined(r)},t.copyAsset=fe,t.copyAssetResources=function(e,t,r,s,o,n,i){return Ne(e,t,r,s,o,n,i)},t.copyResources=function(e,t,r,s,o,n,i){return pe("copyResource()"),Ne(e,t,r,s,o,n,i).then((e=>e.response)).then(Oe)},t.createAsset=Kr,t.defaultBufferResponseType=Zt,t.deleteACLPolicy=xt,t.deleteAsset=Ae,t.deserializeAsset=le,t.deserializeIndexDocument=ts,t.deserializeRepository=ue,t.deserializeUploadComponentRecord=We,t.deserializeVersion=gr,t.deserializeVersionSet=function(e){is("deserializeVersionSet()");const r={versionCount:e[t.VersionProperties.TOTAL_CHILDREN],repositoryId:e[t.VersionProperties.REPO_ID],assetId:e[t.Properties.REPO_ASSET_ID],links:{},versions:[]},s=e.children||e[t.Properties.CHILDREN];return s&&s.length>0&&(r.versions=s.map((e=>gr(e)))),r.links=e._links,r},t.directoryTransformer=Wr,t.discardAsset=Ee,t.discoverableAssetTransformer=$r,t.discoverableReposTransformer=Jr,t.doBatchOperation=function(e,t,r,s){return ve(e,t,r,s).then(Ce)},t.doBlockDownload=ar,t.doLinksContain=$,t.doOperation=ve,t.doesAssetContainLinks=J,t.fetchLinksForAsset=bt,t.fetchLinksForAssetWithResponse=Tt,t.fetchLinksIfMissing=Ut,t.getACLPolicy=Mt,t.getAppMetadata=kt,t.getBaseDirectoryMetadata=wt,t.getBlockDownloadThreshold=Ye,t.getCompositeComponent=jr,t.getCompositeComponentByPath=xr,t.getCompositeComponentPresignedUrl=Br,t.getCompositeComponentUrl=Mr,t.getCompositeComponentsUrlsForUpload=function(e,r,s,n){return Ut(e,r,[_.COMPONENT,_.BLOCK_UPLOAD_INIT],void 0,n).then((i=>{var d;const c=F(e);null===(d=Y(e))||void 0===d||d.setValueWithAsset(i,r),r.links=Object.assign(Object.assign({},r.links),i);const l=a.normalizeHeaders(a.pruneUndefined(Object.assign(Object.assign({},n),{[t.HeaderKeys.AUTHORIZATION]:c.authProvider.authToken,[t.HeaderKeys.X_API_KEY]:c.authProvider.apiKey})));return Promise.all(s.map((e=>je(r,e.size)?function(e,r,s,n){return Kt(e,r,a.pruneUndefined({"repo:reltype":_.COMPONENT,"repo:size":s.size,"dc:format":s.contentType,component_id:s.componentId}),n).then((e=>{if(200!==e.response.statusCode)throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from block upload init",e.response);const r=e.result;return{blockSize:r[t.BlockTransferProperties.REPO_BLOCK_SIZE],uploadRequestParameters:r[t.Properties.LINKS][_.BLOCK_TRANSFER].map((({href:e})=>({href:e,method:t.HTTPMethods.PUT}))),finalizeRequestParameters:{href:a.getLinkHrefTemplated(r[t.Properties.LINKS],_.BLOCK_FINALIZE,{}),method:t.HTTPMethods.POST,headers:n,body:`${JSON.stringify(r)}`}}})).catch((e=>{throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from block upload init",e)}))}(c,r,e,l):function(e,r,s,o){return h.default.resolve({blockSize:s.size,uploadRequestParameters:[{href:Mr(e,r,s.componentId),method:t.HTTPMethods.PUT,headers:o}]})}(c,r,e,l))))}))},t.getCompositeManifest=wr,t.getCompositeManifestUrl=Rr,t.getDataLength=He,t.getDirectory=function(e,t){return Fr("directoryTransformer()"),Ut(e,t,[_.PRIMARY]).then((t=>zr(F(e),a.getLinkHref(t,_.PRIMARY))))},t.getDirectoryByURL=zr,t.getDiscoverableAssets=function(e,t={},r){Gr("getDiscoverableAssets()"),a.validateParams(["svc",e,"object"],["pageOpts",t,"object"]);const s=F(e);return ie(e,r).then((e=>new hr(e.assetLinks,s,$r,"api:primary").getPage(t,r))).then((e=>({result:e.response.response,paged:e.paged,response:e.response})))},t.getDiscoverableRepos=function(e,r={},s){Gr("getDiscoverableRepos()"),a.validateParams(["svc",e,"object"],["pageOpts",r,"object"]);const o=F(e),n=W("/repositories",o);return h.default.resolve(void 0).then((()=>O(this,void 0,void 0,(function*(){const i=Y(e);let a;return i&&(a=yield i.getRepositoryLinks()),a||(a=ae(yield o.invoke(t.HTTPMethods.HEAD,n,s,void 0,{isStatusValid:z()}))),i&&i.setRepositoryLinks(a),new hr(a,o,Jr).getPage(r,s)})))).then((e=>({result:e.response.response,paged:e.paged,response:e.response})))},t.getEffectivePrivileges=Lt,t.getEmbeddedMetadata=Qt,t.getHTTPResource=se,t.getIndexDocument=function(e,r){es("getIndexDocument()"),a.validateParams(["svc",e,"object"]);const s=F(e),o=W("/index",s);return s.invoke(t.HTTPMethods.GET,o,r,void 0,{responseType:"json",isStatusValid:z()}).then((e=>({result:ts(e.response),response:e.response})))},t.getIndexLinks=ne,t.getIndexRepository=ie,t.getLinksForAsset=Pt,t.getLinksFromCache=Ft,t.getManifestAndComponentsByPath=Sr,t.getOpsHref=ce,t.getPagedChildren=qr,t.getPagedVersions=Cr,t.getPresignedUrl=Xr,t.getPrimaryResource=Dt,t.getRendition=ir,t.getRepoMetadata=function(e,r,s){At("getRepoMetadata()"),a.validateParams(["svc",e,"object"],["asset",r,"object"]),q(r.links,[_.REPO_METADATA]);const o=a.getLinkHref(r.links,_.REPO_METADATA);return e.invoke(t.HTTPMethods.GET,o,s,void 0,{responseType:"json",isStatusValid:z()}).then((e=>{const r=ae(e),s=e.response;return s[t.Properties.LINKS]=a.merge({},s[t.Properties.LINKS],r),{result:s,response:e}}))},t.getRepositoryResource=Rt,t.getReposityLinksCache=Y,t.getResolveByIdHref=function(e){if(a.isObject(this)){if("string"==typeof this.resolveByIdHref)return h.default.resolve(this.resolveByIdHref);if(a.isFunction(this.resolveByIdHref))return h.default.resolve(this.resolveByIdHref())}return ne(e).then((e=>{try{return a.getLinkHref(e,_.RESOLVE_BY_ID)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ResolveByID href.",e)}}))},t.getResolveByPathHref=function(e){if(a.isObject(this)){if("string"==typeof this.resolveByPathHref)return h.default.resolve(this.resolveByPathHref);if(a.isFunction(this.resolveByPathHref))return h.default.resolve(this.resolveByPathHref())}return ne(e).then((e=>{try{return a.getLinkHref(e,_.RESOLVE_BY_PATH)}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,"Could not get ResolveByPath href.",e)}}))},t.getResolveLinkForAsset=It,t.getService=F,t.getVersionResource=Dr,t.headAppMetadata=Ot,t.headCompositeManifest=Pr,t.headHTTPResource=re,t.headPrimaryResource=Ct,t.hydrateAsset=Qr,t.isAdobeCopyResourcesDocument=e=>"copy_resources"===e.op,t.isAdobeDCXBranchLike=function(e){return a.isObject(e)&&(["compositeId","compositeAssetId","compositeRepositoryId"].some((t=>t in e))||a.isObject(e._core))},t.isAdobeDCXCompositeLike=X,t.isAdobeResponseLike=S,t.isBlob=B,t.isBufferLike=M,t.isComponentResourceDesignator=function(e){return a.isObject(e)&&"component_id"in e},t.isHttpService=j,t.isMinimalAdobeAsset=function(e){return a.isObject(e)&&(a.isObject(e.links)||"string"==typeof e.repositoryId&&("string"==typeof e.path||"string"==typeof e.assetId))},t.isRepoResponseLike=N,t.isRepoResponseResultLike=L,t.isResolvableAsset=x,t.isServiceConfig=U,t.isTransferDocument=V,t.maybeGetBlockTransfer=ze,t.moveAsset=me,t.newBlockDownload=Qe,t.newOperationDocBuilder=Te,t.normalizeCopyResourcesDesignator=e=>{if((e=>e.hasOwnProperty("source")&&e.hasOwnProperty("target"))(e))return{source:ge(e.source),target:ge(e.target)};const t=ge(e);return{source:t,target:t}},t.packageAssets=De,t.parseHttpResponseContent=ut,t.parseLinkString=de,t.parseLinksFromResponseHeader=ae,t.parseMultipartResponseParts=ct,t.patchACLPolicy=Bt,t.patchAppMetadata=Nt,t.patchEmbeddedMetadata=tr,t.patchVersions=yr,t.pauseBlockTransfer=function(e,t){return O(this,void 0,void 0,(function*(){const r=yield ze(e);if(r)return t&&r.on("stateChanged",t),yield r.pause(),r}))},t.performBulkRequest=_t,t.putAppMetadata=St,t.putCompositeComponent=Vr,t.putEmbeddedMetadata=er,t.resolveAsset=vt,t.restoreAsset=ye,t.setBlockDownloadThreshold=e=>{if(Number.isNaN(e)||"number"!=typeof e||e<=0)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Invalid block download threshold, must be positive integer");xe=e},t.shouldUseBlockTransferForDownload=(e,t=52428800)=>((e,t)=>e>=t)(e,t),t.shouldUseBlockTransferForUpload=je,t.streamToGetSliceCallback=function(e,t,r,s=4){var n;const i=null!==(n=Ve(r))&&void 0!==n?n:Me,d=i*s,c=new ArrayBuffer(d),h=new Uint8Array(c);let l=0;const u=a.isWHATWGReadableStream(e)?e.pipeThrough(function(e,t){let r;const s=new ByteLengthQueuingStrategy({highWaterMark:e*t});return{writable:new WritableStream({write(t){if(Le("Chunk Received:",t.byteLength),t.byteLength<e)r.enqueue(t);else{const s=Math.ceil(t.byteLength/e),o=[...Array(s).keys()].map((r=>t.subarray(r*e,Math.min((r+1)*e,t.byteLength))));for(const e of o)Le("enqueue smaller chunk:",e.byteLength),r.enqueue(e)}},close(){r.close()}},s),readable:new ReadableStream({start(e){r=e}},s)}}(i,s)).getReader():e;let p=!1,_=Promise.resolve();return function(e,t){return O(this,void 0,void 0,(function*(){if(p)return new Uint8Array([]);try{let r;const s=new Promise(((o,n)=>O(this,void 0,void 0,(function*(){function i(r){const s=l%d;if(r.byteLength+s>d){const e=d-s;h.set(r.subarray(0,e),s),h.set(r.subarray(e),0)}else h.set(r,s);if(l+=r.byteLength,Le(`chunk ${e}-${t} progress: ${l-e}/${t-e}`),l>=t){const r=h.subarray(e%d,t%d||t);Le(`resolving slice - start:  ${e}, end: ${t}, length: ${r.byteLength}`),o(r)}}if(a.isNodeReadableStream(u)){function c(){return O(this,void 0,void 0,(function*(){const e=u.read(t-l);null!==e&&i(e)}))}const f=()=>{p=!0,o(h.subarray(e%d,l%d||d))},g=()=>{u.off("readable",c),u.off("end",f),u.off("error",n)},m=()=>{u.on("readable",c),u.on("end",f),u.on("error",n)};r=()=>O(this,void 0,void 0,(function*(){m(),yield c(),s.finally(g)}))}else{function E(){return O(this,void 0,void 0,(function*(){const{value:r,done:s}=yield u.read();return s?(p=!0,Le("End of stream",e,l),o(h.subarray(e%d,l%d||d))):(i(r),l<=t?yield E():void 0)}))}r=()=>(Le("starting read for slice",e,t),E())}_=_.then((()=>O(this,void 0,void 0,(function*(){r(),yield s}))))}))));return s}catch(e){throw new o.DCXError(o.DCXError.UNEXPECTED,e.message,e)}}))}},t.updateCompositeManifest=Ur,t.updatePrimaryResource=dr,t.useLinkOrResolveResource=jt,t.versionTransformer=fr,t.waitForBlockDownloadToStart=function(e){return O(this,void 0,void 0,(function*(){yield ze(e)}))}},337791:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(971507);var o,n,i=function(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}(r(294462));o=function(e){"undefined"!=typeof self?e.exports=self:"undefined"!=typeof window?e.exports=window:e.exports=Function("return this")()},o(n={path:undefined,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports;const a="dcxjs";let d=!1;const c=globalThis;var h,l;d||(d=!0,c[a]={_modules:{}},Object.assign(c[a],{getModule:e=>{var t;return null===(t=c[a])||void 0===t?void 0:t.modules[e]},registerModule:(e,t)=>{const r=c[a];if(!r)throw new Error("[@dcx/core] Namespace not yet initialized.");if(e in r.modules)throw new Error(`[@dcx/core] Module ${e} already registered.`);r.modules[e]={module:t}}}),Object.defineProperty(c[a],"modules",{get:()=>c[a]._modules}),null===(h=c[a])||void 0===h||h.registerModule("AdobeDCXLogger",s.AdobeDCXLogger),Object.defineProperty(c[a],"logger",{get:()=>{var e;return null===(e=c[a])||void 0===e?void 0:e.getModule("AdobeDCXLogger").module},enumerable:!0}),null===(l=c[a])||void 0===l||l.registerModule("AdobeDCXPromise",i.default));const u=globalThis[a];t.dcxjs=u,t.default=u,t.getModule=e=>{var t;const r=c[a];if(!r)throw new Error("[@dcx/core] Namespace not yet initialized.");return null===(t=r.getModule(e))||void 0===t?void 0:t.module}},973301:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(200334);var o,n,i=function(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}(r(310799));o=function(e){"undefined"!=typeof self?e.exports=self:"undefined"!=typeof window?e.exports=window:e.exports=Function("return this")()},o(n={path:undefined,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports;const a="dcxjs";let d=!1;const c=globalThis;var h,l;d||(d=!0,c[a]={_modules:{}},Object.assign(c[a],{getModule:e=>{var t;return null===(t=c[a])||void 0===t?void 0:t.modules[e]},registerModule:(e,t)=>{const r=c[a];if(!r)throw new Error("[@dcx/core] Namespace not yet initialized.");if(e in r.modules)throw new Error(`[@dcx/core] Module ${e} already registered.`);r.modules[e]={module:t}}}),Object.defineProperty(c[a],"modules",{get:()=>c[a]._modules}),null===(h=c[a])||void 0===h||h.registerModule("AdobeDCXLogger",s.AdobeDCXLogger),Object.defineProperty(c[a],"logger",{get:()=>{var e;return null===(e=c[a])||void 0===e?void 0:e.getModule("AdobeDCXLogger").module},enumerable:!0}),null===(l=c[a])||void 0===l||l.registerModule("AdobeDCXPromise",i.default));const u=globalThis[a];t.dcxjs=u,t.default=u,t.getModule=e=>{var t;const r=c[a];if(!r)throw new Error("[@dcx/core] Namespace not yet initialized.");return null===(t=r.getModule(e))||void 0===t?void 0:t.module}},330891:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),r(337791);var s=r(360470),o=r(971507);r(120084);var n=r(617759),i=r(395768),a=r(154118),d=r(294462),c=r(137158),h=r(566870);function l(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=l(o),p=function(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var s=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}(n),_=l(a),f=l(d);class g{constructor(){this._communityId=null,this._artworkComponentId=null,this._assetId=null,this._resourcePath=null,this._mainResource=null,this._mainResourceVersion=null,this._artworkResource=null,this._artworkResourceVersion=null,this._title=null,this._alias=null,this._tags=[],this._description=null,this._categoryId=null,this._subCategoryIds=[],this._creatorIds=[],this._undiscoverable=!1,this._isPrivate=!1,this._custom=null}get communityId(){return this._communityId}set communityId(e){this._communityId=e}get artworkComponentId(){return this._artworkComponentId}set artworkComponentId(e){this._artworkComponentId=e}get assetId(){return this._assetId}set assetId(e){this._assetId=e}get resourcePath(){return this._resourcePath}set resourcePath(e){this._resourcePath=e}get mainResource(){return this._mainResource}set mainResource(e){this._mainResource=e}get mainResourceVersion(){return this._mainResourceVersion}set mainResourceVersion(e){this._mainResourceVersion=e}get artworkResource(){return this._artworkResource}set artworkResource(e){this._artworkResource=e}get artworkResourceVersion(){return this._artworkResourceVersion}set artworkResourceVersion(e){this._artworkResourceVersion=e}get title(){return this._title}set title(e){this._title=e}get alias(){return this._alias}set alias(e){this._alias=e}get tags(){return this._tags}set tags(e){this._tags=this._tags.concat(e)}get description(){return this._description}set description(e){this._description=e}get categoryId(){return this._categoryId}set categoryId(e){this._categoryId=e}get subCategoryIds(){return this._subCategoryIds}set subCategoryIds(e){this._subCategoryIds=this._subCategoryIds.concat(e)}get creatorIds(){return this._creatorIds}set creatorIds(e){this._creatorIds=this._creatorIds.concat(e)}get undiscoverable(){return this._undiscoverable}set undiscoverable(e){this._undiscoverable=e}get isPrivate(){return this._isPrivate}set isPrivate(e){this._isPrivate=e}get custom(){return this._custom}set custom(e){this._custom=e}}const m=o.newDebug("dcx:dcxjs:sb"),E=()=>!0,A={disableRetry:!0},y=!1,D="primary",C="http://ns.adobe.com/ccapi/manifest",I="http://ns.adobe.com/ccapi/manifest2",v="http://ns.adobe.com/ccapi/component",b="version-history",T="rendition";let P=null,w=null;class R{constructor(e,t){this._maxRedirects=5,this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._assetInfoCache={},this._assetIdResolutionTemplate=null,this.SYNC_ASYNC_DEFAULT_DELAY=5,this.ASYNC_DEFAULT_DELAY=1,this.DEFAULT_POLL_DELAY=10,this._service=e,this._server=t,t&&(this._endPoint=n.endPointOf(t))}get maxRedirects(){return this._maxRedirects}set maxRedirects(e){if("number"!=typeof e)throw new _.default(_.default.INVALID_PARAMS,"Expecting a number.");this._maxRedirects=Math.floor(e)}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new _.default(_.default.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}isValidHref(e){const t=n.endPointOf(e);return!t||t===this._endPoint}isDomainOnAllowList(e){m("isDomainOnAllowList");const t=n.parseURI(e).authority;if(!t||0===t.length)return!0;const r=t.length,s=this._authenticationAllowList.length;for(let e=0;e<s;e++){const s=this._authenticationAllowList[e],o=s.length;let n;if(n=r>o?t.slice(-o):t,n===s)return m("iDOAL true"),!0}return m("iDOAL false"),!1}getAsset(e,t,r,s){return this._getAsset(e,t,r,void 0,s)}_getAsset(e,t={},r,s,o){if(m("_getAsset()"),!(e=this._resolveUrl(e)))return void o(new _.default(_.default.WRONG_ENDPOINT,"Wrong endpoint: "+e));let d=s;const c={};"string"==typeof t?c["if-none-match"]=t:n.merge(c,t);let h,l=0;const u=(e,t)=>{if(m("_getAsset() respHandler",e,t),e)return void o(a.networkError("Error downloading an asset",e,t));const r=t.statusCode;if(200===r)o(void 0,t);else if(304===r)o(void 0,t);else if(301===r||302===r||303===r||307===r)if(!this._service.handlesRedirects&&this.maxRedirects)if(l<this.maxRedirects){const r=t.headers.location;r?h(r):o(a.unexpectedResponse("Missing location header in redirect response",e,t))}else o(a.unexpectedResponse("Too many redirects",e,t));else o(a.unexpectedResponse("Unexpected response getting an asset",e,t));else o(a.unexpectedResponse("Unexpected response getting an asset",e,t))};return h=t=>{const s={responseType:r,isStatusValid:E,retryOptions:A,autoParseJson:y};return t&&(l++,s.reuseRequestDesc=d,this.isDomainOnAllowList(t)||(c.authorization=null)),this._service.invoke(i.HTTPMethods.GET,t||e,c,void 0,s,u)},d=h(),d.progress=n.noOp,d}getAssetAsType(e,t,r,s){return this._getAssetAsType(e,t,r,void 0,void 0,void 0,s)}_cacheLinksFromResponse(e,t){if("string"==typeof e){const r=this._parseCachableLinks(t);if(Object.keys(r).length>0){const t=this._assetInfoCache[e],s=Object.assign({},t||{},n.pruneUndefined(r));this._cacheInfoForAssetId(e,void 0,s)}}}_getAssetAsType(e,t,r,s,o,n,i){return m("_getAssetAsType"),this._getAsset(e,r,t,s,((e,t)=>{if(e)return i(e);if(200===t.statusCode){const e=t.response||t.responseText;null==n&&this._cacheLinksFromResponse(o,t),i(void 0,e,t.headers.etag,t)}else 304===t.statusCode?i(void 0,null,t.headers.etag,t):i(a.unexpectedResponse("Unexpected response getting asset",e,t))}))}_getResourcePathFromHref(e,t){return m("_getResourcePathFromHref"),this._service.invoke(i.HTTPMethods.HEAD,e,{},void 0,{isStatusValid:E,retryOptions:A,autoParseJson:y},((e,r)=>{if(m("_gRPFH invoked",e,r),e)return t(e);if(200===r.statusCode){const e=r.headers.link;if(e){const r=n.parse(e).get("rel","http://ns.adobe.com/ccapi/path");if(r&&r[0]&&r[0].uri)return t(void 0,r[0].uri)}}return t(a.unexpectedResponse("Unexpected response trying to retrieve path to asset.",void 0,r))}))}resolveRootURLAsync(){m("resolveRootURLAsync()");const e=this._resolveUrl("/");let t;return m("rRUA() rootHref",e),P=this._service.invoke(i.HTTPMethods.GET,e,{},void 0,{responseType:"text",isStatusValid:E,retryOptions:A,autoParseJson:y}).then((e=>{if(m("rRUA() resolved",e),200!==e.statusCode)throw t=new _.default(_.default.UNEXPECTED_RESPONSE,"Resolve root URL did not succeed with 200",void 0,e),t;{const r=e.responseText||e.response;try{const e=JSON.parse(r),t=e._links?e._links["http://ns.adobe.com/ccapi/resolve/id"]:void 0;if(t)return{href:t.href,self:this}}catch(r){throw t=new _.default(_.default.INVALID_DATA,"Invalid JSON returned by server",r,e),t}}})).catch((e=>{throw m("rRUA() rejected",e),e})),m("rRUA() rootReqDesc",P),P}getPromiseCacheInfo(e){return m("getPromiseCacheInfo()"),null!=w||(w=e(),w&&w.then&&w.then((()=>{m("gPCI() resolved"),w=null}),(()=>{m("gPCI() rejected"),w=null}))),w}_parseCachableLinks(e){const t={};e.headers["content-location"];const r=e.headers.link;if(r){const e=n.parse(r);let s=e.get("rel",D);s&&(t.primaryTemplate=s[0].uri),s=e.get("rel",I),s?t.manifestTemplate=s[0].uri:(s=e.get("rel",C),s&&(t.manifestTemplate=s[0].uri)),s=e.get("rel",v),s&&(t.componentTemplate=s[0].uri),s=e.get("rel",b),s&&(t.versionHistory=s[0].uri),s=e.get("rel",T),s&&(t.renditionTemplates=s)}return t}getCachedAssetInfo(e,t){m("getCachedAssetInfo()");const r=this._infoForAssetId(e);if(r)return m("gCAI() cached"),t(void 0,r);const s=this._awaitInfoForAssetId(e,t);if(m("gCAI() needs head req",s),s){let r;const s=s=>{let o=n.expandURITemplate(s,{asset_id:e});if(o=this._resolveUrl(o),!o)return m("gCAI() no href"),t(new _.default(_.default.WRONG_ENDPOINT,"Wrong endpoint: "+o));let d={};return r&&(d={reuseRequestDesc:r},m("gCAI() reuse RD",d)),r=this._service.invoke(i.HTTPMethods.HEAD,o,{},void 0,Object.assign(Object.assign({},d),{isStatusValid:E,retryOptions:A,autoParseJson:y}),((t,r)=>{if(m("gCAI() resolveAssetId() resolved",t,r),t)return this._cacheInfoForAssetId(e,t);const s=r.statusCode;if(200===s){const t=this._parseCachableLinks(r);return this._cacheInfoForAssetId(e,void 0,t)}return 404===s?this._cacheInfoForAssetId(e,new _.default(_.default.ASSET_NOT_FOUND,"Asset not found",t,r)):this._cacheInfoForAssetId(e,a.unexpectedResponse("Unable to resolve asset id.",t,r))})),r};return this._assetIdResolutionTemplate?(m("gCAI() has resolution template"),s(this._assetIdResolutionTemplate)):(m("gCAI() get resolution template"),P=this.getPromiseCacheInfo(this.resolveRootURLAsync.bind(this)).then((e=>(m("gCAI() getPromiseCacheInfo() resolved",e),this._assetIdResolutionTemplate=e.href,s(e.self._assetIdResolutionTemplate)))).catch((e=>{m("gCAI() getPromiseCacheInfo() rejected",e);const r=new _.default(_.default.UNEXPECTED_RESPONSE,"Unable to retrieve asset id resolution link from root resource.",e,e.response);return t(r)})),m("gCAI() rootReqDesc",P),P)}}registerLinks(e){e=e._links||e;const t={};t.assetId="urn:aaid:faux:"+n.generateUuid();let r=e[D];return r&&(t.primaryTemplate=r.href),r=e[C],r&&(t.manifestTemplate=r.href),r=e[I],r&&(t.manifestTemplate=r.href),r=e[v],r&&(t.componentTemplate=r.href),r=e[b],r&&(t.versionHistory=r.href),r=e[T],r&&(t.renditionTemplates=[{rel:"rendition",uri:r.href}]),this._assetInfoCache[t.assetId]=t,t.assetId}_infoForAssetId(e){const t=this._assetInfoCache[e];if(t&&!t.callbacks)return t}_awaitInfoForAssetId(e,t){m("_awaitInfoForAssetId");let r=this._assetInfoCache[e];return r?(m("_aIFA pending"),r.callbacks.push(t),!1):(m("_aIFA not pending"),r={},r.assetId=e,r.callbacks=[t],this._assetInfoCache[e]=r,!0)}_cacheInfoForAssetId(e,t,r){m("_cacheInfoForAssetId");let s=this._assetInfoCache[e];if(s){if(t){const r=s.callbacks;this._assetInfoCache[e]=void 0;for(let e=0;e<r.length;e++)r[e](t)}}else!t&&r&&(this._assetInfoCache[e]=s={});if(!t&&r&&(s.assetId||(s.assetId=e),s.primaryTemplate=r.primaryTemplate,s.manifestTemplate=r.manifestTemplate,s.componentTemplate=r.componentTemplate,s.versionHistory=r.versionHistory,s.renditionTemplates=r.renditionTemplates,s.callbacks)){for(let e=0;e<s.callbacks.length;e++)s.callbacks[e](void 0,s);s.callbacks=void 0}}_resolveUrl(e){return n.endPointOf(e)?e:n.appendPathElements(this._server,e)}_makeRelativeUrl(e){if(n.endPointOf(e)){const t=n.parseURI(e);(t.scheme||t.authority)&&(e=t.path,t.query&&(e+="?"+t.query),t.fragment&&(e+="#"+t.fragment))}return e}_parseAsyncResponse(e){m("_parseAsyncResponse");const t=e.responseText||e.response;if(!t)throw new _.default(_.default.INVALID_DATA,"No body data.");const r={},s=t.indexOf("\n");if(-1===s)throw new _.default(_.default.INVALID_DATA,"Could not find status line.");const o=t.slice(0,13===t.charCodeAt(s-1)?s-1:s).split(" ");if(r.statusCode=parseInt(o[1],10),!r.statusCode)throw new _.default(_.default.INVALID_DATA,"Could not find status code.");o.length>2&&(r.statusText=o[2]);let i=t.search(/\r?\n\r?\n/);-1===i&&(i=t.length);const a=t.slice(s+1,i);r.headers=n.parseHeaders(a);const d="\r"===t.charAt(i)?i+4:i+2;return r.response=t.slice(d),r}_pollForAsyncResponse(e,t,r,s){m("_pollForAsyncResponse");const n=Date.now()+1e3*t,d={responseType:"text",reuseRequestDesc:r,noSoonerThen:n,isStatusValid:E,retryOptions:A,autoParseJson:y};o.log("asynchronous request - polling");const c=this._service.invoke(i.HTTPMethods.GET,e,void 0,void 0,d,((t,n)=>{if(t)return s(a.networkError("Error polling for an asynchronous reponse",t,n));let i=n.statusCode;if(202===i){let t;o.log("asynchronous request - not yet ready"),n.headers["retry-after"]&&(t=parseInt(n.headers["retry-after"],10)),this._pollForAsyncResponse(e,t||10,r,s)}else if(200===i){o.log("asynchronous request - success");try{n=this._parseAsyncResponse(n)}catch(e){return s(a.unexpectedResponse("Error parsing response body.",e,n))}i=n.statusCode,200===i||201===i||204===i?s(void 0,n):s(a.unexpectedResponse("Unexpected response polling for an asynchronous response",t,n))}else o.log("asynchronous request - error"),s(a.unexpectedResponse("Unexpected response polling for an asynchronous response",t,n))}));r=c}_handle202Response(e,t,r,s){m("_handle202Response");const o=e.responseText||e.response;let n;try{n=JSON.parse(o)}catch(t){return s(a.unexpectedResponse("Error parsing 202 response body.",t,e))}const i=n.href;if(!i)return s(a.unexpectedResponse("202 response missing an href.",void 0,e));let d=e.headers["retry-after"];d=d?parseInt(d,10):r,this._pollForAsyncResponse(this._resolveUrl(i),d,t,s)}}const O=()=>!0,k={disableRetry:!0},S=!1,N="/content/2/",L=/^\/?content\/2\/[^\/]+\/[^\/]+/,M=/^\/?api\/v2\/[^\/]+\/assets\/[^\/]+/,X={"image/jpeg":"jpg","image/png":"png"};class B extends R{constructor(e,t){if(super(e,t),this.name="AdobeCommunitySession",!this._endPoint)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Could not determine endpoint from: "+t)}publishCompositeAtResource(e,t,r){let s="/api/v2/"+t.communityId+"/assets";s=this._resolveUrl(s);const o={resource_path:this.assetIdFromSSResourceHref(t.resourcePath),resource_type:e,metadata:this.metadataFromPubRecord(t)},n={[i.HeaderKeys.CONTENT_TYPE]:i.JSONMediaType};return this._service.invoke(i.HTTPMethods.POST,s,n,JSON.stringify(o),{responseType:"text",autoParseJson:S,isStatusValid:O,retryOptions:k},(function(e,s){if(e)return r(a.networkError("Error publishing composite",e,s));if(201===s.statusCode){const o=s.headers.location;if(!o)return e=new a.AdobeDCXError(a.AdobeDCXError.INVALID_DATA,"Missing location header returned on response by server",void 0,s),r(a.unexpectedResponse("Unexpected response publishing composite",e,s));const n=function(e){const t=e.match("^.*?\\/api\\/v2\\/([^/]*)/assets\\/([^\\/]*).*$");return t?t[2]:null}(o);if(n)return t.assetId=n,r(void 0,o)}return r(a.unexpectedResponse("Unexpected response publishing composite",e,s))}))}updateCpMetadataAtResource(e,t,r){let s="/api/v2/"+t.communityId+"/assets/"+t.assetId;s=this._resolveUrl(s);const o=this.metadataFromPubRecord(t),n={[i.HeaderKeys.CONTENT_TYPE]:i.JSONMediaType};return this._service.invoke(i.HTTPMethods.PUT,s,n,JSON.stringify(o),{responseType:"text",autoParseJson:S,isStatusValid:O,retryOptions:k},((e,t)=>e?r(a.networkError("Error publishing composite",e,t)):200===t.statusCode?r(void 0,s):r(a.unexpectedResponse("Unexpected response publishing composite",e,t))))}getCpMetadata(e,t){let r="/api/v2/"+e.communityId+"/assets/"+e.assetId;r=this._resolveUrl(r),this._service.invoke(i.HTTPMethods.GET,r,{},void 0,{responseType:"text",autoParseJson:S,isStatusValid:O,retryOptions:k},(function(r,s){if(r)return t(a.networkError("Error getting metadata for CP composite",r,s));if(200===s.statusCode){let r;const o=s.response||s;try{r=JSON.parse(o),e.resourcePath=r.resource_path,e.description=r.description||null,e.title=r.title||null,e.alias=r.alias||null,e.undiscoverable=r.undiscoverable||!1,e.isPrivate=r.private||!1;let t=r.tags;t&&null!==t&&t.length>0&&(e.tags=t);let s=r._embedded;if(s&&null!==s&&(t=r.creators,t&&null!==t&&t.length>0)){const r=[];for(let e=0;e<t.length;++e){const s=t[e];if(s&&null!==s){const e=s.id;e&&null!==e&&r.push(e)}}0!==r.length&&(e.creatorIds=r)}if(s=r.category_id,s&&null!==s&&(e.categoryId=s.id||null),t=r.sub_categories,t&&null!==t&&t.length>0){e.subCategoryIds=[];for(let r=0;r<t.length;++r)s=t[r],e.subCategoryIds.push(s.id)}s=r.custom,s&&null!==s&&(e.custom=s)}catch(e){const r=new a.AdobeDCXError(a.AdobeDCXError.INVALID_DATA,"Invalid JSON returned by server",e,s);return t(r)}return t(void 0,e)}return t(a.unexpectedResponse("Unexpected response while getting metadata for CP composite",r,s))}))}updatePublicationRecordData(e,t){const r=t.versionId;if(e.mainResource="manifest",r&&(e.mainResourceVersion=r),null!==e.artworkComponentId){const r=t.getComponentWithId(e.artworkComponentId);if(null==r)throw new a.AdobeDCXError(a.AdobeDCXError.COMPONENT_DOWNLOAD_ERROR,"Bad component ID = "+e.artworkComponentId);let s=e.resourcePath;s=this.assetIdFromSSResourceHref(s),s+=r.absolutePath,e.artworkResource=s,e.artworkResourceVersion=r.version}}getCompositeManifestHref(e,t,r){if(t)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"AdobeCommunitySession does not support version manifests.");if(!e.assetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Composite must be bound.");if(!this.isProperAssetId(e.assetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");const s=this._resolveUrl(e.assetId);if(!s)throw new a.AdobeDCXError(a.AdobeDCXError.WRONG_ENDPOINT,"Wrong endpoint: "+e.assetId);return r(void 0,n.appendPathElements(s,"manifest"))}getComponent(e,t,r){const s={};let o=s;return this.getComponentHref(e,e.version,((e,n)=>e?r(e):(o=o||s,this._getAsset(n,void 0,t,o,r)))),o||s}getRenditionOfComponent(e,t,r,s,o,n){const i={};let a=i;return this.getComponentRenditionHref(e,e.version,t,r,s,((e,r)=>e?n(e):(a=a||i,this._getAsset(r,{accept:t},o,a,n)))),a||i}getCompositeManifest(e,t,r,s){let o=e.assetId;return o&&(o=this._resolveUrl(o)),o?(o=n.appendPathElements(o,"manifest"),this.getAssetAsType(o,"text",r,s)):s(new a.AdobeDCXError(a.AdobeDCXError.WRONG_ENDPOINT,"Wrong endpoint: "+e.assetId))}headRequest(e,t){return this._service.invoke(i.HTTPMethods.HEAD,e,{},void 0,{responseType:"text",autoParseJson:S,isStatusValid:O,retryOptions:k},(function(e,r){if(e)return t(e);t(e,r)}))}getComponentHref(e,t,r){const s=e._owner;if(!s||!s.compositeAssetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Component must be part of a branch of a bound composite.");if(!this.isProperAssetId(s.compositeAssetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");if(s._core){const t=s._core._getSourceAssetInfoOfComponent(e);if(t)return void r(void 0,this._constructComponentHref(t.compositeAssetId,t.componentPath,t.componentVersion))}r(void 0,this._constructComponentHref(s.compositeAssetId,e.absolutePath,t))}getComponentRenditionHref(e,t,r,s,o,n){const i=e._owner;if(!i||!i.compositeAssetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Component must be part of a branch of a bound composite.");if(!this.isProperAssetId(i.compositeAssetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");if(i._core&&i._core._getSourceAssetInfoOfComponent(e))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Getting a rendition of a source href not implemented.");return n(void 0,this._constructComponentRenditionHref(i.compositeAssetId,e.absolutePath,t,r,s,o))}isProperAssetId(e){return n.ensureRelativeHrefStartsWithSlash(e)}_constructComponentHref(e,t,r){const s=t.slice(1);let o=n.appendPathElements(this._resolveUrl(e),s);return o&&void 0!==r&&(this._hrefUsesContentApis(e)?o+="/version/"+r:o+="?version="+r),o}_constructComponentRenditionHref(e,t,r,s,o,i){let d,c;const h=t.slice(1),l=n.parseURI(e).path;if(l.slice(0,11)===N){const t=X[s];if(!t)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Unsupported rendition media type: "+s);if(d=L.exec(l),!(d&&d.length>0))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Failed to parse composite href: "+e);c=this._resolveUrl(n.appendPathElements(d[0],"rendition",h,"version",r,"format",t,"dimension",o,"size",String(i)))}else{if(d=M.exec(l),!(d&&d.length>0))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Failed to parse composite href: "+e);c=this._resolveUrl(n.appendPathElements(d[0],"rendition",o,String(i),h)+"?version="+r)}return c}_hrefUsesContentApis(e){return n.parseURI(e).path.slice(0,11)===N}assetIdFromSSResourceHref(e){const t=e.match("^\\/pubs\\/([^\\/]*).*$");return t?t[1]:null}metadataFromPubRecord(e){const t={};if(null!==e.title&&(t.title=e.title),null!==e.description&&(t.description=e.description),null!==e.alias&&(t.alias=e.alias),t.undiscoverable=e.undiscoverable,e.isPrivate&&(t.private=e.isPrivate),Array.isArray(e.tags)&&(t.tags=[...e.tags]),Array.isArray(e.creatorIds)&&(t.creator_ids=[...e.creatorIds]),null!==e.categoryId&&(t.category_id=e.categoryId),Array.isArray(e.subCategoryIds)&&(t.sub_category_ids=[...e.subCategoryIds]),null!==e.custom&&(t.custom=e.custom),null!==e.mainResource&&null!==e.mainResourceVersion){const r={};r.resource_path=e.mainResource,r.resource_version=e.mainResourceVersion,t.main_resource=r}if(null!==e.artworkResource&&null!==e.artworkResourceVersion){const r={};r.resource_path=e.artworkResource,r.resource_version=e.artworkResourceVersion,t.artwork=r}return t}}const x={unmodified:"unmodified",modified:"modified",pendingDelete:"pendingDelete",committedDelete:"committedDelete"},j={pending:"pending",active:"active",archived:"archived"},U={name:!0,id:!0,state:!0,path:!0,rel:!0,type:!0,etag:!0,length:!0,version:!0,md5:!0,width:!0,height:!0};class V{constructor(e,t=!1){this._readOnly=!1,this._data={},this.records={},e&&this._setData(e),this._readOnly=t}get compositeId(){return this._compositeId}get owner(){return this._owner}get data(){return this._data}get id(){return this._data.id}set id(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._owner)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the id of a component that is part of a branch or element.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.id=e,this._setDirty()}get name(){return this._data.name}set name(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.name=e,this._setDirty()}get type(){return this._data.type}set type(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.type=e,this._setDirty()}get path(){return this._data.path}set path(e){if(this._data.path!==e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!n.isValidPath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a valid path.");this._owner?this._owner._core._setPathOfComponent(this,e):(this._data.path=e,this._parentPath=""),this._setDirty()}}get parentPath(){return this._parentPath}set parentPath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"parentPath is read-only.")}get absolutePath(){return this._data.path&&this._owner?n.appendPathElements(this._parentPath,this._data.path):void 0}set absolutePath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"absolutePath is read-only.")}get relationship(){return this._data.rel}set relationship(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.rel=e,this._setDirty()}get state(){return this._data.state}set state(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.keys(x).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "modified", "unmodified", "pendingDelete", or "committedDelete".');this._data.state=e,this._setDirty()}get etag(){return this._data.etag}set etag(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.etag=e,this._setDirty()}get md5(){return this._data.md5}set md5(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.md5=e,this._setDirty()}get version(){return this._data.version}set version(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(void 0!==e&&"string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.version=e,this._setDirty()}get length(){return this._data.length}set length(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.length=e,this._setDirty()}get width(){return this._data.width}set width(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.width=e,this._setDirty()}get height(){return this._data.height}set height(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.height=e,this._setDirty()}get assetId(){return this._assetId}set assetId(e){if(e!==this._assetId){if(this._assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"assetId property cannot be changed.");this._assetId=e}}get repositoryId(){return this._repoId}set repositoryId(e){if(e!==this._repoId){if(this._repoId)throw new a.DCXError(a.DCXError.INVALID_STATE,"repoId property cannot be changed.");this._repoId=e}}getComponentDescriptor(){if(!i.isAdobeDCXBranchLike(this._owner))throw new a.DCXError(a.DCXError.INVALID_STATE,"Component must be part of a composite to get a descriptor.");return JSON.stringify({versionId:c.CURRENT_COMPONENT_DESCRIPTOR_VERSION,componentId:this.id,compositeId:this._owner.compositeId,cloudAssetId:this._owner.compositeAssetId,repositoryId:this.repositoryId||this._owner.compositeRepositoryId,componentRevisionId:this.version,type:this.type,size:this.length,etag:this.etag,hashType:c.CURRENT_COMPONENT_DESCRIPTOR_HASH_TYPE,hashValue:this.md5})}getCustomKeys(){const e=[],t=Object.keys(this._data),r=t.length;for(let s=0;s<r;s++){const r=t[s];U[r]||e.push(r)}return e}getValue(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');return this._data[e]}setValue(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');this._data[e]=t,this._setDirty()}removeValue(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');delete this._data[e],this._setDirty()}getLink(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');return this._data._links?this._data._links[e]:void 0}setLink(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("object"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "link" must be an object.');if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');let r=this._data._links;r||(r=this._data._links={}),r[t]=e,this._setDirty()}removeLink(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');const t=this._data._links;t&&(delete t[e],Object.keys(t).length<1&&delete this._data._links,this._setDirty())}isEqualTo(e,t){return n.objectsEqual(this._data,e._data,t)}_setData(e){const t=this._verify(e);if(null===t)return this._data=e,this;throw t}_setDirty(){this._owner&&this._owner._setDirty()}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Component is missing an id of type string"):null}}V.STATES=x;class H{constructor(e,t=!1,r=!1){this._data={},e&&this._setData(e),this._readOnly=t,this._isRoot=r}get owner(){return this._owner}get id(){return this._data.id}set id(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._owner)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the id of a node that is part of a branch or element.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.id=e,this._setDirty()}get name(){return this._data.name}set name(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.name=e,this._setDirty()}get type(){return this._data.type}set type(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.type=e,this._setDirty()}get relationship(){return this._data.rel}set relationship(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.rel=e,this._setDirty()}get path(){return this._isRoot?H.ROOT_PATH:this._data.path}set path(e){if(e!==this.path){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._isRoot)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the path of the root node.");if(e&&!n.isValidPath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a valid path or undefined.");this._owner?this._owner._setPathOfNode(this,e||void 0):(this._data.path=e||void 0,this._parentPath=""),this._setDirty()}}get parentPath(){return this._parentPath}set parentPath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"parentPath is read-only.")}get absolutePath(){const e=this.path;return this._isRoot?e:e&&this._owner?n.appendPathElements(this._parentPath,e):void 0}set absolutePath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"absolutePath is read-only.")}get isRoot(){return this._isRoot}set isRoot(e){throw new a.DCXError(a.DCXError.READ_ONLY,"isRoot is read-only.")}getLink(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');return this._data._links?this._data._links[e]:void 0}setLink(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("object"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "link" must be an object.');if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');let r=this._data._links;r||(r=this._data._links={}),r[t]=e,this._setDirty()}removeLink(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');const t=this._data._links;t&&(delete t[e],Object.keys(t).length<1&&delete this._data._links,this._setDirty())}getCustomKeys(){const e=[],t=Object.keys(this._data),r=t.length;for(let s=0;s<r;s++){const r=t[s];(this._isRoot?F[r]:Y[r])||e.push(r)}return e}getValue(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");return this._data[e]}setValue(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");this._data[e]=t,this._setDirty()}removeValue(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");delete this._data[e],this._setDirty()}copy(){let e;const t=this._data.children,r=this._data.components;try{t&&delete this._data.children,r&&delete this._data.components;const s=JSON.parse(JSON.stringify(this._data));e=new H(s)}finally{t&&(this._data.children=t),r&&(this._data.components=r)}return e}isEqualTo(e,t,r){return this._isEqual(this._data,e._data,n.merge({children:!0,components:!0},t),r)}_isEqual(e,t,r,s){let o,i,a,d,c;if(!n.objectsEqual(e,t,r))return!1;if(i=e.components,a=t.components,d=i?i.length:0,c=a?a.length:0,d!==c)return!1;if(d){let e,t,r;for(o=0;o<d;o++){for(e=i[o],t=null,r=0;r<d;r++)if(e.id===a[r].id){t=a[r];break}if(!t)return!1;if(!n.objectsEqual(e,t,s))return!1}}if(i=e.children,a=t.children,d=i?i.length:0,c=a?a.length:0,d!==c)return!1;if(d)for(o=0;o<d;o++)if(!this._isEqual(i[o],a[o],r,s))return!1;return!0}_setData(e){const t=this._verify(e);if(null===t)return this._data=e,this;throw t}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Node is missing an id of type string"):null}_setDirty(){this._owner&&this._owner._setDirty()}}H.ROOT_PATH="/";const F={components:!0,children:!0,"manifest-format-version":!0,id:!0,name:!0,type:!0,state:!0,local:!0},Y={components:!0,children:!0,rel:!0,path:!0,id:!0,name:!0,type:!0};class W{constructor(e,t,r=!1){this._allNodes={},this._allComponents={},this._absolutePaths={},this._readOnly=!1,this._isDirty=!1,this._sourceAssetInfoLookup={},this._readOnly=r,this._owner=t,this._setData(e)}get allNodes(){return this._allNodes}get rootNode(){return this.getChildWithAbsolutePath(H.ROOT_PATH)}set rootNode(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "rootNode" is read-only.')}get isDirty(){return this._isDirty}set isDirty(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isDirty.")}get changeCount(){return this._data.local&&this._data.local.change||0}set changeCount(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property changeCount.")}getChildWithId(e){return this._allNodes[e]}getChildWithAbsolutePath(e){const t=this._absolutePaths[e.toLowerCase()];return t&&t instanceof H?t:void 0}getChildrenOf(e){const t=e?this._allNodes[e.id]:this.rootNode;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown node");const r=[],s=t._data.children;if(Array.isArray(s))for(let e=0;e<s.length;e++){const t=s[e],o=this._allNodes[t.id];if(!o)throw new a.DCXError(a.DCXError.INVALID_DATA,"Node not in cache");r.push(o)}return r}addChild(e,t,r,s){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(t=t||n.generateUuid(),this._allNodes[t])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Node already exists in branch.");if(r&&("number"!=typeof r||r%1!=0))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "index" must be an integer.');const o=s?this._allNodes[s.id]:this.rootNode;if(!o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const i=new H;i.id=t,e&&(i.name=e),i._parentPath=o.absolutePath||o._parentPath;const d=o._data.children;return d?(r>=0&&r<=d.length||(r=d.length),r===d.length?d[r]=i._data:d.splice(r,0,i._data)):o._data.children=[i._data],this._allNodes[i.id]=i,i._owner=this._owner,this._setDirty(),i}removeChild(e){let t=e;if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');if(t.isRoot)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot remove the root node.");const r=t.id;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "node" must have an id.');const s=this._nodeDataOfParentOfNode(t);if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node not found in this branch.");const o=s.parentNodeData.children;return o&&(o.splice(s.index,1),0===o.length&&delete s.parentNodeData.children),t=this._allNodes[r],this._removeNodeFromCachesRecursively(t._data),this._setDirty(),t}moveChild(e,t,r){let s=e;const o=r;if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');if(s.isRoot)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot move the root node.");if(t&&("number"!=typeof t||t%1!=0))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "index" must be an integer.');const n=s.id;if(!n)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "node" must have an id.');const i=this._nodeDataOfParentOfNode(s);if(s=this._allNodes[n],!i)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node not found in this branch.");const d=o?this._allNodes[o.id]:this.rootNode;if(!d)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");if(this._nodeIdIsDescendantOf(d.id,s._data))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Must not create a cycle.");const c=i.parentNodeData.children.splice(i.index,1)[0];try{const e=d._data.children;e?(t>=0&&t<=e.length||(t=e.length),t===e.length?e[t]=c:e.splice(t,0,c)):d._data.children=[c]}catch(e){throw i.parentNodeData.children.splice(i.index,0,c),e}return 0===i.parentNodeData.children.length&&delete i.parentNodeData.children,this._setDirty(),this._allNodes[n]}copyChild(e,t,r,s,o,n){return this._copyChild(e,t,r,s,o,!1,n)}replaceChild(e,t,r,s){return this._copyChild(e,void 0,void 0,t,r||e.id,!0,s)}getMissingComponentsFromError(e){var t;return e.code!==a.DCXError.INCOMPLETE_COMPOSITE?[]:(null!==(t=e.response.response.report.failures.filter((e=>"MissingComponent"===e.rule)))&&void 0!==t?t:[]).map((e=>this.getComponentWithId(e.component_id)||this.getComponentWithAbsolutePath(e.component_path))).filter((e=>e))}allComponents(){const e=[];for(const t in this._allComponents)Object.prototype.hasOwnProperty.call(this._allComponents,t)&&e.push(this._allComponents[t]);return e}getComponentWithId(e){return this._allComponents[e]}getComponentWithAbsolutePath(e){const t=this._absolutePaths[e.toLowerCase()];return t&&t instanceof V?t:void 0}getComponentsOf(e){const t=e?this._allNodes[e.id]:this.rootNode;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown node");const r=[],s=t._data.components;if(Array.isArray(s)){let e;for(e=0;e<s.length;e++){const t=s[e],o=this._allComponents[t.id];if(!o)throw new a.DCXError(a.DCXError.INVALID_DATA,"Component not in cache");r[r.length]=o}}return r}addComponentWithComponentDescriptor(e,t,r,s=i.LinkRelation.COMPONENT,o){return this.addComponentWithUploadResults(t,s,r,o,c.uploadResultsFromComponentDescriptor(e))}addComponentWithUploadResults(e,t,r,s,o){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(o.compositeId!==this._owner.compositeId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not appear valid to be for this composite.");const n=Object.keys(o.records);if(1!==n.length)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults must contain records of exactly one component upload.");const i=o.records[n[0]],d=i.id;if(this._allComponents[d])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate component id: "+d);const c=s?this._allNodes[s.id]:this.rootNode;if(!c)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const h=new V;h.id=d,h.name=e,h.type=i.type,h.relationship=t,h.path=r,h.state=x.unmodified,h.etag=i.etag,h.length=i.length,h.version=i.version,h.md5=i.md5;const l=this._normalizedAbsolutePathForItem(h,c);if(this._absolutePaths[l])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+l);h._parentPath=c.absolutePath||c._parentPath;const u=c._data.components;return u?u.push(h.data):c._data.components=[h.data],h._owner=this._owner,this._allComponents[d]=h,this._absolutePaths[l]=h,this._setDirty(),h}updateComponentWithUploadResults(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!(e=this._allComponents[e.id]))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown component.");if(t.compositeId!==this._owner.compositeId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not appear to be valid for this composite.");const r=t.records[e.id];if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not contain an upload record for the given component.");return e.etag=r.etag,e.version=r.version,e.md5=r.md5,e.length=r.length,this._setSourceAssetInfoOfComponent(void 0,e),e.state=x.unmodified,this._setDirty(),e}removeComponent(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const t=e.id;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "component" must have an id.');const r=this._nodeDataOfParentOfComponent(e);if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component not found in this branch.");return r.parentNodeData.components.splice(r.index,1),0===r.parentNodeData.components.length&&delete r.parentNodeData.components,e=this._allComponents[t],delete this._allComponents[t],delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],e._owner=void 0,e._parentPath="",this._setDirty(),e}moveComponent(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const r=e.id;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "component" must have an id.');const s=this._nodeDataOfParentOfComponent(e);if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component not found in this branch.");const o=t?this._allNodes[t.id]:this.rootNode;if(!o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const n=this._normalizedAbsolutePathForItem(e,o);if(this._absolutePaths[n])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+n);const i=s.parentNodeData.components.splice(s.index,1)[0],d=o._data.components;return d?d.push(i):o._data.components=[i],0===s.parentNodeData.components.length&&delete s.parentNodeData.components,e=this._allComponents[r],delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],e._parentPath=o.absolutePath||o._parentPath,this._absolutePaths[n]=e,this._setDirty(),e}copyComponent(e,t,r,s,o){return this._copyComponent(e,t,r,s,!1,o)}replaceComponent(e,t,r,s){const o=this._copyComponent(e,void 0,t,r||e.id,!0,s);return r&&r!==e.id&&delete this._allComponents[e.id],o}_getHrefOfComponent(e){let t;const r=this._getBranchOf(e).compositeHref;return r&&void 0!==e.version&&(t=n.appendPathElements(r,e.id),t+=";version="+e.version),t}_setSourceAssetInfoOfComponent(e,t){const r=t.id,s=this._sourceAssetInfoLookup;e?s[r]=e:s[r]&&delete s[r]}_getSourceAssetInfoOfComponent(e){const t=e.id,r=this._sourceAssetInfoLookup;if(r)return r[t]}_copySourceHrefsFrom(e){const t=e._sourceAssetInfoLookup,r=this.allComponents(),s=r.length;if(s&&t){const e=this._sourceAssetInfoLookup;for(let o=0;o<s;o++){const s=r[o].id;e[s]=t[s]}}}_getBranchOf(e){return e._owner?this._getBranchOf(e._owner):e}_isSameComposite(e){const t=this._getBranchOf(this),r=this._getBranchOf(e);return t._data.id===r._data.id&&t.compositeAssetId===r.compositeAssetId&&t.compositeRepositoryId===r.compositeRepositoryId}_stringify(e,t=!1){if(e){const e=this._data.local;let r=null;try{delete this._data.local,r=JSON.stringify(this._data,void 0,t?2:void 0)}finally{e&&(this._data.local=e)}return r}return JSON.stringify(this._data,void 0,t?2:void 0)}_setData(e){const t=new H(e,this._readOnly,!0);t._owner=this._owner,t._parentPath="";const r=t.id,s={},o={},i={};o[r]=t,i[H.ROOT_PATH]=t;const d=(e,t)=>{let r,c;const h=e.components;if(Array.isArray(h))for(let e=0;e<h.length;e++){const r=h[e],o=new V(r,this._readOnly);if(s[o.id])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate component id: "+o.id);if(o._owner=this._owner,o._parentPath=t,c=this._normalizedAbsolutePathForItem(o),i[c])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate absolute path: "+c);if(!n.isValidAbsolutePath(c))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid absolute component path: "+c);s[o.id]=o,i[c]=o}const l=e.children;if(Array.isArray(l))for(let e=0;e<l.length;e++){const s=l[e],h=new H(s,this._readOnly);if(o[h.id])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate node id: "+h.id);if(r=h.path,h._owner=this._owner,h._parentPath=t,r){if(c=this._normalizedAbsolutePathForItem(h),i[c])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate absolute path: "+c);if(!n.isValidAbsolutePath(c))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid node absolute path: "+c);i[c]=h}o[h.id]=h,d(s,h.path?n.appendPathElements(t,h.path):t)}};return d(e,H.ROOT_PATH),this._data=e,this._allComponents=s,this._allNodes=o,this._absolutePaths=i,this._isDirty=!1,this}_removeNodeFromCachesRecursively(e){const t=e.components;if(Array.isArray(t))for(let e=0;e<t.length;e++){const r=t[e].id,s=this._allComponents[r];delete this._allComponents[r],delete this._absolutePaths[this._normalizedAbsolutePathForItem(s)],s._owner=void 0}const r=e.children;if(Array.isArray(r))for(let e=0;e<r.length;e++)this._removeNodeFromCachesRecursively(r[e]);const s=e.id,o=this._allNodes[s];delete this._allNodes[s],o.path&&delete this._absolutePaths[this._normalizedAbsolutePathForItem(o)],o._owner=void 0}_local(){return this._data.local||(this._data.local={version:2}),this._data.local}_recursiveReset(e,t){const r=e.components;if(r)for(let e=r.length-1;e>=0;e--){const s=r[e];s.state===x.committedDelete?(delete r[e],delete this._allComponents[s.id],delete s._owner,this._setSourceAssetInfoOfComponent(void 0,s)):(delete s.etag,delete s.version,s.state=x.modified,t&&t(s))}const s=e.children;if(s)for(let e=0;e<s.length;e++)this._recursiveReset(s[e],t)}_nodeIdIsDescendantOf(e,t){const r=t.children;if(r)for(let t=0;t<r.length;t++){const s=r[t];if(s.id===e||this._nodeIdIsDescendantOf(e,s))return!0}return!1}_recursivelyGetAllComponentsOfChild(e,t=[]){const r=e._data||e,s=r.components;if(s){const e=s.length;for(let r=0;r<e;r++)t[t.length]=this._allComponents[s[r].id]}const o=r.children;if(o){const e=o.length;for(let r=0;r<e;r++)t=this._recursivelyGetAllComponentsOfChild(o[r],t)}return t}_nodeDataOfParentOfNode(e,t=this._data){const r=e._data.id,s=t.children;if(s)for(let o=0;o<s.length;o++){const n=s[o];if(n.id===r)return{parentNodeData:t,index:o};const i=this._nodeDataOfParentOfNode(e,n);if(i)return i}return null}_nodeDataOfParentOfComponent(e,t=this._data){const r=e._data.id,s=t.components;if(s)for(let e=0;e<s.length;e++)if(s[e].id===r)return{parentNodeData:t,index:e};const o=t.children;if(o)for(let t=0;t<o.length;t++){const r=o[t],s=this._nodeDataOfParentOfComponent(e,r);if(s)return s}return null}_determineAbsolutePathChangesRecursively(e,t,r){const s=e.components;if(s)for(let e=0;e<s.length;e++){const o=s[e],i=this._allComponents[o.id];r.push({item:i,parentPath:t,absPath:n.appendPathElements(t,o.path)})}const o=e.children;if(o)for(let e=0;e<o.length;e++){const s=o[e],i=this._allNodes[s.id],a=s.path,d=a?n.appendPathElements(t,a):t;r.push({item:i,parentPath:t,absPath:a?d:void 0}),this._determineAbsolutePathChangesRecursively(s,d,r)}}_setPathOfNode(e,t){const r=t?n.appendPathElements(e._parentPath,t):e._parentPath,s=[{item:e,absPath:t?r:void 0}];let o;this._determineAbsolutePathChangesRecursively(e._data,r,s);const i=n.flatCopy(this._absolutePaths);for(let e=0;e<s.length;e++){const t=s[e].item;t._data.path&&delete i[this._normalizedAbsolutePathForItem(t)]}for(let e=0;e<s.length;e++)if(o=s[e],o.absPath){const e=o.absPath.toLowerCase();if(i[e])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+e);if(!n.isValidAbsolutePath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid absolute path: "+e);i[e]=o.item}for(let e=0;e<s.length;e++)o=s[e],o.parentPath&&(o.item._parentPath=o.parentPath);e._data.path=t,this._absolutePaths=i}_setPathOfComponent(e,t){if(!this._allComponents[e.id])throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown component.");const r=n.appendPathElements(e._parentPath,t).toLowerCase();if(this._absolutePaths[r])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path for component: "+r);if(!n.isValidAbsolutePath(r))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid absolute path: "+r);delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],this._absolutePaths[r]=e,e._data.path=t}_setDirty(e=!1){if(!e){if(this._local().archivalState===j.pending||this._local().archivalState===j.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot modify an archived composite.");this._data.state!==x.pendingDelete&&this._data.state!==x.committedDelete||u.default.warn("Modifying deleted composite")}this._isDirty=!0,this._local().change=this.changeCount+1,e||this._data.state!==x.unmodified&&this._data.state||(this._data.state=x.modified)}_normalizedAbsolutePathForItem(e,t){let r;return r=t?n.appendPathElements(t.absolutePath||t._parentPath,e.path):e.absolutePath,r.toLowerCase()}_hasSameEndpoint(e){return!0}_copyComponent(e,t,r,s,o,i){n.validateParams(["component",e,"object"],["callback",i,"function",!0]);const d=e._owner._core;if(!d)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy, undefined component owner");const c=this._isSameComposite(d),h=c||this._hasSameEndpoint(e);if(d._local(),!h)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy between two different endpoints.");const l=function(e,t,r){z(e,t,c,h,!s)};if(!i)return this._copyComponentModel(e,t,o,r,s,l);try{i(void 0,this._copyComponentModel(e,t,o,r,s,l))}catch(e){i(a.DCXError.wrapError(a.DCXError.UNEXPECTED,"Unexpected error attempting to copy component model",e))}}_copyComponentModel(e,t,r,s,o,i){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const d=e._owner,c=new V(JSON.parse(JSON.stringify(e._data)));if(s?(c.path=s,c.id=o||n.generateUuid()):o&&(c.id=o),c._owner=this._owner,e.id===c.id&&this._isSameComposite(d._core)||(c.state=x.modified,c.etag=void 0,c.version=void 0,c.md5=void 0,c.length=void 0),this._allComponents[c.id]&&!r)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Component already exists.");const h=this._allComponents[e.id];if(r&&!h)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Could not find existing component.");let l,u;if(r){const e=this._nodeDataOfParentOfComponent(h);if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Parent node of existing component not found in this branch.");const t=e.parentNodeData.id;if(u=this._allNodes[t],!u)throw new a.DCXError(a.DCXError.INVALID_STATE,"Unknown parent node.");l=e.index}else if(u=t?this._allNodes[t.id]:this.rootNode,!u)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");c._parentPath=u.absolutePath||u._parentPath;const p=this._normalizedAbsolutePathForItem(c),_=this._absolutePaths[p];if(_&&_!==h)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+p);if(!n.isValidAbsolutePath(p))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component path must be a valid path for a component.");let f=this._local();i&&(f=n.deepCopy(f),i(e,c,f));const g=u._data.components;return r?g[l]=c.data:g?g.push(c.data):u._data.components=[c.data],this._data.local=f,this._allComponents[c.id]=c,this._absolutePaths[p]=c,this._setDirty(),c}_copyChild(e,t,r,s,o,n,i){if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');const d=e._owner._core,c=this._isSameComposite(d),h=c||this._hasSameEndpoint(e);if(d._local(),d._recursivelyGetAllComponentsOfChild(e).length>0&&!h)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy components between two different endpoints.");const l=(e,t,r)=>{z(e,t,c,h,!0)};if(!i)return this._copyChildModel(e,t,r,n,s,o,l);try{i(void 0,this._copyChildModel(e,t,r,n,s,o,l))}catch(e){i(e)}}_copyChildModel(e,t,r,s,o,i,d){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");const c=e._owner,h=new H(JSON.parse(JSON.stringify(e._data)));o?(h.path=o,h.id=i||n.generateUuid()):i&&(h.id=i),h._owner=this._owner,e.isRoot&&(delete h._data.local,delete h._data.state,delete h._data["manifest-format-version"]);const l=this._allNodes[h.id];if(l&&!s)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Child node already exists.");if(s&&!l)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Could not find existing node to replace.");let u;if(s){const e=this._nodeDataOfParentOfNode(l);if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Parent of existing node not found in this branch.");const t=e.parentNodeData.id;if(u=this._allNodes[t],!u)throw new a.DCXError(a.DCXError.INVALID_STATE,"Unknown parent node.");r=e.index}else if(u=t?this._allNodes[t.id]:this.rootNode,!u)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");if(h._parentPath=u.absolutePath||u._parentPath,h.path){const e=this._normalizedAbsolutePathForItem(h),t=this._absolutePaths[e];if(t&&t!==l)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+e);if(!n.isValidAbsolutePath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node path must be a valid path for a node.")}const p=n.flatCopy(this._allNodes),_=n.flatCopy(this._allComponents),f=n.flatCopy(this._absolutePaths),g=n.deepCopy(this._local()),m=function(e,t,r,s,o,n){let i,a;delete r[e.id],e.path&&delete o[t._normalizedAbsolutePathForItem(e)];const d=e._data.children;if(d)for(a=d.length,i=0;i<a;i++)m(r[d[i].id],t,r,s,o);const c=e._data.components;if(c)for(a=c.length,i=0;i<a;i++){const e=s[c[i].id];delete s[e.id],delete o[t._normalizedAbsolutePathForItem(e)]}};l&&m(l,this,p,_,f);const E=(e,t,r,s,o,i,h)=>{if(r[e.id])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate node id: "+e.id);let l;if(r[e.id]=e,e.path){if(l=t._core._normalizedAbsolutePathForItem(e),o[l])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+l);o[l]=e}const u=e._data.children;if(u){const a=u.length;for(let d=0;d<a;d++){const a=new H(u[d]);r[a.id]&&(a.id=n.generateUuid()),a._owner=t,a._parentPath=e.absolutePath||e._parentPath,E(a,t,r,s,o,i)}}const p=e._data.components;if(p){const r=p.length;for(let h=0;h<r;h++){const r=new V(p[h]),u=r.id;if(s[u]&&(r.id=n.generateUuid(),r.state=x.modified,r.etag=void 0,r.version=void 0,r.md5=void 0,r.length=void 0),r._owner=t,r._parentPath=e.absolutePath||e._parentPath,d&&d(c.getComponentWithId(u),r,i),s[r.id])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate component id: "+r.id);if(s[r.id]=r,l=t._core._normalizedAbsolutePathForItem(r),o[l])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+l);o[l]=r}}};if(E(h,this._owner,p,_,f,g,c._local()),s)u._data.children[r]=h._data;else{const e=u._data.children;e?(r>=0&&r<=e.length||(r=e.length),r===e.length?e[r]=h._data:e.splice(r,0,h._data)):u._data.children=[h._data]}return this._allNodes=p,this._allComponents=_,this._absolutePaths=f,this._data.local=g,this._setDirty(),h}_verifyIntegrity(e,t,r){const s=[];let o=!1;const i=e=>(s.push(new a.DCXError(a.DCXError.INVALID_STATE,e)),t&&(o||(t("Branch for composite "+this.rootNode.id+" has the following errors:"),o=!0),t("   "+e)),!1),d=function(e,t){return!!e||i(t)},c=[],h=function(e){(c.indexOf(e)<0||i("Item "+e.id+" encountered more than once"))&&c.push(e)},l=n.flatCopy(this._allComponents),u=n.flatCopy(this._allNodes),p=n.flatCopy(this._absolutePaths),_=Object.keys(p),f=_.length;for(let e=0;e<f;e++){const t=_[e];d("/"===t.charAt(0),"Absolute path "+t+" does not start with a slash.")}const g=(e,t)=>{let r,s;const o=e.children;if(o)for(r=0;r<o.length;r++){const e=o[r],a=u[e.id];(a||i("Node "+e.id+" is not in cache."))&&(h(a),d(a._data===e,"Node "+a.id+" _data property incorrect."),delete u[a.id],a.path&&a._owner&&(s=this._normalizedAbsolutePathForItem(a),(p[s]||i("Absolute path of node "+a.id+" ("+s+") is not in cache."))&&delete p[s]),d(a._parentPath===t,"Parent path of node "+a.id+" should be "+t+" but is "+a._parentPath),d(a._owner===this._owner,"Node "+a.id+" _owner property is not correct.")),g(e,e.path?n.appendPathElements(t,e.path):t)}const a=e.components;if(a)for(r=0;r<a.length;r++){const e=a[r],o=l[e.id];(o||i("Component "+e.id+" is not in cache."))&&(h(o),d(o._data===e,"Component "+o.id+" _data property incorrect."),delete l[o.id],o._owner&&(s=this._normalizedAbsolutePathForItem(o),(p[s]||i("Absolute path "+s+" is not in cache."))&&delete p[s]),d(o._parentPath===t,"Parent path of component "+o.id+" should be "+t+" but is "+o._parentPath),d(o._owner===this._owner,"Component "+o.id+" _owner property is not correct."))}},m=p[H.ROOT_PATH];d(m,"Cannot find root node via path")&&(d(m.id===this._data.id,"Root node has correct id"),d(m.path===H.ROOT_PATH,"Root node has correct path"),d(""===m._parentPath,"Root node has correct parent path"),d(m._owner===this._owner,"Root node has correct owner"),d(m._data===this._data,"Root node has correct data"),d(u[m.id]===m,"Cannot find root node via id")&&delete u[m.id],delete p[H.ROOT_PATH]),g(this._data,H.ROOT_PATH);let E=Object.keys(l);for(let e=0;e<E.length;e++)i("Component "+E[e]+" is in cache but could not be found.");E=Object.keys(u);for(let e=0;e<E.length;e++)i("Node "+E[e]+" is in cache but could not be found.");E=Object.keys(p);for(let e=0;e<E.length;e++)i("Absolute path "+E[e]+" is in cache but could not be found.");return s.length?s:null}}function z(e,t,r,s,o,i,d){if(!t._owner||!e._owner)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Failed to update storage for copied component, missing target or source branch core.");const c=t._owner._core,h=e._owner._core,l=r&&e.id===t.id;let u=h._getSourceAssetInfoOfComponent(e);const p=c.getComponentWithId(t.id),_=s&&(!p||!p.etag)&&e.state===x.unmodified,f=!l&&!u,g=f;if(o&&!p&&(u||f)&&e.id===t.id&&(t._data.id=n.generateUuid(),t.state=x.modified,t.etag=void 0,t.version=void 0,t.md5=void 0,t.length=void 0),f){if(_&&e._owner.compositeAssetId)u={compositeAssetId:e._owner.compositeAssetId,componentId:e.id,componentVersion:e.version,componentPath:e.absolutePath,repositoryId:e._owner.compositeRepositoryId},c._setSourceAssetInfoOfComponent(u,t);else if(g)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not use server-to-server copy for component "+e.id)}else c._setSourceAssetInfoOfComponent(u,t);u&&(t.state=x.modified)}class q{constructor(e,t,r=!1){this._owner=t,e?this._setData(e,r):(e={id:n.generateUuid()},this._core=new W(e,this,r),this._data=e)}get owner(){return this._owner}get rootNode(){return this._core.rootNode}get name(){return this._core.rootNode.name}set name(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t.rootNode.name=e}get type(){return this._core.rootNode.type}set type(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");t.rootNode.type=e}get compositeAssetId(){return this._owner?this._owner.compositeAssetId:void 0}set compositeAssetId(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "compositeAssetId" is read-only.')}get compositeRepositoryId(){return this._owner?this._owner.compositeRepositoryId:void 0}set compositeRepositoryId(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "compositeRepositoryId" is read-only.')}get _isDirty(){return this._core._isDirty}set _isDirty(e){this._core._isDirty=e}get isDirty(){return this._isDirty}get changeCount(){return this._core.changeCount}getChildWithId(e){return this._core.getChildWithId(e)}getChildWithAbsolutePath(e){return this._core.getChildWithAbsolutePath(e)}getChildrenOf(e){return this._core.getChildrenOf(e)}addChild(e,t,r,s){return this._core.addChild(e,t,r,s)}removeChild(e){return this._core.removeChild(e)}moveChild(e,t,r){return this._core.moveChild(e,t,r)}copyChild(e,t,r,s,o,n){return this._core.copyChild(e,t,r,s,o,n)}allComponents(){return this._core.allComponents()}getComponentWithId(e){return this._core.getComponentWithId(e)}getComponentWithAbsolutePath(e){return this._core.getComponentWithAbsolutePath(e)}getComponentsOf(e){return this._core.getComponentsOf(e)}getMissingComponentsFromError(e){return this._core.getMissingComponentsFromError(e)}addComponentWithUploadResults(e,t,r,s,o){return this._core.addComponentWithUploadResults(e,t,r,s,o)}addComponentWithComponentDescriptor(e,t,r,s,o){return this._core.addComponentWithComponentDescriptor(e,t,r,s,o)}updateComponentWithUploadResults(e,t){return this._core.updateComponentWithUploadResults(e,t)}removeComponent(e){return this._core.removeComponent(e)}moveComponent(e,t){return this._core.moveComponent(e,t)}copyComponent(e,t,r,s,o){return this._core.copyComponent(e,t,r,s,o)}parse(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "data" must be a string');let t;try{t=JSON.parse(e)}catch(e){throw new a.DCXError(a.DCXError.INVALID_JSON,"Manifest could not be parsed. Underlying error: "+e.message,e)}return this._setData(t,this._core._readOnly)}copy(){return new q(JSON.parse(JSON.stringify(this._data)),this._owner)}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing an id of type string"):"string"!=typeof e.name?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing a name of type string"):"string"!=typeof e.type?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing a type of type string"):null}_setData(e,t){const r=this._verify(e);if(null===r)return this._core=new W(e,this,t),this._data=e,this;throw r}_local(){return this._core._local()}_setDirty(e){this._core._setDirty(e)}_setPathOfNode(e,t){this._core._setPathOfNode(e,t)}_verifyIntegrity(e,t,r){return this._core._verifyIntegrity(e,t,r)}}var K;!function(e){e[e.NONE=0]="NONE",e[e.COPY=1]="COPY"}(K||(K={}));const G=o.newDebug("dcx:dcxjs:dcxbranch");class ${constructor(e,t,r,s){this._derivationType=K.NONE,e?this._setData(e,t,r,s):(e={"manifest-format-version":6,id:n.generateUuid()},this.originalManifestFormatVersion=6,this._core=new W(e,this,t),this._core._compositeAssetId=r,this._core._compositeRepositoryId=s,this._data=e),this._pendingElements=[]}get data(){return this._data}set data(e){this._data=e}get compositeId(){return this._core.rootNode.id}set compositeId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");if(t.allNodes[e])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"There is already a node with the same id.");delete t.allNodes[this._data.id],this._data.id=e,t.allNodes[e]=this._core.rootNode,t._setDirty()}get rootNode(){return this._core.rootNode}set rootNode(e){this._core.rootNode=e}get name(){return this._core.rootNode.name}set name(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t.rootNode.name=e}get type(){return this._core.rootNode.type}set type(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");t.rootNode.type=e}get compositeAssetId(){return this._core._compositeAssetId}set compositeAssetId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t._compositeAssetId=e}get compositeRepositoryId(){return this._core._compositeRepositoryId}set compositeRepositoryId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");n.validateParams(["repoId",e,"string",!0]),t._compositeRepositoryId=e}get compositeLinks(){return this._core._compositeLinks}set compositeLinks(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");n.validateParams(["links",e,"object",!0]),t._compositeLinks=e}get _isRepoComposite(){return!!this._core._compositeRepositoryId}get _collaborationType(){return this._data.local?this._data.local.collaborationType:void 0}set _collaborationType(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");e?t._local().collaborationType=e:delete t._local().collaborationType,t._setDirty(!0)}get _clientDataString(){return this._data.local?this._data.local.clientDataString:void 0}set _clientDataString(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");e?t._local().clientDataString=e:delete t._local().clientDataString,t._setDirty(!0)}get manifestEtag(){return this._data.local?this._data.local.manifestEtag:void 0}set manifestEtag(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t._local().manifestEtag=e,t._setDirty(!0)}get compositeState(){return this._data.state||x.unmodified}set compositeState(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.values(x).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "modified", "unmodified", "pendingDelete", or "committedDelete".');if(this._isRepoComposite&&(e===x.pendingDelete||e===x.committedDelete))throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites must be deleted in one step using RepoAPISession.");if(!(this._isRepoComposite||e!==x.pendingDelete&&e!==x.committedDelete||this.compositeArchivalState!==j.pending)||this.compositeArchivalState===j.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot delete an archived composite.");this._data.state=e,t._setDirty(!0)}get compositeArchivalState(){return this._core._local().archivalState||j.active}set compositeArchivalState(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.values(j).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "pending", "archived", or "active".');if(this._isRepoComposite&&e===j.pending)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites must be discarded in one step using RepoAPISession#discardAsset.");if(this.compositeArchivalState===j.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite has already been archived.");if(e!==j.active&&(this.compositeState===x.pendingDelete||this.compositeState===x.committedDelete))throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot archive a deleted composite.");e===j.active?delete this._core._local().archivalState:this._core._local().archivalState=e,t._setDirty(!0)}get isBound(){return!(!this.manifestEtag||!this.compositeAssetId)}set isBound(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isBound. Use resetIdentity instead.")}get versionId(){return this._versionId}set versionId(e){if(this._core._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");this._versionId=e}get _isDirty(){return this._core._isDirty}set _isDirty(e){this._core._isDirty=e}get isDirty(){return this._core.isDirty}set isDirty(e){this._core.isDirty=e}get localData(){return this._core._stringify(!1,!0)}set localData(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property localData.")}get remoteData(){return this._core._stringify(!0)}set remoteData(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property remoteData.")}get pendingElements(){return this._pendingElements}set pendingElements(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property pendingElements.")}get changeCount(){return this._core.changeCount}set changeCount(e){this._core.changeCount=e}get readOnly(){return this._core._readOnly}set readOnly(e){this._core._readOnly=e}static _newBranchAsCopyOfCore(e){G("_newBranchAsCopyOfCore()");const t=JSON.parse(JSON.stringify(e._data)),r=new $(t),s=r._core;return s._sourceCompositeInfo={links:e._compositeLinks,repositoryId:e._compositeRepositoryId,assetId:e._compositeAssetId},r._resetIdentity((function(t){const r=e.getComponentWithId(t.id);if(!r)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not find original component.");if(r.state===x.modified||!r.etag)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot create a new composite from a branch that contains modified or unbound components.");const o=r._owner.compositeAssetId;if(!o)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot make a copy of component of a composite that has not been bound with an asset id. Component id ="+r.id);const n=r._owner.compositeRepositoryId;G("_nBACOC() origAssetId",o),G("_nBACOC() origRepositoryId",n),G("_nBACOC() resetComponent",t),s._setSourceAssetInfoOfComponent({compositeAssetId:o,componentId:r.id,componentVersion:r.version,componentPath:r.absolutePath,repositoryId:n},t)})),r}parse(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "data" must be a string');let t;try{t=JSON.parse(e)}catch(e){throw new a.DCXError(a.DCXError.INVALID_JSON,"Manifest could not be parsed. Underlying error: "+e.message,e)}return this._setData(t,this._core._readOnly,this._core._compositeAssetId,this._core._compositeRepositoryId)}getElementWithId(e){return this._createElement(this._core.getChildWithId(e))}getElementWithAbsolutePath(e){return this._createElement(this._core.getChildWithAbsolutePath(e))}addElement(e,t,r,s,o,n){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a name of type string");if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a type of type string");if("string"!=typeof r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a path of type string");const i=this._core.addChild(e,s,o,n);try{i.path=r}catch(e){throw this._core.removeChild(i),e}return i._data.type=t,this._createElement(i)}updateElement(e){const t=this.getChildWithId(e.rootNode.id);if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element does not exist in branch.");const r=this._core.replaceChild(e.rootNode,t.path);return this._deleteElement(e),r}abandonElement(e){this._deleteElement(e)}getChildWithId(e){return this._core.getChildWithId(e)}getChildWithAbsolutePath(e){return this._core.getChildWithAbsolutePath(e)}getChildrenOf(e){return this._core.getChildrenOf(e)}addChild(e,t,r,s){return this._core.addChild(e,t,r,s)}removeChild(e){return this._core.removeChild(e)}moveChild(e,t=null,r=null){return this._core.moveChild(e,t,r)}copyChild(e,t,r,s,o,n){return this._core.copyChild(e,t,r,s,o,n)}replaceChild(e,t,r,s){return this._core.replaceChild(e,t,r,s)}allComponents(){return this._core.allComponents()}getComponentWithId(e){return this._core.getComponentWithId(e)}getComponentWithAbsolutePath(e){return this._core.getComponentWithAbsolutePath(e)}getComponentsOf(e){return this._core.getComponentsOf(e)}getMissingComponentsFromError(e){return this._core.getMissingComponentsFromError(e)}addComponentWithUploadResults(e,t,r,s,o){return this._core.addComponentWithUploadResults(e,t,r,s,o)}addComponentWithComponentDescriptor(e,t,r,s,o){return this._core.addComponentWithComponentDescriptor(e,t,r,s,o)}updateComponentWithUploadResults(e,t){return this._core.updateComponentWithUploadResults(e,t)}removeComponent(e){return this._core.removeComponent(e)}moveComponent(e,t){return this._core.moveComponent(e,t)}copyComponent(e,t,r,s,o){return this._core.copyComponent(e,t,r,s,o)}replaceComponent(e,t,r,s){return this._core.replaceComponent(e,t,r,s)}copy(){const e=new $(JSON.parse(JSON.stringify(this._data)),!1,this._core._compositeAssetId,this._core._compositeRepositoryId);if(e._derivationType=this._derivationType,e._derivationDatetime=this._derivationDatetime,this._core._sourceAssetInfoLookup){const t=JSON.stringify(this._core._sourceAssetInfoLookup);e._core._sourceAssetInfoLookup=JSON.parse(t)}return e}_isNodeLike(e){return n.isObject(e)}_createElement(e){if(!e)return;const t=JSON.parse(JSON.stringify(e._data));t["manifest-format-version"]=this._data["manifest-format-version"],delete t.path;const r=new q(t,this,this._core._readOnly);return this._pendingElements.push(r),r}_deleteElement(e){const t=this._pendingElements.indexOf(e);if(t<0)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown element.");this._pendingElements.splice(t,1)}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing an id of type string"):"string"!=typeof e.name?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a name of type string"):"string"!=typeof e.type?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a type of type string"):"number"!=typeof e["manifest-format-version"]?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a manifest-format-version of type number"):null}_setData(e,t,r,s){this.originalManifestFormatVersion=e["manifest-format-version"],function(e){const t=e["manifest-format-version"];if(t<6){if(t<4)throw new a.DCXError(a.DCXError.INVALID_DATA,"Encountered manifest format version "+e["manifest-format-version"]+". Format version conversion not yet implemented for that version.");t<6&&J(e,!0)}}(e),e.local&&(e.local.version=2);const o=this._verify(e);if(null===o)return e["manifest-format-version"]=6,this._core=new W(e,this,t),this._core._compositeAssetId=r,this._core._compositeRepositoryId=s,this._data=e,this;throw o}_reset(e,t){if(this.readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");this._data.local&&(delete this._data.local.manifestEtag,delete this._core._compositeAssetId,delete this._core._compositeRepositoryId),e||(this._data.id=n.generateUuid()),this._data.state=x.modified,this._core._recursiveReset(this._data,t),this._core._setDirty()}_resetBinding(e){this._reset(!0,e)}_resetIdentity(e){this._reset(!1,e)}_local(){return this._core._local()}_setDirty(e){this._core._setDirty(e)}_setPathOfNode(e,t){this._core._setPathOfNode(e,t)}_verifyIntegrity(e,t,r){return this._core._verifyIntegrity(e,t,r)}}function J(e,t=!1){t&&e.path&&delete e.path;const r=e.components;if("object"==typeof r)for(let e=0;e<r.length;e++){const t=r[e];"number"==typeof t.version&&(t.version=t.version.toString())}const s=e.children;if("object"==typeof s)for(let e=0;e<s.length;e++)J(s[e])}const Z=o.newDebug("dcx:dcxjs:dcxcomposite"),Q={PRIVATE:void 0,SHARED_BY_USER:"sharedByUser",SHARED_WITH_USER:"sharedWithUser"};class ee{constructor(e,t,r,s,o,n={}){this._collaborationType=Q.PRIVATE,null!=o&&"object"==typeof o&&(n=o,o=void 0),this._repoId=o,this._current=new $,o&&(this._current.compositeRepositoryId=o),(e||""===e)&&(this._current.data.name=e),t&&(this._current.data.type=t),r&&(this._current.compositeId=r),this._current._collaborationType=this._collaborationType,this._current.data.state=x.modified,this._current._setDirty(!0),this._options=n,s&&(this._assetId=s,this._current.compositeAssetId=s,(e||""===e)&&(this._name=e),t&&(this._type=t),r&&(this._id=r)),this._options.xhrBaseBranchSupport&&(this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0)}get href(){return this._href}set href(e){this._href=e}get links(){return this._links}set links(e){n.validateParams(["links",e,"object"]),this._current&&(this._current.compositeLinks=e),this._links=e}get repositoryId(){return this._current?this._current.compositeRepositoryId:this._repoId}set repositoryId(e){n.validateParams(["repoId",e,"string"]),this._current&&(this._current.compositeRepositoryId=e),this._repoId=e}get id(){return this._current?this._current.compositeId:this._id}set id(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.compositeId=e),this._id=e}get name(){return this._current?this._current.name:this._name}set name(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.name=e),this._name=e}get type(){return this._current?this._current.type:this._type}set type(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.type=e),this._type=e}get assetId(){return this._current?this._current.compositeAssetId:this._assetId}set assetId(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.compositeAssetId=e),this._assetId=e}get collaborationType(){return this._current?this._current._collaborationType:this._collaborationType}set collaborationType(e){if(e!==Q.PRIVATE&&e!==Q.SHARED_BY_USER&&e!==Q.SHARED_WITH_USER)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid value: ."+e);this._current&&(this._current._collaborationType=e),this._collaborationType=e}get clientDataString(){return this._current?this._current._clientDataString:this._clientDataString}set clientDataString(e){if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid clientDataString: must be a string or undefined.");const t=this._options.maxClientDataLength||1024;if(e&&e.length>t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid clientDataString: cannot be greater than 1KB");this._current&&(this._current._clientDataString=e),this._clientDataString=e}get isBound(){return!!(this._current&&this._current.isBound||!this._current&&this._assetId)}set isBound(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isBound. Use resetIdentity or resetBinding instead.")}get current(){return this._current}set current(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "current" is read-only.')}static newCompositeAsCopyOf(e,t,r,s,o){let i=e._core;if(i||e.current&&(i=e.current._core),!i)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"compositeBranchOrElement must be a branch, an element or a composite with a current branch.");const d=new ee(void 0,void 0,void 0,void 0,void 0,o);return d._current=$._newBranchAsCopyOfCore(i),d._current._derivationType=K.COPY,d._current._derivationDatetime=(new Date).toISOString(),d.id=s||n.generateUuid(),t&&(d.name=t),r&&(d.type=r),d}loadBaseBranch(e){if(!this._baseBranchData)throw new a.DCXError(a.DCXError.NO_BASE_BRANCH_DATA,"No base branch data.");let t,r;try{if(r=new $(void 0,!0,this.assetId).parse(this._baseBranchData),!e)return f.default.resolve(r)}catch(r){if(!e)return f.default.reject(r);t=r}e(t,r)}resolvePullWithBranch(e,t){const r=e;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Need a branch.");if(r===this._current)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot resolve current.");if(this._options.xhrBaseBranchSupport&&(this._baseBranchData=this._pulledBranchData,this._pulledBranchData=void 0),(()=>{r.readOnly=!1,r._collaborationType=this.collaborationType,r._clientDataString=this.clientDataString,this._current=r})(),!t)return this._current;t(void 0,this._current)}acceptPush(e){const t=this._pushJournal;let r;if(t)try{t.applyToBranch(this._current,!0),this._options.xhrBaseBranchSupport&&(this._baseBranchData=this._pushedBranchData,this._pushedBranchData=void 0),this._pushJournal=void 0,e&&e()}catch(e){r=e}else e&&e();if(r){if(!e)throw r;e(r)}if(!e)return this._current}resetBinding(e){delete this._assetId,this._current&&this._current._resetBinding(),this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0,e&&e()}resetIdentity(e){delete this._assetId,this._current?(this._current._resetIdentity(),this._id=this._current.compositeId):this._id=n.generateUuid(),this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0,e&&e()}_setPath(e){this._path=e}get _isRepoComposite(){return n.isObject(this._current)&&"boolean"==typeof this._current._isRepoComposite?this._current._isRepoComposite:!!this.repositoryId}}function te(e,t,r){if(Z("convertToDCXComposite()"),e.format&&!e.format.endsWith("+dcx"))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Format must end in "+dcx"');return new ee(e.name,e.format,t,e.assetId,e.repositoryId,r)}function re(e,t,r,s,o,a,d,c,h){const{repositoryId:l}=r;return e.createComposite(r,s,o,a,d,c,h).then((r=>function(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}(this,void 0,void 0,(function*(){const{assetId:s,links:o}=r.result;if(t.assetId=s,t.repositoryId=l,t.links=o,c){const{manifestData:r}=yield e.getCompositeManifest(t);t.resolvePullWithBranch(new $(r))}return a?r.result:t})))).catch((r=>{try{if(r.response&&n.isObject(r.response.headers)){const s=r.response.headers["asset-id"]||r.response.headers["x-resource-id"],o=i.parseLinksFromResponseHeader(r.response);t.links=o,"string"==typeof s&&n.isObject(o)&&e.updateCachedAssetLinks({assetId:s,repositoryId:l,links:o})}}catch(e){}throw r}))}ee.COLLABORATION=Q;class se{constructor(){this._originURL=null,this._manageUIURL=null,this._licenseType=null,this._licenseUrl=null,this._attributionURL=null,this._attributionName=null}get originURL(){return this._originURL}set originURL(e){this._originURL=e}get manageUIURL(){return this._manageUIURL}set manageUIURL(e){this._manageUIURL=e}get licenseType(){return this._licenseType}set licenseType(e){this._licenseType=e}get licenseUrl(){return this._licenseUrl}set licenseUrl(e){this._licenseUrl=e}get attributionURL(){return this._attributionURL}set attributionURL(e){this._attributionURL=e}get attributionName(){return this._attributionName}set attributionName(e){this._attributionName=e}}const oe=(e,t)=>`It looks like you're using a ${e} bundle in a ${t} environment. \r\nThis may lead to unexpected results. \n\nSee https://git.corp.adobe.com/DMA/dcx-js/blob/dev/docs/guides/bundles.md for main field definitions.`;class ne{constructor(e,t,r){this._aborted=!1,this._session=e,this._callback=t,this._cleanup=r,this._componentsPending=0,this._bytesTransfered=0,this._bytesTotal=0,this._onProgress=n.noOp,this._reportProgress=e=>{if(e>0){this._bytesTransfered+=e;const t=this._onProgress;t&&t(this._bytesTransfered,this._bytesTotal)}}}get xferComplete(){return this._xferComplete}get aborted(){return this._aborted}get bytesTransfered(){return this._bytesTransfered}get bytesTotal(){return this._bytesTotal}set onProgress(e){this._onProgress=e}get onProgress(){return this._onProgress}_callCallback(e,t){const r=this._callback;if(r)return this._callback=void 0,r(e,t)}_xferComplete(e,t){const r=this._cleanup;if(!r)return this._callCallback(e,t);this._cleanup=void 0,r(e,t)}abort(e){return this._aborted||(this._aborted=!0,this._session._service.abortAllWithToken(this)),e||(this._callback=void 0,e=new Error("Aborted")),this._xferComplete(e,null)}}class ie{constructor(){}static publishCompositeAlreadyPushedToPubs(e,t,r,s,o,n){if(!t||null==t.resourcePath||null==t.communityId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"ResourcePath & communityId must be set on publication record for the composite to be published.");const i=new ne(o,n),d=null!==t.assetId;let c;return e.current&&o.updatePublicationRecordData(t,e.current),d?(c=o.updateCpMetadataAtResource(e.type,t,(function(e,r){return i.xferComplete(e,e?void 0:t)})),c&&(c.token=i),i):(c=o.publishCompositeAtResource(e.type,t,(function(e,r){return i.xferComplete(e,e?void 0:t)})),c&&(c.token=i),i)}static getCpMetadata(e,t,r){if(!t||null==t.assetId||null==t.communityId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Asset Id & communityId must be set on publication record to fetch its CP metadata.");return e.getCpMetadata(t,r)}}class ae{constructor(e){this._waitingCallbacks=[],this._commitInProgress=!1,this._needAnotherCommit=!1,this._data={"composite-href":e.href,"uploaded-components":{}}}get compositeHref(){return this._data["composite-href"]}set compositeHref(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}get derivationType(){return this._data["derivation-type"]}set derivationType(e){this._data["derivation-type"]=e}get manifestEtag(){return this._data.etag}set manifestEtag(e){e?this._data.etag=e:delete this._data.etag}get versionId(){return this._data.versionId}set versionId(e){e?this._data.versionId=e:delete this._data.versionId}get currentBranchEtag(){return this._data["current-branch-etag"]}set currentBranchEtag(e){e?this._data["current-branch-etag"]=e:delete this._data["current-branch-etag"]}get changeCount(){return this._data.change}set changeCount(e){e?this._data.change=e:delete this._data.change}get compositeHasBeenDeleted(){return!!this._data["composite-deleted"]}set compositeHasBeenDeleted(e){e?this._data["composite-deleted"]=!0:delete this._data["composite-deleted"]}get compositeHasBeenArchived(){return!!this._data["composite-archived"]}set compositeHasBeenArchived(e){e?this._data["composite-archived"]=!0:delete this._data["composite-archived"]}get isEmpty(){return 0===Object.keys(this._data["uploaded-components"]).length&&!this.compositeHasBeenDeleted&&!this.compositeHasBeenArchived&&!this.manifestEtag}set isEmpty(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}get isComplete(){return!!(this._data.etag&&this._data.change||this._data["composite-deleted"]||this._data["composite-archived"])}set isComplete(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}recordUploadedComponent(e,t,r,s,o,n){const i={etag:t,length:o,version:r,md5:s,timestamp:(new Date).toISOString()};n&&(i["source-asset-info"]=n),this._data["uploaded-components"][e]=i}idsOfAllUploadedComponents(){return Object.keys(this._data["uploaded-components"])}getRecordForUploadedComponent(e){const t=this._data["uploaded-components"][e];if(t&&!this.isComplete){let r=t.timestamp;if(!r)return void this.removeRecordForUploadedComponent(e);if(r=new Date(r),isNaN(r.getTime()))return void this.removeRecordForUploadedComponent(e);if(Date.now()-r.getTime()>=6012e5)return void this.removeRecordForUploadedComponent(e)}return t}removeRecordForUploadedComponent(e){delete this._data["uploaded-components"][e]}applyToBranch(e,t){const r=e;if(!this.isComplete)throw new a.DCXError(a.DCXError.INVALID_STATE,"Journal is not complete.");const s=r.isDirty;if(this.compositeHasBeenDeleted)r._data.state=x.committedDelete,r.manifestEtag=this.manifestEtag;else{this.compositeHasBeenArchived&&(r.compositeArchivalState=j.archived);const e=r.compositeState!==x.unmodified&&this.changeCount!==r.changeCount,t=this.idsOfAllUploadedComponents(),s=t.length;for(let e=0;e<s;e++){const s=t[e],o=r.getComponentWithId(s);if(o){const e=this.getRecordForUploadedComponent(o.id);if(o._data.etag=e.etag,o._data.length=e.length,o._data.version=e.version,o._data.md5=e.md5,e["source-asset-info"]){const t=r._core._getSourceAssetInfoOfComponent(o),s=e["source-asset-info"];t&&s&&t.compositeAssetId===s.compositeAssetId&&t.componentId===s.componentId&&t.componentVersion===s.componentVersion&&(o._data.state=x.unmodified,r._core._setSourceAssetInfoOfComponent(void 0,o))}else o._data.state=x.unmodified}}r.manifestEtag=this.manifestEtag,"string"==typeof this.versionId&&(r.versionId=this.versionId),void 0!==this.derivationType&&(r._derivationType=this.derivationType),e||(r._data.state=x.unmodified)}t&&(r._isDirty=s)}}function de(e){let t=0;return(r,s,o)=>{e(r-t,o),t=r}}const ce=o.newDebug("dcx:dcxjs:compositexfer:pull");function he(e){ce("_pullCompositeManifest()");const{_composite:t,_session:r,_additionalData:{versionId:s,referenceBranch:o},additionalHeaders:d}=e;if(t._links){const{assetId:e,repositoryId:s}=r.registerLinks(t._links,t.repositoryId,t.assetId);t.assetId=e,t.repositoryId=s,delete t._links}if("string"!=typeof t.assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must have an asset id.");let c;return ce("_pCM() pullManifest()",e),o&&!s&&(c=o.manifestEtag),f.default.resolve(void 0,e).then((()=>{const o=r.getCompositeManifest(t,s,c,d);return e.hasProgressHandler&&(o.progress=de(e._reportProgress.bind(e))),o})).then((r=>{const{manifestData:o,manifestEtag:d,response:c}=r;e._additionalData.response=c;try{const e=i.parseLinksFromResponseHeader(c);t.links=e}catch(e){}if(ce("_pCM() pM() getCompositeManifest() cb",d),null===o)return;let h;try{h=n.isObject(o)?new $(o):(new $).parse(o),h.compositeAssetId=t.assetId,h.compositeRepositoryId=t.repositoryId,h._collaborationType=t.collaborationType,h._clientDataString=t.clientDataString,h.versionId=null!=c.headers.version?c.headers.version:s,h.manifestEtag=d}catch(e){throw ce("_pCM() pM() gCM() bad manifest"),new a.DCXError(a.DCXError.INVALID_JSON,"Corrupted manifest",e)}if(h.compositeState===x.committedDelete||h.compositeState===x.pendingDelete)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites should be deleted using a single step with RepoAPISession#deleteAsset");const l=h._core.allComponents();for(let e=0;e<l.length;++e){const t=l[e];t.state===x.pendingDelete||t.state===x.committedDelete?h.removeComponent(t):t.state=x.unmodified}return h})).then((e=>{if(null!=e)return e.compositeState=x.unmodified,e.readOnly=!0,t._options.xhrBaseBranchSupport&&!s&&(t._pulledBranchData=e.localData),e})).catch((e=>{if(e.code===a.DCXError.NOT_FOUND)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite missing or deleted",e.underlyingError||e);throw e}))}const le=o.newDebug("dcx:dcxjs:compositexfer:push"),ue="META-INF/metadata.xml";var pe;function _e(e,t){if(le("_pushComposite()"),!t.assetId||!t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite is not bound to a cloud asset. createComposite() must be called to assign an asset ID and repository ID before calling push.");const{owner:r,compositeIsNew:s,shouldPushWithXMP:o}=e._additionalData;return function(e,t){return le("_isNoOpPush()"),!t&&e.compositeState===x.unmodified}(r,s)?f.default.resolve(r,e):(function(e){if(le("_assertStateIsValidForPush()"),e.compositeState===x.committedDelete)throw new a.DCXError(a.DCXError.DELETED_COMPOSITE,"Attempt to push a deleted composite");if(e.compositeState===x.pendingDelete)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites should be deleted using a single step with RepoAPISession#deleteAsset");if(e.compositeArchivalState===j.pending||e.compositeArchivalState===j.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites cannot be archived")}(r),e._bytesTotal=0,e._indeterminateTotalBytes=!0,Pe.call(e).then(De.bind(e)).then(o&&!fe(r)?ge.bind(e):void 0).then(Ee.bind(e)).then(ye.bind(e)).catch(me.bind(e)))}function fe(e){return e.getComponentWithAbsolutePath(`/${ue}`)}function ge(){const{_composite:e,_session:r,_additionalData:{xmpConfig:s,owner:o,compositeIsNew:a}}=this,d=function(e,r,s){if(r.mode===t.XMPModes.CLIENT_MANAGED&&r.initialXMPXML)return r.initialXMPXML;const{creatorTool:o,modifyDate:i}=r,a=n.generateUuid(),d=[];if(e._derivationType===K.COPY){const t=e._derivationDatetime,r=h.makeHistoryEventXML(o,"copied",a,t);d.push(r)}else if(s){const e=h.makeHistoryEventXML(o,"created",a,i);d.push(e)}if(!s||e._derivationType===K.COPY){const e=h.makeHistoryEventXML(o,"saved",a,i);d.push(e)}return h.initializeXMPXML(o,a,i,d,void 0)}(o,s,a);return r.putCompositeComponent(e,n.generateUuid(),d,i.EmbeddedMetadataMediaTypes.XML,!0,d.length).then((t=>r.uploadResultsFromAdobeRepoUploadResult(t,e.id))).then((e=>(this._additionalData.xmpPushed=!0,o.addComponentWithUploadResults("xmp-metadata","metadata",ue,void 0,e))))}function me(e){le("_handleError()",e);const{_session:t,_composite:r,_additionalData:{compositeIsNew:s}}=this;if(s||0===this.failedComponents.length&&(e.response&&400===e.response.statusCode||e.additionalData&&e.additionalData.bulkResponse))throw e;let o=!1;return t.headCompositeManifest(r).then((()=>{throw o=!0,e})).catch((t=>{if(!o&&404===t.response.statusCode)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite does not exist; may have been deleted",e,e.response,{failedComponents:this.failedComponents});throw e.additionalData={failedComponents:this.failedComponents},e}))}function Ee(){le("_pushManifest()");const e=this._additionalData.owner;if(e.compositeState!==x.modified)return;const{_session:t,_additionalData:{overwriteExisting:r,validationLevel:s,xmpConfig:o,compositeIsNew:n,shouldPushWithXMP:i,xmpPushed:a}}=this;e.compositeState=x.unmodified;const d=e.remoteData,c=d.length;this._bytesTotal+=c,this._indeterminateTotalBytes=!1;const h=function(e,t){return le("_updateManifestEtag()"),e._journal.manifestEtag&&e._journal.currentBranchEtag===t.manifestEtag&&(le("_uME() updating etag, previous: ",t.manifestEtag),t.manifestEtag=e._journal.manifestEtag),le("_uME() using if-match: ",t.manifestEtag),t.manifestEtag}(this,e);let l;return!i||a?(l=t.updateCompositeManifest(e,d,r,s,h),this.hasProgressHandler&&(l.progress=de(this._reportProgress.bind(this))),l):Ae(this,e,d,r,s,h,n,o)}function Ae(e,r,s,o,d,c,l,u,p=0){const{_session:_,_composite:g}=e,m=function(e,r){if(r.mode===t.XMPModes.CLIENT_MANAGED)return r.xmpPatch;const{creatorTool:s,modifyDate:o}=r,n=[];return e._derivationType===K.COPY&&h.makeDerivedWithAction.call({patchDocument:n},s,"copied",void 0,o),h.appendHistoryEvent.call({patchDocument:n},"saved",s,o),n}(r,u),E=_.getLinkHrefForAsset(g,i.LinkRelation.EMBEDDED_METADATA),A=n.pruneUndefined({[i.HeaderKeys.IF_MATCH]:"*",[i.HeaderKeys.CONTENT_TYPE]:i.JSONPatchMediaType}),y=_.getLinkHrefForAsset(g,i.LinkRelation.MANIFEST),D=n.pruneUndefined({[i.HeaderKeys.IF_MATCH]:c,[i.HeaderKeys.CONTENT_TYPE]:`${i.ManifestMediaType};validation-level=${d}`});return f.default.allSettled([y,E]).then((([e,t])=>{if("rejected"===t.status||"rejected"===e.status)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not retrieve required links.");return _.performBulkRequest(g,[{method:i.HTTPMethods.PUT,href:e.value,headers:D,body:s},{method:i.HTTPMethods.PATCH,href:t.value,headers:A,body:JSON.stringify(m)}])})).then((t=>function(e,t,r,s,o,n,d,c,l,u=0){le("_handleManifestAndXMPResponse()");const[p,_]=l.result,{statusCode:f}=p,{statusCode:g}=_;if(le("_hMAXR() manifest, embedded status: ",f,g),u>2&&(f>=400||g>=400))throw le("_hMAXR() circuit break retries"),new a.DCXError(a.DCXError.INVALID_STATE,"Repairing failed or repeated failures during XMP/manifest push. Check additionalData.",void 0,l[0],{bulkResponse:l});let m=s,E=d,A=n;function y(s=r){return le("_hMAXR() retry bulk; isNew, etag, overwrite: ",E,A,m),Ae(e,t,s,m,o,A,E,c,u+1)}if(f>=400){if(404===f)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite not found.",void 0,p,{bulkResponse:l});if(424===f);else{if(s&&409===f)throw new a.DCXError(a.DCXError.UPDATE_CONFLICT,"Manifest has been changed",void 0,p,{bulkResponse:l});if(s&&412===f)throw new a.DCXError(a.DCXError.PRECONDITION_FAILED,"Precondition failed",void 0,p,{bulkResponse:l});if(409===f)m=!1;else{if(412!==f)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from manifest PUT in bulk.",void 0,p,{bulkResponse:l});m=!1,A=void 0}}}if(g>=400){if(424===g);else{if(404!==g){if(400===g){const r=fe(t);if(r)return function(e,t,r){const{_session:s,_composite:o,_additionalData:{owner:n}}=e;return s.getCompositeComponent(o,t.id,t.version,"text").then((({response:e})=>{const n=h.repairXMPXML(e,r.creatorTool,r.modifyDate);if(e!==n)return s.putCompositeComponent(o,t.id,n,i.EmbeddedMetadataMediaTypes.XML,!1,n.length)})).then((e=>e&&s.uploadResultsFromAdobeRepoUploadResult(e,o.id))).then((e=>{if(e)return n.updateComponentWithUploadResults(t,e),e.records[t.id].etag}))}(e,r,c).then((()=>y(t.remoteData)));throw new a.DCXError(a.DCXError.INVALID_STATE,"Manifest appears to be corrupted.",void 0,p,{bulkResponse:l})}throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from embedded request in bulk.",void 0,p,{bulkResponse:l})}E=!0}return y()}const D=fe(t);return e._journal.recordUploadedComponent(D.id,"*",`${parseInt(D.version)+1}`,_.headers["content-md5"]||D.md5,D.length),p}(e,r,s,o,d,c,l,u,t,p)))}function ye(e){if(void 0===e)return this._additionalData.owner;this._additionalData.manifestResponse=e;const{_journal:t,_composite:r,_additionalData:{owner:s}}=this,o=e.headers.etag,n=e.headers.version,i=s.changeCount;return t.manifestEtag=o,t.derivationType=K.NONE,t.currentBranchEtag=s.manifestEtag,t.changeCount=i,t.versionId=n,t.applyToBranch(s),s.compositeState=x.unmodified,r._options.xhrBaseBranchSupport&&(r._pushedBranchData=s.localData),s}function De(e){if(le("_handleFailedComponents()"),0===e.length)return this._additionalData.owner;if(e.filter((e=>e.error&&e.error.code===a.DCXError.EXCEEDS_QUOTA)).length>0)throw new a.DCXError(a.DCXError.EXCEEDS_QUOTA,"One or more components failed to upload.",void 0,void 0,{failedComponents:e});throw new a.DCXError(a.DCXError.COMPONENT_UPLOAD_ERROR,"One or more components failed to upload.",void 0,void 0,{failedComponents:e})}function Ce(e){return le("_getCurrentCopyOpCollector()"),(0===e.length||e[e.length-1].docBuilder.entryCount>=(this._additionalData._test_operationsPerBatch||50))&&(le("_gCCOC() new copy op collector"),e.push({docBuilder:i.newOperationDocBuilder(),orderedPendingComponents:[]})),e[e.length-1]}function Ie(e,t){le("_reduceComponent()");const{_journal:r,_composite:s,_additionalData:{owner:o}}=this,{state:n=x.unmodified,etag:d}=t,c=null==d;if(!c&&n===x.unmodified)return le("_rC() not new, not modified"),void r.removeRecordForUploadedComponent(t.id);if(!c&&(n===x.committedDelete||n===x.pendingDelete))return le("_rC() not new, committedDelete or pendingDelete"),void o.removeComponent(t);const h=o._core._getSourceAssetInfoOfComponent(t);if(le("_rC() source asset",h),null==h)return void this._failedComponents.push({component:t,error:new a.DCXError(a.DCXError.INVALID_STATE,"Component should not be modified or new without local storage")});const l=r.getRecordForUploadedComponent(t.id);if(h&&l){const e=l["source-asset-info"];if(e&&e.compositeAssetId===h.compositeAssetId&&e.componentId===h.componentId&&e.componentVersion===h.componentVersion)return t.etag=l.etag,t.version=l.version,t.md5=l.md5,t.length=l.length,void(t.state=x.unmodified)}const u=Ce.call(this,e);u.docBuilder.copyResources({assetId:h.compositeAssetId,repositoryId:h.repositoryId},s,[{source:{component_id:h.componentId,revision:h.componentVersion,reltype:i.LinkRelation.COMPONENT},target:{component_id:t.id,reltype:i.LinkRelation.COMPONENT}}],!0),u.orderedPendingComponents.push([t,h])}function ve(e){le("_handleBatchResults(): ",e);const{_journal:t,_failedComponents:r}=this;e.map((e=>{if("rejected"===e.status)throw le("_hBR() error",e.reason),e.reason;const{orderedPendingComponents:s,results:o,response:i}=e.value;o.forEach((({resources:e})=>{e.forEach((e=>{const o=s.find((([,t])=>t.componentId===e.target.component_id));if(o){const[s,d]=o;try{const{etag:r,id:o,version:c,md5:h,length:l}=function(e,t,r){if(le("_validateCopyResponse()"),!n.isObject(e))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid result",void 0,t);const s={etag:e.etag,version:e.revision,md5:r.md5,length:r.length,state:x.unmodified};for(const e in s)if(null==s[e])throw new a.DCXError(a.DCXError.INVALID_DATA,`No ${e}`,void 0,t);return Object.assign(r,s)}(e.target,i,s);t.recordUploadedComponent(o,r,c,h,l,d)}catch(e){r.push({component:s,error:e})}}}))}))}))}function be(e,t){le("_parallelBatchOperations()");const{value:r,done:s}=t.next();return le("_pBO() next generator: ",r,s),f.default.resolve(r).then((t=>{const r=t.filter((e=>e.orderedPendingComponents.length)).map((t=>{const r=t.docBuilder.getDocument(),s=JSON.stringify(r);this._bytesTotal+=s.length;const o=e.performBatchOperation(s).then((({result:e,response:r})=>({results:e,response:r,orderedPendingComponents:t.orderedPendingComponents})));return this.hasProgressHandler&&(o.progress=de(this._reportProgress.bind(this))),o}));return f.default.allSettled(r)})).then(ve.bind(this)).then((()=>s?this.failedComponents:be.call(this,e,t)))}function*Te(e){le("_makeCopyOpGenerator()");let t=[];for(let r=0;r<e.length;r++){const s=e[r];Ie.call(this,t,s);const o=Ce.call(this,t);o.orderedPendingComponents.length===i.COPY_RESOURCES_RESOURCE_LIMIT&&(yield[o],t=[])}return t}function Pe(){le("_pushComponents()");const{_session:e,_additionalData:{owner:t}}=this,r=t.allComponents();le("_pC() component count: ",r.length);const s=Te.call(this,r);return f.default.resolve(void 0,this).then((()=>be.call(this,e,s)))}t.XMPModes=void 0,(pe=t.XMPModes||(t.XMPModes={}))[pe.MANAGED=0]="MANAGED",pe[pe.PARTIALLY_MANAGED=1]="PARTIALLY_MANAGED",pe[pe.CLIENT_MANAGED=2]="CLIENT_MANAGED",pe[pe.UNMANAGED=3]="UNMANAGED";const we=o.newDebug("dcx:dcxjs:compositexfer:upload");function Re(e,t){we("_uploadComponent()");const{additionalHeaders:r,_additionalData:{componentId:s,componentType:o,componentIsNew:i,size:d,md5:h},_composite:l,_session:u,_blockSize:p}=e;n.validateObject(l,"composite",["id","string"],["repositoryId","string"],["assetId","string"]),n.validateParams(["session",u,"object"],["dataOrSliceCallback",t,["object","function","string"]],["componentType",o,"string"],["componentId",s,"string",!0],["size",d,"+number",!0],["md5",h,"string",!0]);const{id:_,repositoryId:g}=l,m=d||t.length||t.byteLength||t.size;return e._bytesTotal=m,f.default.resolve(void 0,e).then((()=>u.putCompositeComponent(l,s,t,o,i,m,h,e.hasProgressHandler?de(e._reportProgress.bind(e)):void 0,r,p))).then((({result:t,response:r})=>{e._additionalData.response=r;const n=c.createUploadResults(_,l.assetId,g);return n.records[s]=function(e,t,r,s){if("object"!=typeof s)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Invalid upload result, expecting object");const{md5:o,etag:n,revision:i,length:d=t}=s;if(null==d)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No length");if(null==n)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No etag");if(null==i)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No version");if(null==o)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No md5");return c.createUploadRecord(e,n,i,o,d,r)}(s,m,o,t),n}))}const Oe=o.newDebug("dcx:dcxjs:repocompositexfer:xferctx");class ke{constructor(e,t,r,s,o,n){this.additionalHeaders=o,this._aborted=!1,this._bytesTransfered=0,this._abortHandlers=[],this._bytesTotal=0,this._additionalData={},this._failedComponents=[],this._session=e,this._composite=t,this.onProgress=s,r&&(this._additionalData=r),this._blockSize=n}get aborted(){return this._aborted}get bytesTransfered(){return this._bytesTransfered}get bytesTotal(){return this._bytesTotal}get failedComponents(){return this._failedComponents}get hasProgressHandler(){return void 0!==this._progressHandler}set onProgress(e){n.isAnyFunction(e)&&(this._progressHandler=e)}get onProgress(){return this._progressHandler}onAbort(e){this._abortHandlers.push(e)}abort(e){this._aborted||(this._abortHandlers.forEach((t=>n.isAnyFunction(t)&&t.call(void 0,e))),this._session._service.abortAllWithToken(this),this._aborted=!0)}_reportProgress(e,t){if(Oe("progress",e),t&&(this._indeterminateTotalBytes=!0),e>0&&(this._bytesTransfered+=e,n.isAnyFunction(this._progressHandler)))try{this._progressHandler(this._bytesTransfered,this._bytesTotal,this._indeterminateTotalBytes)}catch(e){console.error("Error in progress callback",e)}}}const Se=o.newDebug("dcx:dcxjs:compositexfer");function Ne(e,t,r,s){const n=e._additionalData.response;if((n||r&&r.response)&&o.emitAnalyticsEvent(t,{composite:e._composite,error:r,response:n||r.response,branch:s}),r)throw r}function Le(e,t,r,s,n){const i=e._additionalData.response;if((i||s&&s.response)&&o.emitAnalyticsEvent(o.AnalyticsEvent.UploadComponent,{composite:e._composite,error:s,response:i||s.response,isBlockTransferred:t,component:r}),s)throw s;return n}const Me=s.AdobeNetworkHTTPService,Xe=Me;n.isBrowserSDK()&&n.isNode()?u.default.warn(oe("browser","Node")):!n.isBrowserSDK()&&n.isBrowser()&&u.default.warn(oe("Node","browser"));const Be=o.getGlobalLogger(),xe=p,je=ee.COLLABORATION,Ue=g;Object.defineProperty(t,"createHTTPService",{enumerable:!0,get:function(){return s.createHTTPService}}),Object.defineProperty(t,"AdobeDCXLogger",{enumerable:!0,get:function(){return o.AdobeDCXLogger}}),Object.defineProperty(t,"getGlobalLogger",{enumerable:!0,get:function(){return o.getGlobalLogger}}),Object.defineProperty(t,"AdobeDCXError",{enumerable:!0,get:function(){return a.AdobeDCXError}}),Object.defineProperty(t,"DCXError",{enumerable:!0,get:function(){return a.DCXError}}),Object.defineProperty(t,"isAdobeDCXError",{enumerable:!0,get:function(){return a.isAdobeDCXError}}),t.AdobeCommunityPlatform=ie,t.AdobeCommunityPublicationRecord=g,t.AdobeCommunitySession=B,t.AdobeDCXBranch=$,t.AdobeDCXComponent=V,t.AdobeDCXComposite=ee,t.AdobeDCXElement=q,t.AdobeDCXNode=H,t.AdobeDCXPushJournal=ae,t.AdobeDCXUtil=xe,t.AdobeNetworkHTTPService=Me,t.AdobeRemixData=se,t.COLLABORATION=je,t.CommunityPublicationRecord=Ue,t.CommunitySession=B,t.HTTPService=Xe,t.RemixData=se,t.communityPlatform=ie,t.convertToDCXComposite=te,t.copyResources=function(e,t,r,s,o,n){return e.copyResources(t,r,s,o,n)},t.createCommunityPublicationRecord=()=>new g,t.createCommunitySession=(e,t)=>new B(e,t),t.createComposite=function(e,t,r,s,o,d,c,h){if(Z("createComposite()"),n.validateParams(["session",e,"object"],["composite",t,"object"],["parentDir",r,"object"],["relPath",s,"string"]),t.assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must not already have an assigned asset id.");if("string"!=typeof r.repositoryId&&"string"!=typeof t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Either composite or parentDir must contain valid repositoryId.");if("string"==typeof r.repositoryId&&"string"==typeof t.repositoryId&&r.repositoryId!==t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Composite contains a repositoryId that does not match parentDir.");if("string"!=typeof t.type)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must contain a valid type.");const l="string"==typeof t.repositoryId?t.repositoryId:r.repositoryId,u=r;if(Object.getOwnPropertyNames(r).forEach((e=>{u[e]=r[e],u.repositoryId=l})),!i.isMinimalAdobeAsset(u))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"parentDir must contain links or repositoryId & assetId or path");return re(e,t,u,s,t.type,o||void 0,d,c,h)},t.createRemixData=()=>new se,t.getCompositeManifestAndComponentsByPath=function(e,t,r,s,o,n){const a=i.isAdobeDCXCompositeLike(t)?t:te(t);return e.getManifestAndComponentsByPath(a,r,s,o,n).then((e=>Object.assign(e,{composite:a})))},t.getURLForComponent=function(e,t,r,s){return e.getCompositeComponentUrl(t,t.id,void 0!==r?r:t.version,s)},t.logger=Be,t.newCompositeAsCopyOf=(e,t,r,s,o={})=>ee.newCompositeAsCopyOf(e,t,r,s,o),t.newDCXComposite=function(e,t,r,s,o,n,i={}){if(null==e&&null==n){if("string"!=typeof o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unbound DCXComposite must have a type.");if("string"!=typeof r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unbound DCXComposite must have a name.")}const d=new ee(r,o,s,e,t,i);return n&&(d.links=n),d},t.pullCompositeManifestOnly=function(e,t,r){const s=new ke(e,t,{referenceBranch:t.current},void 0,r),n=(e,t)=>(Ne(s,o.AnalyticsEvent.PullComposite,e,t),t);return he(s).then(n.bind(void 0,void 0)).catch(n)},t.pullCompositeVersionManifestOnly=function(e,t,r,s){const n=new ke(e,t,{versionId:r,referenceBranch:t.current},void 0,s),i=(e,t)=>(Ne(n,o.AnalyticsEvent.PullCompositeVersion,e,t),t);return he(n).then(i.bind(void 0,void 0)).catch(i)},t.pushComposite=function(e,r,s,i=1,d={mode:t.XMPModes.MANAGED},c){Se("pushComposite()"),n.validateParams(["session",e,"object"],["composite",r,"object"],["overwriteExisting",s,"boolean"],["validationLevel",i,"+number"],["options",d,"object",!0]);const h=function(e){void 0===e.mode&&(e.mode=t.XMPModes.MANAGED);const r=e.modifyDate||(new Date).toISOString(),s=e.creatorTool||"dcx-js";if(e.mode===t.XMPModes.MANAGED||e.mode===t.XMPModes.PARTIALLY_MANAGED)return Se("push: using managed XMP mode"),n.validateObject(e,"options",["creatorTool","string",!0],["modifyDate","string",!0]),{mode:e.mode,creatorTool:s,modifyDate:r};if(e.mode===t.XMPModes.CLIENT_MANAGED){Se("push: using client managed XMP mode"),n.validateObject(e,"options",["xmpPatch","object[]",!0],["initialXMPXML","string",!0]);const t=e.xmpPatch||[],o=n.validateJSONPatchDocument(t);if(!0!==o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Invalid parameter "options.xmpPatch".',void 0,void 0,{issues:o});return Object.assign(Object.assign({},e),{modifyDate:r,creatorTool:s})}if(e.mode===t.XMPModes.UNMANAGED)return Se("push: using unmanaged XMP mode"),e;throw new a.DCXError(a.DCXError.INVALID_PARAMS,`Invalid XMP mode '${e.mode}'`)}(d),l=!r.isBound;!function(e,r){e.mode===t.XMPModes.PARTIALLY_MANAGED||e.mode===t.XMPModes.MANAGED||e.mode===t.XMPModes.CLIENT_MANAGED&&(r||!r&&e.xmpPatch)}(h,l);const u=r._current.copy(),p=u._derivationType,_=new ke(e,r,{owner:u,overwriteExisting:s,compositeIsNew:l,validationLevel:i,xmpConfig:h,shouldPushWithXMP:!1,xmpPushed:!1},void 0,c);_._journal=_._composite._pushJournal||new ae(r);const f=function(e,t){const s=_._additionalData.manifestResponse;(s||t&&t.response)&&o.emitAnalyticsEvent(o.AnalyticsEvent.PushComposite,{composite:r,branch:u,error:t,response:s||t.response,derivationType:p});const n=_._journal;return _._composite._pushJournal=n.isEmpty?void 0:n,e};return _e(_,r).then(f).catch((e=>{throw f(void 0),e}))},t.uploadComponent=function(e,t,r,s,o,i,a,d){Se("uploadComponent()"),n.validateObject(r,"component",["id","string"],["type","string"]);const{id:c,type:h}=r,l=new ke(e,t,{componentType:h,componentIsNew:!1,componentId:c,size:o,md5:i},a,d),u=(e,t)=>(Le(l,!!p.blockUpload,r,e,t),t),p=Re(l,s).then(u.bind(void 0,void 0)).catch(u);return p},t.uploadNewComponent=function(e,t,r,s,o,i,d,c,h,l){if(Se("uploadNewComponent()"),o&&!n.verifyUuid(o))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component id is not a uuid ");const u=new ke(e,t,{componentType:s,componentIsNew:!0,componentId:o||n.generateUuid(),size:i,md5:d},c,h,l),p=(e,t)=>(Le(u,!!_.blockUpload,{length:i,type:s},e,t),t),_=Re(u,r).then(p.bind(void 0,void 0)).catch(p);return _},Object.keys(d).forEach((function(e){"default"===e||t.hasOwnProperty(e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}})})),Object.keys(c).forEach((function(e){"default"===e||t.hasOwnProperty(e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}})}))},36006:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),r(973301);var s=r(796348),o=r(200334);r(683016);var n=r(499164),i=r(935341),a=r(45276),d=r(310799),c=r(899027),h=r(168511);function l(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=l(o),p=function(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var s=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}(n),_=l(a),f=l(d);class g{constructor(){this._communityId=null,this._artworkComponentId=null,this._assetId=null,this._resourcePath=null,this._mainResource=null,this._mainResourceVersion=null,this._artworkResource=null,this._artworkResourceVersion=null,this._title=null,this._alias=null,this._tags=[],this._description=null,this._categoryId=null,this._subCategoryIds=[],this._creatorIds=[],this._undiscoverable=!1,this._isPrivate=!1,this._custom=null}get communityId(){return this._communityId}set communityId(e){this._communityId=e}get artworkComponentId(){return this._artworkComponentId}set artworkComponentId(e){this._artworkComponentId=e}get assetId(){return this._assetId}set assetId(e){this._assetId=e}get resourcePath(){return this._resourcePath}set resourcePath(e){this._resourcePath=e}get mainResource(){return this._mainResource}set mainResource(e){this._mainResource=e}get mainResourceVersion(){return this._mainResourceVersion}set mainResourceVersion(e){this._mainResourceVersion=e}get artworkResource(){return this._artworkResource}set artworkResource(e){this._artworkResource=e}get artworkResourceVersion(){return this._artworkResourceVersion}set artworkResourceVersion(e){this._artworkResourceVersion=e}get title(){return this._title}set title(e){this._title=e}get alias(){return this._alias}set alias(e){this._alias=e}get tags(){return this._tags}set tags(e){this._tags=this._tags.concat(e)}get description(){return this._description}set description(e){this._description=e}get categoryId(){return this._categoryId}set categoryId(e){this._categoryId=e}get subCategoryIds(){return this._subCategoryIds}set subCategoryIds(e){this._subCategoryIds=this._subCategoryIds.concat(e)}get creatorIds(){return this._creatorIds}set creatorIds(e){this._creatorIds=this._creatorIds.concat(e)}get undiscoverable(){return this._undiscoverable}set undiscoverable(e){this._undiscoverable=e}get isPrivate(){return this._isPrivate}set isPrivate(e){this._isPrivate=e}get custom(){return this._custom}set custom(e){this._custom=e}}const m=o.newDebug("dcx:dcxjs:sb"),E=()=>!0,A={disableRetry:!0},y=!1,D="primary",C="http://ns.adobe.com/ccapi/manifest",I="http://ns.adobe.com/ccapi/manifest2",v="http://ns.adobe.com/ccapi/component",b="version-history",T="rendition";let P=null,w=null;class R{constructor(e,t){this._maxRedirects=5,this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._assetInfoCache={},this._assetIdResolutionTemplate=null,this.SYNC_ASYNC_DEFAULT_DELAY=5,this.ASYNC_DEFAULT_DELAY=1,this.DEFAULT_POLL_DELAY=10,this._service=e,this._server=t,t&&(this._endPoint=n.endPointOf(t))}get maxRedirects(){return this._maxRedirects}set maxRedirects(e){if("number"!=typeof e)throw new _.default(_.default.INVALID_PARAMS,"Expecting a number.");this._maxRedirects=Math.floor(e)}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new _.default(_.default.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}isValidHref(e){const t=n.endPointOf(e);return!t||t===this._endPoint}isDomainOnAllowList(e){m("isDomainOnAllowList");const t=n.parseURI(e).authority;if(!t||0===t.length)return!0;const r=t.length,s=this._authenticationAllowList.length;for(let e=0;e<s;e++){const s=this._authenticationAllowList[e],o=s.length;let n;if(n=r>o?t.slice(-o):t,n===s)return m("iDOAL true"),!0}return m("iDOAL false"),!1}getAsset(e,t,r,s){return this._getAsset(e,t,r,void 0,s)}_getAsset(e,t={},r,s,o){if(m("_getAsset()"),!(e=this._resolveUrl(e)))return void o(new _.default(_.default.WRONG_ENDPOINT,"Wrong endpoint: "+e));let d=s;const c={};"string"==typeof t?c["if-none-match"]=t:n.merge(c,t);let h,l=0;const u=(e,t)=>{if(m("_getAsset() respHandler",e,t),e)return void o(a.networkError("Error downloading an asset",e,t));const r=t.statusCode;if(200===r)o(void 0,t);else if(304===r)o(void 0,t);else if(301===r||302===r||303===r||307===r)if(!this._service.handlesRedirects&&this.maxRedirects)if(l<this.maxRedirects){const r=t.headers.location;r?h(r):o(a.unexpectedResponse("Missing location header in redirect response",e,t))}else o(a.unexpectedResponse("Too many redirects",e,t));else o(a.unexpectedResponse("Unexpected response getting an asset",e,t));else o(a.unexpectedResponse("Unexpected response getting an asset",e,t))};return h=t=>{const s={responseType:r,isStatusValid:E,retryOptions:A,autoParseJson:y};return t&&(l++,s.reuseRequestDesc=d,this.isDomainOnAllowList(t)||(c.authorization=null)),this._service.invoke(i.HTTPMethods.GET,t||e,c,void 0,s,u)},d=h(),d.progress=n.noOp,d}getAssetAsType(e,t,r,s){return this._getAssetAsType(e,t,r,void 0,void 0,void 0,s)}_cacheLinksFromResponse(e,t){if("string"==typeof e){const r=this._parseCachableLinks(t);if(Object.keys(r).length>0){const t=this._assetInfoCache[e],s=Object.assign({},t||{},n.pruneUndefined(r));this._cacheInfoForAssetId(e,void 0,s)}}}_getAssetAsType(e,t,r,s,o,n,i){return m("_getAssetAsType"),this._getAsset(e,r,t,s,((e,t)=>{if(e)return i(e);if(200===t.statusCode){const e=t.response||t.responseText;null==n&&this._cacheLinksFromResponse(o,t),i(void 0,e,t.headers.etag,t)}else 304===t.statusCode?i(void 0,null,t.headers.etag,t):i(a.unexpectedResponse("Unexpected response getting asset",e,t))}))}_getResourcePathFromHref(e,t){return m("_getResourcePathFromHref"),this._service.invoke(i.HTTPMethods.HEAD,e,{},void 0,{isStatusValid:E,retryOptions:A,autoParseJson:y},((e,r)=>{if(m("_gRPFH invoked",e,r),e)return t(e);if(200===r.statusCode){const e=r.headers.link;if(e){const r=n.parse(e).get("rel","http://ns.adobe.com/ccapi/path");if(r&&r[0]&&r[0].uri)return t(void 0,r[0].uri)}}return t(a.unexpectedResponse("Unexpected response trying to retrieve path to asset.",void 0,r))}))}resolveRootURLAsync(){m("resolveRootURLAsync()");const e=this._resolveUrl("/");let t;return m("rRUA() rootHref",e),P=this._service.invoke(i.HTTPMethods.GET,e,{},void 0,{responseType:"text",isStatusValid:E,retryOptions:A,autoParseJson:y}).then((e=>{if(m("rRUA() resolved",e),200!==e.statusCode)throw t=new _.default(_.default.UNEXPECTED_RESPONSE,"Resolve root URL did not succeed with 200",void 0,e),t;{const r=e.responseText||e.response;try{const e=JSON.parse(r),t=e._links?e._links["http://ns.adobe.com/ccapi/resolve/id"]:void 0;if(t)return{href:t.href,self:this}}catch(r){throw t=new _.default(_.default.INVALID_DATA,"Invalid JSON returned by server",r,e),t}}})).catch((e=>{throw m("rRUA() rejected",e),e})),m("rRUA() rootReqDesc",P),P}getPromiseCacheInfo(e){return m("getPromiseCacheInfo()"),null!=w||(w=e(),w&&w.then&&w.then((()=>{m("gPCI() resolved"),w=null}),(()=>{m("gPCI() rejected"),w=null}))),w}_parseCachableLinks(e){const t={};e.headers["content-location"];const r=e.headers.link;if(r){const e=n.parse(r);let s=e.get("rel",D);s&&(t.primaryTemplate=s[0].uri),s=e.get("rel",I),s?t.manifestTemplate=s[0].uri:(s=e.get("rel",C),s&&(t.manifestTemplate=s[0].uri)),s=e.get("rel",v),s&&(t.componentTemplate=s[0].uri),s=e.get("rel",b),s&&(t.versionHistory=s[0].uri),s=e.get("rel",T),s&&(t.renditionTemplates=s)}return t}getCachedAssetInfo(e,t){m("getCachedAssetInfo()");const r=this._infoForAssetId(e);if(r)return m("gCAI() cached"),t(void 0,r);const s=this._awaitInfoForAssetId(e,t);if(m("gCAI() needs head req",s),s){let r;const s=s=>{let o=n.expandURITemplate(s,{asset_id:e});if(o=this._resolveUrl(o),!o)return m("gCAI() no href"),t(new _.default(_.default.WRONG_ENDPOINT,"Wrong endpoint: "+o));let d={};return r&&(d={reuseRequestDesc:r},m("gCAI() reuse RD",d)),r=this._service.invoke(i.HTTPMethods.HEAD,o,{},void 0,Object.assign(Object.assign({},d),{isStatusValid:E,retryOptions:A,autoParseJson:y}),((t,r)=>{if(m("gCAI() resolveAssetId() resolved",t,r),t)return this._cacheInfoForAssetId(e,t);const s=r.statusCode;if(200===s){const t=this._parseCachableLinks(r);return this._cacheInfoForAssetId(e,void 0,t)}return 404===s?this._cacheInfoForAssetId(e,new _.default(_.default.ASSET_NOT_FOUND,"Asset not found",t,r)):this._cacheInfoForAssetId(e,a.unexpectedResponse("Unable to resolve asset id.",t,r))})),r};return this._assetIdResolutionTemplate?(m("gCAI() has resolution template"),s(this._assetIdResolutionTemplate)):(m("gCAI() get resolution template"),P=this.getPromiseCacheInfo(this.resolveRootURLAsync.bind(this)).then((e=>(m("gCAI() getPromiseCacheInfo() resolved",e),this._assetIdResolutionTemplate=e.href,s(e.self._assetIdResolutionTemplate)))).catch((e=>{m("gCAI() getPromiseCacheInfo() rejected",e);const r=new _.default(_.default.UNEXPECTED_RESPONSE,"Unable to retrieve asset id resolution link from root resource.",e,e.response);return t(r)})),m("gCAI() rootReqDesc",P),P)}}registerLinks(e){e=e._links||e;const t={};t.assetId="urn:aaid:faux:"+n.generateUuid();let r=e[D];return r&&(t.primaryTemplate=r.href),r=e[C],r&&(t.manifestTemplate=r.href),r=e[I],r&&(t.manifestTemplate=r.href),r=e[v],r&&(t.componentTemplate=r.href),r=e[b],r&&(t.versionHistory=r.href),r=e[T],r&&(t.renditionTemplates=[{rel:"rendition",uri:r.href}]),this._assetInfoCache[t.assetId]=t,t.assetId}_infoForAssetId(e){const t=this._assetInfoCache[e];if(t&&!t.callbacks)return t}_awaitInfoForAssetId(e,t){m("_awaitInfoForAssetId");let r=this._assetInfoCache[e];return r?(m("_aIFA pending"),r.callbacks.push(t),!1):(m("_aIFA not pending"),r={},r.assetId=e,r.callbacks=[t],this._assetInfoCache[e]=r,!0)}_cacheInfoForAssetId(e,t,r){m("_cacheInfoForAssetId");let s=this._assetInfoCache[e];if(s){if(t){const r=s.callbacks;this._assetInfoCache[e]=void 0;for(let e=0;e<r.length;e++)r[e](t)}}else!t&&r&&(this._assetInfoCache[e]=s={});if(!t&&r&&(s.assetId||(s.assetId=e),s.primaryTemplate=r.primaryTemplate,s.manifestTemplate=r.manifestTemplate,s.componentTemplate=r.componentTemplate,s.versionHistory=r.versionHistory,s.renditionTemplates=r.renditionTemplates,s.callbacks)){for(let e=0;e<s.callbacks.length;e++)s.callbacks[e](void 0,s);s.callbacks=void 0}}_resolveUrl(e){return n.endPointOf(e)?e:n.appendPathElements(this._server,e)}_makeRelativeUrl(e){if(n.endPointOf(e)){const t=n.parseURI(e);(t.scheme||t.authority)&&(e=t.path,t.query&&(e+="?"+t.query),t.fragment&&(e+="#"+t.fragment))}return e}_parseAsyncResponse(e){m("_parseAsyncResponse");const t=e.responseText||e.response;if(!t)throw new _.default(_.default.INVALID_DATA,"No body data.");const r={},s=t.indexOf("\n");if(-1===s)throw new _.default(_.default.INVALID_DATA,"Could not find status line.");const o=t.slice(0,13===t.charCodeAt(s-1)?s-1:s).split(" ");if(r.statusCode=parseInt(o[1],10),!r.statusCode)throw new _.default(_.default.INVALID_DATA,"Could not find status code.");o.length>2&&(r.statusText=o[2]);let i=t.search(/\r?\n\r?\n/);-1===i&&(i=t.length);const a=t.slice(s+1,i);r.headers=n.parseHeaders(a);const d="\r"===t.charAt(i)?i+4:i+2;return r.response=t.slice(d),r}_pollForAsyncResponse(e,t,r,s){m("_pollForAsyncResponse");const n=Date.now()+1e3*t,d={responseType:"text",reuseRequestDesc:r,noSoonerThen:n,isStatusValid:E,retryOptions:A,autoParseJson:y};o.log("asynchronous request - polling");const c=this._service.invoke(i.HTTPMethods.GET,e,void 0,void 0,d,((t,n)=>{if(t)return s(a.networkError("Error polling for an asynchronous reponse",t,n));let i=n.statusCode;if(202===i){let t;o.log("asynchronous request - not yet ready"),n.headers["retry-after"]&&(t=parseInt(n.headers["retry-after"],10)),this._pollForAsyncResponse(e,t||10,r,s)}else if(200===i){o.log("asynchronous request - success");try{n=this._parseAsyncResponse(n)}catch(e){return s(a.unexpectedResponse("Error parsing response body.",e,n))}i=n.statusCode,200===i||201===i||204===i?s(void 0,n):s(a.unexpectedResponse("Unexpected response polling for an asynchronous response",t,n))}else o.log("asynchronous request - error"),s(a.unexpectedResponse("Unexpected response polling for an asynchronous response",t,n))}));r=c}_handle202Response(e,t,r,s){m("_handle202Response");const o=e.responseText||e.response;let n;try{n=JSON.parse(o)}catch(t){return s(a.unexpectedResponse("Error parsing 202 response body.",t,e))}const i=n.href;if(!i)return s(a.unexpectedResponse("202 response missing an href.",void 0,e));let d=e.headers["retry-after"];d=d?parseInt(d,10):r,this._pollForAsyncResponse(this._resolveUrl(i),d,t,s)}}const O=()=>!0,k={disableRetry:!0},S=!1,N="/content/2/",L=/^\/?content\/2\/[^\/]+\/[^\/]+/,M=/^\/?api\/v2\/[^\/]+\/assets\/[^\/]+/,X={"image/jpeg":"jpg","image/png":"png"};class B extends R{constructor(e,t){if(super(e,t),this.name="AdobeCommunitySession",!this._endPoint)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Could not determine endpoint from: "+t)}publishCompositeAtResource(e,t,r){let s="/api/v2/"+t.communityId+"/assets";s=this._resolveUrl(s);const o={resource_path:this.assetIdFromSSResourceHref(t.resourcePath),resource_type:e,metadata:this.metadataFromPubRecord(t)},n={[i.HeaderKeys.CONTENT_TYPE]:i.JSONMediaType};return this._service.invoke(i.HTTPMethods.POST,s,n,JSON.stringify(o),{responseType:"text",autoParseJson:S,isStatusValid:O,retryOptions:k},(function(e,s){if(e)return r(a.networkError("Error publishing composite",e,s));if(201===s.statusCode){const o=s.headers.location;if(!o)return e=new a.AdobeDCXError(a.AdobeDCXError.INVALID_DATA,"Missing location header returned on response by server",void 0,s),r(a.unexpectedResponse("Unexpected response publishing composite",e,s));const n=function(e){const t=e.match("^.*?\\/api\\/v2\\/([^/]*)/assets\\/([^\\/]*).*$");return t?t[2]:null}(o);if(n)return t.assetId=n,r(void 0,o)}return r(a.unexpectedResponse("Unexpected response publishing composite",e,s))}))}updateCpMetadataAtResource(e,t,r){let s="/api/v2/"+t.communityId+"/assets/"+t.assetId;s=this._resolveUrl(s);const o=this.metadataFromPubRecord(t),n={[i.HeaderKeys.CONTENT_TYPE]:i.JSONMediaType};return this._service.invoke(i.HTTPMethods.PUT,s,n,JSON.stringify(o),{responseType:"text",autoParseJson:S,isStatusValid:O,retryOptions:k},((e,t)=>e?r(a.networkError("Error publishing composite",e,t)):200===t.statusCode?r(void 0,s):r(a.unexpectedResponse("Unexpected response publishing composite",e,t))))}getCpMetadata(e,t){let r="/api/v2/"+e.communityId+"/assets/"+e.assetId;r=this._resolveUrl(r),this._service.invoke(i.HTTPMethods.GET,r,{},void 0,{responseType:"text",autoParseJson:S,isStatusValid:O,retryOptions:k},(function(r,s){if(r)return t(a.networkError("Error getting metadata for CP composite",r,s));if(200===s.statusCode){let r;const o=s.response||s;try{r=JSON.parse(o),e.resourcePath=r.resource_path,e.description=r.description||null,e.title=r.title||null,e.alias=r.alias||null,e.undiscoverable=r.undiscoverable||!1,e.isPrivate=r.private||!1;let t=r.tags;t&&null!==t&&t.length>0&&(e.tags=t);let s=r._embedded;if(s&&null!==s&&(t=r.creators,t&&null!==t&&t.length>0)){const r=[];for(let e=0;e<t.length;++e){const s=t[e];if(s&&null!==s){const e=s.id;e&&null!==e&&r.push(e)}}0!==r.length&&(e.creatorIds=r)}if(s=r.category_id,s&&null!==s&&(e.categoryId=s.id||null),t=r.sub_categories,t&&null!==t&&t.length>0){e.subCategoryIds=[];for(let r=0;r<t.length;++r)s=t[r],e.subCategoryIds.push(s.id)}s=r.custom,s&&null!==s&&(e.custom=s)}catch(e){const r=new a.AdobeDCXError(a.AdobeDCXError.INVALID_DATA,"Invalid JSON returned by server",e,s);return t(r)}return t(void 0,e)}return t(a.unexpectedResponse("Unexpected response while getting metadata for CP composite",r,s))}))}updatePublicationRecordData(e,t){const r=t.versionId;if(e.mainResource="manifest",r&&(e.mainResourceVersion=r),null!==e.artworkComponentId){const r=t.getComponentWithId(e.artworkComponentId);if(null==r)throw new a.AdobeDCXError(a.AdobeDCXError.COMPONENT_DOWNLOAD_ERROR,"Bad component ID = "+e.artworkComponentId);let s=e.resourcePath;s=this.assetIdFromSSResourceHref(s),s+=r.absolutePath,e.artworkResource=s,e.artworkResourceVersion=r.version}}getCompositeManifestHref(e,t,r){if(t)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"AdobeCommunitySession does not support version manifests.");if(!e.assetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Composite must be bound.");if(!this.isProperAssetId(e.assetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");const s=this._resolveUrl(e.assetId);if(!s)throw new a.AdobeDCXError(a.AdobeDCXError.WRONG_ENDPOINT,"Wrong endpoint: "+e.assetId);return r(void 0,n.appendPathElements(s,"manifest"))}getComponent(e,t,r){const s={};let o=s;return this.getComponentHref(e,e.version,((e,n)=>e?r(e):(o=o||s,this._getAsset(n,void 0,t,o,r)))),o||s}getRenditionOfComponent(e,t,r,s,o,n){const i={};let a=i;return this.getComponentRenditionHref(e,e.version,t,r,s,((e,r)=>e?n(e):(a=a||i,this._getAsset(r,{accept:t},o,a,n)))),a||i}getCompositeManifest(e,t,r,s){let o=e.assetId;return o&&(o=this._resolveUrl(o)),o?(o=n.appendPathElements(o,"manifest"),this.getAssetAsType(o,"text",r,s)):s(new a.AdobeDCXError(a.AdobeDCXError.WRONG_ENDPOINT,"Wrong endpoint: "+e.assetId))}headRequest(e,t){return this._service.invoke(i.HTTPMethods.HEAD,e,{},void 0,{responseType:"text",autoParseJson:S,isStatusValid:O,retryOptions:k},(function(e,r){if(e)return t(e);t(e,r)}))}getComponentHref(e,t,r){const s=e._owner;if(!s||!s.compositeAssetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Component must be part of a branch of a bound composite.");if(!this.isProperAssetId(s.compositeAssetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");if(s._core){const t=s._core._getSourceAssetInfoOfComponent(e);if(t)return void r(void 0,this._constructComponentHref(t.compositeAssetId,t.componentPath,t.componentVersion))}r(void 0,this._constructComponentHref(s.compositeAssetId,e.absolutePath,t))}getComponentRenditionHref(e,t,r,s,o,n){const i=e._owner;if(!i||!i.compositeAssetId)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Component must be part of a branch of a bound composite.");if(!this.isProperAssetId(i.compositeAssetId))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Composite asset id has invalid format.");if(i._core&&i._core._getSourceAssetInfoOfComponent(e))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_STATE,"Getting a rendition of a source href not implemented.");return n(void 0,this._constructComponentRenditionHref(i.compositeAssetId,e.absolutePath,t,r,s,o))}isProperAssetId(e){return n.ensureRelativeHrefStartsWithSlash(e)}_constructComponentHref(e,t,r){const s=t.slice(1);let o=n.appendPathElements(this._resolveUrl(e),s);return o&&void 0!==r&&(this._hrefUsesContentApis(e)?o+="/version/"+r:o+="?version="+r),o}_constructComponentRenditionHref(e,t,r,s,o,i){let d,c;const h=t.slice(1),l=n.parseURI(e).path;if(l.slice(0,11)===N){const t=X[s];if(!t)throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Unsupported rendition media type: "+s);if(d=L.exec(l),!(d&&d.length>0))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Failed to parse composite href: "+e);c=this._resolveUrl(n.appendPathElements(d[0],"rendition",h,"version",r,"format",t,"dimension",o,"size",String(i)))}else{if(d=M.exec(l),!(d&&d.length>0))throw new a.AdobeDCXError(a.AdobeDCXError.INVALID_PARAMS,"Failed to parse composite href: "+e);c=this._resolveUrl(n.appendPathElements(d[0],"rendition",o,String(i),h)+"?version="+r)}return c}_hrefUsesContentApis(e){return n.parseURI(e).path.slice(0,11)===N}assetIdFromSSResourceHref(e){const t=e.match("^\\/pubs\\/([^\\/]*).*$");return t?t[1]:null}metadataFromPubRecord(e){const t={};if(null!==e.title&&(t.title=e.title),null!==e.description&&(t.description=e.description),null!==e.alias&&(t.alias=e.alias),t.undiscoverable=e.undiscoverable,e.isPrivate&&(t.private=e.isPrivate),Array.isArray(e.tags)&&(t.tags=[...e.tags]),Array.isArray(e.creatorIds)&&(t.creator_ids=[...e.creatorIds]),null!==e.categoryId&&(t.category_id=e.categoryId),Array.isArray(e.subCategoryIds)&&(t.sub_category_ids=[...e.subCategoryIds]),null!==e.custom&&(t.custom=e.custom),null!==e.mainResource&&null!==e.mainResourceVersion){const r={};r.resource_path=e.mainResource,r.resource_version=e.mainResourceVersion,t.main_resource=r}if(null!==e.artworkResource&&null!==e.artworkResourceVersion){const r={};r.resource_path=e.artworkResource,r.resource_version=e.artworkResourceVersion,t.artwork=r}return t}}const x={unmodified:"unmodified",modified:"modified",pendingDelete:"pendingDelete",committedDelete:"committedDelete"},j={pending:"pending",active:"active",archived:"archived"},U={name:!0,id:!0,state:!0,path:!0,rel:!0,type:!0,etag:!0,length:!0,version:!0,md5:!0,width:!0,height:!0};class V{constructor(e,t=!1){this._readOnly=!1,this._data={},this.records={},e&&this._setData(e),this._readOnly=t}get compositeId(){return this._compositeId}get owner(){return this._owner}get data(){return this._data}get id(){return this._data.id}set id(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._owner)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the id of a component that is part of a branch or element.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.id=e,this._setDirty()}get name(){return this._data.name}set name(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.name=e,this._setDirty()}get type(){return this._data.type}set type(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.type=e,this._setDirty()}get path(){return this._data.path}set path(e){if(this._data.path!==e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!n.isValidPath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a valid path.");this._owner?this._owner._core._setPathOfComponent(this,e):(this._data.path=e,this._parentPath=""),this._setDirty()}}get parentPath(){return this._parentPath}set parentPath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"parentPath is read-only.")}get absolutePath(){return this._data.path&&this._owner?n.appendPathElements(this._parentPath,this._data.path):void 0}set absolutePath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"absolutePath is read-only.")}get relationship(){return this._data.rel}set relationship(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.rel=e,this._setDirty()}get state(){return this._data.state}set state(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.keys(x).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "modified", "unmodified", "pendingDelete", or "committedDelete".');this._data.state=e,this._setDirty()}get etag(){return this._data.etag}set etag(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.etag=e,this._setDirty()}get md5(){return this._data.md5}set md5(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.md5=e,this._setDirty()}get version(){return this._data.version}set version(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(void 0!==e&&"string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.version=e,this._setDirty()}get length(){return this._data.length}set length(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.length=e,this._setDirty()}get width(){return this._data.width}set width(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.width=e,this._setDirty()}get height(){return this._data.height}set height(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("number"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a number or undefined.");this._data.height=e,this._setDirty()}get assetId(){return this._assetId}set assetId(e){if(e!==this._assetId){if(this._assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"assetId property cannot be changed.");this._assetId=e}}get repositoryId(){return this._repoId}set repositoryId(e){if(e!==this._repoId){if(this._repoId)throw new a.DCXError(a.DCXError.INVALID_STATE,"repoId property cannot be changed.");this._repoId=e}}getComponentDescriptor(){if(!i.isAdobeDCXBranchLike(this._owner))throw new a.DCXError(a.DCXError.INVALID_STATE,"Component must be part of a composite to get a descriptor.");return JSON.stringify({versionId:c.CURRENT_COMPONENT_DESCRIPTOR_VERSION,componentId:this.id,compositeId:this._owner.compositeId,cloudAssetId:this._owner.compositeAssetId,repositoryId:this.repositoryId||this._owner.compositeRepositoryId,componentRevisionId:this.version,type:this.type,size:this.length,etag:this.etag,hashType:c.CURRENT_COMPONENT_DESCRIPTOR_HASH_TYPE,hashValue:this.md5})}getCustomKeys(){const e=[],t=Object.keys(this._data),r=t.length;for(let s=0;s<r;s++){const r=t[s];U[r]||e.push(r)}return e}getValue(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');return this._data[e]}setValue(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');this._data[e]=t,this._setDirty()}removeValue(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');delete this._data[e],this._setDirty()}getLink(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');return this._data._links?this._data._links[e]:void 0}setLink(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("object"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "link" must be an object.');if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');let r=this._data._links;r||(r=this._data._links={}),r[t]=e,this._setDirty()}removeLink(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');const t=this._data._links;t&&(delete t[e],Object.keys(t).length<1&&delete this._data._links,this._setDirty())}isEqualTo(e,t){return n.objectsEqual(this._data,e._data,t)}_setData(e){const t=this._verify(e);if(null===t)return this._data=e,this;throw t}_setDirty(){this._owner&&this._owner._setDirty()}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Component is missing an id of type string"):null}}V.STATES=x;class H{constructor(e,t=!1,r=!1){this._data={},e&&this._setData(e),this._readOnly=t,this._isRoot=r}get owner(){return this._owner}get id(){return this._data.id}set id(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._owner)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the id of a node that is part of a branch or element.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");this._data.id=e,this._setDirty()}get name(){return this._data.name}set name(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.name=e,this._setDirty()}get type(){return this._data.type}set type(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.type=e,this._setDirty()}get relationship(){return this._data.rel}set relationship(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");this._data.rel=e,this._setDirty()}get path(){return this._isRoot?H.ROOT_PATH:this._data.path}set path(e){if(e!==this.path){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(this._isRoot)throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot change the path of the root node.");if(e&&!n.isValidPath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a valid path or undefined.");this._owner?this._owner._setPathOfNode(this,e||void 0):(this._data.path=e||void 0,this._parentPath=""),this._setDirty()}}get parentPath(){return this._parentPath}set parentPath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"parentPath is read-only.")}get absolutePath(){const e=this.path;return this._isRoot?e:e&&this._owner?n.appendPathElements(this._parentPath,e):void 0}set absolutePath(e){throw new a.DCXError(a.DCXError.READ_ONLY,"absolutePath is read-only.")}get isRoot(){return this._isRoot}set isRoot(e){throw new a.DCXError(a.DCXError.READ_ONLY,"isRoot is read-only.")}getLink(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');return this._data._links?this._data._links[e]:void 0}setLink(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("object"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "link" must be an object.');if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');let r=this._data._links;r||(r=this._data._links={}),r[t]=e,this._setDirty()}removeLink(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "relationship" must be a string');const t=this._data._links;t&&(delete t[e],Object.keys(t).length<1&&delete this._data._links,this._setDirty())}getCustomKeys(){const e=[],t=Object.keys(this._data),r=t.length;for(let s=0;s<r;s++){const r=t[s];(this._isRoot?F[r]:Y[r])||e.push(r)}return e}getValue(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");return this._data[e]}setValue(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");this._data[e]=t,this._setDirty()}removeValue(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "key" must be a string');if("children"===e||"components"===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Illegal key");delete this._data[e],this._setDirty()}copy(){let e;const t=this._data.children,r=this._data.components;try{t&&delete this._data.children,r&&delete this._data.components;const s=JSON.parse(JSON.stringify(this._data));e=new H(s)}finally{t&&(this._data.children=t),r&&(this._data.components=r)}return e}isEqualTo(e,t,r){return this._isEqual(this._data,e._data,n.merge({children:!0,components:!0},t),r)}_isEqual(e,t,r,s){let o,i,a,d,c;if(!n.objectsEqual(e,t,r))return!1;if(i=e.components,a=t.components,d=i?i.length:0,c=a?a.length:0,d!==c)return!1;if(d){let e,t,r;for(o=0;o<d;o++){for(e=i[o],t=null,r=0;r<d;r++)if(e.id===a[r].id){t=a[r];break}if(!t)return!1;if(!n.objectsEqual(e,t,s))return!1}}if(i=e.children,a=t.children,d=i?i.length:0,c=a?a.length:0,d!==c)return!1;if(d)for(o=0;o<d;o++)if(!this._isEqual(i[o],a[o],r,s))return!1;return!0}_setData(e){const t=this._verify(e);if(null===t)return this._data=e,this;throw t}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Node is missing an id of type string"):null}_setDirty(){this._owner&&this._owner._setDirty()}}H.ROOT_PATH="/";const F={components:!0,children:!0,"manifest-format-version":!0,id:!0,name:!0,type:!0,state:!0,local:!0},Y={components:!0,children:!0,rel:!0,path:!0,id:!0,name:!0,type:!0};class W{constructor(e,t,r=!1){this._allNodes={},this._allComponents={},this._absolutePaths={},this._readOnly=!1,this._isDirty=!1,this._sourceAssetInfoLookup={},this._readOnly=r,this._owner=t,this._setData(e)}get allNodes(){return this._allNodes}get rootNode(){return this.getChildWithAbsolutePath(H.ROOT_PATH)}set rootNode(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "rootNode" is read-only.')}get isDirty(){return this._isDirty}set isDirty(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isDirty.")}get changeCount(){return this._data.local&&this._data.local.change||0}set changeCount(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property changeCount.")}getChildWithId(e){return this._allNodes[e]}getChildWithAbsolutePath(e){const t=this._absolutePaths[e.toLowerCase()];return t&&t instanceof H?t:void 0}getChildrenOf(e){const t=e?this._allNodes[e.id]:this.rootNode;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown node");const r=[],s=t._data.children;if(Array.isArray(s))for(let e=0;e<s.length;e++){const t=s[e],o=this._allNodes[t.id];if(!o)throw new a.DCXError(a.DCXError.INVALID_DATA,"Node not in cache");r.push(o)}return r}addChild(e,t,r,s){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(t=t||n.generateUuid(),this._allNodes[t])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Node already exists in branch.");if(r&&("number"!=typeof r||r%1!=0))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "index" must be an integer.');const o=s?this._allNodes[s.id]:this.rootNode;if(!o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const i=new H;i.id=t,e&&(i.name=e),i._parentPath=o.absolutePath||o._parentPath;const d=o._data.children;return d?(r>=0&&r<=d.length||(r=d.length),r===d.length?d[r]=i._data:d.splice(r,0,i._data)):o._data.children=[i._data],this._allNodes[i.id]=i,i._owner=this._owner,this._setDirty(),i}removeChild(e){let t=e;if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');if(t.isRoot)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot remove the root node.");const r=t.id;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "node" must have an id.');const s=this._nodeDataOfParentOfNode(t);if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node not found in this branch.");const o=s.parentNodeData.children;return o&&(o.splice(s.index,1),0===o.length&&delete s.parentNodeData.children),t=this._allNodes[r],this._removeNodeFromCachesRecursively(t._data),this._setDirty(),t}moveChild(e,t,r){let s=e;const o=r;if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');if(s.isRoot)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot move the root node.");if(t&&("number"!=typeof t||t%1!=0))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "index" must be an integer.');const n=s.id;if(!n)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "node" must have an id.');const i=this._nodeDataOfParentOfNode(s);if(s=this._allNodes[n],!i)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node not found in this branch.");const d=o?this._allNodes[o.id]:this.rootNode;if(!d)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");if(this._nodeIdIsDescendantOf(d.id,s._data))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Must not create a cycle.");const c=i.parentNodeData.children.splice(i.index,1)[0];try{const e=d._data.children;e?(t>=0&&t<=e.length||(t=e.length),t===e.length?e[t]=c:e.splice(t,0,c)):d._data.children=[c]}catch(e){throw i.parentNodeData.children.splice(i.index,0,c),e}return 0===i.parentNodeData.children.length&&delete i.parentNodeData.children,this._setDirty(),this._allNodes[n]}copyChild(e,t,r,s,o,n){return this._copyChild(e,t,r,s,o,!1,n)}replaceChild(e,t,r,s){return this._copyChild(e,void 0,void 0,t,r||e.id,!0,s)}getMissingComponentsFromError(e){var t;return e.code!==a.DCXError.INCOMPLETE_COMPOSITE?[]:(null!==(t=e.response.response.report.failures.filter((e=>"MissingComponent"===e.rule)))&&void 0!==t?t:[]).map((e=>this.getComponentWithId(e.component_id)||this.getComponentWithAbsolutePath(e.component_path))).filter((e=>e))}allComponents(){const e=[];for(const t in this._allComponents)Object.prototype.hasOwnProperty.call(this._allComponents,t)&&e.push(this._allComponents[t]);return e}getComponentWithId(e){return this._allComponents[e]}getComponentWithAbsolutePath(e){const t=this._absolutePaths[e.toLowerCase()];return t&&t instanceof V?t:void 0}getComponentsOf(e){const t=e?this._allNodes[e.id]:this.rootNode;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown node");const r=[],s=t._data.components;if(Array.isArray(s)){let e;for(e=0;e<s.length;e++){const t=s[e],o=this._allComponents[t.id];if(!o)throw new a.DCXError(a.DCXError.INVALID_DATA,"Component not in cache");r[r.length]=o}}return r}addComponentWithComponentDescriptor(e,t,r,s=i.LinkRelation.COMPONENT,o){return this.addComponentWithUploadResults(t,s,r,o,c.uploadResultsFromComponentDescriptor(e))}addComponentWithUploadResults(e,t,r,s,o){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(o.compositeId!==this._owner.compositeId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not appear valid to be for this composite.");const n=Object.keys(o.records);if(1!==n.length)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults must contain records of exactly one component upload.");const i=o.records[n[0]],d=i.id;if(this._allComponents[d])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate component id: "+d);const c=s?this._allNodes[s.id]:this.rootNode;if(!c)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const h=new V;h.id=d,h.name=e,h.type=i.type,h.relationship=t,h.path=r,h.state=x.unmodified,h.etag=i.etag,h.length=i.length,h.version=i.version,h.md5=i.md5;const l=this._normalizedAbsolutePathForItem(h,c);if(this._absolutePaths[l])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+l);h._parentPath=c.absolutePath||c._parentPath;const u=c._data.components;return u?u.push(h.data):c._data.components=[h.data],h._owner=this._owner,this._allComponents[d]=h,this._absolutePaths[l]=h,this._setDirty(),h}updateComponentWithUploadResults(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!(e=this._allComponents[e.id]))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown component.");if(t.compositeId!==this._owner.compositeId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not appear to be valid for this composite.");const r=t.records[e.id];if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Param uploadResults does not contain an upload record for the given component.");return e.etag=r.etag,e.version=r.version,e.md5=r.md5,e.length=r.length,this._setSourceAssetInfoOfComponent(void 0,e),e.state=x.unmodified,this._setDirty(),e}removeComponent(e){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const t=e.id;if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "component" must have an id.');const r=this._nodeDataOfParentOfComponent(e);if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component not found in this branch.");return r.parentNodeData.components.splice(r.index,1),0===r.parentNodeData.components.length&&delete r.parentNodeData.components,e=this._allComponents[t],delete this._allComponents[t],delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],e._owner=void 0,e._parentPath="",this._setDirty(),e}moveComponent(e,t){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const r=e.id;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "component" must have an id.');const s=this._nodeDataOfParentOfComponent(e);if(!s)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component not found in this branch.");const o=t?this._allNodes[t.id]:this.rootNode;if(!o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");const n=this._normalizedAbsolutePathForItem(e,o);if(this._absolutePaths[n])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+n);const i=s.parentNodeData.components.splice(s.index,1)[0],d=o._data.components;return d?d.push(i):o._data.components=[i],0===s.parentNodeData.components.length&&delete s.parentNodeData.components,e=this._allComponents[r],delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],e._parentPath=o.absolutePath||o._parentPath,this._absolutePaths[n]=e,this._setDirty(),e}copyComponent(e,t,r,s,o){return this._copyComponent(e,t,r,s,!1,o)}replaceComponent(e,t,r,s){const o=this._copyComponent(e,void 0,t,r||e.id,!0,s);return r&&r!==e.id&&delete this._allComponents[e.id],o}_getHrefOfComponent(e){let t;const r=this._getBranchOf(e).compositeHref;return r&&void 0!==e.version&&(t=n.appendPathElements(r,e.id),t+=";version="+e.version),t}_setSourceAssetInfoOfComponent(e,t){const r=t.id,s=this._sourceAssetInfoLookup;e?s[r]=e:s[r]&&delete s[r]}_getSourceAssetInfoOfComponent(e){const t=e.id,r=this._sourceAssetInfoLookup;if(r)return r[t]}_copySourceHrefsFrom(e){const t=e._sourceAssetInfoLookup,r=this.allComponents(),s=r.length;if(s&&t){const e=this._sourceAssetInfoLookup;for(let o=0;o<s;o++){const s=r[o].id;e[s]=t[s]}}}_getBranchOf(e){return e._owner?this._getBranchOf(e._owner):e}_isSameComposite(e){const t=this._getBranchOf(this),r=this._getBranchOf(e);return t._data.id===r._data.id&&t.compositeAssetId===r.compositeAssetId&&t.compositeRepositoryId===r.compositeRepositoryId}_stringify(e,t=!1){if(e){const e=this._data.local;let r=null;try{delete this._data.local,r=JSON.stringify(this._data,void 0,t?2:void 0)}finally{e&&(this._data.local=e)}return r}return JSON.stringify(this._data,void 0,t?2:void 0)}_setData(e){const t=new H(e,this._readOnly,!0);t._owner=this._owner,t._parentPath="";const r=t.id,s={},o={},i={};o[r]=t,i[H.ROOT_PATH]=t;const d=(e,t)=>{let r,c;const h=e.components;if(Array.isArray(h))for(let e=0;e<h.length;e++){const r=h[e],o=new V(r,this._readOnly);if(s[o.id])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate component id: "+o.id);if(o._owner=this._owner,o._parentPath=t,c=this._normalizedAbsolutePathForItem(o),i[c])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate absolute path: "+c);if(!n.isValidAbsolutePath(c))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid absolute component path: "+c);s[o.id]=o,i[c]=o}const l=e.children;if(Array.isArray(l))for(let e=0;e<l.length;e++){const s=l[e],h=new H(s,this._readOnly);if(o[h.id])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate node id: "+h.id);if(r=h.path,h._owner=this._owner,h._parentPath=t,r){if(c=this._normalizedAbsolutePathForItem(h),i[c])throw new a.DCXError(a.DCXError.INVALID_DATA,"Duplicate absolute path: "+c);if(!n.isValidAbsolutePath(c))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid node absolute path: "+c);i[c]=h}o[h.id]=h,d(s,h.path?n.appendPathElements(t,h.path):t)}};return d(e,H.ROOT_PATH),this._data=e,this._allComponents=s,this._allNodes=o,this._absolutePaths=i,this._isDirty=!1,this}_removeNodeFromCachesRecursively(e){const t=e.components;if(Array.isArray(t))for(let e=0;e<t.length;e++){const r=t[e].id,s=this._allComponents[r];delete this._allComponents[r],delete this._absolutePaths[this._normalizedAbsolutePathForItem(s)],s._owner=void 0}const r=e.children;if(Array.isArray(r))for(let e=0;e<r.length;e++)this._removeNodeFromCachesRecursively(r[e]);const s=e.id,o=this._allNodes[s];delete this._allNodes[s],o.path&&delete this._absolutePaths[this._normalizedAbsolutePathForItem(o)],o._owner=void 0}_local(){return this._data.local||(this._data.local={version:2}),this._data.local}_recursiveReset(e,t){const r=e.components;if(r)for(let e=r.length-1;e>=0;e--){const s=r[e];s.state===x.committedDelete?(delete r[e],delete this._allComponents[s.id],delete s._owner,this._setSourceAssetInfoOfComponent(void 0,s)):(delete s.etag,delete s.version,s.state=x.modified,t&&t(s))}const s=e.children;if(s)for(let e=0;e<s.length;e++)this._recursiveReset(s[e],t)}_nodeIdIsDescendantOf(e,t){const r=t.children;if(r)for(let t=0;t<r.length;t++){const s=r[t];if(s.id===e||this._nodeIdIsDescendantOf(e,s))return!0}return!1}_recursivelyGetAllComponentsOfChild(e,t=[]){const r=e._data||e,s=r.components;if(s){const e=s.length;for(let r=0;r<e;r++)t[t.length]=this._allComponents[s[r].id]}const o=r.children;if(o){const e=o.length;for(let r=0;r<e;r++)t=this._recursivelyGetAllComponentsOfChild(o[r],t)}return t}_nodeDataOfParentOfNode(e,t=this._data){const r=e._data.id,s=t.children;if(s)for(let o=0;o<s.length;o++){const n=s[o];if(n.id===r)return{parentNodeData:t,index:o};const i=this._nodeDataOfParentOfNode(e,n);if(i)return i}return null}_nodeDataOfParentOfComponent(e,t=this._data){const r=e._data.id,s=t.components;if(s)for(let e=0;e<s.length;e++)if(s[e].id===r)return{parentNodeData:t,index:e};const o=t.children;if(o)for(let t=0;t<o.length;t++){const r=o[t],s=this._nodeDataOfParentOfComponent(e,r);if(s)return s}return null}_determineAbsolutePathChangesRecursively(e,t,r){const s=e.components;if(s)for(let e=0;e<s.length;e++){const o=s[e],i=this._allComponents[o.id];r.push({item:i,parentPath:t,absPath:n.appendPathElements(t,o.path)})}const o=e.children;if(o)for(let e=0;e<o.length;e++){const s=o[e],i=this._allNodes[s.id],a=s.path,d=a?n.appendPathElements(t,a):t;r.push({item:i,parentPath:t,absPath:a?d:void 0}),this._determineAbsolutePathChangesRecursively(s,d,r)}}_setPathOfNode(e,t){const r=t?n.appendPathElements(e._parentPath,t):e._parentPath,s=[{item:e,absPath:t?r:void 0}];let o;this._determineAbsolutePathChangesRecursively(e._data,r,s);const i=n.flatCopy(this._absolutePaths);for(let e=0;e<s.length;e++){const t=s[e].item;t._data.path&&delete i[this._normalizedAbsolutePathForItem(t)]}for(let e=0;e<s.length;e++)if(o=s[e],o.absPath){const e=o.absPath.toLowerCase();if(i[e])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+e);if(!n.isValidAbsolutePath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid absolute path: "+e);i[e]=o.item}for(let e=0;e<s.length;e++)o=s[e],o.parentPath&&(o.item._parentPath=o.parentPath);e._data.path=t,this._absolutePaths=i}_setPathOfComponent(e,t){if(!this._allComponents[e.id])throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown component.");const r=n.appendPathElements(e._parentPath,t).toLowerCase();if(this._absolutePaths[r])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path for component: "+r);if(!n.isValidAbsolutePath(r))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid absolute path: "+r);delete this._absolutePaths[this._normalizedAbsolutePathForItem(e)],this._absolutePaths[r]=e,e._data.path=t}_setDirty(e=!1){if(!e){if(this._local().archivalState===j.pending||this._local().archivalState===j.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot modify an archived composite.");this._data.state!==x.pendingDelete&&this._data.state!==x.committedDelete||u.default.warn("Modifying deleted composite")}this._isDirty=!0,this._local().change=this.changeCount+1,e||this._data.state!==x.unmodified&&this._data.state||(this._data.state=x.modified)}_normalizedAbsolutePathForItem(e,t){let r;return r=t?n.appendPathElements(t.absolutePath||t._parentPath,e.path):e.absolutePath,r.toLowerCase()}_hasSameEndpoint(e){return!0}_copyComponent(e,t,r,s,o,i){n.validateParams(["component",e,"object"],["callback",i,"function",!0]);const d=e._owner._core;if(!d)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy, undefined component owner");const c=this._isSameComposite(d),h=c||this._hasSameEndpoint(e);if(d._local(),!h)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy between two different endpoints.");const l=function(e,t,r){z(e,t,c,h,!s)};if(!i)return this._copyComponentModel(e,t,o,r,s,l);try{i(void 0,this._copyComponentModel(e,t,o,r,s,l))}catch(e){i(a.DCXError.wrapError(a.DCXError.UNEXPECTED,"Unexpected error attempting to copy component model",e))}}_copyComponentModel(e,t,r,s,o,i){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "component".');const d=e._owner,c=new V(JSON.parse(JSON.stringify(e._data)));if(s?(c.path=s,c.id=o||n.generateUuid()):o&&(c.id=o),c._owner=this._owner,e.id===c.id&&this._isSameComposite(d._core)||(c.state=x.modified,c.etag=void 0,c.version=void 0,c.md5=void 0,c.length=void 0),this._allComponents[c.id]&&!r)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Component already exists.");const h=this._allComponents[e.id];if(r&&!h)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Could not find existing component.");let l,u;if(r){const e=this._nodeDataOfParentOfComponent(h);if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Parent node of existing component not found in this branch.");const t=e.parentNodeData.id;if(u=this._allNodes[t],!u)throw new a.DCXError(a.DCXError.INVALID_STATE,"Unknown parent node.");l=e.index}else if(u=t?this._allNodes[t.id]:this.rootNode,!u)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");c._parentPath=u.absolutePath||u._parentPath;const p=this._normalizedAbsolutePathForItem(c),_=this._absolutePaths[p];if(_&&_!==h)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+p);if(!n.isValidAbsolutePath(p))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component path must be a valid path for a component.");let f=this._local();i&&(f=n.deepCopy(f),i(e,c,f));const g=u._data.components;return r?g[l]=c.data:g?g.push(c.data):u._data.components=[c.data],this._data.local=f,this._allComponents[c.id]=c,this._absolutePaths[p]=c,this._setDirty(),c}_copyChild(e,t,r,s,o,n,i){if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Expecting param "node".');const d=e._owner._core,c=this._isSameComposite(d),h=c||this._hasSameEndpoint(e);if(d._local(),d._recursivelyGetAllComponentsOfChild(e).length>0&&!h)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot copy components between two different endpoints.");const l=(e,t,r)=>{z(e,t,c,h,!0)};if(!i)return this._copyChildModel(e,t,r,n,s,o,l);try{i(void 0,this._copyChildModel(e,t,r,n,s,o,l))}catch(e){i(e)}}_copyChildModel(e,t,r,s,o,i,d){if(this._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");const c=e._owner,h=new H(JSON.parse(JSON.stringify(e._data)));o?(h.path=o,h.id=i||n.generateUuid()):i&&(h.id=i),h._owner=this._owner,e.isRoot&&(delete h._data.local,delete h._data.state,delete h._data["manifest-format-version"]);const l=this._allNodes[h.id];if(l&&!s)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Child node already exists.");if(s&&!l)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Could not find existing node to replace.");let u;if(s){const e=this._nodeDataOfParentOfNode(l);if(!e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Parent of existing node not found in this branch.");const t=e.parentNodeData.id;if(u=this._allNodes[t],!u)throw new a.DCXError(a.DCXError.INVALID_STATE,"Unknown parent node.");r=e.index}else if(u=t?this._allNodes[t.id]:this.rootNode,!u)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown parent node.");if(h._parentPath=u.absolutePath||u._parentPath,h.path){const e=this._normalizedAbsolutePathForItem(h),t=this._absolutePaths[e];if(t&&t!==l)throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+e);if(!n.isValidAbsolutePath(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Node path must be a valid path for a node.")}const p=n.flatCopy(this._allNodes),_=n.flatCopy(this._allComponents),f=n.flatCopy(this._absolutePaths),g=n.deepCopy(this._local()),m=function(e,t,r,s,o,n){let i,a;delete r[e.id],e.path&&delete o[t._normalizedAbsolutePathForItem(e)];const d=e._data.children;if(d)for(a=d.length,i=0;i<a;i++)m(r[d[i].id],t,r,s,o);const c=e._data.components;if(c)for(a=c.length,i=0;i<a;i++){const e=s[c[i].id];delete s[e.id],delete o[t._normalizedAbsolutePathForItem(e)]}};l&&m(l,this,p,_,f);const E=(e,t,r,s,o,i,h)=>{if(r[e.id])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate node id: "+e.id);let l;if(r[e.id]=e,e.path){if(l=t._core._normalizedAbsolutePathForItem(e),o[l])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+l);o[l]=e}const u=e._data.children;if(u){const a=u.length;for(let d=0;d<a;d++){const a=new H(u[d]);r[a.id]&&(a.id=n.generateUuid()),a._owner=t,a._parentPath=e.absolutePath||e._parentPath,E(a,t,r,s,o,i)}}const p=e._data.components;if(p){const r=p.length;for(let h=0;h<r;h++){const r=new V(p[h]),u=r.id;if(s[u]&&(r.id=n.generateUuid(),r.state=x.modified,r.etag=void 0,r.version=void 0,r.md5=void 0,r.length=void 0),r._owner=t,r._parentPath=e.absolutePath||e._parentPath,d&&d(c.getComponentWithId(u),r,i),s[r.id])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate component id: "+r.id);if(s[r.id]=r,l=t._core._normalizedAbsolutePathForItem(r),o[l])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"Duplicate absolute path: "+l);o[l]=r}}};if(E(h,this._owner,p,_,f,g,c._local()),s)u._data.children[r]=h._data;else{const e=u._data.children;e?(r>=0&&r<=e.length||(r=e.length),r===e.length?e[r]=h._data:e.splice(r,0,h._data)):u._data.children=[h._data]}return this._allNodes=p,this._allComponents=_,this._absolutePaths=f,this._data.local=g,this._setDirty(),h}_verifyIntegrity(e,t,r){const s=[];let o=!1;const i=e=>(s.push(new a.DCXError(a.DCXError.INVALID_STATE,e)),t&&(o||(t("Branch for composite "+this.rootNode.id+" has the following errors:"),o=!0),t("   "+e)),!1),d=function(e,t){return!!e||i(t)},c=[],h=function(e){(c.indexOf(e)<0||i("Item "+e.id+" encountered more than once"))&&c.push(e)},l=n.flatCopy(this._allComponents),u=n.flatCopy(this._allNodes),p=n.flatCopy(this._absolutePaths),_=Object.keys(p),f=_.length;for(let e=0;e<f;e++){const t=_[e];d("/"===t.charAt(0),"Absolute path "+t+" does not start with a slash.")}const g=(e,t)=>{let r,s;const o=e.children;if(o)for(r=0;r<o.length;r++){const e=o[r],a=u[e.id];(a||i("Node "+e.id+" is not in cache."))&&(h(a),d(a._data===e,"Node "+a.id+" _data property incorrect."),delete u[a.id],a.path&&a._owner&&(s=this._normalizedAbsolutePathForItem(a),(p[s]||i("Absolute path of node "+a.id+" ("+s+") is not in cache."))&&delete p[s]),d(a._parentPath===t,"Parent path of node "+a.id+" should be "+t+" but is "+a._parentPath),d(a._owner===this._owner,"Node "+a.id+" _owner property is not correct.")),g(e,e.path?n.appendPathElements(t,e.path):t)}const a=e.components;if(a)for(r=0;r<a.length;r++){const e=a[r],o=l[e.id];(o||i("Component "+e.id+" is not in cache."))&&(h(o),d(o._data===e,"Component "+o.id+" _data property incorrect."),delete l[o.id],o._owner&&(s=this._normalizedAbsolutePathForItem(o),(p[s]||i("Absolute path "+s+" is not in cache."))&&delete p[s]),d(o._parentPath===t,"Parent path of component "+o.id+" should be "+t+" but is "+o._parentPath),d(o._owner===this._owner,"Component "+o.id+" _owner property is not correct."))}},m=p[H.ROOT_PATH];d(m,"Cannot find root node via path")&&(d(m.id===this._data.id,"Root node has correct id"),d(m.path===H.ROOT_PATH,"Root node has correct path"),d(""===m._parentPath,"Root node has correct parent path"),d(m._owner===this._owner,"Root node has correct owner"),d(m._data===this._data,"Root node has correct data"),d(u[m.id]===m,"Cannot find root node via id")&&delete u[m.id],delete p[H.ROOT_PATH]),g(this._data,H.ROOT_PATH);let E=Object.keys(l);for(let e=0;e<E.length;e++)i("Component "+E[e]+" is in cache but could not be found.");E=Object.keys(u);for(let e=0;e<E.length;e++)i("Node "+E[e]+" is in cache but could not be found.");E=Object.keys(p);for(let e=0;e<E.length;e++)i("Absolute path "+E[e]+" is in cache but could not be found.");return s.length?s:null}}function z(e,t,r,s,o,i,d){if(!t._owner||!e._owner)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Failed to update storage for copied component, missing target or source branch core.");const c=t._owner._core,h=e._owner._core,l=r&&e.id===t.id;let u=h._getSourceAssetInfoOfComponent(e);const p=c.getComponentWithId(t.id),_=s&&(!p||!p.etag)&&e.state===x.unmodified,f=!l&&!u,g=f;if(o&&!p&&(u||f)&&e.id===t.id&&(t._data.id=n.generateUuid(),t.state=x.modified,t.etag=void 0,t.version=void 0,t.md5=void 0,t.length=void 0),f){if(_&&e._owner.compositeAssetId)u={compositeAssetId:e._owner.compositeAssetId,componentId:e.id,componentVersion:e.version,componentPath:e.absolutePath,repositoryId:e._owner.compositeRepositoryId},c._setSourceAssetInfoOfComponent(u,t);else if(g)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not use server-to-server copy for component "+e.id)}else c._setSourceAssetInfoOfComponent(u,t);u&&(t.state=x.modified)}class q{constructor(e,t,r=!1){this._owner=t,e?this._setData(e,r):(e={id:n.generateUuid()},this._core=new W(e,this,r),this._data=e)}get owner(){return this._owner}get rootNode(){return this._core.rootNode}get name(){return this._core.rootNode.name}set name(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t.rootNode.name=e}get type(){return this._core.rootNode.type}set type(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");t.rootNode.type=e}get compositeAssetId(){return this._owner?this._owner.compositeAssetId:void 0}set compositeAssetId(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "compositeAssetId" is read-only.')}get compositeRepositoryId(){return this._owner?this._owner.compositeRepositoryId:void 0}set compositeRepositoryId(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "compositeRepositoryId" is read-only.')}get _isDirty(){return this._core._isDirty}set _isDirty(e){this._core._isDirty=e}get isDirty(){return this._isDirty}get changeCount(){return this._core.changeCount}getChildWithId(e){return this._core.getChildWithId(e)}getChildWithAbsolutePath(e){return this._core.getChildWithAbsolutePath(e)}getChildrenOf(e){return this._core.getChildrenOf(e)}addChild(e,t,r,s){return this._core.addChild(e,t,r,s)}removeChild(e){return this._core.removeChild(e)}moveChild(e,t,r){return this._core.moveChild(e,t,r)}copyChild(e,t,r,s,o,n){return this._core.copyChild(e,t,r,s,o,n)}allComponents(){return this._core.allComponents()}getComponentWithId(e){return this._core.getComponentWithId(e)}getComponentWithAbsolutePath(e){return this._core.getComponentWithAbsolutePath(e)}getComponentsOf(e){return this._core.getComponentsOf(e)}getMissingComponentsFromError(e){return this._core.getMissingComponentsFromError(e)}addComponentWithUploadResults(e,t,r,s,o){return this._core.addComponentWithUploadResults(e,t,r,s,o)}addComponentWithComponentDescriptor(e,t,r,s,o){return this._core.addComponentWithComponentDescriptor(e,t,r,s,o)}updateComponentWithUploadResults(e,t){return this._core.updateComponentWithUploadResults(e,t)}removeComponent(e){return this._core.removeComponent(e)}moveComponent(e,t){return this._core.moveComponent(e,t)}copyComponent(e,t,r,s,o){return this._core.copyComponent(e,t,r,s,o)}parse(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "data" must be a string');let t;try{t=JSON.parse(e)}catch(e){throw new a.DCXError(a.DCXError.INVALID_JSON,"Manifest could not be parsed. Underlying error: "+e.message,e)}return this._setData(t,this._core._readOnly)}copy(){return new q(JSON.parse(JSON.stringify(this._data)),this._owner)}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing an id of type string"):"string"!=typeof e.name?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing a name of type string"):"string"!=typeof e.type?new a.DCXError(a.DCXError.INVALID_DATA,"Element is missing a type of type string"):null}_setData(e,t){const r=this._verify(e);if(null===r)return this._core=new W(e,this,t),this._data=e,this;throw r}_local(){return this._core._local()}_setDirty(e){this._core._setDirty(e)}_setPathOfNode(e,t){this._core._setPathOfNode(e,t)}_verifyIntegrity(e,t,r){return this._core._verifyIntegrity(e,t,r)}}var K;!function(e){e[e.NONE=0]="NONE",e[e.COPY=1]="COPY"}(K||(K={}));const G=o.newDebug("dcx:dcxjs:dcxbranch");class ${constructor(e,t,r,s){this._derivationType=K.NONE,e?this._setData(e,t,r,s):(e={"manifest-format-version":6,id:n.generateUuid()},this.originalManifestFormatVersion=6,this._core=new W(e,this,t),this._core._compositeAssetId=r,this._core._compositeRepositoryId=s,this._data=e),this._pendingElements=[]}get data(){return this._data}set data(e){this._data=e}get compositeId(){return this._core.rootNode.id}set compositeId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");if(t.allNodes[e])throw new a.DCXError(a.DCXError.DUPLICATE_VALUE,"There is already a node with the same id.");delete t.allNodes[this._data.id],this._data.id=e,t.allNodes[e]=this._core.rootNode,t._setDirty()}get rootNode(){return this._core.rootNode}set rootNode(e){this._core.rootNode=e}get name(){return this._core.rootNode.name}set name(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t.rootNode.name=e}get type(){return this._core.rootNode.type}set type(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e||""===e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a non-empty string.");t.rootNode.type=e}get compositeAssetId(){return this._core._compositeAssetId}set compositeAssetId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t._compositeAssetId=e}get compositeRepositoryId(){return this._core._compositeRepositoryId}set compositeRepositoryId(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");n.validateParams(["repoId",e,"string",!0]),t._compositeRepositoryId=e}get compositeLinks(){return this._core._compositeLinks}set compositeLinks(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");n.validateParams(["links",e,"object",!0]),t._compositeLinks=e}get _isRepoComposite(){return!!this._core._compositeRepositoryId}get _collaborationType(){return this._data.local?this._data.local.collaborationType:void 0}set _collaborationType(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");e?t._local().collaborationType=e:delete t._local().collaborationType,t._setDirty(!0)}get _clientDataString(){return this._data.local?this._data.local.clientDataString:void 0}set _clientDataString(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");e?t._local().clientDataString=e:delete t._local().clientDataString,t._setDirty(!0)}get manifestEtag(){return this._data.local?this._data.local.manifestEtag:void 0}set manifestEtag(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string or undefined.");t._local().manifestEtag=e,t._setDirty(!0)}get compositeState(){return this._data.state||x.unmodified}set compositeState(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.values(x).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "modified", "unmodified", "pendingDelete", or "committedDelete".');if(this._isRepoComposite&&(e===x.pendingDelete||e===x.committedDelete))throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites must be deleted in one step using RepoAPISession.");if(!(this._isRepoComposite||e!==x.pendingDelete&&e!==x.committedDelete||this.compositeArchivalState!==j.pending)||this.compositeArchivalState===j.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot delete an archived composite.");this._data.state=e,t._setDirty(!0)}get compositeArchivalState(){return this._core._local().archivalState||j.active}set compositeArchivalState(e){const t=this._core;if(t._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");if(!Object.values(j).includes(e))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'State must be "pending", "archived", or "active".');if(this._isRepoComposite&&e===j.pending)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites must be discarded in one step using RepoAPISession#discardAsset.");if(this.compositeArchivalState===j.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite has already been archived.");if(e!==j.active&&(this.compositeState===x.pendingDelete||this.compositeState===x.committedDelete))throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot archive a deleted composite.");e===j.active?delete this._core._local().archivalState:this._core._local().archivalState=e,t._setDirty(!0)}get isBound(){return!(!this.manifestEtag||!this.compositeAssetId)}set isBound(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isBound. Use resetIdentity instead.")}get versionId(){return this._versionId}set versionId(e){if(this._core._readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");this._versionId=e}get _isDirty(){return this._core._isDirty}set _isDirty(e){this._core._isDirty=e}get isDirty(){return this._core.isDirty}set isDirty(e){this._core.isDirty=e}get localData(){return this._core._stringify(!1,!0)}set localData(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property localData.")}get remoteData(){return this._core._stringify(!0)}set remoteData(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property remoteData.")}get pendingElements(){return this._pendingElements}set pendingElements(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property pendingElements.")}get changeCount(){return this._core.changeCount}set changeCount(e){this._core.changeCount=e}get readOnly(){return this._core._readOnly}set readOnly(e){this._core._readOnly=e}static _newBranchAsCopyOfCore(e){G("_newBranchAsCopyOfCore()");const t=JSON.parse(JSON.stringify(e._data)),r=new $(t),s=r._core;return s._sourceCompositeInfo={links:e._compositeLinks,repositoryId:e._compositeRepositoryId,assetId:e._compositeAssetId},r._resetIdentity((function(t){const r=e.getComponentWithId(t.id);if(!r)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not find original component.");if(r.state===x.modified||!r.etag)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot create a new composite from a branch that contains modified or unbound components.");const o=r._owner.compositeAssetId;if(!o)throw new a.DCXError(a.DCXError.INVALID_STATE,"Cannot make a copy of component of a composite that has not been bound with an asset id. Component id ="+r.id);const n=r._owner.compositeRepositoryId;G("_nBACOC() origAssetId",o),G("_nBACOC() origRepositoryId",n),G("_nBACOC() resetComponent",t),s._setSourceAssetInfoOfComponent({compositeAssetId:o,componentId:r.id,componentVersion:r.version,componentPath:r.absolutePath,repositoryId:n},t)})),r}parse(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Param "data" must be a string');let t;try{t=JSON.parse(e)}catch(e){throw new a.DCXError(a.DCXError.INVALID_JSON,"Manifest could not be parsed. Underlying error: "+e.message,e)}return this._setData(t,this._core._readOnly,this._core._compositeAssetId,this._core._compositeRepositoryId)}getElementWithId(e){return this._createElement(this._core.getChildWithId(e))}getElementWithAbsolutePath(e){return this._createElement(this._core.getChildWithAbsolutePath(e))}addElement(e,t,r,s,o,n){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a name of type string");if("string"!=typeof t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a type of type string");if("string"!=typeof r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element must have a path of type string");const i=this._core.addChild(e,s,o,n);try{i.path=r}catch(e){throw this._core.removeChild(i),e}return i._data.type=t,this._createElement(i)}updateElement(e){const t=this.getChildWithId(e.rootNode.id);if(!t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Element does not exist in branch.");const r=this._core.replaceChild(e.rootNode,t.path);return this._deleteElement(e),r}abandonElement(e){this._deleteElement(e)}getChildWithId(e){return this._core.getChildWithId(e)}getChildWithAbsolutePath(e){return this._core.getChildWithAbsolutePath(e)}getChildrenOf(e){return this._core.getChildrenOf(e)}addChild(e,t,r,s){return this._core.addChild(e,t,r,s)}removeChild(e){return this._core.removeChild(e)}moveChild(e,t=null,r=null){return this._core.moveChild(e,t,r)}copyChild(e,t,r,s,o,n){return this._core.copyChild(e,t,r,s,o,n)}replaceChild(e,t,r,s){return this._core.replaceChild(e,t,r,s)}allComponents(){return this._core.allComponents()}getComponentWithId(e){return this._core.getComponentWithId(e)}getComponentWithAbsolutePath(e){return this._core.getComponentWithAbsolutePath(e)}getComponentsOf(e){return this._core.getComponentsOf(e)}getMissingComponentsFromError(e){return this._core.getMissingComponentsFromError(e)}addComponentWithUploadResults(e,t,r,s,o){return this._core.addComponentWithUploadResults(e,t,r,s,o)}addComponentWithComponentDescriptor(e,t,r,s,o){return this._core.addComponentWithComponentDescriptor(e,t,r,s,o)}updateComponentWithUploadResults(e,t){return this._core.updateComponentWithUploadResults(e,t)}removeComponent(e){return this._core.removeComponent(e)}moveComponent(e,t){return this._core.moveComponent(e,t)}copyComponent(e,t,r,s,o){return this._core.copyComponent(e,t,r,s,o)}replaceComponent(e,t,r,s){return this._core.replaceComponent(e,t,r,s)}copy(){const e=new $(JSON.parse(JSON.stringify(this._data)),!1,this._core._compositeAssetId,this._core._compositeRepositoryId);if(e._derivationType=this._derivationType,e._derivationDatetime=this._derivationDatetime,this._core._sourceAssetInfoLookup){const t=JSON.stringify(this._core._sourceAssetInfoLookup);e._core._sourceAssetInfoLookup=JSON.parse(t)}return e}_isNodeLike(e){return n.isObject(e)}_createElement(e){if(!e)return;const t=JSON.parse(JSON.stringify(e._data));t["manifest-format-version"]=this._data["manifest-format-version"],delete t.path;const r=new q(t,this,this._core._readOnly);return this._pendingElements.push(r),r}_deleteElement(e){const t=this._pendingElements.indexOf(e);if(t<0)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unknown element.");this._pendingElements.splice(t,1)}_verify(e){return"string"!=typeof e.id?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing an id of type string"):"string"!=typeof e.name?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a name of type string"):"string"!=typeof e.type?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a type of type string"):"number"!=typeof e["manifest-format-version"]?new a.DCXError(a.DCXError.INVALID_DATA,"Manifest is missing a manifest-format-version of type number"):null}_setData(e,t,r,s){this.originalManifestFormatVersion=e["manifest-format-version"],function(e){const t=e["manifest-format-version"];if(t<6){if(t<4)throw new a.DCXError(a.DCXError.INVALID_DATA,"Encountered manifest format version "+e["manifest-format-version"]+". Format version conversion not yet implemented for that version.");t<6&&J(e,!0)}}(e),e.local&&(e.local.version=2);const o=this._verify(e);if(null===o)return e["manifest-format-version"]=6,this._core=new W(e,this,t),this._core._compositeAssetId=r,this._core._compositeRepositoryId=s,this._data=e,this;throw o}_reset(e,t){if(this.readOnly)throw new a.DCXError(a.DCXError.READ_ONLY,"This object is read-only.");this._data.local&&(delete this._data.local.manifestEtag,delete this._core._compositeAssetId,delete this._core._compositeRepositoryId),e||(this._data.id=n.generateUuid()),this._data.state=x.modified,this._core._recursiveReset(this._data,t),this._core._setDirty()}_resetBinding(e){this._reset(!0,e)}_resetIdentity(e){this._reset(!1,e)}_local(){return this._core._local()}_setDirty(e){this._core._setDirty(e)}_setPathOfNode(e,t){this._core._setPathOfNode(e,t)}_verifyIntegrity(e,t,r){return this._core._verifyIntegrity(e,t,r)}}function J(e,t=!1){t&&e.path&&delete e.path;const r=e.components;if("object"==typeof r)for(let e=0;e<r.length;e++){const t=r[e];"number"==typeof t.version&&(t.version=t.version.toString())}const s=e.children;if("object"==typeof s)for(let e=0;e<s.length;e++)J(s[e])}const Z=o.newDebug("dcx:dcxjs:dcxcomposite"),Q={PRIVATE:void 0,SHARED_BY_USER:"sharedByUser",SHARED_WITH_USER:"sharedWithUser"};class ee{constructor(e,t,r,s,o,n={}){this._collaborationType=Q.PRIVATE,null!=o&&"object"==typeof o&&(n=o,o=void 0),this._repoId=o,this._current=new $,o&&(this._current.compositeRepositoryId=o),(e||""===e)&&(this._current.data.name=e),t&&(this._current.data.type=t),r&&(this._current.compositeId=r),this._current._collaborationType=this._collaborationType,this._current.data.state=x.modified,this._current._setDirty(!0),this._options=n,s&&(this._assetId=s,this._current.compositeAssetId=s,(e||""===e)&&(this._name=e),t&&(this._type=t),r&&(this._id=r)),this._options.xhrBaseBranchSupport&&(this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0)}get href(){return this._href}set href(e){this._href=e}get links(){return this._links}set links(e){n.validateParams(["links",e,"object"]),this._current&&(this._current.compositeLinks=e),this._links=e}get repositoryId(){return this._current?this._current.compositeRepositoryId:this._repoId}set repositoryId(e){n.validateParams(["repoId",e,"string"]),this._current&&(this._current.compositeRepositoryId=e),this._repoId=e}get id(){return this._current?this._current.compositeId:this._id}set id(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.compositeId=e),this._id=e}get name(){return this._current?this._current.name:this._name}set name(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.name=e),this._name=e}get type(){return this._current?this._current.type:this._type}set type(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.type=e),this._type=e}get assetId(){return this._current?this._current.compositeAssetId:this._assetId}set assetId(e){if("string"!=typeof e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Expecting a string.");this._current&&(this._current.compositeAssetId=e),this._assetId=e}get collaborationType(){return this._current?this._current._collaborationType:this._collaborationType}set collaborationType(e){if(e!==Q.PRIVATE&&e!==Q.SHARED_BY_USER&&e!==Q.SHARED_WITH_USER)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid value: ."+e);this._current&&(this._current._collaborationType=e),this._collaborationType=e}get clientDataString(){return this._current?this._current._clientDataString:this._clientDataString}set clientDataString(e){if("string"!=typeof e&&void 0!==e)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid clientDataString: must be a string or undefined.");const t=this._options.maxClientDataLength||1024;if(e&&e.length>t)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Invalid clientDataString: cannot be greater than 1KB");this._current&&(this._current._clientDataString=e),this._clientDataString=e}get isBound(){return!!(this._current&&this._current.isBound||!this._current&&this._assetId)}set isBound(e){throw new a.DCXError(a.DCXError.READ_ONLY,"Cannot set the property isBound. Use resetIdentity or resetBinding instead.")}get current(){return this._current}set current(e){throw new a.DCXError(a.DCXError.READ_ONLY,'Property "current" is read-only.')}static newCompositeAsCopyOf(e,t,r,s,o){let i=e._core;if(i||e.current&&(i=e.current._core),!i)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"compositeBranchOrElement must be a branch, an element or a composite with a current branch.");const d=new ee(void 0,void 0,void 0,void 0,void 0,o);return d._current=$._newBranchAsCopyOfCore(i),d._current._derivationType=K.COPY,d._current._derivationDatetime=(new Date).toISOString(),d.id=s||n.generateUuid(),t&&(d.name=t),r&&(d.type=r),d}loadBaseBranch(e){if(!this._baseBranchData)throw new a.DCXError(a.DCXError.NO_BASE_BRANCH_DATA,"No base branch data.");let t,r;try{if(r=new $(void 0,!0,this.assetId).parse(this._baseBranchData),!e)return f.default.resolve(r)}catch(r){if(!e)return f.default.reject(r);t=r}e(t,r)}resolvePullWithBranch(e,t){const r=e;if(!r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Need a branch.");if(r===this._current)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Cannot resolve current.");if(this._options.xhrBaseBranchSupport&&(this._baseBranchData=this._pulledBranchData,this._pulledBranchData=void 0),(()=>{r.readOnly=!1,r._collaborationType=this.collaborationType,r._clientDataString=this.clientDataString,this._current=r})(),!t)return this._current;t(void 0,this._current)}acceptPush(e){const t=this._pushJournal;let r;if(t)try{t.applyToBranch(this._current,!0),this._options.xhrBaseBranchSupport&&(this._baseBranchData=this._pushedBranchData,this._pushedBranchData=void 0),this._pushJournal=void 0,e&&e()}catch(e){r=e}else e&&e();if(r){if(!e)throw r;e(r)}if(!e)return this._current}resetBinding(e){delete this._assetId,this._current&&this._current._resetBinding(),this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0,e&&e()}resetIdentity(e){delete this._assetId,this._current?(this._current._resetIdentity(),this._id=this._current.compositeId):this._id=n.generateUuid(),this._baseBranchData=void 0,this._pushedBranchData=void 0,this._pulledBranchData=void 0,e&&e()}_setPath(e){this._path=e}get _isRepoComposite(){return n.isObject(this._current)&&"boolean"==typeof this._current._isRepoComposite?this._current._isRepoComposite:!!this.repositoryId}}function te(e,t,r){if(Z("convertToDCXComposite()"),e.format&&!e.format.endsWith("+dcx"))throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Format must end in "+dcx"');return new ee(e.name,e.format,t,e.assetId,e.repositoryId,r)}function re(e,t,r,s,o,a,d,c,h){const{repositoryId:l}=r;return e.createComposite(r,s,o,a,d,c,h).then((r=>function(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}(this,void 0,void 0,(function*(){const{assetId:s,links:o}=r.result;if(t.assetId=s,t.repositoryId=l,t.links=o,c){const{manifestData:r}=yield e.getCompositeManifest(t);t.resolvePullWithBranch(new $(r))}return a?r.result:t})))).catch((r=>{try{if(r.response&&n.isObject(r.response.headers)){const s=r.response.headers["asset-id"]||r.response.headers["x-resource-id"],o=i.parseLinksFromResponseHeader(r.response);t.links=o,"string"==typeof s&&n.isObject(o)&&e.updateCachedAssetLinks({assetId:s,repositoryId:l,links:o})}}catch(e){}throw r}))}ee.COLLABORATION=Q;class se{constructor(){this._originURL=null,this._manageUIURL=null,this._licenseType=null,this._licenseUrl=null,this._attributionURL=null,this._attributionName=null}get originURL(){return this._originURL}set originURL(e){this._originURL=e}get manageUIURL(){return this._manageUIURL}set manageUIURL(e){this._manageUIURL=e}get licenseType(){return this._licenseType}set licenseType(e){this._licenseType=e}get licenseUrl(){return this._licenseUrl}set licenseUrl(e){this._licenseUrl=e}get attributionURL(){return this._attributionURL}set attributionURL(e){this._attributionURL=e}get attributionName(){return this._attributionName}set attributionName(e){this._attributionName=e}}const oe=(e,t)=>`It looks like you're using a ${e} bundle in a ${t} environment. \r\nThis may lead to unexpected results. \n\nSee https://git.corp.adobe.com/DMA/dcx-js/blob/dev/docs/guides/bundles.md for main field definitions.`;class ne{constructor(e,t,r){this._aborted=!1,this._session=e,this._callback=t,this._cleanup=r,this._componentsPending=0,this._bytesTransfered=0,this._bytesTotal=0,this._onProgress=n.noOp,this._reportProgress=e=>{if(e>0){this._bytesTransfered+=e;const t=this._onProgress;t&&t(this._bytesTransfered,this._bytesTotal)}}}get xferComplete(){return this._xferComplete}get aborted(){return this._aborted}get bytesTransfered(){return this._bytesTransfered}get bytesTotal(){return this._bytesTotal}set onProgress(e){this._onProgress=e}get onProgress(){return this._onProgress}_callCallback(e,t){const r=this._callback;if(r)return this._callback=void 0,r(e,t)}_xferComplete(e,t){const r=this._cleanup;if(!r)return this._callCallback(e,t);this._cleanup=void 0,r(e,t)}abort(e){return this._aborted||(this._aborted=!0,this._session._service.abortAllWithToken(this)),e||(this._callback=void 0,e=new Error("Aborted")),this._xferComplete(e,null)}}class ie{constructor(){}static publishCompositeAlreadyPushedToPubs(e,t,r,s,o,n){if(!t||null==t.resourcePath||null==t.communityId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"ResourcePath & communityId must be set on publication record for the composite to be published.");const i=new ne(o,n),d=null!==t.assetId;let c;return e.current&&o.updatePublicationRecordData(t,e.current),d?(c=o.updateCpMetadataAtResource(e.type,t,(function(e,r){return i.xferComplete(e,e?void 0:t)})),c&&(c.token=i),i):(c=o.publishCompositeAtResource(e.type,t,(function(e,r){return i.xferComplete(e,e?void 0:t)})),c&&(c.token=i),i)}static getCpMetadata(e,t,r){if(!t||null==t.assetId||null==t.communityId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Asset Id & communityId must be set on publication record to fetch its CP metadata.");return e.getCpMetadata(t,r)}}class ae{constructor(e){this._waitingCallbacks=[],this._commitInProgress=!1,this._needAnotherCommit=!1,this._data={"composite-href":e.href,"uploaded-components":{}}}get compositeHref(){return this._data["composite-href"]}set compositeHref(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}get derivationType(){return this._data["derivation-type"]}set derivationType(e){this._data["derivation-type"]=e}get manifestEtag(){return this._data.etag}set manifestEtag(e){e?this._data.etag=e:delete this._data.etag}get versionId(){return this._data.versionId}set versionId(e){e?this._data.versionId=e:delete this._data.versionId}get currentBranchEtag(){return this._data["current-branch-etag"]}set currentBranchEtag(e){e?this._data["current-branch-etag"]=e:delete this._data["current-branch-etag"]}get changeCount(){return this._data.change}set changeCount(e){e?this._data.change=e:delete this._data.change}get compositeHasBeenDeleted(){return!!this._data["composite-deleted"]}set compositeHasBeenDeleted(e){e?this._data["composite-deleted"]=!0:delete this._data["composite-deleted"]}get compositeHasBeenArchived(){return!!this._data["composite-archived"]}set compositeHasBeenArchived(e){e?this._data["composite-archived"]=!0:delete this._data["composite-archived"]}get isEmpty(){return 0===Object.keys(this._data["uploaded-components"]).length&&!this.compositeHasBeenDeleted&&!this.compositeHasBeenArchived&&!this.manifestEtag}set isEmpty(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}get isComplete(){return!!(this._data.etag&&this._data.change||this._data["composite-deleted"]||this._data["composite-archived"])}set isComplete(e){throw new a.DCXError(a.DCXError.READ_ONLY,"This property is read-only.")}recordUploadedComponent(e,t,r,s,o,n){const i={etag:t,length:o,version:r,md5:s,timestamp:(new Date).toISOString()};n&&(i["source-asset-info"]=n),this._data["uploaded-components"][e]=i}idsOfAllUploadedComponents(){return Object.keys(this._data["uploaded-components"])}getRecordForUploadedComponent(e){const t=this._data["uploaded-components"][e];if(t&&!this.isComplete){let r=t.timestamp;if(!r)return void this.removeRecordForUploadedComponent(e);if(r=new Date(r),isNaN(r.getTime()))return void this.removeRecordForUploadedComponent(e);if(Date.now()-r.getTime()>=6012e5)return void this.removeRecordForUploadedComponent(e)}return t}removeRecordForUploadedComponent(e){delete this._data["uploaded-components"][e]}applyToBranch(e,t){const r=e;if(!this.isComplete)throw new a.DCXError(a.DCXError.INVALID_STATE,"Journal is not complete.");const s=r.isDirty;if(this.compositeHasBeenDeleted)r._data.state=x.committedDelete,r.manifestEtag=this.manifestEtag;else{this.compositeHasBeenArchived&&(r.compositeArchivalState=j.archived);const e=r.compositeState!==x.unmodified&&this.changeCount!==r.changeCount,t=this.idsOfAllUploadedComponents(),s=t.length;for(let e=0;e<s;e++){const s=t[e],o=r.getComponentWithId(s);if(o){const e=this.getRecordForUploadedComponent(o.id);if(o._data.etag=e.etag,o._data.length=e.length,o._data.version=e.version,o._data.md5=e.md5,e["source-asset-info"]){const t=r._core._getSourceAssetInfoOfComponent(o),s=e["source-asset-info"];t&&s&&t.compositeAssetId===s.compositeAssetId&&t.componentId===s.componentId&&t.componentVersion===s.componentVersion&&(o._data.state=x.unmodified,r._core._setSourceAssetInfoOfComponent(void 0,o))}else o._data.state=x.unmodified}}r.manifestEtag=this.manifestEtag,"string"==typeof this.versionId&&(r.versionId=this.versionId),void 0!==this.derivationType&&(r._derivationType=this.derivationType),e||(r._data.state=x.unmodified)}t&&(r._isDirty=s)}}function de(e){let t=0;return(r,s,o)=>{e(r-t,o),t=r}}const ce=o.newDebug("dcx:dcxjs:compositexfer:pull");function he(e){ce("_pullCompositeManifest()");const{_composite:t,_session:r,_additionalData:{versionId:s,referenceBranch:o},additionalHeaders:d}=e;if(t._links){const{assetId:e,repositoryId:s}=r.registerLinks(t._links,t.repositoryId,t.assetId);t.assetId=e,t.repositoryId=s,delete t._links}if("string"!=typeof t.assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must have an asset id.");let c;return ce("_pCM() pullManifest()",e),o&&!s&&(c=o.manifestEtag),f.default.resolve(void 0,e).then((()=>{const o=r.getCompositeManifest(t,s,c,d);return e.hasProgressHandler&&(o.progress=de(e._reportProgress.bind(e))),o})).then((r=>{const{manifestData:o,manifestEtag:d,response:c}=r;e._additionalData.response=c;try{const e=i.parseLinksFromResponseHeader(c);t.links=e}catch(e){}if(ce("_pCM() pM() getCompositeManifest() cb",d),null===o)return;let h;try{h=n.isObject(o)?new $(o):(new $).parse(o),h.compositeAssetId=t.assetId,h.compositeRepositoryId=t.repositoryId,h._collaborationType=t.collaborationType,h._clientDataString=t.clientDataString,h.versionId=null!=c.headers.version?c.headers.version:s,h.manifestEtag=d}catch(e){throw ce("_pCM() pM() gCM() bad manifest"),new a.DCXError(a.DCXError.INVALID_JSON,"Corrupted manifest",e)}if(h.compositeState===x.committedDelete||h.compositeState===x.pendingDelete)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites should be deleted using a single step with RepoAPISession#deleteAsset");const l=h._core.allComponents();for(let e=0;e<l.length;++e){const t=l[e];t.state===x.pendingDelete||t.state===x.committedDelete?h.removeComponent(t):t.state=x.unmodified}return h})).then((e=>{if(null!=e)return e.compositeState=x.unmodified,e.readOnly=!0,t._options.xhrBaseBranchSupport&&!s&&(t._pulledBranchData=e.localData),e})).catch((e=>{if(e.code===a.DCXError.NOT_FOUND)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite missing or deleted",e.underlyingError||e);throw e}))}const le=o.newDebug("dcx:dcxjs:compositexfer:push"),ue="META-INF/metadata.xml";var pe;function _e(e,t){if(le("_pushComposite()"),!t.assetId||!t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite is not bound to a cloud asset. createComposite() must be called to assign an asset ID and repository ID before calling push.");const{owner:r,compositeIsNew:s,shouldPushWithXMP:o}=e._additionalData;return function(e,t){return le("_isNoOpPush()"),!t&&e.compositeState===x.unmodified}(r,s)?f.default.resolve(r,e):(function(e){if(le("_assertStateIsValidForPush()"),e.compositeState===x.committedDelete)throw new a.DCXError(a.DCXError.DELETED_COMPOSITE,"Attempt to push a deleted composite");if(e.compositeState===x.pendingDelete)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites should be deleted using a single step with RepoAPISession#deleteAsset");if(e.compositeArchivalState===j.pending||e.compositeArchivalState===j.archived)throw new a.DCXError(a.DCXError.INVALID_STATE,"R-API composites cannot be archived")}(r),e._bytesTotal=0,e._indeterminateTotalBytes=!0,Pe.call(e).then(De.bind(e)).then(o&&!fe(r)?ge.bind(e):void 0).then(Ee.bind(e)).then(ye.bind(e)).catch(me.bind(e)))}function fe(e){return e.getComponentWithAbsolutePath(`/${ue}`)}function ge(){const{_composite:e,_session:r,_additionalData:{xmpConfig:s,owner:o,compositeIsNew:a}}=this,d=function(e,r,s){if(r.mode===t.XMPModes.CLIENT_MANAGED&&r.initialXMPXML)return r.initialXMPXML;const{creatorTool:o,modifyDate:i}=r,a=n.generateUuid(),d=[];if(e._derivationType===K.COPY){const t=e._derivationDatetime,r=h.makeHistoryEventXML(o,"copied",a,t);d.push(r)}else if(s){const e=h.makeHistoryEventXML(o,"created",a,i);d.push(e)}if(!s||e._derivationType===K.COPY){const e=h.makeHistoryEventXML(o,"saved",a,i);d.push(e)}return h.initializeXMPXML(o,a,i,d,void 0)}(o,s,a);return r.putCompositeComponent(e,n.generateUuid(),d,i.EmbeddedMetadataMediaTypes.XML,!0,d.length).then((t=>r.uploadResultsFromAdobeRepoUploadResult(t,e.id))).then((e=>(this._additionalData.xmpPushed=!0,o.addComponentWithUploadResults("xmp-metadata","metadata",ue,void 0,e))))}function me(e){le("_handleError()",e);const{_session:t,_composite:r,_additionalData:{compositeIsNew:s}}=this;if(s||0===this.failedComponents.length&&(e.response&&400===e.response.statusCode||e.additionalData&&e.additionalData.bulkResponse))throw e;let o=!1;return t.headCompositeManifest(r).then((()=>{throw o=!0,e})).catch((t=>{if(!o&&404===t.response.statusCode)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite does not exist; may have been deleted",e,e.response,{failedComponents:this.failedComponents});throw e.additionalData={failedComponents:this.failedComponents},e}))}function Ee(){le("_pushManifest()");const e=this._additionalData.owner;if(e.compositeState!==x.modified)return;const{_session:t,_additionalData:{overwriteExisting:r,validationLevel:s,xmpConfig:o,compositeIsNew:n,shouldPushWithXMP:i,xmpPushed:a}}=this;e.compositeState=x.unmodified;const d=e.remoteData,c=d.length;this._bytesTotal+=c,this._indeterminateTotalBytes=!1;const h=function(e,t){return le("_updateManifestEtag()"),e._journal.manifestEtag&&e._journal.currentBranchEtag===t.manifestEtag&&(le("_uME() updating etag, previous: ",t.manifestEtag),t.manifestEtag=e._journal.manifestEtag),le("_uME() using if-match: ",t.manifestEtag),t.manifestEtag}(this,e);let l;return!i||a?(l=t.updateCompositeManifest(e,d,r,s,h),this.hasProgressHandler&&(l.progress=de(this._reportProgress.bind(this))),l):Ae(this,e,d,r,s,h,n,o)}function Ae(e,r,s,o,d,c,l,u,p=0){const{_session:_,_composite:g}=e,m=function(e,r){if(r.mode===t.XMPModes.CLIENT_MANAGED)return r.xmpPatch;const{creatorTool:s,modifyDate:o}=r,n=[];return e._derivationType===K.COPY&&h.makeDerivedWithAction.call({patchDocument:n},s,"copied",void 0,o),h.appendHistoryEvent.call({patchDocument:n},"saved",s,o),n}(r,u),E=_.getLinkHrefForAsset(g,i.LinkRelation.EMBEDDED_METADATA),A=n.pruneUndefined({[i.HeaderKeys.IF_MATCH]:"*",[i.HeaderKeys.CONTENT_TYPE]:i.JSONPatchMediaType}),y=_.getLinkHrefForAsset(g,i.LinkRelation.MANIFEST),D=n.pruneUndefined({[i.HeaderKeys.IF_MATCH]:c,[i.HeaderKeys.CONTENT_TYPE]:`${i.ManifestMediaType};validation-level=${d}`});return f.default.allSettled([y,E]).then((([e,t])=>{if("rejected"===t.status||"rejected"===e.status)throw new a.DCXError(a.DCXError.INVALID_STATE,"Could not retrieve required links.");return _.performBulkRequest(g,[{method:i.HTTPMethods.PUT,href:e.value,headers:D,body:s},{method:i.HTTPMethods.PATCH,href:t.value,headers:A,body:JSON.stringify(m)}])})).then((t=>function(e,t,r,s,o,n,d,c,l,u=0){le("_handleManifestAndXMPResponse()");const[p,_]=l.result,{statusCode:f}=p,{statusCode:g}=_;if(le("_hMAXR() manifest, embedded status: ",f,g),u>2&&(f>=400||g>=400))throw le("_hMAXR() circuit break retries"),new a.DCXError(a.DCXError.INVALID_STATE,"Repairing failed or repeated failures during XMP/manifest push. Check additionalData.",void 0,l[0],{bulkResponse:l});let m=s,E=d,A=n;function y(s=r){return le("_hMAXR() retry bulk; isNew, etag, overwrite: ",E,A,m),Ae(e,t,s,m,o,A,E,c,u+1)}if(f>=400){if(404===f)throw new a.DCXError(a.DCXError.NO_COMPOSITE,"Composite not found.",void 0,p,{bulkResponse:l});if(424===f);else{if(s&&409===f)throw new a.DCXError(a.DCXError.UPDATE_CONFLICT,"Manifest has been changed",void 0,p,{bulkResponse:l});if(s&&412===f)throw new a.DCXError(a.DCXError.PRECONDITION_FAILED,"Precondition failed",void 0,p,{bulkResponse:l});if(409===f)m=!1;else{if(412!==f)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from manifest PUT in bulk.",void 0,p,{bulkResponse:l});m=!1,A=void 0}}}if(g>=400){if(424===g);else{if(404!==g){if(400===g){const r=fe(t);if(r)return function(e,t,r){const{_session:s,_composite:o,_additionalData:{owner:n}}=e;return s.getCompositeComponent(o,t.id,t.version,"text").then((({response:e})=>{const n=h.repairXMPXML(e,r.creatorTool,r.modifyDate);if(e!==n)return s.putCompositeComponent(o,t.id,n,i.EmbeddedMetadataMediaTypes.XML,!1,n.length)})).then((e=>e&&s.uploadResultsFromAdobeRepoUploadResult(e,o.id))).then((e=>{if(e)return n.updateComponentWithUploadResults(t,e),e.records[t.id].etag}))}(e,r,c).then((()=>y(t.remoteData)));throw new a.DCXError(a.DCXError.INVALID_STATE,"Manifest appears to be corrupted.",void 0,p,{bulkResponse:l})}throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Unexpected response from embedded request in bulk.",void 0,p,{bulkResponse:l})}E=!0}return y()}const D=fe(t);return e._journal.recordUploadedComponent(D.id,"*",`${parseInt(D.version)+1}`,_.headers["content-md5"]||D.md5,D.length),p}(e,r,s,o,d,c,l,u,t,p)))}function ye(e){if(void 0===e)return this._additionalData.owner;this._additionalData.manifestResponse=e;const{_journal:t,_composite:r,_additionalData:{owner:s}}=this,o=e.headers.etag,n=e.headers.version,i=s.changeCount;return t.manifestEtag=o,t.derivationType=K.NONE,t.currentBranchEtag=s.manifestEtag,t.changeCount=i,t.versionId=n,t.applyToBranch(s),s.compositeState=x.unmodified,r._options.xhrBaseBranchSupport&&(r._pushedBranchData=s.localData),s}function De(e){if(le("_handleFailedComponents()"),0===e.length)return this._additionalData.owner;if(e.filter((e=>e.error&&e.error.code===a.DCXError.EXCEEDS_QUOTA)).length>0)throw new a.DCXError(a.DCXError.EXCEEDS_QUOTA,"One or more components failed to upload.",void 0,void 0,{failedComponents:e});throw new a.DCXError(a.DCXError.COMPONENT_UPLOAD_ERROR,"One or more components failed to upload.",void 0,void 0,{failedComponents:e})}function Ce(e){return le("_getCurrentCopyOpCollector()"),(0===e.length||e[e.length-1].docBuilder.entryCount>=(this._additionalData._test_operationsPerBatch||50))&&(le("_gCCOC() new copy op collector"),e.push({docBuilder:i.newOperationDocBuilder(),orderedPendingComponents:[]})),e[e.length-1]}function Ie(e,t){le("_reduceComponent()");const{_journal:r,_composite:s,_additionalData:{owner:o}}=this,{state:n=x.unmodified,etag:d}=t,c=null==d;if(!c&&n===x.unmodified)return le("_rC() not new, not modified"),void r.removeRecordForUploadedComponent(t.id);if(!c&&(n===x.committedDelete||n===x.pendingDelete))return le("_rC() not new, committedDelete or pendingDelete"),void o.removeComponent(t);const h=o._core._getSourceAssetInfoOfComponent(t);if(le("_rC() source asset",h),null==h)return void this._failedComponents.push({component:t,error:new a.DCXError(a.DCXError.INVALID_STATE,"Component should not be modified or new without local storage")});const l=r.getRecordForUploadedComponent(t.id);if(h&&l){const e=l["source-asset-info"];if(e&&e.compositeAssetId===h.compositeAssetId&&e.componentId===h.componentId&&e.componentVersion===h.componentVersion)return t.etag=l.etag,t.version=l.version,t.md5=l.md5,t.length=l.length,void(t.state=x.unmodified)}const u=Ce.call(this,e);u.docBuilder.copyResources({assetId:h.compositeAssetId,repositoryId:h.repositoryId},s,[{source:{component_id:h.componentId,revision:h.componentVersion,reltype:i.LinkRelation.COMPONENT},target:{component_id:t.id,reltype:i.LinkRelation.COMPONENT}}],!0),u.orderedPendingComponents.push([t,h])}function ve(e){le("_handleBatchResults(): ",e);const{_journal:t,_failedComponents:r}=this;e.map((e=>{if("rejected"===e.status)throw le("_hBR() error",e.reason),e.reason;const{orderedPendingComponents:s,results:o,response:i}=e.value;o.forEach((({resources:e})=>{e.forEach((e=>{const o=s.find((([,t])=>t.componentId===e.target.component_id));if(o){const[s,d]=o;try{const{etag:r,id:o,version:c,md5:h,length:l}=function(e,t,r){if(le("_validateCopyResponse()"),!n.isObject(e))throw new a.DCXError(a.DCXError.INVALID_DATA,"Invalid result",void 0,t);const s={etag:e.etag,version:e.revision,md5:r.md5,length:r.length,state:x.unmodified};for(const e in s)if(null==s[e])throw new a.DCXError(a.DCXError.INVALID_DATA,`No ${e}`,void 0,t);return Object.assign(r,s)}(e.target,i,s);t.recordUploadedComponent(o,r,c,h,l,d)}catch(e){r.push({component:s,error:e})}}}))}))}))}function be(e,t){le("_parallelBatchOperations()");const{value:r,done:s}=t.next();return le("_pBO() next generator: ",r,s),f.default.resolve(r).then((t=>{const r=t.filter((e=>e.orderedPendingComponents.length)).map((t=>{const r=t.docBuilder.getDocument(),s=JSON.stringify(r);this._bytesTotal+=s.length;const o=e.performBatchOperation(s).then((({result:e,response:r})=>({results:e,response:r,orderedPendingComponents:t.orderedPendingComponents})));return this.hasProgressHandler&&(o.progress=de(this._reportProgress.bind(this))),o}));return f.default.allSettled(r)})).then(ve.bind(this)).then((()=>s?this.failedComponents:be.call(this,e,t)))}function*Te(e){le("_makeCopyOpGenerator()");let t=[];for(let r=0;r<e.length;r++){const s=e[r];Ie.call(this,t,s);const o=Ce.call(this,t);o.orderedPendingComponents.length===i.COPY_RESOURCES_RESOURCE_LIMIT&&(yield[o],t=[])}return t}function Pe(){le("_pushComponents()");const{_session:e,_additionalData:{owner:t}}=this,r=t.allComponents();le("_pC() component count: ",r.length);const s=Te.call(this,r);return f.default.resolve(void 0,this).then((()=>be.call(this,e,s)))}t.XMPModes=void 0,(pe=t.XMPModes||(t.XMPModes={}))[pe.MANAGED=0]="MANAGED",pe[pe.PARTIALLY_MANAGED=1]="PARTIALLY_MANAGED",pe[pe.CLIENT_MANAGED=2]="CLIENT_MANAGED",pe[pe.UNMANAGED=3]="UNMANAGED";const we=o.newDebug("dcx:dcxjs:compositexfer:upload");function Re(e,t){we("_uploadComponent()");const{additionalHeaders:r,_additionalData:{componentId:s,componentType:o,componentIsNew:i,size:d,md5:h},_composite:l,_session:u,_blockSize:p}=e;n.validateObject(l,"composite",["id","string"],["repositoryId","string"],["assetId","string"]),n.validateParams(["session",u,"object"],["dataOrSliceCallback",t,["object","function","string"]],["componentType",o,"string"],["componentId",s,"string",!0],["size",d,"+number",!0],["md5",h,"string",!0]);const{id:_,repositoryId:g}=l,m=d||t.length||t.byteLength||t.size;return e._bytesTotal=m,f.default.resolve(void 0,e).then((()=>u.putCompositeComponent(l,s,t,o,i,m,h,e.hasProgressHandler?de(e._reportProgress.bind(e)):void 0,r,p))).then((({result:t,response:r})=>{e._additionalData.response=r;const n=c.createUploadResults(_,l.assetId,g);return n.records[s]=function(e,t,r,s){if("object"!=typeof s)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"Invalid upload result, expecting object");const{md5:o,etag:n,revision:i,length:d=t}=s;if(null==d)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No length");if(null==n)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No etag");if(null==i)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No version");if(null==o)throw new a.DCXError(a.DCXError.UNEXPECTED_RESPONSE,"No md5");return c.createUploadRecord(e,n,i,o,d,r)}(s,m,o,t),n}))}const Oe=o.newDebug("dcx:dcxjs:repocompositexfer:xferctx");class ke{constructor(e,t,r,s,o,n){this.additionalHeaders=o,this._aborted=!1,this._bytesTransfered=0,this._abortHandlers=[],this._bytesTotal=0,this._additionalData={},this._failedComponents=[],this._session=e,this._composite=t,this.onProgress=s,r&&(this._additionalData=r),this._blockSize=n}get aborted(){return this._aborted}get bytesTransfered(){return this._bytesTransfered}get bytesTotal(){return this._bytesTotal}get failedComponents(){return this._failedComponents}get hasProgressHandler(){return void 0!==this._progressHandler}set onProgress(e){n.isAnyFunction(e)&&(this._progressHandler=e)}get onProgress(){return this._progressHandler}onAbort(e){this._abortHandlers.push(e)}abort(e){this._aborted||(this._abortHandlers.forEach((t=>n.isAnyFunction(t)&&t.call(void 0,e))),this._session._service.abortAllWithToken(this),this._aborted=!0)}_reportProgress(e,t){if(Oe("progress",e),t&&(this._indeterminateTotalBytes=!0),e>0&&(this._bytesTransfered+=e,n.isAnyFunction(this._progressHandler)))try{this._progressHandler(this._bytesTransfered,this._bytesTotal,this._indeterminateTotalBytes)}catch(e){console.error("Error in progress callback",e)}}}const Se=o.newDebug("dcx:dcxjs:compositexfer");function Ne(e,t,r,s){const n=e._additionalData.response;if((n||r&&r.response)&&o.emitAnalyticsEvent(t,{composite:e._composite,error:r,response:n||r.response,branch:s}),r)throw r}function Le(e,t,r,s,n){const i=e._additionalData.response;if((i||s&&s.response)&&o.emitAnalyticsEvent(o.AnalyticsEvent.UploadComponent,{composite:e._composite,error:s,response:i||s.response,isBlockTransferred:t,component:r}),s)throw s;return n}const Me=s.AdobeNetworkHTTPService,Xe=Me;n.isBrowserSDK()&&n.isNode()?u.default.warn(oe("browser","Node")):!n.isBrowserSDK()&&n.isBrowser()&&u.default.warn(oe("Node","browser"));const Be=o.getGlobalLogger(),xe=p,je=ee.COLLABORATION,Ue=g;Object.defineProperty(t,"createHTTPService",{enumerable:!0,get:function(){return s.createHTTPService}}),Object.defineProperty(t,"AdobeDCXLogger",{enumerable:!0,get:function(){return o.AdobeDCXLogger}}),Object.defineProperty(t,"getGlobalLogger",{enumerable:!0,get:function(){return o.getGlobalLogger}}),Object.defineProperty(t,"AdobeDCXError",{enumerable:!0,get:function(){return a.AdobeDCXError}}),Object.defineProperty(t,"DCXError",{enumerable:!0,get:function(){return a.DCXError}}),Object.defineProperty(t,"isAdobeDCXError",{enumerable:!0,get:function(){return a.isAdobeDCXError}}),t.AdobeCommunityPlatform=ie,t.AdobeCommunityPublicationRecord=g,t.AdobeCommunitySession=B,t.AdobeDCXBranch=$,t.AdobeDCXComponent=V,t.AdobeDCXComposite=ee,t.AdobeDCXElement=q,t.AdobeDCXNode=H,t.AdobeDCXPushJournal=ae,t.AdobeDCXUtil=xe,t.AdobeNetworkHTTPService=Me,t.AdobeRemixData=se,t.COLLABORATION=je,t.CommunityPublicationRecord=Ue,t.CommunitySession=B,t.HTTPService=Xe,t.RemixData=se,t.communityPlatform=ie,t.convertToDCXComposite=te,t.copyResources=function(e,t,r,s,o,n){return e.copyResources(t,r,s,o,n)},t.createCommunityPublicationRecord=()=>new g,t.createCommunitySession=(e,t)=>new B(e,t),t.createComposite=function(e,t,r,s,o,d,c,h){if(Z("createComposite()"),n.validateParams(["session",e,"object"],["composite",t,"object"],["parentDir",r,"object"],["relPath",s,"string"]),t.assetId)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must not already have an assigned asset id.");if("string"!=typeof r.repositoryId&&"string"!=typeof t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Either composite or parentDir must contain valid repositoryId.");if("string"==typeof r.repositoryId&&"string"==typeof t.repositoryId&&r.repositoryId!==t.repositoryId)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Composite contains a repositoryId that does not match parentDir.");if("string"!=typeof t.type)throw new a.DCXError(a.DCXError.INVALID_STATE,"Composite must contain a valid type.");const l="string"==typeof t.repositoryId?t.repositoryId:r.repositoryId,u=r;if(Object.getOwnPropertyNames(r).forEach((e=>{u[e]=r[e],u.repositoryId=l})),!i.isMinimalAdobeAsset(u))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"parentDir must contain links or repositoryId & assetId or path");return re(e,t,u,s,t.type,o||void 0,d,c,h)},t.createRemixData=()=>new se,t.getCompositeManifestAndComponentsByPath=function(e,t,r,s,o,n){const a=i.isAdobeDCXCompositeLike(t)?t:te(t);return e.getManifestAndComponentsByPath(a,r,s,o,n).then((e=>Object.assign(e,{composite:a})))},t.getURLForComponent=function(e,t,r,s){return e.getCompositeComponentUrl(t,t.id,void 0!==r?r:t.version,s)},t.logger=Be,t.newCompositeAsCopyOf=(e,t,r,s,o={})=>ee.newCompositeAsCopyOf(e,t,r,s,o),t.newDCXComposite=function(e,t,r,s,o,n,i={}){if(null==e&&null==n){if("string"!=typeof o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unbound DCXComposite must have a type.");if("string"!=typeof r)throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Unbound DCXComposite must have a name.")}const d=new ee(r,o,s,e,t,i);return n&&(d.links=n),d},t.pullCompositeManifestOnly=function(e,t,r){const s=new ke(e,t,{referenceBranch:t.current},void 0,r),n=(e,t)=>(Ne(s,o.AnalyticsEvent.PullComposite,e,t),t);return he(s).then(n.bind(void 0,void 0)).catch(n)},t.pullCompositeVersionManifestOnly=function(e,t,r,s){const n=new ke(e,t,{versionId:r,referenceBranch:t.current},void 0,s),i=(e,t)=>(Ne(n,o.AnalyticsEvent.PullCompositeVersion,e,t),t);return he(n).then(i.bind(void 0,void 0)).catch(i)},t.pushComposite=function(e,r,s,i=1,d={mode:t.XMPModes.MANAGED},c){Se("pushComposite()"),n.validateParams(["session",e,"object"],["composite",r,"object"],["overwriteExisting",s,"boolean"],["validationLevel",i,"+number"],["options",d,"object",!0]);const h=function(e){void 0===e.mode&&(e.mode=t.XMPModes.MANAGED);const r=e.modifyDate||(new Date).toISOString(),s=e.creatorTool||"dcx-js";if(e.mode===t.XMPModes.MANAGED||e.mode===t.XMPModes.PARTIALLY_MANAGED)return Se("push: using managed XMP mode"),n.validateObject(e,"options",["creatorTool","string",!0],["modifyDate","string",!0]),{mode:e.mode,creatorTool:s,modifyDate:r};if(e.mode===t.XMPModes.CLIENT_MANAGED){Se("push: using client managed XMP mode"),n.validateObject(e,"options",["xmpPatch","object[]",!0],["initialXMPXML","string",!0]);const t=e.xmpPatch||[],o=n.validateJSONPatchDocument(t);if(!0!==o)throw new a.DCXError(a.DCXError.INVALID_PARAMS,'Invalid parameter "options.xmpPatch".',void 0,void 0,{issues:o});return Object.assign(Object.assign({},e),{modifyDate:r,creatorTool:s})}if(e.mode===t.XMPModes.UNMANAGED)return Se("push: using unmanaged XMP mode"),e;throw new a.DCXError(a.DCXError.INVALID_PARAMS,`Invalid XMP mode '${e.mode}'`)}(d),l=!r.isBound;!function(e,r){e.mode===t.XMPModes.PARTIALLY_MANAGED||e.mode===t.XMPModes.MANAGED||e.mode===t.XMPModes.CLIENT_MANAGED&&(r||!r&&e.xmpPatch)}(h,l);const u=r._current.copy(),p=u._derivationType,_=new ke(e,r,{owner:u,overwriteExisting:s,compositeIsNew:l,validationLevel:i,xmpConfig:h,shouldPushWithXMP:!1,xmpPushed:!1},void 0,c);_._journal=_._composite._pushJournal||new ae(r);const f=function(e,t){const s=_._additionalData.manifestResponse;(s||t&&t.response)&&o.emitAnalyticsEvent(o.AnalyticsEvent.PushComposite,{composite:r,branch:u,error:t,response:s||t.response,derivationType:p});const n=_._journal;return _._composite._pushJournal=n.isEmpty?void 0:n,e};return _e(_,r).then(f).catch((e=>{throw f(void 0),e}))},t.uploadComponent=function(e,t,r,s,o,i,a,d){Se("uploadComponent()"),n.validateObject(r,"component",["id","string"],["type","string"]);const{id:c,type:h}=r,l=new ke(e,t,{componentType:h,componentIsNew:!1,componentId:c,size:o,md5:i},a,d),u=(e,t)=>(Le(l,!!p.blockUpload,r,e,t),t),p=Re(l,s).then(u.bind(void 0,void 0)).catch(u);return p},t.uploadNewComponent=function(e,t,r,s,o,i,d,c,h,l){if(Se("uploadNewComponent()"),o&&!n.verifyUuid(o))throw new a.DCXError(a.DCXError.INVALID_PARAMS,"Component id is not a uuid ");const u=new ke(e,t,{componentType:s,componentIsNew:!0,componentId:o||n.generateUuid(),size:i,md5:d},c,h,l),p=(e,t)=>(Le(u,!!_.blockUpload,{length:i,type:s},e,t),t),_=Re(u,r).then(p.bind(void 0,void 0)).catch(p);return _},Object.keys(d).forEach((function(e){"default"===e||t.hasOwnProperty(e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}})})),Object.keys(c).forEach((function(e){"default"===e||t.hasOwnProperty(e)||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}})}))},360470:(e,t,r)=>{var s=r(640430).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(154118),n=r(971507),i=r(294462),a=r(617759);var d=function(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}(i);function c(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}const h=n.newDebug("dcx:http:auth");class l{constructor(e,t,r){this._authToken=e,this._apiKey=t,this._pendingAuth=!1,this._hasBaseRefreshCb=!1,this._authListeners=[],this._persistentListeners=[],this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._authTokenScheme="Bearer",a.validateParams(["authToken",e,"string",!0],["apiKey",t,"string",!0],["refreshCb",r,"function",!0]),r&&(this._hasBaseRefreshCb=!0,this.onChange(((e,t)=>{"unauthenticated"===e&&r.call(null,t)}),!0)),e&&t||(h("init unauthenticated"),this._pendingAuth=!0,setTimeout((()=>{h("after tick",this._pendingAuth),this._pendingAuth&&this.refreshAuth()})))}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}get isNoAuthMode(){return!this._hasBaseRefreshCb}set isNoAuthMode(e){this._hasBaseRefreshCb=!e}get apiKey(){return this._apiKey}get authToken(){return this._authToken}get authTokenScheme(){return this._authTokenScheme}set authTokenScheme(e){this._authTokenScheme=e}setAuthToken(e){h("setAuthToken"),this._authToken=e,this._pendingAuth=!1,this._authChanged("updated")}setApiKey(e){this._apiKey=e}resume(){h("resume()"),this._pendingAuth=!1,this._authChanged("updated")}get pendingAuth(){return this._pendingAuth}onChange(e,t=!1){h("onChange, persistent:",t);const r=this._authListeners.push(e)-1;return t&&this._persistentListeners.push(r),()=>{try{t&&(this._persistentListeners=this._persistentListeners.filter((e=>e!==r))),delete this._authListeners[r]}catch(e){}}}clearListeners(e=!1){if(h("clearListeners, persistent:",e),!0===e)return this._authListeners=[],void(this._persistentListeners=[]);this._authListeners=this._authListeners.map(((e,t)=>{if(this._persistentListeners.includes(t))return e}))}get refreshPromise(){return this._refreshPromise}_authChanged(e){return c(this,void 0,void 0,(function*(){h("authChanged",e),this._pendingAuth="unauthenticated"===e,queueMicrotask((()=>c(this,void 0,void 0,(function*(){const t=[];this._authListeners.map((r=>{if("function"==typeof r){const s=r.call(null,e,this);s&&"object"==typeof s&&s.then&&t.push(s)}})),yield Promise.all(t),"updated"===e&&this._resolveRefresh()}))))}))}_resolveRefresh(){h("_resolveRefresh"),this._refreshResolve&&this._refreshResolve(this.getAuthData()),this._refreshResolve=void 0,this._refreshPromise=void 0}refreshAuth(){return h("refreshAuth"),this._refreshPromise||(this._refreshPromise=new Promise((e=>{this._refreshResolve=e})),this._authChanged("unauthenticated")),this._refreshPromise}getAuthData(){return{authToken:this._authToken,apiKey:this._apiKey}}getAuth(){return c(this,void 0,void 0,(function*(){return Promise.resolve(this.getAuthData())}))}isAuthorizedURL(e){const t=a.getDomainFromURL(e);return this._authenticationAllowList.includes(t)}logout(){h("logout"),this._apiKey=void 0,this._authToken=void 0,!1===this._pendingAuth&&(this._pendingAuth=!0,this._authChanged("unauthenticated"))}applyAuthHeaders(e,t){const r={"x-api-key":void 0,authorization:void 0};return this.isAuthorizedURL(e)&&(null!==t["x-api-key"]&&this.apiKey&&(r["x-api-key"]=this.apiKey),null!==t.authorization&&this.authToken&&(r.authorization=(this.authTokenScheme?`${this.authTokenScheme} `:"")+this.authToken)),a.pruneUndefined(Object.assign(Object.assign({},t),r))}}const u=12e4,p=n.newDebug("dcx:http:xhr");let _;if(_="undefined"!=typeof window?window.XMLHttpRequest:XMLHttpRequest,null==_)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_STATE,"XMLHttpRequest module not found.");const f={NO_ERROR:"",ABORTED:o.ErrorCodes.ABORTED,NETWORK:o.ErrorCodes.NETWORK_ERROR,TIMEOUT:o.ErrorCodes.TIMED_OUT,TOO_MANY_REDIRECTS:o.ErrorCodes.TOO_MANY_REDIRECTS,INSECURE_REDIRECT:o.ErrorCodes.INSECURE_REDIRECT};class g{constructor(e={}){this._autoParseJson=!1,this._bytesReported=0,this._errorCode=f.NO_ERROR,this._isFetchRequest=!1,this._fetchAbort=()=>{},this._preferFetch=!1,this._sent=!1,this.headers={},this.responseType="text",this._progressListeners=[];const{forceXhr:t,preCallback:s,postCallback:n,timeout:i,preferFetch:a}=e;this._preCallback=s,this._postCallback=n,this._timeout=null==i?u:i,this._xhr=t?new t:new _,this._xhr.timeout=this._timeout,this._preferFetch=!0===a,this._fetch=e.fetch?e.fetch:"undefined"!=typeof window&&"fetch"in window&&"function"==typeof window.fetch?window.fetch.bind(window):"undefined"!=typeof self&&"fetch"in self&&"function"==typeof self.fetch?self.fetch.bind(self):void 0!==r.g&&"fetch"in r.g&&"function"==typeof r.g.fetch?r.g.fetch.bind(r.g):void 0,this._parseFetchResponse=this._parseFetchResponse.bind(this),this.onProgress=this.onProgress.bind(this),this._autoParseJson=null==e.autoParseJson||e.autoParseJson,e.additionalNodeOptions&&this._xhr.setNodeOptions&&this._xhr.setNodeOptions(e.additionalNodeOptions),this._promise=new Promise((e=>{this._resolve=e,this._xhr.addEventListener("abort",(()=>{p("aborted",this._errorCode,this._timeout),this._errorCode=this._errorCode||f.ABORTED,this._finalize()})),this._xhr.addEventListener("error",(e=>{switch(p("err",this._errorCode,e,this._xhr.status,this._timeout),this._underlyingError=e,e?e.code:void 0){case"ERR_FR_TOO_MANY_REDIRECTS":this._errorCode=f.TOO_MANY_REDIRECTS;break;case o.AdobeDCXError.INSECURE_REDIRECT:this._errorCode=f.INSECURE_REDIRECT;break;case f.TIMEOUT:this._errorCode=f.TIMEOUT;break;default:this._errorCode=f.NETWORK}this._finalize()})),this._xhr.addEventListener("load",(()=>{p("load"),this._estimatedTotalBytes&&this._estimatedTotalBytes>this._bytesReported&&this._notifyProgressListeners(this._estimatedTotalBytes,this._estimatedTotalBytes,!1),this._finalize()})),this._xhr.addEventListener("timeout",(()=>{p("timeout",this._timeout),this._errorCode=f.TIMEOUT,this._finalize()}))}))}get xhr(){return this._xhr}_parseFetchResponse(e){return c(this,void 0,void 0,(function*(){if(204===e.status)return e;if("chunked"===e.headers.get("transfer-encoding")||parseInt(e.headers.get("content-length")||"0")>0)switch(this.responseType){case"json":a.isJsonContentType(e.headers.get("content-type")||"")&&(this._fetchBodyAsResponseType=yield e.json());break;case"arraybuffer":this._fetchBodyAsResponseType=yield e.arrayBuffer();break;case"blob":this._fetchBodyAsResponseType=yield e.blob();break;case"text":this._fetchBodyAsResponseType=yield e.text();break;case"void":break;case"buffer":case"defaultbuffer":this._fetchBodyAsResponseType=yield e.arrayBuffer().then((e=>new Uint8Array(e)))}return"stream"===this.responseType&&(this._fetchBodyAsResponseType=e.body),e}))}_shouldAutoParseResponse(){const e=this._errorCode===f.NO_ERROR&&this._sent&&!this._isFetchRequest&&"text"===this._xhr.responseType&&this._autoParseJson&&"string"==typeof this._xhr.response&&this._xhr.response.length<102400&&a.isJsonContentType(this.getResponseHeader("content-type"));return p("_shouldAutoParseResponse()",e),e}_fetchWithTimeout(e,t={}){if("function"!=typeof this._fetch)throw new o.DCXError(o.DCXError.UNEXPECTED,"fetch method not found but was invoked");const{timeout:r}=t,s=function(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(r[s[o]]=e[s[o]])}return r}(t,["timeout"]);this._isFetchRequest=!0;const n=e=>()=>{this._errorCode=this._errorCode||f.TIMEOUT,e(new o.DCXError(o.DCXError.TIMED_OUT,"request aborted due to timeout")),this._finalize()};if("function"!=typeof AbortController)return new Promise(((t,o)=>c(this,void 0,void 0,(function*(){this._timeoutTimeout=setTimeout(n(o),r);const i=yield this._fetch(e,s);return clearTimeout(this._timeoutTimeout),this._parseFetchResponse(i).then(t)})))).finally((()=>{clearTimeout(this._timeoutTimeout)}));const i=new AbortController;return this._timeoutTimeout=setTimeout(n(i.abort.bind(i)),r),this._fetchAbort=()=>{this._errorCode=this._errorCode||f.ABORTED,i.abort(),this._finalize()},this._fetch(e,Object.assign({signal:i.signal},s)).then(this._parseFetchResponse).finally((()=>{clearTimeout(this._timeoutTimeout)}))}_finalize(){if(p("_finalize",this._xhr.status,this._errorCode),this._shouldAutoParseResponse())try{const e=JSON.parse(this._xhr.response);this._autoParsedResponse=e,this._xhr.responseType="json"}catch(e){}this._postCallback&&this._postCallback(this),this._timeoutTimeout&&clearTimeout(this._timeoutTimeout),this._progressListeners=[],this._resolve(this)}_validateResponseType(e){if("buffer"===e){if("function"!=typeof s)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"No Buffer class")}else if("blob"===e){if("function"!=typeof Blob)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"No Blob class")}else if("text"!==e&&"json"!==e&&"arraybuffer"!==e&&"stream"!==e)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Unsupported response type");return e.toLowerCase()}send(e,t,r,s={},n="text",i={}){if(p("send"),this._sent)throw new Error("Xhr already sent");this.href=e,this.method=t.toUpperCase(),this.body=r,this.body?this._estimatedTotalBytes=this.body.byteLength||this.body.length||this.body.size:this._estimatedTotalBytes=Number.MAX_SAFE_INTEGER;const d=e=>{var t;p(`progress ${e.loaded}/${e.total}`),this._bytesReported=e.loaded,e.lengthComputable?(this._estimatedTotalBytes=e.total,this._notifyProgressListeners(this._bytesReported,null!==(t=this._estimatedTotalBytes)&&void 0!==t?t:1/0,!1)):this._estimatedTotalBytes&&this._estimatedTotalBytes>this._bytesReported&&this._notifyProgressListeners(this._bytesReported,this._estimatedTotalBytes||e.total,!0)};["POST","PUT","PATCH"].includes(this.method)&&this._xhr.upload?this._xhr.upload.onprogress=d:this._xhr.addEventListener("progress",d),this._timeout=i.timeout||this._timeout||u,p("setting timeout",this._timeout),this._xhr.timeout=this._timeout,n&&(n=this._validateResponseType(n),p("responseType: ",n),this.responseType="buffer"===n?"arraybuffer":"stream"===n?"stream":"void"===n?"text":n);const c=a.normalizeHeaders(s);if(this.headers=c,this.href.startsWith("http:")&&null!==this.headers.authorization)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Must not send auth token over unsecured connection");if(this._preCallback&&this._preCallback(this),(this._preferFetch||"stream"===n)&&"function"==typeof this._fetch)return this._xhr.responseType=this.responseType,this._promise=new Promise((e=>{this._resolve=e,this._fetchWithTimeout(this.href,{body:["GET","HEAD"].includes(this.method.toUpperCase())?void 0:r,credentials:i.withCredentials?"include":void 0,headers:c,method:this.method,timeout:this._timeout}).then((e=>{this._fetchResponse=e,this._finalize()})),this._sent=!0})),this._promise;this._xhr.open(this.method,this.href,!0),this._xhr.responseType=this.responseType;for(const[e,t]of Object.entries(c))this._xhr.setRequestHeader(e,t);return null!=i.withCredentials&&(this._xhr.withCredentials=i.withCredentials),null!=r?this._xhr.send(r):this._xhr.send(),this._sent=!0,this._promise}abort(){if(p("abort()"),!this._sent)throw new Error("Cannot abort before sending.");this._isFetchRequest?this._fetchAbort():this._xhr.abort()}getResponseHeader(e){if(!this._sent)throw new Error("Cannot getResponseHeader before sending.");const t=e.toLowerCase(),r=this.getAllResponseHeaders();if(t in r)return r[t]}getAllResponseHeaders(){var e,t;if(!this._sent)throw new Error("Cannot getAllResponseHeaders before sending.");if(this._parsedResponseHeaders)return this._parsedResponseHeaders;const r=this._isFetchRequest?a.objectFromEntries(null!==(t=null===(e=this._fetchResponse)||void 0===e?void 0:e.headers.entries())&&void 0!==t?t:[]):this._xhr.getAllResponseHeaders();return this._parsedResponseHeaders="string"==typeof r?a.parseHeaders(r):a.normalizeHeaders(r),this._parsedResponseHeaders}isError(){if(!this._sent)throw new Error("Cannot check isError before sending.");return this._errorCode!==f.NO_ERROR}isAborted(){if(!this._sent)throw new Error("Cannot check isAborted before sending.");return this._errorCode===f.ABORTED}isTimedOut(){if(!this._sent)throw new Error("Cannot check isTimedOut before sending.");return this._errorCode===f.TIMEOUT}isSent(){return this._sent}getErrorCode(){return this._errorCode}getStatus(){if(!this._sent)throw new Error("Cannot getStatus before sending.");return this._fetchResponse?this._fetchResponse.status:this._xhr.status}getResponse(){var e;if(!this._sent)throw new Error("Cannot getResponse before sending.");return this._response||(this._response={statusCode:this.getStatus(),headers:this.getAllResponseHeaders(),responseType:this._autoParsedResponse?"json":this.responseType,response:this.getResponseData(),message:this._isFetchRequest?(null===(e=this._fetchResponse)||void 0===e?void 0:e.statusText)||"":this._xhr.statusText,xhr:this},this._autoParsedResponse&&(this._response.originalResponseData=this._xhr.response)),this._response}toJSON(){return{statusCode:this.getStatus(),headers:this.getAllResponseHeaders(),responseType:this._autoParsedResponse?"json":this.responseType,response:this.getResponseData(),message:this._xhr.statusText}}getResponseDataAsJSON(){return c(this,void 0,void 0,(function*(){try{if(this._fetchResponse)return yield this._fetchResponse.json();if(this._autoParsedResponse)return this._autoParsedResponse;if("json"===this._xhr.responseType){if("string"==typeof this._xhr.response)return JSON.parse(this._xhr.response);if(null===this.xhr.response&&["application/problem+json","application/json"].includes(this.xhr.getResponseHeader("content-type")))throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected response type");return this.xhr.response}let e=this._xhr.response;if("text"===this._xhr.responseType&&null!==this._xhr.responseText)e=this._xhr.responseText;else if("arraybuffer"===this._xhr.responseType)e=a.arrayBufferToString(this._xhr.response);else{if("blob"===this._xhr.responseType&&(e instanceof Blob||a.isFunction(e.text)))return JSON.parse(yield e.text());"stream"===this.responseType?yield new Promise(((t,r)=>{if(e="","function"==typeof this.xhr.response.on)return this.xhr.response.on("data",(t=>{e+=t})),this.xhr.response.on("end",t),void this.xhr.response.on("error",r);if("string"==typeof this.xhr.response)return t(e=this.xhr.response);throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected response type")})):e=this._xhr.responseText?this._xhr.responseText:e}return"string"==typeof e?JSON.parse(e):e}catch(e){throw new o.DCXError(o.DCXError.INVALID_JSON,"Could not parse response as JSON",e,this.toJSON())}}))}getResponseData(){if(!this._sent)throw new Error("Cannot getResponseData before sending.");return this._isFetchRequest&&this._fetchBodyAsResponseType?this._fetchBodyAsResponseType:this._autoParsedResponse||this._xhr.response}onProgress(e){const t=this._progressListeners.push(e)-1;return()=>{try{delete this._progressListeners[t]}catch(e){}}}_notifyProgressListeners(e,t,r){this._progressListeners.map((s=>s&&s.call&&s.call(null,e,t,r)))}}const m=n.newDebug("dcx:http:backoff");function E(e,t,r,s={},i,d={},h=!1){const{disableRetry:l=!1,retryNetworkError:u=!0,responseType:p="text",authCallback:_=null,progressListeners:E=[],initialWait:A=2e3,maxWait:y=32e3,preCallback:D,postCallback:C,preScheduleCallback:I,postScheduleCallback:v,preferRetryAfterHeader:b=!0,pollCodes:T=[],pollHeader:P,pollMethod:w="get"}=d;let{retryCodes:R=[],timeoutAfter:O=72e3}=d;R=h?[...T,...R]:l||a.isReadableStream(r)?[]:d.retryCodes||a.DEFAULT_RETRY_CODES,m("retry codes",R);const k=d.increase||((e,t,r)=>1===e?r:t*t>y?y:t*t);let S=0,N=0,L=!1;const M=a.now();let X,B,x,j,U=a.now(),V=0,H=!1,F=!1;const Y=[];let W;function z(){m("getSnapshot()",L,S,a.now(),U,V);const e=L||null!=X?0:S-(a.now()-U);let t=V;t+=L?a.now()-U:0;const r=(X||a.now())-M;return{count:N,canceled:H,timedOut:F,requests:Y,duration:r,totalWaited:t,requestPending:L,waitingFor:e}}function q(){const e=k(N,S,A);return Math.min(e,y)}function K(e){if(e)return t=>e(t,z())}function G(e){const t=e.getResponseHeader("retry-after");if(b&&t){if(isNaN(t)){const e=Date.parse(t)-Date.now();return m("nextWait from retry-after",e),e<0?q():e}return 1e3*parseInt(e.getResponseHeader("retry-after"))}}function $(l=S){return c(this,void 0,void 0,(function*(){if(V>=O)return m("timed out",V,O),F=!0,B(j);U=a.now(),I&&(yield I(z())),m("retry in ",l),W=setTimeout((()=>{var f;m("retry start"),n.log(`Request: ${t.toUpperCase()} ${e} ${null!==(f=null==s?void 0:s["x-request-id"])&&void 0!==f?f:""}`),L=!0,V+=l,j=new g(Object.assign(Object.assign({},d),{timeout:i,preCallback:K(D),postCallback:K(C)})),Y.push(j),N++;for(const e of E)j.onProgress(e);j.send(e,t,r,s,p).then((i=>c(this,void 0,void 0,(function*(){var d;if(n.log(`Response: ${t.toUpperCase()} ${e} ${null===(d=i.headers)||void 0===d?void 0:d["x-request-id"]} ${i.getStatus()}`),L=!1,!(i.isError()||a.checkRetriable(i.getStatus(),R)||401===i.getStatus()&&null!=_||"string"==typeof P&&null!=T&&a.checkRetriable(i.getStatus(),T)))return X=a.now(),B(i);if(i.isAborted()||H)return X=a.now(),H=!0,B(i);if(!h&&"string"==typeof P&&null!=T&&a.checkRetriable(i.getStatus(),T)){const s=i.getResponseHeader(P.toLowerCase());if(s){h=!0,e=s,t=w,r=void 0,R=[...R,...T],V=0,O*=3;const o=i.getResponseHeader("retry-after");if(b&&o){const e=G(i);if(null!=e)return S=e,$(S)}return $(0)}}if(401===i.getStatus()){if(_){try{s=yield _(e,s)}catch(e){return x(new o.DCXError(o.DCXError.UNAUTHORIZED,"Authentication Failed",i))}return V+=a.now()-U,$(0)}return X=a.now(),x(new o.DCXError(o.DCXError.UNAUTHORIZED,"Authentication Failed",i))}if(a.checkRetriable(i.getStatus(),R)||u&&i.getErrorCode()===o.ErrorCodes.NETWORK_ERROR){const e=i.getResponseHeader("retry-after");if(b&&e){const e=G(i);if(null!=e)return S=e,$(S)}return S=q(),$(S)}return X=a.now(),B(i)}))))}),l),v&&(yield v(z()))}))}const J=new Promise(((e,t)=>{B=e,x=t,$(0)}));return{getPromise:()=>J,cancel:function(){m("cancel()"),H=!0,null!=j&&j.abort(),L||(m("abort"),clearTimeout(W),B({getErrorCode:()=>f.ABORTED}))},onProgress:function(e){if(!E.includes(e))return E.push(e),null!=j?j.onProgress&&j.onProgress(e):void 0},getSnapshot:z}}class A{constructor(e,t,r,s,o="text",n,i,a={}){const{descriptor:d}=a;delete a.descriptor;const{cancel:c,getPromise:h,onProgress:l,getSnapshot:u}=E(e,t,r,s,a.timeout,Object.assign(Object.assign(Object.assign(Object.assign({},a),{responseType:o,authCallback:i}),a.retryOptions),{descriptor:d,forceXhr:a.forceXhr,autoParseJson:a.autoParseJson}));this.onProgress=l,"function"==typeof n&&l(((e,t)=>n("progress",{total:t,sentOrReceived:e}))),this._cancel=c,this._promise=h(),this._getSnapshot=u}getSnapshot(){return this._getSnapshot()}getPromise(){return this._promise}cancel(e){this._cancel(e)}}const y=n.newDebug("dcx:http:req");class D{constructor(e){var t;if(this._pausable=!1,this._listeners={progress:[],cancel:[]},this._isStatusValid=e.isStatusValid||o._defaultStatusValidator,this._isExternalRequest=e.isExternalRequest,this._authProvider=e.authProvider,this._id=e.id,this._descriptor=e.descriptor,e.descriptor&&e.descriptor.progress){const t=e.descriptor.progress;this.on("progress",(({sentOrReceived:e,total:r})=>{t.call(void 0,e,r)}))}const r=this._authProvider.applyAuthHeaders(e.url,a.normalizeHeaders(e.headers||{}));this._isExternalRequest&&D._internalOnlyHeaders.forEach((e=>delete r[e])),this._networkRequest=new A(e.url,e.method,e.body,r,e.responseType,(null===(t=e.descriptor)||void 0===t?void 0:t.progress)?this._emit.bind(this):void 0,this._getAuthCb(),e),this._promise=this._networkRequest.getPromise().then((t=>{const r=t.getErrorCode(),s=r||this._isStatusValid(t.getStatus(),t.getResponse());if(r||!0!==s){if(r===f.ABORTED)throw new o.DCXError(o.DCXError.ABORTED,"Aborted");if(r===f.NETWORK)throw new o.DCXError(o.DCXError.NETWORK_ERROR,"Network error",void 0,t.getResponse());if(r===f.TIMEOUT)throw new o.DCXError(o.DCXError.TIMED_OUT,"Timeout",void 0,t.getResponse());if(s instanceof o.DCXError||s instanceof Error)throw new o.DCXError(s.code||o.DCXError.UNEXPECTED_RESPONSE,s._message||s.message,s.underlyingError,t.getResponse());throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response",void 0,t.getResponse())}const n=this._networkRequest.getSnapshot().requests;return y("resolve",e.id),Object.assign(Object.assign({},t.getResponse()),{xhr:n[n.length-1]})})).catch((t=>{throw y("reject",e.id),t}))}get id(){return this._id}get descriptor(){return this._descriptor}_getAuthCb(){if(!this._authProvider.isNoAuthMode)return this._authCb.bind(this)}_authCb(e,t){return y("_authCb()"),this._authProvider.isAuthorizedURL(e)?this._authProvider.refreshAuth().then((()=>this._authProvider.applyAuthHeaders(e,t))):Promise.reject(new o.DCXError(o.DCXError.UNAUTHORIZED,"URL is not part of authenticationAllowList.",void 0,void 0,{url:e}))}_emit(e,t){this._listeners[e].map((e=>e.call(null,t)))}getPromise(){return this._promise}cancel(e){return this._networkRequest.cancel(e)}on(e,t){var r;"progress"===e&&0===this._listeners[e].length&&(null===(r=this._networkRequest)||void 0===r||r.onProgress(((t,r)=>this._emit(e,{total:r,sentOrReceived:t})))),this._listeners[e].push(t)}}D._internalOnlyHeaders=["x-request-id","x-api-key","authorization"];const C=n.newDebug("dcx:http:map");class I{constructor(){this._map=new Map}addRequest(e,t){return C("addRequest()",e),this._map.set(e,t),t.getPromise().then((t=>{C("then",e),this._map.delete(e)})).catch((t=>{C("catch",e,t),this._map.delete(e)})),e}get(e){return this._map.get(e)}get length(){return this._map.size}has(e){return this._map.has(e)}removeById(e){const t=this._map.get(e);t&&this.remove(t)}remove(e,t){return e&&e.cancel&&e.cancel(t)}clear(e){this._map.forEach((t=>{this.remove(t,e)})),this._map.clear()}removeAllWithToken(e){this._map.forEach((t=>{t.descriptor.token===e&&this.remove(t)}))}}const v=n.newDebug("dcx:http:q"),b=e=>"head"===e.method.toLowerCase();class T{constructor(){this._queue=[],this._later={},this._headEndPtr=0,this._isPriority=b,this._usePriority=!1}push(e,t,r){return c(this,void 0,void 0,(function*(){let s;const o=new Promise((e=>{s=e}));if("number"!=typeof t||t<=0){const t={descriptor:e,notifySent:e=>s(e),notifyCanceled:this._notifyCanceled(s)};return this._push(t),o}const{id:n}=e,i=setTimeout((()=>{this._ready(n)}),t),a=e=>s(e);return this._later[n]={readyTimeout:i,wait:t,descriptor:e,notifySent:a,notifyCanceled:this._notifyCanceled(s),notifyReady:()=>{r&&r.call(null,{wait:t,descriptor:e,notifySent:a})}},o}))}_notifyCanceled(e){return t=>{if(!t)return e({canceled:!0});e({canceled:!0,error:t})}}_push(e){this._usePriority&&this._isPriority(e.descriptor)?this._queue.splice(this._headEndPtr++,0,e):this._queue.push(e)}remove(e){if(e.id in this._later)return v("remove from later",e.id),this._remove(e.id);const t=this._indexOf(e);return v("remove from q",t),t>=0?this._remove(t):void 0}_remove(e,t){if(v("_remove",e),"string"==typeof e){const r=this._later[e];return r.notifyCanceled.call(null,t),r.readyTimeout&&clearTimeout(r.readyTimeout),void delete this._later[e]}this._queue[e].notifyCanceled.call(null,t),this._queue.splice(e,1),e<this._headEndPtr&&this._headEndPtr--}_indexOf(e){const t=!!e.method,r=t&&this._usePriority&&this._isPriority(e),s=r?this._headEndPtr:this._queue.length,o=r||!t?0:this._headEndPtr;for(let t=o;t<o+s;t++)if(e.id===this._queue[t].descriptor.id)return t;return-1}exists(e){return e.id in this._later||this._indexOf(e)>=0}_ready(e){const t=this._later[e],r=t.notifyReady;delete this._later[e],delete t.notifyReady,delete t.readyTimeout,delete t.wait,this._push(t),"function"==typeof r&&r.call(null)}pop(){const e=this._queue.shift();return this._headEndPtr>0&&this._headEndPtr--,e}get length(){return v("length: ",this._queue.length,Object.keys(this._later).length),this._queue.length+Object.keys(this._later).length}clear(e){for(let t=this._queue.length-1;t>=0;t--)this._remove(t,e);this._queue=[];const t=Object.keys(this._later);for(const r in t){const s=t[r];this._remove(s,e)}this._later={}}removeAllWithToken(e){for(let t=this._queue.length-1;t>=0;t--)this._queue[t].descriptor.token===e&&this._remove(t);const t=Object.keys(this._later);for(const r in t){const s=t[r];this._later[s].descriptor.token===e&&this._remove(s)}}}const P=n.newDebug("dcx:http:service"),w=3e5;class R{constructor(e,t={}){this.name="AdobeHTTPService",this._requestQueue=new T,this._requestsOutstanding=new I,this._authProvider=void 0,this._isActive=!0,this._preferFetch=!1,this._handlesRedirects=!0,this._withCredentials=!1,this._additionalNodeOptions={},this._retryOptions={},this._serviceGuid=a.generateUuid(),this._reqNum=0,this.featureFlags={},e instanceof l||a.isObject(e)&&a.isAnyFunction(e.onChange)?this._authProvider=e:a.isAnyFunction(e)&&(t.useAuthProvider?(this._authProvider=new l(void 0,void 0,e),this._waitingForAuthentication=!0):(this._authProvider=new l(void 0,void 0,(()=>e.call(null,this))),this._waitingForAuthentication=!0)),this._authProvider?this._authProvider.onChange(this._onAuthChange.bind(this)):(this._authProvider=new l,this._authProvider.resume()),this._maxOutstanding=t.maxOutstanding||5,this._withCredentials=t.crossOriginCredentials||!1,this._timeout=null==t.timeout?u:t.timeout,this._preferFetch=!0===t.preferFetch,this._requestIdPrefix=t.requestIdPrefix,t.server&&(this.server=t.server)}get isActive(){return this._isActive}set isActive(e){this._isActive!==e&&(this._isActive=e,e||this._authProvider.logout(),this._checkQueue())}get crossOriginCredentials(){return this._withCredentials}set crossOriginCredentials(e){this._withCredentials=e}get maxOutstanding(){return this._maxOutstanding}set maxOutstanding(e){this._maxOutstanding=e,this._checkQueue()}get handlesRedirects(){return this._handlesRedirects}get server(){return this._server}set server(e){this._server=e&&e.endsWith("/")?e.substr(0,e.length-1):e}_forceXhr(e,t=!1){this._forcedXhr=e,this._handlesRedirects=!t}_useFetchApi(e){this._fetch=e}setAdditionalHeaders(e){this._additionalHeaders=e||{}}setValidateStatus(e){this._isStatusValid=e}setAdditionalNodeOptions(e){this._additionalNodeOptions=e,a.isNode()&&e&&0===e.maxRedirects&&(this._handlesRedirects=!1)}setRetryOptions(e){this._retryOptions=e}set authenticationAllowList(e){this._authProvider.authenticationAllowList=e}get authenticationAllowList(){return this._authProvider.authenticationAllowList}get authProvider(){return this._authProvider}setApiKey(e){this._authProvider.setApiKey(e)}setTimeout(e){this._timeout=e}setAuthToken(e){e?this._authProvider.setAuthToken(e):this._authProvider.logout()}_onAuthChange(e,t){P("_oAC",e);const r=this._waitingForAuthentication;"unauthenticated"===e?this._waitingForAuthentication=!0:(this._waitingForAuthentication=!1,!1!==r&&this._checkQueue())}resume(){this._waitingForAuthentication=!1,this._authProvider.resume(),this._checkQueue()}setRequestHooks(e,t){this._beforeHook=e,this._afterHook=t}invoke(e="GET",t,r={},n,i={},c){var h;P("invoke",e,t,i);let l=(i=i||{}).autoParseJson||!1,u=i.responseType;if(null!=u&&"void"!==u||(l=null==i.autoParseJson||i.autoParseJson,u=i.responseType="text"),"defaultbuffer"===u&&(u=a.isNode()?i.responseType="buffer":i.responseType="arraybuffer"),"buffer"===u){if("function"!=typeof s)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"No Buffer class")}else if("blob"===u){if("function"!=typeof Blob)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"No Blob class")}else if(u&&"text"!==u&&"json"!==u&&"arraybuffer"!==u&&"stream"!==u)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Unsupported response type: "+u);!a.endPointOf(t)&&this.server&&(t=`${this.server}/${t.startsWith("/")?t.substr(1,t.length):t}`),P("invoke href",t);const p=a.merge({},r,this._additionalHeaders);P("invoke headers",r),p["x-request-id"]=[this._requestIdPrefix,this._serviceGuid,p["x-request-id"],""+this._reqNum++].filter((e=>e)).join("."),i.additionalNodeOptions=Object.assign({},this._additionalNodeOptions||{},i.additionalNodeOptions||{}),i.isStatusValid=i.isStatusValid||this._isStatusValid,i.retryOptions=Object.assign({},this._retryOptions||{},i.retryOptions||{});let _={method:e,href:t,headers:p,token:void 0,body:n,options:i,progress:null===(h=i.reuseRequestDesc)||void 0===h?void 0:h.progress,autoParseJson:l},f=i.reuseRequestDesc;f&&f instanceof d.default&&"props"in f&&(f=f.props),f&&((this._requestQueue.exists(f)||f.id&&null!=this._requestsOutstanding.get(f.id))&&P("requestDesc still in use"),_=a.merge(f,_)),_.id=_.id||a.generateUuid(),c&&("maxRedirects"in i.additionalNodeOptions&&(i.additionalNodeOptions.maxRedirects=0),i.retryOptions&&0!==Object.keys(i.retryOptions).length||(i.retryOptions={disableRetry:!0}));const g=this._getRequestPromise(_);return g.getPromise().then(this._checkQueue.bind(this)).catch(this._checkQueue.bind(this)),a.isAnyFunction(c)&&(P("invoke - cb"),g.then((e=>{P("invoke - cb - resolve ",e.statusCode);try{c(void 0,e,e.response)}catch(e){console.error("[dcx:http] error in success callback",e,e.stack)}})).catch((e=>{P("invoke - cb - reject: ",e);try{c(e,e.response)}catch(e){console.error("[dcx:http] error in failure callback",e,e.stack)}}))),this._checkQueue(),g}_makeRequest(e){P("_makeRequest(): ",e.id);const t=e.options||{},r=(e=>new D(e))(a.pruneUndefined(Object.assign(Object.assign({url:e.href,autoParseJson:e.autoParseJson,descriptor:e},e),{timeout:t.timeout||this._timeout,authProvider:this._authProvider,forceXhr:this._forcedXhr,fetch:this._fetch,responseType:t.responseType,preCallback:this._beforeHook,postCallback:this._afterHook,isStatusValid:t.isStatusValid,additionalNodeOptions:t.additionalNodeOptions,retryOptions:t.retryOptions,isExternalRequest:t.isExternalRequest,preferFetch:this._preferFetch})));return this._requestsOutstanding.addRequest(e.id,r),e.startTime=(new Date).valueOf(),r}_checkQueue(){queueMicrotask(this._checkQueueLoop.bind(this))}_checkQueueLoop(){if(P("_checkQueueLoop()",this._waitingForAuthentication,this.isActive,this._requestsOutstanding.length,"<?",this.maxOutstanding),!this._isActive){P("_cQL inactive");const e=new o.DCXError(o.DCXError.SERVICE_IS_INACTIVE,"Network request in inactive state");this._requestsOutstanding.clear(e),this._requestQueue.clear(e)}let e=!0;for(;e&&!this._waitingForAuthentication&&this._requestsOutstanding.length<this.maxOutstanding&&(e=this._requestQueue.pop(),null!=e);){const t=this._makeRequest(e.descriptor);e.notifySent(t)}P("_cQL done")}_getRequestPromise(e){return P("_getRequestPromise()"),new d.default(((t,r,s)=>{if(!this._isActive)return P("_gRP inactive"),r(new o.DCXError(o.DCXError.SERVICE_IS_INACTIVE,"Network request in inactive state"));s((()=>{P("_gRP cancel 1",e.id),this._requestQueue.remove(e)}));let n=e.noSoonerThen||null;return n&&(n-=a.now(),n=n<0?0:n>w?w:n),delete e.noSoonerThen,this._requestQueue.push(e,n,this._checkQueue.bind(this)).then((n=>(P("_gRP sent",e.id),n.canceled?(P("_gRP reject 1: ",e.id),r(new o.DCXError(o.DCXError.ABORTED,"Request aborted",n.error))):(s((t=>{P("_gRP cancel 2",e.id,t),n.cancel(new o.DCXError(o.DCXError.ABORTED,"Request aborted",t))})),n.getPromise().then((r=>(P("_gRP resolve 1",e.id,r),t(r)))).catch((t=>(P("_gRP reject 2: ",e.id,t),r(t)))))))).catch(r)}),e)}abort(e){e&&e.cancel?e.cancel():this._requestQueue.exists(e)?this._requestQueue.remove(e):this._requestsOutstanding.removeById(e.id)}abortAllWithToken(e){P("abortAllWithToken()"),this._requestsOutstanding.removeAllWithToken(e),this._requestQueue.removeAllWithToken(e)}}const O=R;t.AdobeNetworkHTTPService=O,t.AuthProvider=l,t.HTTPService=R,t.Xhr=g,t.XhrErrorCodes=f,t.createHTTPService=(e,t)=>new R(e,t||{})},796348:(e,t,r)=>{var s=r(640430).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(45276),n=r(200334),i=r(310799),a=r(499164);var d=function(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}(i);function c(e,t,r,s){return new(r||(r=Promise))((function(o,n){function i(e){try{d(s.next(e))}catch(e){n(e)}}function a(e){try{d(s.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,a)}d((s=s.apply(e,t||[])).next())}))}const h=n.newDebug("dcx:http:auth");class l{constructor(e,t,r){this._authToken=e,this._apiKey=t,this._pendingAuth=!1,this._hasBaseRefreshCb=!1,this._authListeners=[],this._persistentListeners=[],this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._authTokenScheme="Bearer",a.validateParams(["authToken",e,"string",!0],["apiKey",t,"string",!0],["refreshCb",r,"function",!0]),r&&(this._hasBaseRefreshCb=!0,this.onChange(((e,t)=>{"unauthenticated"===e&&r.call(null,t)}),!0)),e&&t||(h("init unauthenticated"),this._pendingAuth=!0,setTimeout((()=>{h("after tick",this._pendingAuth),this._pendingAuth&&this.refreshAuth()})))}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}get isNoAuthMode(){return!this._hasBaseRefreshCb}set isNoAuthMode(e){this._hasBaseRefreshCb=!e}get apiKey(){return this._apiKey}get authToken(){return this._authToken}get authTokenScheme(){return this._authTokenScheme}set authTokenScheme(e){this._authTokenScheme=e}setAuthToken(e){h("setAuthToken"),this._authToken=e,this._pendingAuth=!1,this._authChanged("updated")}setApiKey(e){this._apiKey=e}resume(){h("resume()"),this._pendingAuth=!1,this._authChanged("updated")}get pendingAuth(){return this._pendingAuth}onChange(e,t=!1){h("onChange, persistent:",t);const r=this._authListeners.push(e)-1;return t&&this._persistentListeners.push(r),()=>{try{t&&(this._persistentListeners=this._persistentListeners.filter((e=>e!==r))),delete this._authListeners[r]}catch(e){}}}clearListeners(e=!1){if(h("clearListeners, persistent:",e),!0===e)return this._authListeners=[],void(this._persistentListeners=[]);this._authListeners=this._authListeners.map(((e,t)=>{if(this._persistentListeners.includes(t))return e}))}get refreshPromise(){return this._refreshPromise}_authChanged(e){return c(this,void 0,void 0,(function*(){h("authChanged",e),this._pendingAuth="unauthenticated"===e,queueMicrotask((()=>c(this,void 0,void 0,(function*(){const t=[];this._authListeners.map((r=>{if("function"==typeof r){const s=r.call(null,e,this);s&&"object"==typeof s&&s.then&&t.push(s)}})),yield Promise.all(t),"updated"===e&&this._resolveRefresh()}))))}))}_resolveRefresh(){h("_resolveRefresh"),this._refreshResolve&&this._refreshResolve(this.getAuthData()),this._refreshResolve=void 0,this._refreshPromise=void 0}refreshAuth(){return h("refreshAuth"),this._refreshPromise||(this._refreshPromise=new Promise((e=>{this._refreshResolve=e})),this._authChanged("unauthenticated")),this._refreshPromise}getAuthData(){return{authToken:this._authToken,apiKey:this._apiKey}}getAuth(){return c(this,void 0,void 0,(function*(){return Promise.resolve(this.getAuthData())}))}isAuthorizedURL(e){const t=a.getDomainFromURL(e);return this._authenticationAllowList.includes(t)}logout(){h("logout"),this._apiKey=void 0,this._authToken=void 0,!1===this._pendingAuth&&(this._pendingAuth=!0,this._authChanged("unauthenticated"))}applyAuthHeaders(e,t){const r={"x-api-key":void 0,authorization:void 0};return this.isAuthorizedURL(e)&&(null!==t["x-api-key"]&&this.apiKey&&(r["x-api-key"]=this.apiKey),null!==t.authorization&&this.authToken&&(r.authorization=(this.authTokenScheme?`${this.authTokenScheme} `:"")+this.authToken)),a.pruneUndefined(Object.assign(Object.assign({},t),r))}}const u=12e4,p=n.newDebug("dcx:http:xhr");let _;if(_="undefined"!=typeof window?window.XMLHttpRequest:XMLHttpRequest,null==_)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_STATE,"XMLHttpRequest module not found.");const f={NO_ERROR:"",ABORTED:o.ErrorCodes.ABORTED,NETWORK:o.ErrorCodes.NETWORK_ERROR,TIMEOUT:o.ErrorCodes.TIMED_OUT,TOO_MANY_REDIRECTS:o.ErrorCodes.TOO_MANY_REDIRECTS,INSECURE_REDIRECT:o.ErrorCodes.INSECURE_REDIRECT};class g{constructor(e={}){this._autoParseJson=!1,this._bytesReported=0,this._errorCode=f.NO_ERROR,this._isFetchRequest=!1,this._fetchAbort=()=>{},this._preferFetch=!1,this._sent=!1,this.headers={},this.responseType="text",this._progressListeners=[];const{forceXhr:t,preCallback:s,postCallback:n,timeout:i,preferFetch:a}=e;this._preCallback=s,this._postCallback=n,this._timeout=null==i?u:i,this._xhr=t?new t:new _,this._xhr.timeout=this._timeout,this._preferFetch=!0===a,this._fetch=e.fetch?e.fetch:"undefined"!=typeof window&&"fetch"in window&&"function"==typeof window.fetch?window.fetch.bind(window):"undefined"!=typeof self&&"fetch"in self&&"function"==typeof self.fetch?self.fetch.bind(self):void 0!==r.g&&"fetch"in r.g&&"function"==typeof r.g.fetch?r.g.fetch.bind(r.g):void 0,this._parseFetchResponse=this._parseFetchResponse.bind(this),this.onProgress=this.onProgress.bind(this),this._autoParseJson=null==e.autoParseJson||e.autoParseJson,e.additionalNodeOptions&&this._xhr.setNodeOptions&&this._xhr.setNodeOptions(e.additionalNodeOptions),this._promise=new Promise((e=>{this._resolve=e,this._xhr.addEventListener("abort",(()=>{p("aborted",this._errorCode,this._timeout),this._errorCode=this._errorCode||f.ABORTED,this._finalize()})),this._xhr.addEventListener("error",(e=>{switch(p("err",this._errorCode,e,this._xhr.status,this._timeout),this._underlyingError=e,e?e.code:void 0){case"ERR_FR_TOO_MANY_REDIRECTS":this._errorCode=f.TOO_MANY_REDIRECTS;break;case o.AdobeDCXError.INSECURE_REDIRECT:this._errorCode=f.INSECURE_REDIRECT;break;case f.TIMEOUT:this._errorCode=f.TIMEOUT;break;default:this._errorCode=f.NETWORK}this._finalize()})),this._xhr.addEventListener("load",(()=>{p("load"),this._estimatedTotalBytes&&this._estimatedTotalBytes>this._bytesReported&&this._notifyProgressListeners(this._estimatedTotalBytes,this._estimatedTotalBytes,!1),this._finalize()})),this._xhr.addEventListener("timeout",(()=>{p("timeout",this._timeout),this._errorCode=f.TIMEOUT,this._finalize()}))}))}get xhr(){return this._xhr}_parseFetchResponse(e){return c(this,void 0,void 0,(function*(){if(204===e.status)return e;if("chunked"===e.headers.get("transfer-encoding")||parseInt(e.headers.get("content-length")||"0")>0)switch(this.responseType){case"json":a.isJsonContentType(e.headers.get("content-type")||"")&&(this._fetchBodyAsResponseType=yield e.json());break;case"arraybuffer":this._fetchBodyAsResponseType=yield e.arrayBuffer();break;case"blob":this._fetchBodyAsResponseType=yield e.blob();break;case"text":this._fetchBodyAsResponseType=yield e.text();break;case"void":break;case"buffer":case"defaultbuffer":this._fetchBodyAsResponseType=yield e.arrayBuffer().then((e=>new Uint8Array(e)))}return"stream"===this.responseType&&(this._fetchBodyAsResponseType=e.body),e}))}_shouldAutoParseResponse(){const e=this._errorCode===f.NO_ERROR&&this._sent&&!this._isFetchRequest&&"text"===this._xhr.responseType&&this._autoParseJson&&"string"==typeof this._xhr.response&&this._xhr.response.length<102400&&a.isJsonContentType(this.getResponseHeader("content-type"));return p("_shouldAutoParseResponse()",e),e}_fetchWithTimeout(e,t={}){if("function"!=typeof this._fetch)throw new o.DCXError(o.DCXError.UNEXPECTED,"fetch method not found but was invoked");const{timeout:r}=t,s=function(e,t){var r={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(r[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(e);o<s.length;o++)t.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(e,s[o])&&(r[s[o]]=e[s[o]])}return r}(t,["timeout"]);this._isFetchRequest=!0;const n=e=>()=>{this._errorCode=this._errorCode||f.TIMEOUT,e(new o.DCXError(o.DCXError.TIMED_OUT,"request aborted due to timeout")),this._finalize()};if("function"!=typeof AbortController)return new Promise(((t,o)=>c(this,void 0,void 0,(function*(){this._timeoutTimeout=setTimeout(n(o),r);const i=yield this._fetch(e,s);return clearTimeout(this._timeoutTimeout),this._parseFetchResponse(i).then(t)})))).finally((()=>{clearTimeout(this._timeoutTimeout)}));const i=new AbortController;return this._timeoutTimeout=setTimeout(n(i.abort.bind(i)),r),this._fetchAbort=()=>{this._errorCode=this._errorCode||f.ABORTED,i.abort(),this._finalize()},this._fetch(e,Object.assign({signal:i.signal},s)).then(this._parseFetchResponse).finally((()=>{clearTimeout(this._timeoutTimeout)}))}_finalize(){if(p("_finalize",this._xhr.status,this._errorCode),this._shouldAutoParseResponse())try{const e=JSON.parse(this._xhr.response);this._autoParsedResponse=e,this._xhr.responseType="json"}catch(e){}this._postCallback&&this._postCallback(this),this._timeoutTimeout&&clearTimeout(this._timeoutTimeout),this._progressListeners=[],this._resolve(this)}_validateResponseType(e){if("buffer"===e){if("function"!=typeof s)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"No Buffer class")}else if("blob"===e){if("function"!=typeof Blob)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"No Blob class")}else if("text"!==e&&"json"!==e&&"arraybuffer"!==e&&"stream"!==e)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Unsupported response type");return e.toLowerCase()}send(e,t,r,s={},n="text",i={}){if(p("send"),this._sent)throw new Error("Xhr already sent");this.href=e,this.method=t.toUpperCase(),this.body=r,this.body?this._estimatedTotalBytes=this.body.byteLength||this.body.length||this.body.size:this._estimatedTotalBytes=Number.MAX_SAFE_INTEGER;const d=e=>{var t;p(`progress ${e.loaded}/${e.total}`),this._bytesReported=e.loaded,e.lengthComputable?(this._estimatedTotalBytes=e.total,this._notifyProgressListeners(this._bytesReported,null!==(t=this._estimatedTotalBytes)&&void 0!==t?t:1/0,!1)):this._estimatedTotalBytes&&this._estimatedTotalBytes>this._bytesReported&&this._notifyProgressListeners(this._bytesReported,this._estimatedTotalBytes||e.total,!0)};["POST","PUT","PATCH"].includes(this.method)&&this._xhr.upload?this._xhr.upload.onprogress=d:this._xhr.addEventListener("progress",d),this._timeout=i.timeout||this._timeout||u,p("setting timeout",this._timeout),this._xhr.timeout=this._timeout,n&&(n=this._validateResponseType(n),p("responseType: ",n),this.responseType="buffer"===n?"arraybuffer":"stream"===n?"stream":"void"===n?"text":n);const c=a.normalizeHeaders(s);if(this.headers=c,this.href.startsWith("http:")&&null!==this.headers.authorization)throw new o.AdobeDCXError(o.AdobeDCXError.INVALID_PARAMS,"Must not send auth token over unsecured connection");if(this._preCallback&&this._preCallback(this),(this._preferFetch||"stream"===n)&&"function"==typeof this._fetch)return this._xhr.responseType=this.responseType,this._promise=new Promise((e=>{this._resolve=e,this._fetchWithTimeout(this.href,{body:["GET","HEAD"].includes(this.method.toUpperCase())?void 0:r,credentials:i.withCredentials?"include":void 0,headers:c,method:this.method,timeout:this._timeout}).then((e=>{this._fetchResponse=e,this._finalize()})),this._sent=!0})),this._promise;this._xhr.open(this.method,this.href,!0),this._xhr.responseType=this.responseType;for(const[e,t]of Object.entries(c))this._xhr.setRequestHeader(e,t);return null!=i.withCredentials&&(this._xhr.withCredentials=i.withCredentials),null!=r?this._xhr.send(r):this._xhr.send(),this._sent=!0,this._promise}abort(){if(p("abort()"),!this._sent)throw new Error("Cannot abort before sending.");this._isFetchRequest?this._fetchAbort():this._xhr.abort()}getResponseHeader(e){if(!this._sent)throw new Error("Cannot getResponseHeader before sending.");const t=e.toLowerCase(),r=this.getAllResponseHeaders();if(t in r)return r[t]}getAllResponseHeaders(){var e,t;if(!this._sent)throw new Error("Cannot getAllResponseHeaders before sending.");if(this._parsedResponseHeaders)return this._parsedResponseHeaders;const r=this._isFetchRequest?a.objectFromEntries(null!==(t=null===(e=this._fetchResponse)||void 0===e?void 0:e.headers.entries())&&void 0!==t?t:[]):this._xhr.getAllResponseHeaders();return this._parsedResponseHeaders="string"==typeof r?a.parseHeaders(r):a.normalizeHeaders(r),this._parsedResponseHeaders}isError(){if(!this._sent)throw new Error("Cannot check isError before sending.");return this._errorCode!==f.NO_ERROR}isAborted(){if(!this._sent)throw new Error("Cannot check isAborted before sending.");return this._errorCode===f.ABORTED}isTimedOut(){if(!this._sent)throw new Error("Cannot check isTimedOut before sending.");return this._errorCode===f.TIMEOUT}isSent(){return this._sent}getErrorCode(){return this._errorCode}getStatus(){if(!this._sent)throw new Error("Cannot getStatus before sending.");return this._fetchResponse?this._fetchResponse.status:this._xhr.status}getResponse(){var e;if(!this._sent)throw new Error("Cannot getResponse before sending.");return this._response||(this._response={statusCode:this.getStatus(),headers:this.getAllResponseHeaders(),responseType:this._autoParsedResponse?"json":this.responseType,response:this.getResponseData(),message:this._isFetchRequest?(null===(e=this._fetchResponse)||void 0===e?void 0:e.statusText)||"":this._xhr.statusText,xhr:this},this._autoParsedResponse&&(this._response.originalResponseData=this._xhr.response)),this._response}toJSON(){return{statusCode:this.getStatus(),headers:this.getAllResponseHeaders(),responseType:this._autoParsedResponse?"json":this.responseType,response:this.getResponseData(),message:this._xhr.statusText}}getResponseDataAsJSON(){return c(this,void 0,void 0,(function*(){try{if(this._fetchResponse)return yield this._fetchResponse.json();if(this._autoParsedResponse)return this._autoParsedResponse;if("json"===this._xhr.responseType){if("string"==typeof this._xhr.response)return JSON.parse(this._xhr.response);if(null===this.xhr.response&&["application/problem+json","application/json"].includes(this.xhr.getResponseHeader("content-type")))throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected response type");return this.xhr.response}let e=this._xhr.response;if("text"===this._xhr.responseType&&null!==this._xhr.responseText)e=this._xhr.responseText;else if("arraybuffer"===this._xhr.responseType)e=a.arrayBufferToString(this._xhr.response);else{if("blob"===this._xhr.responseType&&(e instanceof Blob||a.isFunction(e.text)))return JSON.parse(yield e.text());"stream"===this.responseType?yield new Promise(((t,r)=>{if(e="","function"==typeof this.xhr.response.on)return this.xhr.response.on("data",(t=>{e+=t})),this.xhr.response.on("end",t),void this.xhr.response.on("error",r);if("string"==typeof this.xhr.response)return t(e=this.xhr.response);throw new o.DCXError(o.DCXError.UNEXPECTED,"Unexpected response type")})):e=this._xhr.responseText?this._xhr.responseText:e}return"string"==typeof e?JSON.parse(e):e}catch(e){throw new o.DCXError(o.DCXError.INVALID_JSON,"Could not parse response as JSON",e,this.toJSON())}}))}getResponseData(){if(!this._sent)throw new Error("Cannot getResponseData before sending.");return this._isFetchRequest&&this._fetchBodyAsResponseType?this._fetchBodyAsResponseType:this._autoParsedResponse||this._xhr.response}onProgress(e){const t=this._progressListeners.push(e)-1;return()=>{try{delete this._progressListeners[t]}catch(e){}}}_notifyProgressListeners(e,t,r){this._progressListeners.map((s=>s&&s.call&&s.call(null,e,t,r)))}}const m=n.newDebug("dcx:http:backoff");function E(e,t,r,s={},i,d={},h=!1){const{disableRetry:l=!1,retryNetworkError:u=!0,responseType:p="text",authCallback:_=null,progressListeners:E=[],initialWait:A=2e3,maxWait:y=32e3,preCallback:D,postCallback:C,preScheduleCallback:I,postScheduleCallback:v,preferRetryAfterHeader:b=!0,pollCodes:T=[],pollHeader:P,pollMethod:w="get"}=d;let{retryCodes:R=[],timeoutAfter:O=72e3}=d;R=h?[...T,...R]:l||a.isReadableStream(r)?[]:d.retryCodes||a.DEFAULT_RETRY_CODES,m("retry codes",R);const k=d.increase||((e,t,r)=>1===e?r:t*t>y?y:t*t);let S=0,N=0,L=!1;const M=a.now();let X,B,x,j,U=a.now(),V=0,H=!1,F=!1;const Y=[];let W;function z(){m("getSnapshot()",L,S,a.now(),U,V);const e=L||null!=X?0:S-(a.now()-U);let t=V;t+=L?a.now()-U:0;const r=(X||a.now())-M;return{count:N,canceled:H,timedOut:F,requests:Y,duration:r,totalWaited:t,requestPending:L,waitingFor:e}}function q(){const e=k(N,S,A);return Math.min(e,y)}function K(e){if(e)return t=>e(t,z())}function G(e){const t=e.getResponseHeader("retry-after");if(b&&t){if(isNaN(t)){const e=Date.parse(t)-Date.now();return m("nextWait from retry-after",e),e<0?q():e}return 1e3*parseInt(e.getResponseHeader("retry-after"))}}function $(l=S){return c(this,void 0,void 0,(function*(){if(V>=O)return m("timed out",V,O),F=!0,B(j);U=a.now(),I&&(yield I(z())),m("retry in ",l),W=setTimeout((()=>{var f;m("retry start"),n.log(`Request: ${t.toUpperCase()} ${e} ${null!==(f=null==s?void 0:s["x-request-id"])&&void 0!==f?f:""}`),L=!0,V+=l,j=new g(Object.assign(Object.assign({},d),{timeout:i,preCallback:K(D),postCallback:K(C)})),Y.push(j),N++;for(const e of E)j.onProgress(e);j.send(e,t,r,s,p).then((i=>c(this,void 0,void 0,(function*(){var d;if(n.log(`Response: ${t.toUpperCase()} ${e} ${null===(d=i.headers)||void 0===d?void 0:d["x-request-id"]} ${i.getStatus()}`),L=!1,!(i.isError()||a.checkRetriable(i.getStatus(),R)||401===i.getStatus()&&null!=_||"string"==typeof P&&null!=T&&a.checkRetriable(i.getStatus(),T)))return X=a.now(),B(i);if(i.isAborted()||H)return X=a.now(),H=!0,B(i);if(!h&&"string"==typeof P&&null!=T&&a.checkRetriable(i.getStatus(),T)){const s=i.getResponseHeader(P.toLowerCase());if(s){h=!0,e=s,t=w,r=void 0,R=[...R,...T],V=0,O*=3;const o=i.getResponseHeader("retry-after");if(b&&o){const e=G(i);if(null!=e)return S=e,$(S)}return $(0)}}if(401===i.getStatus()){if(_){try{s=yield _(e,s)}catch(e){return x(new o.DCXError(o.DCXError.UNAUTHORIZED,"Authentication Failed",i))}return V+=a.now()-U,$(0)}return X=a.now(),x(new o.DCXError(o.DCXError.UNAUTHORIZED,"Authentication Failed",i))}if(a.checkRetriable(i.getStatus(),R)||u&&i.getErrorCode()===o.ErrorCodes.NETWORK_ERROR){const e=i.getResponseHeader("retry-after");if(b&&e){const e=G(i);if(null!=e)return S=e,$(S)}return S=q(),$(S)}return X=a.now(),B(i)}))))}),l),v&&(yield v(z()))}))}const J=new Promise(((e,t)=>{B=e,x=t,$(0)}));return{getPromise:()=>J,cancel:function(){m("cancel()"),H=!0,null!=j&&j.abort(),L||(m("abort"),clearTimeout(W),B({getErrorCode:()=>f.ABORTED}))},onProgress:function(e){if(!E.includes(e))return E.push(e),null!=j?j.onProgress&&j.onProgress(e):void 0},getSnapshot:z}}class A{constructor(e,t,r,s,o="text",n,i,a={}){const{descriptor:d}=a;delete a.descriptor;const{cancel:c,getPromise:h,onProgress:l,getSnapshot:u}=E(e,t,r,s,a.timeout,Object.assign(Object.assign(Object.assign(Object.assign({},a),{responseType:o,authCallback:i}),a.retryOptions),{descriptor:d,forceXhr:a.forceXhr,autoParseJson:a.autoParseJson}));this.onProgress=l,"function"==typeof n&&l(((e,t)=>n("progress",{total:t,sentOrReceived:e}))),this._cancel=c,this._promise=h(),this._getSnapshot=u}getSnapshot(){return this._getSnapshot()}getPromise(){return this._promise}cancel(e){this._cancel(e)}}const y=n.newDebug("dcx:http:req");class D{constructor(e){var t;if(this._pausable=!1,this._listeners={progress:[],cancel:[]},this._isStatusValid=e.isStatusValid||o._defaultStatusValidator,this._isExternalRequest=e.isExternalRequest,this._authProvider=e.authProvider,this._id=e.id,this._descriptor=e.descriptor,e.descriptor&&e.descriptor.progress){const t=e.descriptor.progress;this.on("progress",(({sentOrReceived:e,total:r})=>{t.call(void 0,e,r)}))}const r=this._authProvider.applyAuthHeaders(e.url,a.normalizeHeaders(e.headers||{}));this._isExternalRequest&&D._internalOnlyHeaders.forEach((e=>delete r[e])),this._networkRequest=new A(e.url,e.method,e.body,r,e.responseType,(null===(t=e.descriptor)||void 0===t?void 0:t.progress)?this._emit.bind(this):void 0,this._getAuthCb(),e),this._promise=this._networkRequest.getPromise().then((t=>{const r=t.getErrorCode(),s=r||this._isStatusValid(t.getStatus(),t.getResponse());if(r||!0!==s){if(r===f.ABORTED)throw new o.DCXError(o.DCXError.ABORTED,"Aborted");if(r===f.NETWORK)throw new o.DCXError(o.DCXError.NETWORK_ERROR,"Network error",void 0,t.getResponse());if(r===f.TIMEOUT)throw new o.DCXError(o.DCXError.TIMED_OUT,"Timeout",void 0,t.getResponse());if(s instanceof o.DCXError||s instanceof Error)throw new o.DCXError(s.code||o.DCXError.UNEXPECTED_RESPONSE,s._message||s.message,s.underlyingError,t.getResponse());throw new o.DCXError(o.DCXError.UNEXPECTED_RESPONSE,"Unexpected response",void 0,t.getResponse())}const n=this._networkRequest.getSnapshot().requests;return y("resolve",e.id),Object.assign(Object.assign({},t.getResponse()),{xhr:n[n.length-1]})})).catch((t=>{throw y("reject",e.id),t}))}get id(){return this._id}get descriptor(){return this._descriptor}_getAuthCb(){if(!this._authProvider.isNoAuthMode)return this._authCb.bind(this)}_authCb(e,t){return y("_authCb()"),this._authProvider.isAuthorizedURL(e)?this._authProvider.refreshAuth().then((()=>this._authProvider.applyAuthHeaders(e,t))):Promise.reject(new o.DCXError(o.DCXError.UNAUTHORIZED,"URL is not part of authenticationAllowList.",void 0,void 0,{url:e}))}_emit(e,t){this._listeners[e].map((e=>e.call(null,t)))}getPromise(){return this._promise}cancel(e){return this._networkRequest.cancel(e)}on(e,t){var r;"progress"===e&&0===this._listeners[e].length&&(null===(r=this._networkRequest)||void 0===r||r.onProgress(((t,r)=>this._emit(e,{total:r,sentOrReceived:t})))),this._listeners[e].push(t)}}D._internalOnlyHeaders=["x-request-id","x-api-key","authorization"];const C=n.newDebug("dcx:http:map");class I{constructor(){this._map=new Map}addRequest(e,t){return C("addRequest()",e),this._map.set(e,t),t.getPromise().then((t=>{C("then",e),this._map.delete(e)})).catch((t=>{C("catch",e,t),this._map.delete(e)})),e}get(e){return this._map.get(e)}get length(){return this._map.size}has(e){return this._map.has(e)}removeById(e){const t=this._map.get(e);t&&this.remove(t)}remove(e,t){return e&&e.cancel&&e.cancel(t)}clear(e){this._map.forEach((t=>{this.remove(t,e)})),this._map.clear()}removeAllWithToken(e){this._map.forEach((t=>{t.descriptor.token===e&&this.remove(t)}))}}const v=n.newDebug("dcx:http:q"),b=e=>"head"===e.method.toLowerCase();class T{constructor(){this._queue=[],this._later={},this._headEndPtr=0,this._isPriority=b,this._usePriority=!1}push(e,t,r){return c(this,void 0,void 0,(function*(){let s;const o=new Promise((e=>{s=e}));if("number"!=typeof t||t<=0){const t={descriptor:e,notifySent:e=>s(e),notifyCanceled:this._notifyCanceled(s)};return this._push(t),o}const{id:n}=e,i=setTimeout((()=>{this._ready(n)}),t),a=e=>s(e);return this._later[n]={readyTimeout:i,wait:t,descriptor:e,notifySent:a,notifyCanceled:this._notifyCanceled(s),notifyReady:()=>{r&&r.call(null,{wait:t,descriptor:e,notifySent:a})}},o}))}_notifyCanceled(e){return t=>{if(!t)return e({canceled:!0});e({canceled:!0,error:t})}}_push(e){this._usePriority&&this._isPriority(e.descriptor)?this._queue.splice(this._headEndPtr++,0,e):this._queue.push(e)}remove(e){if(e.id in this._later)return v("remove from later",e.id),this._remove(e.id);const t=this._indexOf(e);return v("remove from q",t),t>=0?this._remove(t):void 0}_remove(e,t){if(v("_remove",e),"string"==typeof e){const r=this._later[e];return r.notifyCanceled.call(null,t),r.readyTimeout&&clearTimeout(r.readyTimeout),void delete this._later[e]}this._queue[e].notifyCanceled.call(null,t),this._queue.splice(e,1),e<this._headEndPtr&&this._headEndPtr--}_indexOf(e){const t=!!e.method,r=t&&this._usePriority&&this._isPriority(e),s=r?this._headEndPtr:this._queue.length,o=r||!t?0:this._headEndPtr;for(let t=o;t<o+s;t++)if(e.id===this._queue[t].descriptor.id)return t;return-1}exists(e){return e.id in this._later||this._indexOf(e)>=0}_ready(e){const t=this._later[e],r=t.notifyReady;delete this._later[e],delete t.notifyReady,delete t.readyTimeout,delete t.wait,this._push(t),"function"==typeof r&&r.call(null)}pop(){const e=this._queue.shift();return this._headEndPtr>0&&this._headEndPtr--,e}get length(){return v("length: ",this._queue.length,Object.keys(this._later).length),this._queue.length+Object.keys(this._later).length}clear(e){for(let t=this._queue.length-1;t>=0;t--)this._remove(t,e);this._queue=[];const t=Object.keys(this._later);for(const r in t){const s=t[r];this._remove(s,e)}this._later={}}removeAllWithToken(e){for(let t=this._queue.length-1;t>=0;t--)this._queue[t].descriptor.token===e&&this._remove(t);const t=Object.keys(this._later);for(const r in t){const s=t[r];this._later[s].descriptor.token===e&&this._remove(s)}}}const P=n.newDebug("dcx:http:service"),w=3e5;class R{constructor(e,t={}){this.name="AdobeHTTPService",this._requestQueue=new T,this._requestsOutstanding=new I,this._authProvider=void 0,this._isActive=!0,this._preferFetch=!1,this._handlesRedirects=!0,this._withCredentials=!1,this._additionalNodeOptions={},this._retryOptions={},this._serviceGuid=a.generateUuid(),this._reqNum=0,this.featureFlags={},e instanceof l||a.isObject(e)&&a.isAnyFunction(e.onChange)?this._authProvider=e:a.isAnyFunction(e)&&(t.useAuthProvider?(this._authProvider=new l(void 0,void 0,e),this._waitingForAuthentication=!0):(this._authProvider=new l(void 0,void 0,(()=>e.call(null,this))),this._waitingForAuthentication=!0)),this._authProvider?this._authProvider.onChange(this._onAuthChange.bind(this)):(this._authProvider=new l,this._authProvider.resume()),this._maxOutstanding=t.maxOutstanding||5,this._withCredentials=t.crossOriginCredentials||!1,this._timeout=null==t.timeout?u:t.timeout,this._preferFetch=!0===t.preferFetch,this._requestIdPrefix=t.requestIdPrefix,t.server&&(this.server=t.server)}get isActive(){return this._isActive}set isActive(e){this._isActive!==e&&(this._isActive=e,e||this._authProvider.logout(),this._checkQueue())}get crossOriginCredentials(){return this._withCredentials}set crossOriginCredentials(e){this._withCredentials=e}get maxOutstanding(){return this._maxOutstanding}set maxOutstanding(e){this._maxOutstanding=e,this._checkQueue()}get handlesRedirects(){return this._handlesRedirects}get server(){return this._server}set server(e){this._server=e&&e.endsWith("/")?e.substr(0,e.length-1):e}_forceXhr(e,t=!1){this._forcedXhr=e,this._handlesRedirects=!t}_useFetchApi(e){this._fetch=e}setAdditionalHeaders(e){this._additionalHeaders=e||{}}setValidateStatus(e){this._isStatusValid=e}setAdditionalNodeOptions(e){this._additionalNodeOptions=e,a.isNode()&&e&&0===e.maxRedirects&&(this._handlesRedirects=!1)}setRetryOptions(e){this._retryOptions=e}set authenticationAllowList(e){this._authProvider.authenticationAllowList=e}get authenticationAllowList(){return this._authProvider.authenticationAllowList}get authProvider(){return this._authProvider}setApiKey(e){this._authProvider.setApiKey(e)}setTimeout(e){this._timeout=e}setAuthToken(e){e?this._authProvider.setAuthToken(e):this._authProvider.logout()}_onAuthChange(e,t){P("_oAC",e);const r=this._waitingForAuthentication;"unauthenticated"===e?this._waitingForAuthentication=!0:(this._waitingForAuthentication=!1,!1!==r&&this._checkQueue())}resume(){this._waitingForAuthentication=!1,this._authProvider.resume(),this._checkQueue()}setRequestHooks(e,t){this._beforeHook=e,this._afterHook=t}invoke(e="GET",t,r={},n,i={},c){var h;P("invoke",e,t,i);let l=(i=i||{}).autoParseJson||!1,u=i.responseType;if(null!=u&&"void"!==u||(l=null==i.autoParseJson||i.autoParseJson,u=i.responseType="text"),"defaultbuffer"===u&&(u=a.isNode()?i.responseType="buffer":i.responseType="arraybuffer"),"buffer"===u){if("function"!=typeof s)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"No Buffer class")}else if("blob"===u){if("function"!=typeof Blob)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"No Blob class")}else if(u&&"text"!==u&&"json"!==u&&"arraybuffer"!==u&&"stream"!==u)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"Unsupported response type: "+u);!a.endPointOf(t)&&this.server&&(t=`${this.server}/${t.startsWith("/")?t.substr(1,t.length):t}`),P("invoke href",t);const p=a.merge({},r,this._additionalHeaders);P("invoke headers",r),p["x-request-id"]=[this._requestIdPrefix,this._serviceGuid,p["x-request-id"],""+this._reqNum++].filter((e=>e)).join("."),i.additionalNodeOptions=Object.assign({},this._additionalNodeOptions||{},i.additionalNodeOptions||{}),i.isStatusValid=i.isStatusValid||this._isStatusValid,i.retryOptions=Object.assign({},this._retryOptions||{},i.retryOptions||{});let _={method:e,href:t,headers:p,token:void 0,body:n,options:i,progress:null===(h=i.reuseRequestDesc)||void 0===h?void 0:h.progress,autoParseJson:l},f=i.reuseRequestDesc;f&&f instanceof d.default&&"props"in f&&(f=f.props),f&&((this._requestQueue.exists(f)||f.id&&null!=this._requestsOutstanding.get(f.id))&&P("requestDesc still in use"),_=a.merge(f,_)),_.id=_.id||a.generateUuid(),c&&("maxRedirects"in i.additionalNodeOptions&&(i.additionalNodeOptions.maxRedirects=0),i.retryOptions&&0!==Object.keys(i.retryOptions).length||(i.retryOptions={disableRetry:!0}));const g=this._getRequestPromise(_);return g.getPromise().then(this._checkQueue.bind(this)).catch(this._checkQueue.bind(this)),a.isAnyFunction(c)&&(P("invoke - cb"),g.then((e=>{P("invoke - cb - resolve ",e.statusCode);try{c(void 0,e,e.response)}catch(e){console.error("[dcx:http] error in success callback",e,e.stack)}})).catch((e=>{P("invoke - cb - reject: ",e);try{c(e,e.response)}catch(e){console.error("[dcx:http] error in failure callback",e,e.stack)}}))),this._checkQueue(),g}_makeRequest(e){P("_makeRequest(): ",e.id);const t=e.options||{},r=(e=>new D(e))(a.pruneUndefined(Object.assign(Object.assign({url:e.href,autoParseJson:e.autoParseJson,descriptor:e},e),{timeout:t.timeout||this._timeout,authProvider:this._authProvider,forceXhr:this._forcedXhr,fetch:this._fetch,responseType:t.responseType,preCallback:this._beforeHook,postCallback:this._afterHook,isStatusValid:t.isStatusValid,additionalNodeOptions:t.additionalNodeOptions,retryOptions:t.retryOptions,isExternalRequest:t.isExternalRequest,preferFetch:this._preferFetch})));return this._requestsOutstanding.addRequest(e.id,r),e.startTime=(new Date).valueOf(),r}_checkQueue(){queueMicrotask(this._checkQueueLoop.bind(this))}_checkQueueLoop(){if(P("_checkQueueLoop()",this._waitingForAuthentication,this.isActive,this._requestsOutstanding.length,"<?",this.maxOutstanding),!this._isActive){P("_cQL inactive");const e=new o.DCXError(o.DCXError.SERVICE_IS_INACTIVE,"Network request in inactive state");this._requestsOutstanding.clear(e),this._requestQueue.clear(e)}let e=!0;for(;e&&!this._waitingForAuthentication&&this._requestsOutstanding.length<this.maxOutstanding&&(e=this._requestQueue.pop(),null!=e);){const t=this._makeRequest(e.descriptor);e.notifySent(t)}P("_cQL done")}_getRequestPromise(e){return P("_getRequestPromise()"),new d.default(((t,r,s)=>{if(!this._isActive)return P("_gRP inactive"),r(new o.DCXError(o.DCXError.SERVICE_IS_INACTIVE,"Network request in inactive state"));s((()=>{P("_gRP cancel 1",e.id),this._requestQueue.remove(e)}));let n=e.noSoonerThen||null;return n&&(n-=a.now(),n=n<0?0:n>w?w:n),delete e.noSoonerThen,this._requestQueue.push(e,n,this._checkQueue.bind(this)).then((n=>(P("_gRP sent",e.id),n.canceled?(P("_gRP reject 1: ",e.id),r(new o.DCXError(o.DCXError.ABORTED,"Request aborted",n.error))):(s((t=>{P("_gRP cancel 2",e.id,t),n.cancel(new o.DCXError(o.DCXError.ABORTED,"Request aborted",t))})),n.getPromise().then((r=>(P("_gRP resolve 1",e.id,r),t(r)))).catch((t=>(P("_gRP reject 2: ",e.id,t),r(t)))))))).catch(r)}),e)}abort(e){e&&e.cancel?e.cancel():this._requestQueue.exists(e)?this._requestQueue.remove(e):this._requestsOutstanding.removeById(e.id)}abortAllWithToken(e){P("abortAllWithToken()"),this._requestsOutstanding.removeAllWithToken(e),this._requestQueue.removeAllWithToken(e)}}const O=R;t.AdobeNetworkHTTPService=O,t.AuthProvider=l,t.HTTPService=R,t.Xhr=g,t.XhrErrorCodes=f,t.createHTTPService=(e,t)=>new R(e,t||{})},971507:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s,o,n,i,a,d=r(617759);function c(e,r,s="css"){var o,n,i;d.validateParams(["data",r,"object"]),d.validateObject(r,"data",["composite","object"],["response","object"],["error","object",!0]);const{component:a,error:c,composite:l,branch:u,derivationType:p,isBlockTransferred:_}=r,f=(null===(o=r.error)||void 0===o?void 0:o.response)||r.response;let g,m=!1;switch(e){case t.AnalyticsEvent.CreateComposite:m=!0,g=t.AnalyticsEventSubCategory.Create;break;case t.AnalyticsEvent.PushComposite:m=!0,g=t.AnalyticsEventSubCategory.Push;break;case t.AnalyticsEvent.PullComposite:m=!0,g=t.AnalyticsEventSubCategory.MinPull;break;case t.AnalyticsEvent.PullCompositeVersion:m=!0,g=t.AnalyticsEventSubCategory.VersionPull;break;case t.AnalyticsEvent.DownloadComponent:case t.AnalyticsEvent.UploadComponent:d.validateParams(["component",a,"object"]),d.validateObject(a,"data.component",["type","string"]),g=e===t.AnalyticsEvent.DownloadComponent?t.AnalyticsEventSubCategory.Download:t.AnalyticsEventSubCategory.Upload;break;default:g=t.AnalyticsEventSubCategory.Unknown}m&&d.validateParams(["branch",u,"object",!0]);const E={"env.com.name":"dcx-js","env.svc.name":s,"env.com.version":"8.14.0","event.request_id":f.headers["x-request-id"],"event.cloud_id":l.assetId,"custom.content.repository_id":l.repositoryId,"event.type":t.AnalyticsEventType.Success,"event.category":t.AnalyticsEventCategory.CompositeXfer,"event.subcategory":g},A=null===(n=null==c?void 0:c.underlyingError)||void 0===n?void 0:n.code,y=null===(i=null==c?void 0:c.underlyingError)||void 0===i?void 0:i.message;return c&&(E["event.error_code"]=c.code,E["event.error_desc"]=c.message,E["dcx.underlying_error_code"]=A,E["dcx.underlying_error_desc"]=y,E["event.type"]=t.AnalyticsEventType.Error),g===t.AnalyticsEventSubCategory.Unknown?h(E):m?(E["dcx.num_total_components"]=null==u?void 0:u.allComponents().length,E["custom.content.xmp_derivation_type"]=p,c&&(E["dcx.root_error_desc"]=y),h(E)):(E["content.mimetype"]=a.type,c&&(E["dcx.block_transferred"]=null!=_&&_,E["content.type"]=a.type,E["content.size"]=a.length,E["dcx.component_rel"]=a.relationship),h(E))}function h(e){const t={};for(const r in e){const s=e[r];d.isUndefined(s)||Array.isArray(s)||d.isObject(s)||(t[r]=s)}return t}t.AnalyticsEventType=void 0,(s=t.AnalyticsEventType||(t.AnalyticsEventType={}))[s.Success=0]="Success",s[s.Error=1]="Error",t.AnalyticsEventCategory=void 0,(o=t.AnalyticsEventCategory||(t.AnalyticsEventCategory={}))[o.CompositeXfer=0]="CompositeXfer",t.AnalyticsEventSubCategory=void 0,(n=t.AnalyticsEventSubCategory||(t.AnalyticsEventSubCategory={}))[n.Push=0]="Push",n[n.MinPull=1]="MinPull",n[n.VersionPull=2]="VersionPull",n[n.Upload=3]="Upload",n[n.Download=4]="Download",n[n.Create=5]="Create",n[n.Unknown=6]="Unknown",t.AnalyticsEvent=void 0,(i=t.AnalyticsEvent||(t.AnalyticsEvent={})).PushComposite="analyticsPush",i.CreateComposite="analyticsCreate",i.PullComposite="analyticsPull",i.PullCompositeVersion="analyticsPullVersion",i.UploadComponent="analyticsUpload",i.DownloadComponent="analyticsDownload",i.All="*",t.LogLevel=void 0,(a=t.LogLevel||(t.LogLevel={}))[a.Deprecated=0]="Deprecated",a[a.Error=1]="Error",a[a.Warn=2]="Warn",a[a.Log=3]="Log",a[a.Debug=4]="Debug";const l={[t.LogLevel.Deprecated]:"error",[t.LogLevel.Error]:"error",[t.LogLevel.Log]:"log",[t.LogLevel.Warn]:"warn",[t.LogLevel.Debug]:"debug"};class u extends d.EventEmitter{constructor(e){super([t.AnalyticsEvent.CreateComposite,t.AnalyticsEvent.UploadComponent,t.AnalyticsEvent.PushComposite,t.AnalyticsEvent.PullComposite,t.AnalyticsEvent.PullCompositeVersion,t.AnalyticsEvent.DownloadComponent]),this._logLevel=t.LogLevel.Warn,this._prevDebugTime=d.now(),this._debugFormatter=(e,t,r,s)=>`[${e} (+${(1e3*(t-r)).toFixed(0)})] ${s.map((e=>"string"==typeof e?e:JSON.stringify(e))).join(" ")}`,this._debugNamespaces=[],this._debugSkips=[],this.suppressDeprecationWarnings=!1,e&&(this._logCallback=e),this._initNamespaces()}get debugNamespaces(){return this._debugNamespaces}get debugSkips(){return this._debugSkips}set logLevel(e){if(!Object.values(t.LogLevel).includes(e))throw new Error(`Invalid LogLevel, must be one of: ${Object.values(t.LogLevel).join(", ")}.`);this._logLevel=e}get logLevel(){return this._logLevel}on(e,r){if(e!==t.AnalyticsEvent.All)return super.on(e,r);const s=Object.values(t.AnalyticsEvent);let o;for(let e=0,t=s.length;e<t;e++){const t=s[e];o=super.on(t,r)}return o}static getInstance(){return null==u._instance&&(u._instance=new u),u._instance}static newLogger(e){return new u(e)}set logCallback(e){this._logCallback=e}get logCallback(){return this._logCallback}_initNamespaces(){d.isNode()?this.setDebugNamespaces(process.env.DCX_DEBUG||""):d.isObject(globalThis)&&d.isObject(globalThis.dcxjs)&&this.setDebugNamespaces(globalThis.dcxjs.debug||""),this._debugNamespaces.length>0&&(this._logLevel=t.LogLevel.Debug)}_log(e,r,s){try{if(e===u.LEVEL_DEPRECATED)!this.suppressDeprecationWarnings&&this._logLevel>=e&&console.warn(...s);else if("function"==typeof this._logCallback&&this._logLevel>=e)this._logCallback.call(void 0,...s);else if(this._logLevel>=e)if(e===t.LogLevel.Debug){if(this._debugEnabled(r)){const e=this._prevDebugTime;this._prevDebugTime=d.now(),(console.debug||console.log)(this._debugFormatter(r,this._prevDebugTime,e,s))}}else console[l[e]](...s.slice(0,-2))}catch(e){}}log(...e){this._log(t.LogLevel.Log,void 0,e)}warn(...e){this._log(t.LogLevel.Warn,void 0,e)}error(...e){this._log(t.LogLevel.Error,void 0,e)}deprecated(...e){this._log(t.LogLevel.Deprecated,void 0,e)}_debugEnabled(e){if("*"===e[e.length-1])return!0;let t,r;for(t=0,r=this._debugSkips.length;t<r;t++)if(this._debugSkips[t].test(e))return!1;for(t=0,r=this._debugNamespaces.length;t<r;t++)if(this._debugNamespaces[t].test(e))return!0;return!1}setDebugFormatter(e){this._debugFormatter=e}setDebugNamespaces(e){let t;this._debugNamespaces=[],this._debugSkips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(t=0;t<s;t++)r[t]&&("-"===(e=r[t].replace(/\*/g,".*?"))[0]?this._debugSkips.push(new RegExp("^"+e.substr(1)+"$")):this._debugNamespaces.push(new RegExp("^"+e+"$")))}Debug(e){return(...r)=>{this._log(t.LogLevel.Debug,e,r)}}}u.LEVEL_DEBUG=t.LogLevel.Debug,u.LEVEL_LOG=t.LogLevel.Log,u.LEVEL_WARN=t.LogLevel.Warn,u.LEVEL_ERROR=t.LogLevel.Error,u.LEVEL_DEPRECATED=t.LogLevel.Deprecated;const p=()=>{const e=_();return void 0!==e._logCallback?e:u.getInstance()},_=()=>{if("object"==typeof globalThis&&"object"==typeof globalThis.dcxjs&&globalThis.dcxjs.logger&&globalThis.dcxjs.logger.getInstance)return globalThis.dcxjs.logger.getInstance();const e=()=>{};return{log:e,warn:e,error:e,deprecated:e,debug:e,newLogger:_}};var f=p();t.AdobeDCXLogger=u,t.default=f,t.emitAnalyticsEvent=(e,t)=>{const r=p(),s=c(e,t);try{r.emit(e,[s])}catch(e){const t=e instanceof Error?e.message:"Unknown Error";r.error("Error in analytics hook: ",t)}},t.getGlobalLogger=_,t.getGlobalOrLocalLogger=p,t.log=(...e)=>{const t=p();e.forEach(t.log.bind(t))},t.makeAnalyticsEvent=c,t.newDebug=e=>p().Debug(e),t.setLogCallback=e=>{p().logCallback=e}},200334:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s,o,n,i,a,d=r(499164);function c(e,r,s="css"){var o,n,i;d.validateParams(["data",r,"object"]),d.validateObject(r,"data",["composite","object"],["response","object"],["error","object",!0]);const{component:a,error:c,composite:l,branch:u,derivationType:p,isBlockTransferred:_}=r,f=(null===(o=r.error)||void 0===o?void 0:o.response)||r.response;let g,m=!1;switch(e){case t.AnalyticsEvent.CreateComposite:m=!0,g=t.AnalyticsEventSubCategory.Create;break;case t.AnalyticsEvent.PushComposite:m=!0,g=t.AnalyticsEventSubCategory.Push;break;case t.AnalyticsEvent.PullComposite:m=!0,g=t.AnalyticsEventSubCategory.MinPull;break;case t.AnalyticsEvent.PullCompositeVersion:m=!0,g=t.AnalyticsEventSubCategory.VersionPull;break;case t.AnalyticsEvent.DownloadComponent:case t.AnalyticsEvent.UploadComponent:d.validateParams(["component",a,"object"]),d.validateObject(a,"data.component",["type","string"]),g=e===t.AnalyticsEvent.DownloadComponent?t.AnalyticsEventSubCategory.Download:t.AnalyticsEventSubCategory.Upload;break;default:g=t.AnalyticsEventSubCategory.Unknown}m&&d.validateParams(["branch",u,"object",!0]);const E={"env.com.name":"dcx-js","env.svc.name":s,"env.com.version":"8.15.0","event.request_id":f.headers["x-request-id"],"event.cloud_id":l.assetId,"custom.content.repository_id":l.repositoryId,"event.type":t.AnalyticsEventType.Success,"event.category":t.AnalyticsEventCategory.CompositeXfer,"event.subcategory":g},A=null===(n=null==c?void 0:c.underlyingError)||void 0===n?void 0:n.code,y=null===(i=null==c?void 0:c.underlyingError)||void 0===i?void 0:i.message;return c&&(E["event.error_code"]=c.code,E["event.error_desc"]=c.message,E["dcx.underlying_error_code"]=A,E["dcx.underlying_error_desc"]=y,E["event.type"]=t.AnalyticsEventType.Error),g===t.AnalyticsEventSubCategory.Unknown?h(E):m?(E["dcx.num_total_components"]=null==u?void 0:u.allComponents().length,E["custom.content.xmp_derivation_type"]=p,c&&(E["dcx.root_error_desc"]=y),h(E)):(E["content.mimetype"]=a.type,c&&(E["dcx.block_transferred"]=null!=_&&_,E["content.type"]=a.type,E["content.size"]=a.length,E["dcx.component_rel"]=a.relationship),h(E))}function h(e){const t={};for(const r in e){const s=e[r];d.isUndefined(s)||Array.isArray(s)||d.isObject(s)||(t[r]=s)}return t}t.AnalyticsEventType=void 0,(s=t.AnalyticsEventType||(t.AnalyticsEventType={}))[s.Success=0]="Success",s[s.Error=1]="Error",t.AnalyticsEventCategory=void 0,(o=t.AnalyticsEventCategory||(t.AnalyticsEventCategory={}))[o.CompositeXfer=0]="CompositeXfer",t.AnalyticsEventSubCategory=void 0,(n=t.AnalyticsEventSubCategory||(t.AnalyticsEventSubCategory={}))[n.Push=0]="Push",n[n.MinPull=1]="MinPull",n[n.VersionPull=2]="VersionPull",n[n.Upload=3]="Upload",n[n.Download=4]="Download",n[n.Create=5]="Create",n[n.Unknown=6]="Unknown",t.AnalyticsEvent=void 0,(i=t.AnalyticsEvent||(t.AnalyticsEvent={})).PushComposite="analyticsPush",i.CreateComposite="analyticsCreate",i.PullComposite="analyticsPull",i.PullCompositeVersion="analyticsPullVersion",i.UploadComponent="analyticsUpload",i.DownloadComponent="analyticsDownload",i.All="*",t.LogLevel=void 0,(a=t.LogLevel||(t.LogLevel={}))[a.Deprecated=0]="Deprecated",a[a.Error=1]="Error",a[a.Warn=2]="Warn",a[a.Log=3]="Log",a[a.Debug=4]="Debug";const l={[t.LogLevel.Deprecated]:"error",[t.LogLevel.Error]:"error",[t.LogLevel.Log]:"log",[t.LogLevel.Warn]:"warn",[t.LogLevel.Debug]:"debug"};class u extends d.EventEmitter{constructor(e){super([t.AnalyticsEvent.CreateComposite,t.AnalyticsEvent.UploadComponent,t.AnalyticsEvent.PushComposite,t.AnalyticsEvent.PullComposite,t.AnalyticsEvent.PullCompositeVersion,t.AnalyticsEvent.DownloadComponent]),this._logLevel=t.LogLevel.Warn,this._prevDebugTime=d.now(),this._debugFormatter=(e,t,r,s)=>`[${e} (+${(1e3*(t-r)).toFixed(0)})] ${s.map((e=>"string"==typeof e?e:JSON.stringify(e))).join(" ")}`,this._debugNamespaces=[],this._debugSkips=[],this.suppressDeprecationWarnings=!1,e&&(this._logCallback=e),this._initNamespaces()}get debugNamespaces(){return this._debugNamespaces}get debugSkips(){return this._debugSkips}set logLevel(e){if(!Object.values(t.LogLevel).includes(e))throw new Error(`Invalid LogLevel, must be one of: ${Object.values(t.LogLevel).join(", ")}.`);this._logLevel=e}get logLevel(){return this._logLevel}on(e,r){if(e!==t.AnalyticsEvent.All)return super.on(e,r);const s=Object.values(t.AnalyticsEvent);let o;for(let e=0,t=s.length;e<t;e++){const t=s[e];o=super.on(t,r)}return o}static getInstance(){return null==u._instance&&(u._instance=new u),u._instance}static newLogger(e){return new u(e)}set logCallback(e){this._logCallback=e}get logCallback(){return this._logCallback}_initNamespaces(){d.isNode()?this.setDebugNamespaces(process.env.DCX_DEBUG||""):d.isObject(globalThis)&&d.isObject(globalThis.dcxjs)&&this.setDebugNamespaces(globalThis.dcxjs.debug||""),this._debugNamespaces.length>0&&(this._logLevel=t.LogLevel.Debug)}_log(e,r,s){try{if(e===u.LEVEL_DEPRECATED)!this.suppressDeprecationWarnings&&this._logLevel>=e&&console.warn(...s);else if("function"==typeof this._logCallback&&this._logLevel>=e)this._logCallback.call(void 0,...s);else if(this._logLevel>=e)if(e===t.LogLevel.Debug){if(this._debugEnabled(r)){const e=this._prevDebugTime;this._prevDebugTime=d.now(),(console.debug||console.log)(this._debugFormatter(r,this._prevDebugTime,e,s))}}else console[l[e]](...s.slice(0,-2))}catch(e){}}log(...e){this._log(t.LogLevel.Log,void 0,e)}warn(...e){this._log(t.LogLevel.Warn,void 0,e)}error(...e){this._log(t.LogLevel.Error,void 0,e)}deprecated(...e){this._log(t.LogLevel.Deprecated,void 0,e)}_debugEnabled(e){if("*"===e[e.length-1])return!0;let t,r;for(t=0,r=this._debugSkips.length;t<r;t++)if(this._debugSkips[t].test(e))return!1;for(t=0,r=this._debugNamespaces.length;t<r;t++)if(this._debugNamespaces[t].test(e))return!0;return!1}setDebugFormatter(e){this._debugFormatter=e}setDebugNamespaces(e){let t;this._debugNamespaces=[],this._debugSkips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),s=r.length;for(t=0;t<s;t++)r[t]&&("-"===(e=r[t].replace(/\*/g,".*?"))[0]?this._debugSkips.push(new RegExp("^"+e.substr(1)+"$")):this._debugNamespaces.push(new RegExp("^"+e+"$")))}Debug(e){return(...r)=>{this._log(t.LogLevel.Debug,e,r)}}}u.LEVEL_DEBUG=t.LogLevel.Debug,u.LEVEL_LOG=t.LogLevel.Log,u.LEVEL_WARN=t.LogLevel.Warn,u.LEVEL_ERROR=t.LogLevel.Error,u.LEVEL_DEPRECATED=t.LogLevel.Deprecated;const p=()=>{const e=_();return void 0!==e._logCallback?e:u.getInstance()},_=()=>{if("object"==typeof globalThis&&"object"==typeof globalThis.dcxjs&&globalThis.dcxjs.logger&&globalThis.dcxjs.logger.getInstance)return globalThis.dcxjs.logger.getInstance();const e=()=>{};return{log:e,warn:e,error:e,deprecated:e,debug:e,newLogger:_}};var f=p();t.AdobeDCXLogger=u,t.default=f,t.emitAnalyticsEvent=(e,t)=>{const r=p(),s=c(e,t);try{r.emit(e,[s])}catch(e){const t=e instanceof Error?e.message:"Unknown Error";r.error("Error in analytics hook: ",t)}},t.getGlobalLogger=_,t.getGlobalOrLocalLogger=p,t.log=(...e)=>{const t=p();e.forEach(t.log.bind(t))},t.makeAnalyticsEvent=c,t.newDebug=e=>p().Debug(e),t.setLogCallback=e=>{p().logCallback=e}},120084:(e,t,r)=>{var s=void 0!==r.g?r.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function o(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}var i=o,a=n;function d(e){if(i===setTimeout)return setTimeout(e,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}"function"==typeof s.setTimeout&&(i=setTimeout),"function"==typeof s.clearTimeout&&(a=clearTimeout);var c,h=[],l=!1,u=-1;function p(){l&&c&&(l=!1,c.length?h=c.concat(h):u=-1,h.length&&_())}function _(){if(!l){var e=d(p);l=!0;for(var t=h.length;t;){for(c=h,h=[];++u<t;)c&&c[u].run();u=-1,t=h.length}c=null,l=!1,function(e){if(a===clearTimeout)return clearTimeout(e);if((a===n||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{a(e)}catch(t){try{return a.call(null,e)}catch(t){return a.call(this,e)}}}(e)}}function f(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];h.push(new g(e,t)),1!==h.length||l||d(_)}function g(e,t){this.fun=e,this.array=t}function m(){}g.prototype.run=function(){this.fun.apply(null,this.array)};var E=m,A=m,y=m,D=m,C=m,I=m,v=m,b=s.performance||{},T=b.now||b.mozNow||b.msNow||b.oNow||b.webkitNow||function(){return(new Date).getTime()},P=new Date,w={nextTick:f,title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:E,addListener:A,once:y,off:D,removeListener:C,removeAllListeners:I,emit:v,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*T.call(b),r=Math.floor(t),s=Math.floor(t%1*1e9);return e&&(r-=e[0],(s-=e[1])<0&&(r--,s+=1e9)),[r,s]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-P)/1e3}},R="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==r.g?r.g:"undefined"!=typeof self?self:{};var O,k,S=(O=function(e,t){e.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},r=0,s=void 0,o=void 0,n=function(e,t){u[r]=e,u[r+1]=t,2===(r+=2)&&(o?o(p):_())};var i="undefined"!=typeof window?window:void 0,a=i||{},d=a.MutationObserver||a.WebKitMutationObserver,c="undefined"==typeof self&&void 0!==w&&"[object process]"==={}.toString.call(w),h="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function l(){var e=setTimeout;return function(){return e(p,1)}}var u=new Array(1e3);function p(){for(var e=0;e<r;e+=2)(0,u[e])(u[e+1]),u[e]=void 0,u[e+1]=void 0;r=0}var _=void 0;function g(e,t){var r=this,s=new this.constructor(A);void 0===s[E]&&S(s);var o=r._state;if(o){var i=arguments[o-1];n((function(){return O(o,s,i,r._result)}))}else T(r,s,e,t);return s}function m(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(A);return C(t,e),t}_=c?function(){return f(p)}:d?function(){var e=0,t=new d(p),r=document.createTextNode("");return t.observe(r,{characterData:!0}),function(){r.data=e=++e%2}}():h?function(){var e=new MessageChannel;return e.port1.onmessage=p,function(){return e.port2.postMessage(0)}}():void 0===i?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(p)}:l()}catch(e){return l()}}():l();var E=Math.random().toString(36).substring(2);function A(){}var y=void 0;function D(t,r,s){r.constructor===t.constructor&&s===g&&r.constructor.resolve===m?function(e,t){1===t._state?v(e,t._result):2===t._state?b(e,t._result):T(t,void 0,(function(t){return C(e,t)}),(function(t){return b(e,t)}))}(t,r):void 0===s?v(t,r):e(s)?function(e,t,r){n((function(e){var s=!1,o=function(e,t,r,s){try{e.call(t,r,s)}catch(e){return e}}(r,t,(function(r){s||(s=!0,t!==r?C(e,r):v(e,r))}),(function(t){s||(s=!0,b(e,t))}),e._label);!s&&o&&(s=!0,b(e,o))}),e)}(t,r,s):v(t,r)}function C(e,t){if(e===t)b(e,new TypeError("You cannot resolve a promise with itself"));else if(function(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}(t)){var r=void 0;try{r=t.then}catch(t){return void b(e,t)}D(e,t,r)}else v(e,t)}function I(e){e._onerror&&e._onerror(e._result),P(e)}function v(e,t){e._state===y&&(e._result=t,e._state=1,0!==e._subscribers.length&&n(P,e))}function b(e,t){e._state===y&&(e._state=2,e._result=t,n(I,e))}function T(e,t,r,s){var o=e._subscribers,i=o.length;e._onerror=null,o[i]=t,o[i+1]=r,o[i+2]=s,0===i&&e._state&&n(P,e)}function P(e){var t=e._subscribers,r=e._state;if(0!==t.length){for(var s=void 0,o=void 0,n=e._result,i=0;i<t.length;i+=3)s=t[i],o=t[i+r],s?O(r,s,o,n):o(n);e._subscribers.length=0}}function O(t,r,s,o){var n=e(s),i=void 0,a=void 0,d=!0;if(n){try{i=s(o)}catch(t){d=!1,a=t}if(r===i)return void b(r,new TypeError("A promises callback cannot return that same promise."))}else i=o;r._state!==y||(n&&d?C(r,i):!1===d?b(r,a):1===t?v(r,i):2===t&&b(r,i))}var k=0;function S(e){e[E]=k++,e._state=void 0,e._result=void 0,e._subscribers=[]}var N=function(){function e(e,r){this._instanceConstructor=e,this.promise=new e(A),this.promise[E]||S(this.promise),t(r)?(this.length=r.length,this._remaining=r.length,this._result=new Array(this.length),0===this.length?v(this.promise,this._result):(this.length=this.length||0,this._enumerate(r),0===this._remaining&&v(this.promise,this._result))):b(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===y&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var r=this._instanceConstructor,s=r.resolve;if(s===m){var o=void 0,n=void 0,i=!1;try{o=e.then}catch(e){i=!0,n=e}if(o===g&&e._state!==y)this._settledAt(e._state,t,e._result);else if("function"!=typeof o)this._remaining--,this._result[t]=e;else if(r===L){var a=new r(A);i?b(a,n):D(a,e,o),this._willSettleAt(a,t)}else this._willSettleAt(new r((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,r){var s=this.promise;s._state===y&&(this._remaining--,2===e?b(s,r):this._result[t]=r),0===this._remaining&&v(s,this._result)},e.prototype._willSettleAt=function(e,t){var r=this;T(e,void 0,(function(e){return r._settledAt(1,t,e)}),(function(e){return r._settledAt(2,t,e)}))},e}();var L=function(){function t(e){this[E]=k++,this._result=this._state=void 0,this._subscribers=[],A!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){C(e,t)}),(function(t){b(e,t)}))}catch(t){b(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var r=this,s=r.constructor;return e(t)?r.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):r.then(t,t)},t}();return L.prototype.then=g,L.all=function(e){return new N(this,e).promise},L.race=function(e){var r=this;return t(e)?new r((function(t,s){for(var o=e.length,n=0;n<o;n++)r.resolve(e[n]).then(t,s)})):new r((function(e,t){return t(new TypeError("You must pass an array to race."))}))},L.resolve=m,L.reject=function(e){var t=new this(A);return b(t,e),t},L._setScheduler=function(e){o=e},L._setAsap=function(e){n=e},L._asap=n,L.polyfill=function(){var e=void 0;if(void 0!==R)e=R;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var r=null;try{r=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===r&&!t.cast)return}e.Promise=L},L.Promise=L,L}()},O(k={path:undefined,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&k.path)}},k.exports),k.exports);S.polyfill(),String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return this.substr(t||0,e.length)===e})},683016:(e,t,r)=>{var s=void 0!==r.g?r.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function o(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}var i=o,a=n;function d(e){if(i===setTimeout)return setTimeout(e,0);if((i===o||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}"function"==typeof s.setTimeout&&(i=setTimeout),"function"==typeof s.clearTimeout&&(a=clearTimeout);var c,h=[],l=!1,u=-1;function p(){l&&c&&(l=!1,c.length?h=c.concat(h):u=-1,h.length&&_())}function _(){if(!l){var e=d(p);l=!0;for(var t=h.length;t;){for(c=h,h=[];++u<t;)c&&c[u].run();u=-1,t=h.length}c=null,l=!1,function(e){if(a===clearTimeout)return clearTimeout(e);if((a===n||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{a(e)}catch(t){try{return a.call(null,e)}catch(t){return a.call(this,e)}}}(e)}}function f(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];h.push(new g(e,t)),1!==h.length||l||d(_)}function g(e,t){this.fun=e,this.array=t}function m(){}g.prototype.run=function(){this.fun.apply(null,this.array)};var E=m,A=m,y=m,D=m,C=m,I=m,v=m,b=s.performance||{},T=b.now||b.mozNow||b.msNow||b.oNow||b.webkitNow||function(){return(new Date).getTime()},P=new Date,w={nextTick:f,title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:E,addListener:A,once:y,off:D,removeListener:C,removeAllListeners:I,emit:v,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*T.call(b),r=Math.floor(t),s=Math.floor(t%1*1e9);return e&&(r-=e[0],(s-=e[1])<0&&(r--,s+=1e9)),[r,s]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-P)/1e3}},R="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==r.g?r.g:"undefined"!=typeof self?self:{};var O,k,S=(O=function(e,t){e.exports=function(){function e(e){return"function"==typeof e}var t=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},r=0,s=void 0,o=void 0,n=function(e,t){u[r]=e,u[r+1]=t,2===(r+=2)&&(o?o(p):_())};var i="undefined"!=typeof window?window:void 0,a=i||{},d=a.MutationObserver||a.WebKitMutationObserver,c="undefined"==typeof self&&void 0!==w&&"[object process]"==={}.toString.call(w),h="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel;function l(){var e=setTimeout;return function(){return e(p,1)}}var u=new Array(1e3);function p(){for(var e=0;e<r;e+=2)(0,u[e])(u[e+1]),u[e]=void 0,u[e+1]=void 0;r=0}var _=void 0;function g(e,t){var r=this,s=new this.constructor(A);void 0===s[E]&&S(s);var o=r._state;if(o){var i=arguments[o-1];n((function(){return O(o,s,i,r._result)}))}else T(r,s,e,t);return s}function m(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(A);return C(t,e),t}_=c?function(){return f(p)}:d?function(){var e=0,t=new d(p),r=document.createTextNode("");return t.observe(r,{characterData:!0}),function(){r.data=e=++e%2}}():h?function(){var e=new MessageChannel;return e.port1.onmessage=p,function(){return e.port2.postMessage(0)}}():void 0===i?function(){try{var e=Function("return this")().require("vertx");return void 0!==(s=e.runOnLoop||e.runOnContext)?function(){s(p)}:l()}catch(e){return l()}}():l();var E=Math.random().toString(36).substring(2);function A(){}var y=void 0;function D(t,r,s){r.constructor===t.constructor&&s===g&&r.constructor.resolve===m?function(e,t){1===t._state?v(e,t._result):2===t._state?b(e,t._result):T(t,void 0,(function(t){return C(e,t)}),(function(t){return b(e,t)}))}(t,r):void 0===s?v(t,r):e(s)?function(e,t,r){n((function(e){var s=!1,o=function(e,t,r,s){try{e.call(t,r,s)}catch(e){return e}}(r,t,(function(r){s||(s=!0,t!==r?C(e,r):v(e,r))}),(function(t){s||(s=!0,b(e,t))}),e._label);!s&&o&&(s=!0,b(e,o))}),e)}(t,r,s):v(t,r)}function C(e,t){if(e===t)b(e,new TypeError("You cannot resolve a promise with itself"));else if(function(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}(t)){var r=void 0;try{r=t.then}catch(t){return void b(e,t)}D(e,t,r)}else v(e,t)}function I(e){e._onerror&&e._onerror(e._result),P(e)}function v(e,t){e._state===y&&(e._result=t,e._state=1,0!==e._subscribers.length&&n(P,e))}function b(e,t){e._state===y&&(e._state=2,e._result=t,n(I,e))}function T(e,t,r,s){var o=e._subscribers,i=o.length;e._onerror=null,o[i]=t,o[i+1]=r,o[i+2]=s,0===i&&e._state&&n(P,e)}function P(e){var t=e._subscribers,r=e._state;if(0!==t.length){for(var s=void 0,o=void 0,n=e._result,i=0;i<t.length;i+=3)s=t[i],o=t[i+r],s?O(r,s,o,n):o(n);e._subscribers.length=0}}function O(t,r,s,o){var n=e(s),i=void 0,a=void 0,d=!0;if(n){try{i=s(o)}catch(t){d=!1,a=t}if(r===i)return void b(r,new TypeError("A promises callback cannot return that same promise."))}else i=o;r._state!==y||(n&&d?C(r,i):!1===d?b(r,a):1===t?v(r,i):2===t&&b(r,i))}var k=0;function S(e){e[E]=k++,e._state=void 0,e._result=void 0,e._subscribers=[]}var N=function(){function e(e,r){this._instanceConstructor=e,this.promise=new e(A),this.promise[E]||S(this.promise),t(r)?(this.length=r.length,this._remaining=r.length,this._result=new Array(this.length),0===this.length?v(this.promise,this._result):(this.length=this.length||0,this._enumerate(r),0===this._remaining&&v(this.promise,this._result))):b(this.promise,new Error("Array Methods must be provided an Array"))}return e.prototype._enumerate=function(e){for(var t=0;this._state===y&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var r=this._instanceConstructor,s=r.resolve;if(s===m){var o=void 0,n=void 0,i=!1;try{o=e.then}catch(e){i=!0,n=e}if(o===g&&e._state!==y)this._settledAt(e._state,t,e._result);else if("function"!=typeof o)this._remaining--,this._result[t]=e;else if(r===L){var a=new r(A);i?b(a,n):D(a,e,o),this._willSettleAt(a,t)}else this._willSettleAt(new r((function(t){return t(e)})),t)}else this._willSettleAt(s(e),t)},e.prototype._settledAt=function(e,t,r){var s=this.promise;s._state===y&&(this._remaining--,2===e?b(s,r):this._result[t]=r),0===this._remaining&&v(s,this._result)},e.prototype._willSettleAt=function(e,t){var r=this;T(e,void 0,(function(e){return r._settledAt(1,t,e)}),(function(e){return r._settledAt(2,t,e)}))},e}();var L=function(){function t(e){this[E]=k++,this._result=this._state=void 0,this._subscribers=[],A!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof t?function(e,t){try{t((function(t){C(e,t)}),(function(t){b(e,t)}))}catch(t){b(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}return t.prototype.catch=function(e){return this.then(null,e)},t.prototype.finally=function(t){var r=this,s=r.constructor;return e(t)?r.then((function(e){return s.resolve(t()).then((function(){return e}))}),(function(e){return s.resolve(t()).then((function(){throw e}))})):r.then(t,t)},t}();return L.prototype.then=g,L.all=function(e){return new N(this,e).promise},L.race=function(e){var r=this;return t(e)?new r((function(t,s){for(var o=e.length,n=0;n<o;n++)r.resolve(e[n]).then(t,s)})):new r((function(e,t){return t(new TypeError("You must pass an array to race."))}))},L.resolve=m,L.reject=function(e){var t=new this(A);return b(t,e),t},L._setScheduler=function(e){o=e},L._setAsap=function(e){n=e},L._asap=n,L.polyfill=function(){var e=void 0;if(void 0!==R)e=R;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var r=null;try{r=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===r&&!t.cast)return}e.Promise=L},L.Promise=L,L}()},O(k={path:undefined,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&k.path)}},k.exports),k.exports);S.polyfill(),String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return this.substr(t||0,e.length)===e})},294462:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(617759);const o=e=>"[object Function]"===toString.call(e);class n{constructor(e,t){return this._promise=null,this._props={},this._registeredProps=[],this._handlers={cancel:[]},this._done=!1,this._canceled=!1,this._internalKeys=[],this.name="AdobePromise",this._internalKeys=[...Object.keys(this),...Object.keys(Object.getOwnPropertyDescriptors(Object.getPrototypeOf(this))),"_cancelReason"],t&&"object"==typeof t&&this._setProps(t),this._promise=new Promise(((t,r)=>e.call(this,(e=>{this._done||(this._done=!0,t(e))}),(e=>{this._done||(this._done=!0,r(e))}),this._registerCancelHandler.bind(this)))),new Proxy(this,{set:function(e,t,r){if(e._internalKeys.includes(t)){if(!["_promise","_canceled","_cancelReason","_props","_registeredProps"].includes(t))throw new Error("Cannot overwrite internal AdobePromise property.");e[t]=r}else e._registeredProps.includes(t)||e._registeredProps.push(t),e.props[t]=r;return!0},get:function(e,t){return"symbol"==typeof t||e._internalKeys.includes(t)?e[t]:e.props[t]}})}get[Symbol.toStringTag](){return this.name}static reject(e,t){return new i(((t,r)=>Promise.reject(e).catch((e=>{r&&r(e)}))),t)}static resolve(e,t){return new i((t=>{s.isObject(e)&&o(e.then)?e.then((e=>{t(e)})):t(e)}),t)}static allSettled(e,t){return 0===e.length?i.resolve([],t):new i((t=>{const r=[];e.map(((s,o)=>{s.then((e=>{r[o]={status:"fulfilled",value:e}})).catch((e=>{r[o]={status:"rejected",reason:e}})).then((()=>{r.filter((e=>!!e)).length===e.length&&t(r)}))}))}),t)}get canceled(){return this._canceled}getPromise(){return this._promise}_resolveOrReject(e,t){return this._promise.then((r=>this._canceled?t&&t(this._cancelReason):e(r))).catch((e=>t&&t(this._cancelReason||e)))}then(e,t){if(null==e&&null==t)return this;const r=new i(((e,t,r)=>(r&&r((e=>{this.cancel.call(this,e),t&&t(e)})),this._resolveOrReject.call(this,e,t))),this._props);return r._promise=r.getPromise().then((t=>{const s=e&&e(t);if(s instanceof i){const e=s;this.onCancel((t=>e.cancel(t)));for(const t in this.props)null==e.props[t]&&(e.props[t]=this.props[t]);e._setProps(e.props),this._setProps(e.props),r._setProps(e.props)}return s})).catch(t),r}parallel(e,t){return this._promise.then(e,t)}catch(e){return this._promise=this._promise.catch(e),this}finally(e){return this._promise=this._promise.finally(e),this}cancel(e){this._canceled||(this._canceled=!0,this._cancelReason=e,this._callHandlers("cancel",e||new Error("Aborted")))}abort(e){this.cancel(e)}onCancel(e){o(e)&&this._registerCancelHandler(e)}get props(){return this._props}_setProps(e){if(this._props===e)return;this._props=e;const t=[],r=Object.getOwnPropertyDescriptors(i),s=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(e));if(s.constructor.value!==Object)for(const o in s){if(o in r||o in this&&!this._registeredProps.includes(o))continue;t.push(o);const n=s[o],i=Object.assign({},n);delete i.get,delete i.set,(n.get||n.set)&&(delete i.value,delete i.writable,n.get&&(i.get=n.get.bind(e)),n.set&&(i.set=n.set.bind(e))),Object.defineProperty(this,o,i)}for(const s of Object.keys(e))t.push(s),s in r||s in this&&!this._registeredProps.includes(s)||Object.defineProperty(this,s,{get:()=>this._props[s],set:e=>{this._props[s]=e},configurable:!0});return this._registeredProps=t,this}_registerCancelHandler(e){this._handlers.cancel.push(e)}_callHandlers(e,t){this._handlers[e].map((e=>e&&e(t)))}_destroy(){this._handlers.cancel=[]}}const i=n,a=i;t.AdobePromise=a,t.default=i},310799:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(499164);const o=e=>"[object Function]"===toString.call(e);class n{constructor(e,t){return this._promise=null,this._props={},this._registeredProps=[],this._handlers={cancel:[]},this._done=!1,this._canceled=!1,this._internalKeys=[],this.name="AdobePromise",this._internalKeys=[...Object.keys(this),...Object.keys(Object.getOwnPropertyDescriptors(Object.getPrototypeOf(this))),"_cancelReason"],t&&"object"==typeof t&&this._setProps(t),this._promise=new Promise(((t,r)=>e.call(this,(e=>{this._done||(this._done=!0,t(e))}),(e=>{this._done||(this._done=!0,r(e))}),this._registerCancelHandler.bind(this)))),new Proxy(this,{set:function(e,t,r){if(e._internalKeys.includes(t)){if(!["_promise","_canceled","_cancelReason","_props","_registeredProps"].includes(t))throw new Error("Cannot overwrite internal AdobePromise property.");e[t]=r}else e._registeredProps.includes(t)||e._registeredProps.push(t),e.props[t]=r;return!0},get:function(e,t){return"symbol"==typeof t||e._internalKeys.includes(t)?e[t]:e.props[t]}})}get[Symbol.toStringTag](){return this.name}static reject(e,t){return new i(((t,r)=>Promise.reject(e).catch((e=>{r&&r(e)}))),t)}static resolve(e,t){return new i((t=>{s.isObject(e)&&o(e.then)?e.then((e=>{t(e)})):t(e)}),t)}static allSettled(e,t){return 0===e.length?i.resolve([],t):new i((t=>{const r=[];e.map(((s,o)=>{s.then((e=>{r[o]={status:"fulfilled",value:e}})).catch((e=>{r[o]={status:"rejected",reason:e}})).then((()=>{r.filter((e=>!!e)).length===e.length&&t(r)}))}))}),t)}get canceled(){return this._canceled}getPromise(){return this._promise}_resolveOrReject(e,t){return this._promise.then((r=>this._canceled?t&&t(this._cancelReason):e(r))).catch((e=>t&&t(this._cancelReason||e)))}then(e,t){if(null==e&&null==t)return this;const r=new i(((e,t,r)=>(r&&r((e=>{this.cancel.call(this,e),t&&t(e)})),this._resolveOrReject.call(this,e,t))),this._props);return r._promise=r.getPromise().then((t=>{const s=e&&e(t);if(s instanceof i){const e=s;this.onCancel((t=>e.cancel(t)));for(const t in this.props)null==e.props[t]&&(e.props[t]=this.props[t]);e._setProps(e.props),this._setProps(e.props),r._setProps(e.props)}return s})).catch(t),r}parallel(e,t){return this._promise.then(e,t)}catch(e){return this._promise=this._promise.catch(e),this}finally(e){return this._promise=this._promise.finally(e),this}cancel(e){this._canceled||(this._canceled=!0,this._cancelReason=e,this._callHandlers("cancel",e||new Error("Aborted")))}abort(e){this.cancel(e)}onCancel(e){o(e)&&this._registerCancelHandler(e)}get props(){return this._props}_setProps(e){if(this._props===e)return;this._props=e;const t=[],r=Object.getOwnPropertyDescriptors(i),s=Object.getOwnPropertyDescriptors(Object.getPrototypeOf(e));if(s.constructor.value!==Object)for(const o in s){if(o in r||o in this&&!this._registeredProps.includes(o))continue;t.push(o);const n=s[o],i=Object.assign({},n);delete i.get,delete i.set,(n.get||n.set)&&(delete i.value,delete i.writable,n.get&&(i.get=n.get.bind(e)),n.set&&(i.set=n.set.bind(e))),Object.defineProperty(this,o,i)}for(const s of Object.keys(e))t.push(s),s in r||s in this&&!this._registeredProps.includes(s)||Object.defineProperty(this,s,{get:()=>this._props[s],set:e=>{this._props[s]=e},configurable:!0});return this._registeredProps=t,this}_registerCancelHandler(e){this._handlers.cancel.push(e)}_callHandlers(e,t){this._handlers[e].map((e=>e&&e(t)))}_destroy(){this._handlers.cancel=[]}}const i=n,a=i;t.AdobePromise=a,t.default=i},137158:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(395768),o=r(154118),n=r(971507),i=r(294462),a=r(617759);function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=d(o),h=d(i);class l{constructor(e,t,r,s,o,n){this.id=e,this.etag=t,this.version=r,this.md5=s,this.length=o,this.type=n}}class u{constructor(e,t,r){this.compositeId=e,this.compositeAssetId=t,this.repositoryId=r,this.records={}}addUploadRecord(e,t){a.validateParams(["componentId",e,"string"],["record",t,"object"]),this.records[e]=t}getComponentDescriptor(e){const t=this._checkRAPIComponentParams(e);return JSON.stringify(function(e,t,r,s){try{a.validateObject(s,"UploadRecord",["id","string"],["version","string"],["length","number"],["etag","string"],["type","string"])}catch(e){throw new o.DCXError(o.DCXError.INVALID_STATE,"Invalid record data",e)}const n={versionId:"0",componentId:s.id,cloudAssetId:e,compositeId:t,repositoryId:r,componentRevisionId:s.version,type:s.type,cloudExpiration:void 0,size:s.length,etag:s.etag,hashType:"md5",hashValue:s.md5};return a.pruneUndefined(n)}(this.compositeAssetId,this.compositeId,this.repositoryId,t))}getComponentURL(e,t){const r=this._checkRAPIComponentParams(t);return e.getCompositeComponentUrlForDownload({repositoryId:this.repositoryId,assetId:this.compositeAssetId},t,r.length,r.version)}getComponent(e,t,r){const s=this._checkRAPIComponentParams(t);return e.getCompositeComponent({repositoryId:this.repositoryId,assetId:this.compositeAssetId},t,s.version,r)}_checkRAPIComponentParams(e){if(!this.repositoryId)throw new o.DCXError(o.DCXError.INVALID_STATE,"Repository ID must be defined.",void 0,void 0,{componentId:e});const t=this.records[e];if(!t)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"UploadRecord does not exist",void 0,void 0,{componentId:e});return t}}function p(e,t,r){return a.validateParams(["compositeId",e,"string",!0],["compositeAssetId",t,"string"],["repositoryId",r,["string","undefined"]]),new u(e,t,r)}function _(e,t,r,s,o,n){return a.validateParams(["componentId",e,"string"],["etag",t,"string"],["version",r,"string"],["md5",s,"string"],["length",o,"number"],["type",n,"string"]),new l(e,t,r,s,o,n)}function f(e,t,r){a.validateParams(["repoUploadResults",t,"object"],["compositeId",r,"string",!0]),a.validateObject(t,"repoUploadResults",["result","object"]);const o=t.asset||t.compositeAsset,{result:n}=t;if(!(o.assetId&&o.repositoryId||o.links||n.links))throw new c.default(c.default.INVALID_PARAMS,"AdobeRepoUploadResult#asset object missing repositoryId or assetId, and links");const i=_(n.id,n.etag,n.revision,n.md5,n.length,n.type);let d;if(o.assetId&&o.repositoryId)d=h.default.resolve(p(r,o.assetId,o.repositoryId));else{a.validateParams(["session",e,"object"]);const t=o.links||n.links,i=s.assertLinksContainAny(t,[s.LinkRelation.PRIMARY,s.LinkRelation.ID,s.LinkRelation.PATH,s.LinkRelation.COMPONENT]),h=a.getLinkHrefTemplated(t,i,{component_id:"manifest"});d=e.headHTTPResource(h).then((e=>{const t=e.headers["repository-id"],s=e.headers["asset-id"];if(!t||!s)throw new c.default(c.default.INVALID_DATA,"Fetched data missing repositoryId or assetId");return p(r,s,t)}))}return d.then((e=>(e.addUploadRecord(n.id,i),e)))}const g=n.newDebug("dcx:repoapisession"),m=n.AdobeDCXLogger.getInstance(),E="+dcx";class A{constructor(e,t,r){this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._blockUploadThreshold=s.DEFAULT_BLOCK_UPLOAD_THRESHOLD,a.validateParams(["httpService",e,"object"],["server",t,"string"]),this._service=e,this._service._repoAPIBaseUrl=t;const o=a.endPointOf(t);if(!o)throw new c.default(c.default.INVALID_PARAMS,"Could not determine endpoint from: "+t);this._endPoint=o,a.isObject(r)&&a.isAnyFunction(r.getIndexLinks)?this._linksCache=r:this._linksCache=new s.RepositoryLinksCache}get serviceConfig(){return{service:this._service,cache:this._linksCache}}get blockUploadThreshold(){return this._blockUploadThreshold}set blockUploadThreshold(e){a.validateParam("threshold",e,"+number"),this._blockUploadThreshold=e}get blockDownloadThreshold(){return s.getBlockDownloadThreshold()}set blockDownloadThreshold(e){a.validateParam("threshold",e,"+number"),s.setBlockDownloadThreshold(e)}createAsset(e,t,r,o,n,i,a,d,c){return s.createAsset(this._service,e,t,r,o,n,i,a,d,c)}createComposite(e,t,r,n,i,d,h,l){if(g("createComposite()"),a.validateParams(["parentDir",e,"object"],["relPath",t,"string"],["contentType",r,"string"]),!r.endsWith(E))throw new c.default(c.default.INVALID_PARAMS,`Composite contentType must end in "${E}"`);if(!s.isMinimalAdobeAsset(e))throw new c.default(c.default.INVALID_PARAMS,"parentDir must contain links or repositoryId & assetId or path");return this.createAsset(e,t,!0,d&&r.endsWith("dcx")?r+"ucf":r,n,i,d,h,l).catch((r=>{if(!r.response||409!==r.response.statusCode)throw o.unexpectedResponse("Error creating composite",r,r.response);if(r.response.headers.link){const t=s.parseLinksFromResponseHeader(r.response);this._linksCache.setValueWithAsset(t,{assetId:r.response.headers["asset-id"]||r.response.headers["x-resource-id"],repositoryId:e.repositoryId})}throw new c.default(c.default.ALREADY_EXISTS,"Composite already exists at "+t,void 0,r.response)}))}copyResources(e,t,r,o,n,i){return s.copyAssetResources(this._service,e,t,r,o,n,i)}getIndexLinks(e){return s.getIndexLinks(this.serviceConfig,e)}getIndexRepository(e){return s.getIndexRepository(this.serviceConfig,e)}getIndexDocument(e){return s.getIndexDocument(this.serviceConfig,e)}getDiscoverableAssets(e={},t){return s.getDiscoverableAssets(this.serviceConfig,e,t)}getDiscoverableRepos(e={},t){return s.getDiscoverableRepos(this.serviceConfig,e,t)}headHTTPResource(e,t){return s.headHTTPResource(this._service,e,t)}headCompositeManifest(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.COMPONENT],t).then((()=>s.headCompositeManifest(this._service,e,t)))}resolveAsset(e,t="id",r,o,n){return s.resolveAsset(this.serviceConfig,e,t,r,o,n)}headPrimaryResource(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],t).then((()=>s.headPrimaryResource(this.serviceConfig,e,t)))}getRepoMetadata(e,t){return this.useLinkOrResolveResource(e,s.LinkRelation.REPO_METADATA,"json",t).then((e=>({result:s.deserializeAsset(e.response.response),response:e.response})))}getEmbeddedMetadata(e,t="json",r){return a.validateParams(["asset",e,"object"],["format",t,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA],r).then((()=>s.getEmbeddedMetadata(this._service,e,t)))}putEmbeddedMetadata(e,t,r,o="json",n){return a.validateParams(["asset",e,"object"],["data",t,["string","object","object[]"]],["etag",r,"string",!0],["format",o,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA],n).then((()=>s.putEmbeddedMetadata(this._service,e,t,r,o,n)))}patchEmbeddedMetadata(e,t,r,o){return a.validateParams(["asset",e,"object"],["data",t,["string","object","object[]"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA],o).then((()=>s.patchEmbeddedMetadata(this._service,e,t,r,o)))}getDirectory(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getPagedChildren(this._service,e,t,r).then((e=>({result:s.directoryTransformer(e.paged.data)[1],paged:e.paged,response:e.response})))))}getDirectoryByURL(e){return s.getDirectoryByURL(this._service,e).then((e=>({response:e.response,result:s.deserializeAsset(e.result)})))}getLinksForAsset(e,t){return s.getLinksForAsset(this.serviceConfig,e,t)}getACLPolicy(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.ACL_POLICY],t).then((()=>s.getACLPolicy(this._service,e,t)))}getPrimaryResource(e,t,r){const o={};return this._withSourcePromise(o).then((()=>this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],r))).then((()=>s.getPrimaryResource.call(o,this._service,e,t,r)))}updatePrimaryResource(e,t,r,o,n,i,a){return this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],a).then((()=>s.updatePrimaryResource(this._service,e,t,r,o,n,i,a)))}getRepositoryResource(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.REPOSITORY],t).then((()=>s.getRepositoryResource(this._service,e,t)))}getVersions(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getPagedVersions(this._service,e,t,r).then((e=>({result:s.deserializeVersionSet(e.result),response:e.response,paged:e.paged})))))}getVersionResource(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getVersionResource(this._service,e,t,r).then((e=>({result:s.deserializeVersion(e.result),response:e.response})))))}blockDownloadAsset(e,t,r,o,n,i,a,d){if("string"==typeof e)return s.doBlockDownload(this._service,e,t,r,o,n,i,a,d);const c={};return this._withSourcePromise(c).then((()=>this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY]))).then((()=>s.doBlockDownload.call(c,this._service,e,t,r,o,n,i,a,d)))}fetchLinksIfMissing(e,t,r){return s.fetchLinksIfMissing(this.serviceConfig,e,t,void 0,r)}useLinkOrResolveResource(e,t,r,o){return s.useLinkOrResolveResource(this.serviceConfig,e,t,r,o).then((t=>(e.links!==t.result.links&&(e.links=a.merge(e.links||{},t.result.links),this._linksCache.setValueWithAsset(e.links,e)),t)))}getLinkHrefForAsset(e,t,r="id",s){return this.fetchLinksIfMissing(e,[t],s).then((e=>a.getLinkHref(e,t,r)))}getEffectivePrivileges(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.EFFECTIVE_PRIVILAGES],t).then((()=>s.getEffectivePrivileges(this._service,e,t)))}checkACLPrivilege(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.ACCESS_CHECK],o).then((()=>s.checkACLPrivilege(this._service,e,t,r,o)))}headAppMetadata(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],t).then((()=>s.headAppMetadata(this.serviceConfig,e,t)))}getAppMetadata(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],r).then((()=>s.getAppMetadata(this._service,e,t,r)))}putAppMetadata(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],o).then((()=>s.putAppMetadata(this._service,e,t,r,o)))}patchAppMetadata(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],o).then((()=>s.patchAppMetadata(this._service,e,t,r)))}getCompositeManifestUrl(e,t,r){a.validateParams(["asset",e,"object"],["version",t,"string",!0]);const o=this._getAsAdobeAsset(e);return o.version=t||o.version,this.fetchLinksIfMissing(o,[s.LinkRelation.MANIFEST],r).then((()=>s.getCompositeManifestUrl(this._service,o,t,r)))}getCompositeManifest(e,t,r,o){a.validateParams(["asset",e,"object"],["version",t,"string",!0],["etag",r,"string",!0]);const n=this._getAsAdobeAsset(e);return n.version=t||n.version,this.fetchLinksIfMissing(n,[s.LinkRelation.MANIFEST],o).then((()=>s.getCompositeManifest(this._service,n,t,r,o)))}getManifestAndComponentsByPath(e,t,r,o,n){return s.getManifestAndComponentsByPath(this.serviceConfig.service,e,t,r,o,n)}getRendition(e,t,r,o,n){return this.fetchLinksIfMissing(e,[s.LinkRelation.RENDITION]).then((()=>s.getRendition(this._service,e,t,r,o,n)))}getCompositeComponentUrlForDownload(e,t,r,o,n){var i;const a=this._getAsAdobeAsset(e),d=null!==(i=this._isDCXComponentLike(e)?e.length:r)&&void 0!==i?i:0,{id:c,revision:h}=this._resolveComponentIdAndRevision(e,t,o);return d>this.blockDownloadThreshold?s.getCompositeComponentPresignedUrl(this.serviceConfig,a,c,h,n).then((({response:e,result:t})=>({response:e,isPresignedUrl:!0,url:t}))):this.getCompositeComponentUrl(a,c,h,n).then((e=>({response:void 0,url:e,isPresignedUrl:!1})))}getCompositeComponentUrl(e,t,r,o){const n=this._getAsAdobeAsset(e),{id:i,revision:d}=this._resolveComponentIdAndRevision(e,t,r,!1);return this.fetchLinksIfMissing(n,[s.LinkRelation.COMPONENT],o).then((()=>(a.validateParams(["asset",n,"object"],["componentId",i,"string"],["componentRevision",d,"string",!0]),s.getCompositeComponentUrl(this._service,n,i,d))))}getCompositeComponentByPath(e,t,r,o,n){return s.getCompositeComponentByPath(this._service,this._getAsAdobeAsset(e),t,r,o,n)}getCompositeComponent(e,t,r,o,n,i){const d=this._getAsAdobeAsset(e),{id:c,revision:h}=this._resolveComponentIdAndRevision(e,t,r);return this.fetchLinksIfMissing(d,[s.LinkRelation.COMPONENT],n).then((()=>(a.validateParams(["asset",e,"object"],["componentId",c,"string"],["componentRevision",h,"string"],["responseType",o,"enum",!0,s.STREAMABLE_RESPONSE_TYPES]),s.getCompositeComponent(this._service,d,c,h,o,n,this._isDCXComponentLike(e)?e.length:i))))}putCompositeComponent(e,t,r,o,n,i,d,h,l,u){if(a.validateParams(["asset",e,"object"],["componentId",t,"string"],["contentType",o,"string"],["maybeIsNew",n,"boolean",!0],["size",i,"number",!0],["md5",d,"string",!0]),n&&!a.verifyUuid(t))throw new c.default(c.default.INVALID_PARAMS,"Component id is not a uuid");a.verifyUuid(t)||m.warn("Existing component id is not a uuid");const p=this._getAsAdobeAsset(e);return this.fetchLinksIfMissing(p,[s.LinkRelation.COMPONENT,s.LinkRelation.BLOCK_UPLOAD_INIT],l).then((()=>s.putCompositeComponent(this.serviceConfig,e,t,r,o,n,i,d,h,l,u)))}getCompositeComponentsUrlsForUpload(e,t,r){return s.getCompositeComponentsUrlsForUpload(this._service,e,t,r)}performBulkRequest(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.BULK_REQUEST],o).then((()=>s.performBulkRequest(this._service,e,t,r,o)))}updateCompositeManifest(e,t,r,o=1,n,i){g("updateCompositeManifest()"),a.validateParams(["asset",e,"object"],["manifest",t,["object","string"]],["overwrite",r,"boolean"],["validationLevel",o,"+number"],["etag",n,"string",!0]);const d=this._getAsAdobeAsset(e);return this.fetchLinksIfMissing(d,[s.LinkRelation.MANIFEST],i).then((()=>s.updateCompositeManifest(this._service,d,t,r,o,n,i)))}patchVersions(e,t,r,o){return a.validateParams(["asset",e,"object"],["patchDoc",t,["string","array"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.VERSION_HISTORY],o).then((()=>s.patchVersions(this._service,e,t,r,o)))}patchACLPolicy(e,t,r,o){return a.validateParams(["asset",e,"object"],["policy",t,["string","object"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.VERSION_HISTORY],o).then((()=>s.patchACLPolicy(this._service,e,t,r,o)))}deleteACLPolicy(e,t){return a.validateParams(["asset",e,"object"]),this.fetchLinksIfMissing(e,[s.LinkRelation.ACL_POLICY],t).then((()=>s.deleteACLPolicy(this._service,e,t)))}copyAsset(e,t,r,o,n,i){return s.copyAsset(this.serviceConfig,e,t,r,o,n,i)}moveAsset(e,t,r,o,n){return s.moveAsset(this.serviceConfig,e,t,r,o,n)}deleteAsset(e,t,r,o){return s.deleteAsset(this.serviceConfig,{repositoryId:e.repositoryId,path:e.path,assetId:e.assetId},t,r,o).then((t=>(this._linksCache.deleteWithAsset(e),t)))}discardAsset(e,t,r,o){return s.discardAsset(this.serviceConfig,{repositoryId:e.repositoryId,path:e.path,assetId:e.assetId},t,r,o)}restoreAsset(e,t){return s.restoreAsset(this.serviceConfig,e,t)}packageAssets(e,t,r,o,n){return s.packageAssets(this.serviceConfig,e,t,r,o,n)}performOperation(e,t){return s.getOpsHref(this.serviceConfig,t).then((r=>s.doOperation(this._service,r,e,t)))}performBatchOperation(e,t){return s.getOpsHref(this.serviceConfig).then((r=>s.doBatchOperation(this._service,r,e,t)))}uploadResultsFromAdobeRepoUploadResult(e,t){return f(this,e,t)}updateCachedAssetLinks(e){if(!e.assetId)throw new c.default(c.default.INVALID_PARAMS,"Asset must contain an assetId");this._linksCache.setValueWithAsset(e.links||e._links,e)}updateCachedIndexLinks(e){if(!e)throw new c.default(c.default.INVALID_PARAMS,"Index LinkSet must not be null");this._linksCache.setIndexLinks(e)}getLinksCache(){return this._linksCache}setLinksCache(e){this._linksCache=e}clearLinksCache(){this._linksCache.clear()}_resolveComponentIdAndRevision(e,t,r,o=!0){var n;if(this._isDCXComponentLike(e))return{revision:e.version,id:e.id};if(!t)throw new c.default(c.default.INVALID_PARAMS,"Missing componentId.");if(!1===o||r)return{revision:r,id:t};if(!s.isAdobeDCXCompositeLike(e)||!t)throw new c.default(c.default.INVALID_PARAMS,"Could not determine component revision");const i=null===(n=e.current)||void 0===n?void 0:n.getComponentWithId(t);if(void 0===(null==i?void 0:i.version))throw new c.default(c.default.INVALID_PARAMS,"Could not determine component revision");return{revision:i.version,id:t}}_isDCXComponentLike(e){return!!a.isObject(e)&&null!=e.owner&&s.isAdobeDCXBranchLike(e.owner)}_withSourcePromise(e){return h.default.resolve(void 0,e)}_getAsAdobeAsset(e){if("object"!=typeof e||Array.isArray(e))throw new c.default(c.default.INVALID_PARAMS,"Invalid asset-like object.");if(s.isMinimalAdobeAsset(e))return e;let t,r={};if(("repositoryId"in e||"assetId"in e||"links"in e||"version"in e)&&(r={repositoryId:e.repositoryId,assetId:e.assetId,links:e.links,version:e.version}),s.isAdobeDCXBranchLike(e)&&(t=e._core),this._isDCXComponentLike(e)||t){const s=e,o=t||(s&&s.owner&&s.owner._core?s.owner._core:void 0);if(o){const e=o._getSourceAssetInfoOfComponent(r);e&&"object"==typeof e&&(r.assetId=e.compositeAssetId||r.assetId,r.repositoryId=e.compositeRepositoryId||r.repositoryId,r.links=e.links||r.links,r.version=e.version||r.version)}}const o=e,n=e;return r.assetId=r.assetId?r.assetId:o.owner?o.owner.compositeAssetId:n.compositeAssetId,r.repositoryId=r.repositoryId?r.repositoryId:o.owner?o.owner.compositeRepositoryId:n.compositeRepositoryId,r}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new c.default(c.default.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}_resolveUrl(e){return a.endPointOf(e)?e:a.appendPathElements(this._service._repoAPIBaseUrl||this._service.server,e)}registerLinks(e,t,r){e=e._links||e;const s={assetId:r||"urn:aaid:faux:"+a.generateUuid(),repositoryId:t||"faux-repo-id"};return this._linksCache.setValueWithAsset(e,s),s}}t.AdobeRepoAPISession=A,t.CURRENT_COMPONENT_DESCRIPTOR_HASH_TYPE="md5",t.CURRENT_COMPONENT_DESCRIPTOR_VERSION="0",t.createRepoAPISession=(e,t,r)=>new A(e,t,r),t.createUploadRecord=_,t.createUploadResults=p,t.uploadResultsFromAdobeRepoUploadResult=f,t.uploadResultsFromComponentDescriptor=function(e){let t;a.validateParams(["decriptor",e,"string"]);try{t=JSON.parse(e)}catch(e){throw new c.default(c.default.INVALID_JSON,"Invalid component descriptor",e)}switch(t.versionId){case"0":case void 0:if(!t.repositoryId)throw new c.default(c.default.INVALID_DATA,"Component descriptor missing repositoryId");try{const e=p(t.compositeId,t.cloudAssetId,t.repositoryId),r=_(t.componentId,t.etag,t.componentRevisionId,t.hashValue,t.size,t.type);return e.addUploadRecord(t.componentId,r),e}catch(e){throw new c.default(c.default.INVALID_DATA,"Invalid component descriptor",e)}default:throw new c.default(c.default.INVALID_DATA,"ComponentDescriptor serialization versionId not valid or not yet handled.")}}},899027:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(935341),o=r(45276),n=r(200334),i=r(310799),a=r(499164);function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=d(o),h=d(i);class l{constructor(e,t,r,s,o,n){this.id=e,this.etag=t,this.version=r,this.md5=s,this.length=o,this.type=n}}class u{constructor(e,t,r){this.compositeId=e,this.compositeAssetId=t,this.repositoryId=r,this.records={}}addUploadRecord(e,t){a.validateParams(["componentId",e,"string"],["record",t,"object"]),this.records[e]=t}getComponentDescriptor(e){const t=this._checkRAPIComponentParams(e);return JSON.stringify(function(e,t,r,s){try{a.validateObject(s,"UploadRecord",["id","string"],["version","string"],["length","number"],["etag","string"],["type","string"])}catch(e){throw new o.DCXError(o.DCXError.INVALID_STATE,"Invalid record data",e)}const n={versionId:"0",componentId:s.id,cloudAssetId:e,compositeId:t,repositoryId:r,componentRevisionId:s.version,type:s.type,cloudExpiration:void 0,size:s.length,etag:s.etag,hashType:"md5",hashValue:s.md5};return a.pruneUndefined(n)}(this.compositeAssetId,this.compositeId,this.repositoryId,t))}getComponentURL(e,t){const r=this._checkRAPIComponentParams(t);return e.getCompositeComponentUrlForDownload({repositoryId:this.repositoryId,assetId:this.compositeAssetId},t,r.length,r.version)}getComponent(e,t,r){const s=this._checkRAPIComponentParams(t);return e.getCompositeComponent({repositoryId:this.repositoryId,assetId:this.compositeAssetId},t,s.version,r)}_checkRAPIComponentParams(e){if(!this.repositoryId)throw new o.DCXError(o.DCXError.INVALID_STATE,"Repository ID must be defined.",void 0,void 0,{componentId:e});const t=this.records[e];if(!t)throw new o.DCXError(o.DCXError.INVALID_PARAMS,"UploadRecord does not exist",void 0,void 0,{componentId:e});return t}}function p(e,t,r){return a.validateParams(["compositeId",e,"string",!0],["compositeAssetId",t,"string"],["repositoryId",r,["string","undefined"]]),new u(e,t,r)}function _(e,t,r,s,o,n){return a.validateParams(["componentId",e,"string"],["etag",t,"string"],["version",r,"string"],["md5",s,"string"],["length",o,"number"],["type",n,"string"]),new l(e,t,r,s,o,n)}function f(e,t,r){a.validateParams(["repoUploadResults",t,"object"],["compositeId",r,"string",!0]),a.validateObject(t,"repoUploadResults",["result","object"]);const o=t.asset||t.compositeAsset,{result:n}=t;if(!(o.assetId&&o.repositoryId||o.links||n.links))throw new c.default(c.default.INVALID_PARAMS,"AdobeRepoUploadResult#asset object missing repositoryId or assetId, and links");const i=_(n.id,n.etag,n.revision,n.md5,n.length,n.type);let d;if(o.assetId&&o.repositoryId)d=h.default.resolve(p(r,o.assetId,o.repositoryId));else{a.validateParams(["session",e,"object"]);const t=o.links||n.links,i=s.assertLinksContainAny(t,[s.LinkRelation.PRIMARY,s.LinkRelation.ID,s.LinkRelation.PATH,s.LinkRelation.COMPONENT]),h=a.getLinkHrefTemplated(t,i,{component_id:"manifest"});d=e.headHTTPResource(h).then((e=>{const t=e.headers["repository-id"],s=e.headers["asset-id"];if(!t||!s)throw new c.default(c.default.INVALID_DATA,"Fetched data missing repositoryId or assetId");return p(r,s,t)}))}return d.then((e=>(e.addUploadRecord(n.id,i),e)))}const g=n.newDebug("dcx:repoapisession"),m=n.AdobeDCXLogger.getInstance(),E="+dcx";class A{constructor(e,t,r){this._authenticationAllowList=["adobe.com","adobe.io","adobelogin.com","fotolia.net"],this._blockUploadThreshold=s.DEFAULT_BLOCK_UPLOAD_THRESHOLD,a.validateParams(["httpService",e,"object"],["server",t,"string"]),this._service=e,this._service._repoAPIBaseUrl=t;const o=a.endPointOf(t);if(!o)throw new c.default(c.default.INVALID_PARAMS,"Could not determine endpoint from: "+t);this._endPoint=o,a.isObject(r)&&a.isAnyFunction(r.getIndexLinks)?this._linksCache=r:this._linksCache=new s.RepositoryLinksCache}get serviceConfig(){return{service:this._service,cache:this._linksCache}}get blockUploadThreshold(){return this._blockUploadThreshold}set blockUploadThreshold(e){a.validateParam("threshold",e,"+number"),this._blockUploadThreshold=e}get blockDownloadThreshold(){return s.getBlockDownloadThreshold()}set blockDownloadThreshold(e){a.validateParam("threshold",e,"+number"),s.setBlockDownloadThreshold(e)}createAsset(e,t,r,o,n,i,a,d,c){return s.createAsset(this._service,e,t,r,o,n,i,a,d,c)}createComposite(e,t,r,n,i,d,h,l){if(g("createComposite()"),a.validateParams(["parentDir",e,"object"],["relPath",t,"string"],["contentType",r,"string"]),!r.endsWith(E))throw new c.default(c.default.INVALID_PARAMS,`Composite contentType must end in "${E}"`);if(!s.isMinimalAdobeAsset(e))throw new c.default(c.default.INVALID_PARAMS,"parentDir must contain links or repositoryId & assetId or path");return this.createAsset(e,t,!0,d&&r.endsWith("dcx")?r+"ucf":r,n,i,d,h,l).catch((r=>{if(!r.response||409!==r.response.statusCode)throw o.unexpectedResponse("Error creating composite",r,r.response);if(r.response.headers.link){const t=s.parseLinksFromResponseHeader(r.response);this._linksCache.setValueWithAsset(t,{assetId:r.response.headers["asset-id"]||r.response.headers["x-resource-id"],repositoryId:e.repositoryId})}throw new c.default(c.default.ALREADY_EXISTS,"Composite already exists at "+t,void 0,r.response)}))}copyResources(e,t,r,o,n,i){return s.copyAssetResources(this._service,e,t,r,o,n,i)}getIndexLinks(e){return s.getIndexLinks(this.serviceConfig,e)}getIndexRepository(e){return s.getIndexRepository(this.serviceConfig,e)}getIndexDocument(e){return s.getIndexDocument(this.serviceConfig,e)}getDiscoverableAssets(e={},t){return s.getDiscoverableAssets(this.serviceConfig,e,t)}getDiscoverableRepos(e={},t){return s.getDiscoverableRepos(this.serviceConfig,e,t)}headHTTPResource(e,t){return s.headHTTPResource(this._service,e,t)}headCompositeManifest(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.COMPONENT],t).then((()=>s.headCompositeManifest(this._service,e,t)))}resolveAsset(e,t="id",r,o,n){return s.resolveAsset(this.serviceConfig,e,t,r,o,n)}headPrimaryResource(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],t).then((()=>s.headPrimaryResource(this.serviceConfig,e,t)))}getRepoMetadata(e,t){return this.useLinkOrResolveResource(e,s.LinkRelation.REPO_METADATA,"json",t).then((e=>({result:s.deserializeAsset(e.response.response),response:e.response})))}getEmbeddedMetadata(e,t="json",r){return a.validateParams(["asset",e,"object"],["format",t,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA],r).then((()=>s.getEmbeddedMetadata(this._service,e,t)))}putEmbeddedMetadata(e,t,r,o="json",n){return a.validateParams(["asset",e,"object"],["data",t,["string","object","object[]"]],["etag",r,"string",!0],["format",o,"enum",!1,["json","xml"]]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA],n).then((()=>s.putEmbeddedMetadata(this._service,e,t,r,o,n)))}patchEmbeddedMetadata(e,t,r,o){return a.validateParams(["asset",e,"object"],["data",t,["string","object","object[]"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.EMBEDDED_METADATA],o).then((()=>s.patchEmbeddedMetadata(this._service,e,t,r,o)))}getDirectory(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getPagedChildren(this._service,e,t,r).then((e=>({result:s.directoryTransformer(e.paged.data)[1],paged:e.paged,response:e.response})))))}getDirectoryByURL(e){return s.getDirectoryByURL(this._service,e).then((e=>({response:e.response,result:s.deserializeAsset(e.result)})))}getLinksForAsset(e,t){return s.getLinksForAsset(this.serviceConfig,e,t)}getACLPolicy(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.ACL_POLICY],t).then((()=>s.getACLPolicy(this._service,e,t)))}getPrimaryResource(e,t,r){const o={};return this._withSourcePromise(o).then((()=>this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],r))).then((()=>s.getPrimaryResource.call(o,this._service,e,t,r)))}updatePrimaryResource(e,t,r,o,n,i,a){return this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY],a).then((()=>s.updatePrimaryResource(this._service,e,t,r,o,n,i,a)))}getRepositoryResource(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.REPOSITORY],t).then((()=>s.getRepositoryResource(this._service,e,t)))}getVersions(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getPagedVersions(this._service,e,t,r).then((e=>({result:s.deserializeVersionSet(e.result),response:e.response,paged:e.paged})))))}getVersionResource(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.PAGE],r).then((()=>s.getVersionResource(this._service,e,t,r).then((e=>({result:s.deserializeVersion(e.result),response:e.response})))))}blockDownloadAsset(e,t,r,o,n,i,a,d){if("string"==typeof e)return s.doBlockDownload(this._service,e,t,r,o,n,i,a,d);const c={};return this._withSourcePromise(c).then((()=>this.fetchLinksIfMissing(e,[s.LinkRelation.PRIMARY]))).then((()=>s.doBlockDownload.call(c,this._service,e,t,r,o,n,i,a,d)))}fetchLinksIfMissing(e,t,r){return s.fetchLinksIfMissing(this.serviceConfig,e,t,void 0,r)}useLinkOrResolveResource(e,t,r,o){return s.useLinkOrResolveResource(this.serviceConfig,e,t,r,o).then((t=>(e.links!==t.result.links&&(e.links=a.merge(e.links||{},t.result.links),this._linksCache.setValueWithAsset(e.links,e)),t)))}getLinkHrefForAsset(e,t,r="id",s){return this.fetchLinksIfMissing(e,[t],s).then((e=>a.getLinkHref(e,t,r)))}getEffectivePrivileges(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.EFFECTIVE_PRIVILAGES],t).then((()=>s.getEffectivePrivileges(this._service,e,t)))}checkACLPrivilege(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.ACCESS_CHECK],o).then((()=>s.checkACLPrivilege(this._service,e,t,r,o)))}headAppMetadata(e,t){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],t).then((()=>s.headAppMetadata(this.serviceConfig,e,t)))}getAppMetadata(e,t,r){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],r).then((()=>s.getAppMetadata(this._service,e,t,r)))}putAppMetadata(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],o).then((()=>s.putAppMetadata(this._service,e,t,r,o)))}patchAppMetadata(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.APP_METADATA],o).then((()=>s.patchAppMetadata(this._service,e,t,r)))}getCompositeManifestUrl(e,t,r){a.validateParams(["asset",e,"object"],["version",t,"string",!0]);const o=this._getAsAdobeAsset(e);return o.version=t||o.version,this.fetchLinksIfMissing(o,[s.LinkRelation.MANIFEST],r).then((()=>s.getCompositeManifestUrl(this._service,o,t,r)))}getCompositeManifest(e,t,r,o){a.validateParams(["asset",e,"object"],["version",t,"string",!0],["etag",r,"string",!0]);const n=this._getAsAdobeAsset(e);return n.version=t||n.version,this.fetchLinksIfMissing(n,[s.LinkRelation.MANIFEST],o).then((()=>s.getCompositeManifest(this._service,n,t,r,o)))}getManifestAndComponentsByPath(e,t,r,o,n){return s.getManifestAndComponentsByPath(this.serviceConfig.service,e,t,r,o,n)}getRendition(e,t,r,o,n){return this.fetchLinksIfMissing(e,[s.LinkRelation.RENDITION]).then((()=>s.getRendition(this._service,e,t,r,o,n)))}getCompositeComponentUrlForDownload(e,t,r,o,n){var i;const a=this._getAsAdobeAsset(e),d=null!==(i=this._isDCXComponentLike(e)?e.length:r)&&void 0!==i?i:0,{id:c,revision:h}=this._resolveComponentIdAndRevision(e,t,o);return d>this.blockDownloadThreshold?s.getCompositeComponentPresignedUrl(this.serviceConfig,a,c,h,n).then((({response:e,result:t})=>({response:e,isPresignedUrl:!0,url:t}))):this.getCompositeComponentUrl(a,c,h,n).then((e=>({response:void 0,url:e,isPresignedUrl:!1})))}getCompositeComponentUrl(e,t,r,o){const n=this._getAsAdobeAsset(e),{id:i,revision:d}=this._resolveComponentIdAndRevision(e,t,r,!1);return this.fetchLinksIfMissing(n,[s.LinkRelation.COMPONENT],o).then((()=>(a.validateParams(["asset",n,"object"],["componentId",i,"string"],["componentRevision",d,"string",!0]),s.getCompositeComponentUrl(this._service,n,i,d))))}getCompositeComponentByPath(e,t,r,o,n){return s.getCompositeComponentByPath(this._service,this._getAsAdobeAsset(e),t,r,o,n)}getCompositeComponent(e,t,r,o,n,i){const d=this._getAsAdobeAsset(e),{id:c,revision:h}=this._resolveComponentIdAndRevision(e,t,r);return this.fetchLinksIfMissing(d,[s.LinkRelation.COMPONENT],n).then((()=>(a.validateParams(["asset",e,"object"],["componentId",c,"string"],["componentRevision",h,"string"],["responseType",o,"enum",!0,s.STREAMABLE_RESPONSE_TYPES]),s.getCompositeComponent(this._service,d,c,h,o,n,this._isDCXComponentLike(e)?e.length:i))))}putCompositeComponent(e,t,r,o,n,i,d,h,l,u){if(a.validateParams(["asset",e,"object"],["componentId",t,"string"],["contentType",o,"string"],["maybeIsNew",n,"boolean",!0],["size",i,"number",!0],["md5",d,"string",!0]),n&&!a.verifyUuid(t))throw new c.default(c.default.INVALID_PARAMS,"Component id is not a uuid");a.verifyUuid(t)||m.warn("Existing component id is not a uuid");const p=this._getAsAdobeAsset(e);return this.fetchLinksIfMissing(p,[s.LinkRelation.COMPONENT,s.LinkRelation.BLOCK_UPLOAD_INIT],l).then((()=>s.putCompositeComponent(this.serviceConfig,e,t,r,o,n,i,d,h,l,u)))}getCompositeComponentsUrlsForUpload(e,t,r){return s.getCompositeComponentsUrlsForUpload(this._service,e,t,r)}performBulkRequest(e,t,r,o){return this.fetchLinksIfMissing(e,[s.LinkRelation.BULK_REQUEST],o).then((()=>s.performBulkRequest(this._service,e,t,r,o)))}updateCompositeManifest(e,t,r,o=1,n,i){g("updateCompositeManifest()"),a.validateParams(["asset",e,"object"],["manifest",t,["object","string"]],["overwrite",r,"boolean"],["validationLevel",o,"+number"],["etag",n,"string",!0]);const d=this._getAsAdobeAsset(e);return this.fetchLinksIfMissing(d,[s.LinkRelation.MANIFEST],i).then((()=>s.updateCompositeManifest(this._service,d,t,r,o,n,i)))}patchVersions(e,t,r,o){return a.validateParams(["asset",e,"object"],["patchDoc",t,["string","array"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.VERSION_HISTORY],o).then((()=>s.patchVersions(this._service,e,t,r,o)))}patchACLPolicy(e,t,r,o){return a.validateParams(["asset",e,"object"],["policy",t,["string","object"]],["etag",r,"string",!0]),this.fetchLinksIfMissing(e,[s.LinkRelation.VERSION_HISTORY],o).then((()=>s.patchACLPolicy(this._service,e,t,r,o)))}deleteACLPolicy(e,t){return a.validateParams(["asset",e,"object"]),this.fetchLinksIfMissing(e,[s.LinkRelation.ACL_POLICY],t).then((()=>s.deleteACLPolicy(this._service,e,t)))}copyAsset(e,t,r,o,n,i){return s.copyAsset(this.serviceConfig,e,t,r,o,n,i)}moveAsset(e,t,r,o,n){return s.moveAsset(this.serviceConfig,e,t,r,o,n)}deleteAsset(e,t,r,o){return s.deleteAsset(this.serviceConfig,{repositoryId:e.repositoryId,path:e.path,assetId:e.assetId},t,r,o).then((t=>(this._linksCache.deleteWithAsset(e),t)))}discardAsset(e,t,r,o){return s.discardAsset(this.serviceConfig,{repositoryId:e.repositoryId,path:e.path,assetId:e.assetId},t,r,o)}restoreAsset(e,t){return s.restoreAsset(this.serviceConfig,e,t)}packageAssets(e,t,r,o,n){return s.packageAssets(this.serviceConfig,e,t,r,o,n)}performOperation(e,t){return s.getOpsHref(this.serviceConfig,t).then((r=>s.doOperation(this._service,r,e,t)))}performBatchOperation(e,t){return s.getOpsHref(this.serviceConfig).then((r=>s.doBatchOperation(this._service,r,e,t)))}uploadResultsFromAdobeRepoUploadResult(e,t){return f(this,e,t)}updateCachedAssetLinks(e){if(!e.assetId)throw new c.default(c.default.INVALID_PARAMS,"Asset must contain an assetId");this._linksCache.setValueWithAsset(e.links||e._links,e)}updateCachedIndexLinks(e){if(!e)throw new c.default(c.default.INVALID_PARAMS,"Index LinkSet must not be null");this._linksCache.setIndexLinks(e)}getLinksCache(){return this._linksCache}setLinksCache(e){this._linksCache=e}clearLinksCache(){this._linksCache.clear()}_resolveComponentIdAndRevision(e,t,r,o=!0){var n;if(this._isDCXComponentLike(e))return{revision:e.version,id:e.id};if(!t)throw new c.default(c.default.INVALID_PARAMS,"Missing componentId.");if(!1===o||r)return{revision:r,id:t};if(!s.isAdobeDCXCompositeLike(e)||!t)throw new c.default(c.default.INVALID_PARAMS,"Could not determine component revision");const i=null===(n=e.current)||void 0===n?void 0:n.getComponentWithId(t);if(void 0===(null==i?void 0:i.version))throw new c.default(c.default.INVALID_PARAMS,"Could not determine component revision");return{revision:i.version,id:t}}_isDCXComponentLike(e){return!!a.isObject(e)&&null!=e.owner&&s.isAdobeDCXBranchLike(e.owner)}_withSourcePromise(e){return h.default.resolve(void 0,e)}_getAsAdobeAsset(e){if("object"!=typeof e||Array.isArray(e))throw new c.default(c.default.INVALID_PARAMS,"Invalid asset-like object.");if(s.isMinimalAdobeAsset(e))return e;let t,r={};if(("repositoryId"in e||"assetId"in e||"links"in e||"version"in e)&&(r={repositoryId:e.repositoryId,assetId:e.assetId,links:e.links,version:e.version}),s.isAdobeDCXBranchLike(e)&&(t=e._core),this._isDCXComponentLike(e)||t){const s=e,o=t||(s&&s.owner&&s.owner._core?s.owner._core:void 0);if(o){const e=o._getSourceAssetInfoOfComponent(r);e&&"object"==typeof e&&(r.assetId=e.compositeAssetId||r.assetId,r.repositoryId=e.compositeRepositoryId||r.repositoryId,r.links=e.links||r.links,r.version=e.version||r.version)}}const o=e,n=e;return r.assetId=r.assetId?r.assetId:o.owner?o.owner.compositeAssetId:n.compositeAssetId,r.repositoryId=r.repositoryId?r.repositoryId:o.owner?o.owner.compositeRepositoryId:n.compositeRepositoryId,r}get authenticationAllowList(){return this._authenticationAllowList}set authenticationAllowList(e){if(!Array.isArray(e))throw new c.default(c.default.INVALID_PARAMS,"Expecting an array.");this._authenticationAllowList=e}_resolveUrl(e){return a.endPointOf(e)?e:a.appendPathElements(this._service._repoAPIBaseUrl||this._service.server,e)}registerLinks(e,t,r){e=e._links||e;const s={assetId:r||"urn:aaid:faux:"+a.generateUuid(),repositoryId:t||"faux-repo-id"};return this._linksCache.setValueWithAsset(e,s),s}}t.AdobeRepoAPISession=A,t.CURRENT_COMPONENT_DESCRIPTOR_HASH_TYPE="md5",t.CURRENT_COMPONENT_DESCRIPTOR_VERSION="0",t.createRepoAPISession=(e,t,r)=>new A(e,t,r),t.createUploadRecord=_,t.createUploadResults=p,t.uploadResultsFromAdobeRepoUploadResult=f,t.uploadResultsFromComponentDescriptor=function(e){let t;a.validateParams(["decriptor",e,"string"]);try{t=JSON.parse(e)}catch(e){throw new c.default(c.default.INVALID_JSON,"Invalid component descriptor",e)}switch(t.versionId){case"0":case void 0:if(!t.repositoryId)throw new c.default(c.default.INVALID_DATA,"Component descriptor missing repositoryId");try{const e=p(t.compositeId,t.cloudAssetId,t.repositoryId),r=_(t.componentId,t.etag,t.componentRevisionId,t.hashValue,t.size,t.type);return e.addUploadRecord(t.componentId,r),e}catch(e){throw new c.default(c.default.INVALID_DATA,"Invalid component descriptor",e)}default:throw new c.default(c.default.INVALID_DATA,"ComponentDescriptor serialization versionId not valid or not yet handled.")}}},617759:(e,t,r)=>{var s=r(640430).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(979672),n=r(154118);const i=e=>a(e)&&(d(e.pipe)||d(e.pipeTo)),a=e=>null!=e&&"object"==typeof e,d=e=>"function"==typeof e,c=e=>Array.isArray(e),h=()=>{try{return"[object process]"===Object.prototype.toString.call(r.g.process)}catch(e){return!1}},l=()=>"object"==typeof self&&self.self===self,u=()=>"browser",p=(...e)=>!e||!Array.isArray(e)||e.length<1?{}:e.reduce(((e,t)=>{const r=a(e)?e:{};if(a(t))for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(r[e]=t[e]);return r})),_=(e,...t)=>{if(!t.length)return e;const r=t.shift();if(a(e)&&a(r))for(const t in r)a(r[t])&&!c(r[t])?(e[t]||Object.assign(e,{[t]:{}}),_(e[t],r[t])):c(e[t])&&c(r[t])?Object.assign(e,{[t]:r[t]}):Object.assign(e,{[t]:r[t]});return _(e,...t)},f=/^(CON|PRN|AUX|NUL|COM\d|LPT\d)(\..+)?$/,g=/[\u0000-\u001F\u0022\u002A\u003A\u003C\u003E\u003F\u005C\u007F\u007C]/,m=(e,t=!1)=>{try{if(e.length>65535)return!1;const r=(t?e.slice(1):e).split("/");if(!r||0===r.length)return!1;for(const e of r){if(e.length<1||e.length>255)return!1;if(g.test(e))return!1;if(e.endsWith(".")||e.endsWith(" "))return!1;if(f.test(e))return!1;if(e.startsWith("dcx")||e.startsWith(".dcx"))return!1;if("manifest"===e||"mimetype"===e)return!1}return!(t&&(!e.startsWith("/")||e.endsWith("/")))}catch(e){return!1}},E=()=>{},A=(e,t,r)=>{const s={};let o,n=Object.keys(e),i=n.length;for(let d=0;d<i;d++){if(o=n[d],!r||!r[o]){const s=e[o],n=t[o];if(typeof s!=typeof n)return!1;if(a(s)&&a(n)){if(!A(s,n,r))return!1}else if(s!==n)return!1}s[o]=!0}n=Object.keys(t),i=n.length;for(let e=0;e<i;e++)if(o=n[e],!s[o])return!1;return!0},y=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),D=e=>{const t=e.match(y)||[];return{scheme:t[2],authority:t[4],path:t[5],query:t[7],fragment:t[9]}},C="0".charCodeAt(0),I="1".charCodeAt(0),v="9".charCodeAt(0),b="a".charCodeAt(0),T="A".charCodeAt(0),P="f".charCodeAt(0),w="F".charCodeAt(0),R=e=>{const t=e.charCodeAt(0);return t>=C&&t<=v||t>=b&&t<=P||t>=T&&t<=w},O=e=>e.length>=3&&"%"===e.charAt(0)&&R(e.charAt(1))&&R(e.charAt(2)),k=e=>{const t=e.charCodeAt(0);return t>=C&&t<=v?t-C:t>=b&&t<=P?10+t-b:t>=T&&t<=w?10+t-T:0},S="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_.~",N="0123456789ABCDEF",L=e=>{const t=[];for(let r=0;r<128;++r)t.push(-1!==e.indexOf(String.fromCharCode(r)));return t},M=L(S+":/?#[]@!$&'()*+,;="),X=L(S),B=L(S+"/"),x=(e,t)=>{if(e<128&&t[e])return String.fromCharCode(e);let r="%";return r+=N.charAt(e>>4&15),r+=N.charAt(15&e),r},j=e=>{const t=[];for(let r=0;r<e.length;r++){let s=e.charCodeAt(r);s<128?t.push(s):s<2048?t.push(192|s>>6,128|63&s):s<55296||s>=57344?t.push(224|s>>12,128|s>>6&63,128|63&s):++r<e.length&&(s=65536+((1023&s)<<10|1023&e.charCodeAt(r)),t.push(240|s>>18,128|s>>12&63,128|s>>6&63,128|63&s))}return t},U=(e,t)=>{const r=j(e);let s="";for(let e=0;e<r.length;e++)s+=x(r[e],t);return s},V=e=>(e=e.normalize("NFC"),U(e,X)),H=e=>{e=e.normalize("NFC");let t=0,r="";for(;t<e.length;)O(e.substr(t))?(r+=e.substr(t,3),t+=3):r+=U(e.charAt(t++),M);return r},F=(e,t)=>{let r=0,s="",o=!1,n=!1,i=!1,a=!0,d=!0,c=!1,h="",l="",u=",",p=-1;const _=e=>{if(s+=a?l:c||d?u:",",n&&h&&(a||c||d)&&(s+=V(h),(!i||e.length>0)&&(s+="=")),e){let t;t=o?H(e):V(e),p>0&&(t=((e,t)=>{let r=0;for(;r<e.length&&t>0;){if(O(e.substr(r))){let t=(k(e.substr(r+1))<<4)+k(e.substr(r+2));if(r+=3,!(192&~t))for(;r<e.length&&O(e.substr(r))&&(t=(k(e.substr(r+1))<<4)+k(e.substr(r+2)),r+=3,128==(192&t)););}else++r;--t}return e.substr(0,r)})(t,p)),s+=t}a=!1,d=!1};for(;r<e.length;)if("{"===e.charAt(r)){if(++r<e.length){switch(o=!1,n=!1,l="",u=",",i=!1,e.charAt(r++)){case"+":o=!0;break;case"#":l="#",o=!0;break;case".":l=".",u=".";break;case"/":l="/",u="/";break;case";":l=";",u=";",n=i=!0;break;case"?":l="?",u="&",n=!0;break;case"&":l="&",u="&",n=!0;break;default:--r}for(h="",a=!0,d=!0;r<e.length;)if("}"===e.charAt(r)||","===e.charAt(r)||"*"===e.charAt(r)||":"===e.charAt(r)){if(c=!1,p=-1,"*"===e.charAt(r)){if(c=!0,++r>=e.length)break}else if(":"===e.charAt(r)){if(++r>=e.length)break;for(e.charCodeAt(r)>=I&&e.charCodeAt(r)<=v&&(p=0);r<e.length&&e.charCodeAt(r)>=C&&e.charCodeAt(r)<=v&&p<1e4;)p=10*p+(e.charCodeAt(r++)-C);if(r>=e.length)break}for(;r<e.length&&"}"!==e.charAt(r)&&","!==e.charAt(r);)++r;if(h.length>0&&"*"===h.charAt(h.length-1)&&(c=!0,h=h.substr(0,h.length-1)),h.length>0){const e=t?t[h]:void 0;if(e||""===e)if(Array.isArray(e)){p=-1;for(let t=0;t<e.length;t++)_(String(e[t]))}else if("object"==typeof e&&null!==e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(f=t,g=String(e[t]),s+=a?l:c||d?u:",",n&&h&&a&&!c&&(s+=V(h),(!i||g.length>0)&&(s+="=")),f&&(s+=o?H(f):V(f),s+=c?"=":",",g&&(s+=o?H(g):V(g))),a=!1,d=!1);else _(String(e))}if("}"===e.charAt(r++))break;h="",d=!0}else h+=e.charAt(r++)}}else O(e.substr(r))?(s+=e.substr(r,3),r+=3):s+=U(e.charAt(r++),M);var f,g;return s},Y=(e,t)=>e&&t?e.indexOf(t):-1,W=e=>e?e.search("(text|image|audio|video|ingredient|document|model|application|font)\\/"):-1;function z(e){return this instanceof z?(this.v=e,this):new z(e)}function q(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,o=r.apply(e,t||[]),n=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){o[e]&&(s[e]=function(t){return new Promise((function(r,s){n.push([e,t,r,s])>1||a(e,t)}))})}function a(e,t){try{(r=o[e](t)).value instanceof z?Promise.resolve(r.value.v).then(d,c):h(n[0][2],r)}catch(e){h(n[0][3],e)}var r}function d(e){a("next",e)}function c(e){a("throw",e)}function h(e,t){e(t),n.shift(),n.length&&a(n[0][0],n[0][1])}}function K(e,t){return e?(null!=t&&(e=e.slice(0,t)),(new TextDecoder).decode(e)):""}function G(e){return(new TextEncoder).encode(e)}const $=[/^(?!^501$|^507$)^(5\d{2})$|429|423$/],J=(e,t)=>{return"object"==typeof(r=e)&&"function"==typeof r.test?e.test(t.toString()):t===e;var r},Z=/^([^:]+):(.*)$/,Q=/^\s+|\s+$/g,ee=(e,t,r)=>c(t)?new n.DCXError(n.DCXError.INVALID_PARAMS,`Param '${e}' type must be one of: [${t.join(",")}].${r&&r.length>0?" Possible values: "+r.join(", ")+".":""}`):new n.DCXError(n.DCXError.INVALID_PARAMS,`Param '${e}' must be of type '${t}'.${r&&r.length>0?" Possible values: "+r.join(", ")+".":""}`),te=(e,t,r,s=!1,o=[])=>{if(s&&null==t)return!0;if(c(r)){for(const n in r){const i=r[n];try{return te(e,t,i,s,o),!0}catch(e){}}throw ee(e,r,o)}if("null"===r&&null!==t||"undefined"===r&&void 0!==t||"nullish"===r&&null!=t)throw ee(e,r,o);if("null"===r||"undefined"===r||"nullish"===r)return!0;if(!s&&null==t)throw ee(e,r,o);if(r.endsWith("[]")){if(!c(t))throw ee(e,r,o);return t.forEach(((t,s)=>{te(`${e}[${s}]`,t,r.substr(0,r.length-2))})),!0}let n=r.toLowerCase();switch(r){case"integer":case"+number":case"-number":n="number"}if("array"===n){if(!c(t))throw ee(e,r,o)}else if("enum"!==n){if(typeof t!==n)throw ee(e,r,o);if("integer"===r&&("number"!=typeof t||!Number.isInteger(t)))throw ee(e,r,o);if("+number"===r&&("number"!=typeof t||t<0))throw ee(e,r,o);if("-number"===r&&("number"!=typeof t||t>0))throw ee(e,r,o)}if(o.length>0){const s=o.length;let n=!1;for(let e=0;e<s;e++)if(o[e]===t){n=!0;break}if(!n)throw ee(e,r,o)}return!0};function re(...e){return e.map((e=>te(...e)))}function se(e,t){const r={};for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&void 0!==e[t]&&(r[t]=1);for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&void 0!==t[e]&&delete r[e];return Object.keys(r)}function oe(e,t){return{operations:e.operations.concat(t),cost:e.cost+1}}function ne(e,t,r,s=ne){if(e===t)return[];const o=c(e),n=c(t);return o&&n?function(e,t,r,s){const o={"0,0":{operations:[],cost:0}},n=isNaN(e.length)||e.length<=0?0:e.length,i=isNaN(t.length)||t.length<=0?0:t.length,a=function r(n,i){const a=`${n},${i}`;let d=o[a];if(void 0===d){if(n>0&&i>0&&!s(e[n-1],t[i-1],new de).length)d=r(n-1,i-1);else{const s=[];if(n>0){const e=r(n-1,i),t={op:"remove",index:n-1};s.push(oe(e,t))}if(i>0){const e=r(n,i-1),o={op:"add",index:n-1,value:t[i-1]};s.push(oe(e,o))}if(n>0&&i>0){const o=r(n-1,i-1),a={op:"replace",index:n-1,original:e[n-1],value:t[i-1]};s.push(oe(o,a))}d=s.sort(((e,t)=>e.cost-t.cost))[0]}o[a]=d}return d}(n,i).operations,[d]=a.reduce((([e,t],o)=>{if(function(e){return"add"===e.op}(o)){const s=o.index+1+t,i=s<n+t?String(s):"-",a={op:o.op,path:r.add(i).toString(),value:o.value};return[e.concat(a),t+1]}if(function(e){return"remove"===e.op}(o)){const s={op:o.op,path:r.add(String(o.index+t)).toString()};return[e.concat(s),t-1]}const i=r.add(String(o.index+t)),a=s(o.original,o.value,i);return[e.concat(...a),t]}),[[],0]);return d}(e,t,r,s):!o&&!n&&a(e)&&a(t)?function(e,t,r,s){const o=[];return se(e,t).forEach((e=>{o.push({op:"remove",path:r.add(e).toString()})})),se(t,e).forEach((e=>{o.push({op:"add",path:r.add(e).toString(),value:t[e]})})),function(e){const t=e.length,r={};for(let s=0;s<t;s++){const t=e[s];for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&void 0!==t[e]&&(r[e]=(r[e]||0)+1)}for(const e in r)r[e]<t&&delete r[e];return Object.keys(r)}([e,t]).forEach((n=>{o.push(...s(e[n],t[n],r.add(n)))})),o}(e,t,r,s):[{op:"replace",path:r.toString(),value:t}]}function ie(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function ae(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}class de{constructor(e=[""]){this.tokens=e}static fromJSON(e){const t=e.split("/").map(ie);if(""!==t[0])throw new n.DCXError(n.DCXError.INVALID_DATA,`Invalid JSON Pointer: ${e}`);return new de(t)}toString(){return this.tokens.map(ae).join("/")}evaluate(e){let t=null,r="",s=e;for(let e=1,o=this.tokens.length;e<o;e++)t=s,r=this.tokens[e],s=(t||{})[r];return{parent:t,key:r,value:s}}get(e){return this.evaluate(e).value}set(e,t){let r=e;for(let e=1,t=this.tokens.length-1,s=this.tokens[e];e<t;e++)r=(r||{})[s];r&&(r[this.tokens[this.tokens.length-1]]=t)}push(e){this.tokens.push(e)}add(e){const t=this.tokens.concat(String(e));return new de(t)}}class ce{get operations(){return this._operations}constructor(e=[]){this._operations=e}getDocument(){return JSON.stringify(this._operations)}add(e,t){return re(["path",e,"string"]),this._operations.push({op:"add",path:e,value:t}),this}addToList(e,t,r){if(re(["path",e,"string"]),"number"!=typeof r&&"end"!==r&&"-"!==r)throw new n.DCXError(n.DCXError.INVALID_PARAMS,'Index must be a number, or either "end"/"-" to append to end.');return this._operations.push({op:"add",value:t,path:`${e.endsWith("/")?e:e+"/"}${"end"===r?"-":r}`}),this}remove(e){return re(["path",e,"string"]),this._operations.push({op:"remove",path:e}),this}replace(e,t){return re(["path",e,"string"]),this._operations.push({op:"replace",path:e,value:t}),this}move(e,t){return re(["source",e,"string"],["destination",t,"string"]),this._operations.push({op:"move",from:e,path:t}),this}copy(e,t){return re(["source",e,"string"],["destination",t,"string"]),this._operations.push({op:"copy",from:e,path:t}),this}}function he(e,t){return{property:e,issue:t}}function le(e){const t=[];if("object"!=typeof e||null==e||c(e))return t.push(he("*","Operation not an object.")),t;switch("string"!=typeof e.path&&t.push(he("path","Missing or invalid.")),e.op){case"remove":break;case"add":case"replace":null==e.value&&t.push(he("value","Missing or invalid. Required for add/replace."));break;case"move":case"copy":"string"!=typeof e.from&&t.push(he("from","Missing or invalid. Required for move/copy."));break;default:t.push(he("op","Missing or invalid."))}return!(t.length>0)||t}function ue(e,t={mode:"id"}){let r=e[0],s=0;for(const o of e){let e=0;for(const r in o)r in t&&o[r]===t[r]&&e++;e>s&&(s=e,r=o)}return r}function pe(e){if(!a(e))throw new Error("Expecting object");const t={};for(const r in e)null!=e[r]&&(t[r]=e[r]);return t}const _e=/^utf-?8|ascii|utf-?16-?le|ucs-?2|base-?64|latin-?1$/i,fe=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,ge=/\s|\uFEFF|\xA0/,me=/\r?\n[\x20\x09]+/g,Ee=/[;,"]/,Ae=/[;,"]|\s/;function ye(e){return e.replace(fe,"")}function De(e){return ge.test(e)}function Ce(e,t){for(;De(e[t]);)t++;return t}function Ie(e){return Ae.test(e)}class ve{constructor(e){this.refs=[],e&&this.parse(e)}rel(e){const t=[];for(let r=0;r<this.refs.length;r++)this.refs[r].rel===e&&t.push(this.refs[r]);return t}get(e,t){e=e.toLowerCase();const r=[];for(let s=0;s<this.refs.length;s++)this.refs[s][e]===t&&r.push(this.refs[s]);return r}set(e){return this.refs.push(e),this}has(e,t){e=e.toLowerCase();for(let r=0;r<this.refs.length;r++)if(this.refs[r][e]===t)return!0;return!1}parse(e,t=0){let r=t?e.slice(t):e;r=ye(r).replace(me,"");let s=1;const o=r.length;let n=0,i=null;for(;n<o;)if(1===s){if(De(r[n])){n++;continue}if("<"!==r[n])throw new Error('Unexpected character "'+r[n]+'" at offset '+n);{const e=r.indexOf(">",n);if(-1===e)throw new Error("Expected end of URI delimiter at offset "+n);i={uri:r.slice(n+1,e)},this.refs.push(i),n=e,s=2}n++}else if(2===s){if(De(r[n])){n++;continue}if(";"===r[n])s=4,n++;else{if(","!==r[n])throw new Error('Unexpected character "'+r[n]+'" at offset '+n);s=1,n++}}else{if(4!==s)throw new Error('Unknown parser state "'+s+'"');{if(";"===r[n]||De(r[n])){n++;continue}const e=r.indexOf("=",n);if(-1===e)throw new Error("Expected attribute delimiter at offset "+n);const t=ye(r.slice(n,e)).toLowerCase();let a="";if(n=e+1,n=Ce(r,n),'"'===r[n])for(n++;n<o;){if('"'===r[n]){n++;break}"\\"===r[n]&&n++,a+=r[n],n++}else{let e=n+1;for(;!Ee.test(r[e])&&e<o;)e++;a=r.slice(n,e),n=e}if(i&&i[t]&&Te(t));else if(i&&"*"===t[t.length-1])i[t]=we(a);else if(a="rel"===t||"type"===t?a.toLowerCase():a,i&&null!=i[t]){const e=i[t];c(e)?e.push(a):i[t]=[i[t],a]}else{if(!i)throw new Error("Unexpected null ref");i[t]=a}switch(r[n]){case",":s=1;break;case";":s=4}n++}}return i=null,this}toString(){const e=[];let t,r="";for(let s=0;s<this.refs.length;s++)t=this.refs[s],r=Object.keys(this.refs[s]).reduce((function(e,r){return"uri"===r?e:e+"; "+Re(r,t[r])}),"<"+t.uri+">"),e.push(r);return e.join(", ")}}const be=e=>_e.test(e),Te=e=>"rel"===e||"type"===e||"media"===e||"title"===e||"title*"===e,Pe=e=>e.replace(/"/g,'\\"'),we=e=>{const t=/([^']+)?(?:'([^']+)')?(.+)/.exec(e)||[];return{language:t[2].toLowerCase(),encoding:be(t[1])?null:t[1].toLowerCase(),value:be(t[1])?decodeURIComponent(t[3]):t[3]}},Re=(e,t)=>Array.isArray(t)?t.map((t=>Re(e,t))).join("; "):"*"===e[e.length-1]||"string"!=typeof t?((e,t)=>{const r=(t.encoding||"utf-8").toUpperCase(),o=t.language||"en";let n="";return n=s.isBuffer(t.value)&&be(r)?t.value.toString(r):s.isBuffer(t.value)?t.value.toString("hex").replace(/[0-9a-f]{2}/gi,"%$1"):encodeURIComponent(t.value),e+"="+r+"'"+o+"'"+n})(e,t):((e=>"rel"===e||"type"===e||"anchor"===e)(e)?t=Ie(t)?'"'+Pe(t)+'"':Pe(t):Ie(t)&&(t='"'+(t=(t=encodeURIComponent(t)).replace(/%20/g," ").replace(/%2C/g,",").replace(/%3B/g,";"))+'"'),e+"="+t);function Oe(e,t,r,s="id"){const o=Le(e)[t];if(o){if(Array.isArray(o)){const e=o.filter((e=>e.mode===s));return e.length>0?e[0][r]:o.length>0?o[0][r]:void 0}return o[r]}}function ke(e,t,r="id"){const s=Le(e),o=s[t];let i;if(a(o)&&"string"==typeof o.href?i=o.href:Array.isArray(o)&&(i=Oe(s,t,"href",r)),"string"!=typeof i)throw new n.DCXError(n.DCXError.INVALID_PARAMS,"Missing or invalid link href.");return i}function Se(e,t,r,s="id"){const o=ke(Le(e),t,s);return F(o,pe(r))}const Ne=(e,t=0)=>(new ve).parse(e,t);function Le(e){return a(e)?"_links"in e?e._links:"links"in e?e.links:e:{}}let Me;const Xe=()=>{if(Me)return Me;const e=h();return Me=e&&a(r.g.performance)&&d(r.g.performance.now)?r.g.performance:e&&a(r.g.perf_hooks)&&a(r.g.perf_hooks.performance)&&d(r.g.perf_hooks.performance.now)?r.g.perf_hooks.performance:l()&&a(self.performance)&&d(self.performance.now)?self.performance:Date,Me},Be=Object.freeze({__proto__:null,Link:ve,getLinkProperty:Oe,getLinkHref:ke,getLinkHrefTemplated:Se,parse:Ne});t.DEFAULT_RETRY_CODES=$,t.EventEmitter=class{constructor(e){this._handlers={},e.forEach((e=>{this._handlers[e]=[]}))}on(e,t){return this._handlers[e].push(t)-1}emit(e,t){this._handlers[e].forEach((e=>{d(e)&&e(...t)}))}removeHandler(e,t){delete this._handlers[e][t]}removeAllHandlers(e){e?this._handlers[e]=[]:this._handlers={}}},t.JSONPatchPointer=de,t.Link=ve,t.LinkUtils=Be,t.SDKType=u,t.WatchProxy=function(e){if(e.__watch_proxy__)return e;if("watchProperty"in e)throw new Error("Cannot proxy object, watchProperty already exists.");let t={};const r=((e,r)=>{t[e]=t[e]||[],t[e].push(r)}).bind({listeners:t}),s={set:function(e,r,s){try{r in t&&c(t[r])&&t[r].map((t=>t.call(void 0,s,e[r],e)))}catch(e){throw e}return e[r]=s,!0}},{proxy:o,revoke:n}=Proxy.revocable(e,s);return Object.defineProperty(o,"__watch_proxy__",{value:!0,enumerable:!1,configurable:!0}),Object.defineProperty(o,"revokeWatchProxy",{value:()=>(n(),t={},delete e.__watch_proxy__,delete e.revokeWatchProxy,delete e.watchProperty,e),enumerable:!1,configurable:!0}),Object.defineProperty(o,"watchProperty",{value:r,enumerable:!1,configurable:!0}),o},t._toUTF8Array=j,t.appendPathElements=(...e)=>{if(!e||!Array.isArray(e))return"";const t=[],r=e.length;for(let s=0;s<r;s++){let o=e[s];"string"==typeof o&&""!==o&&(0===s&&1!==o.length||"/"===o.charAt(0)&&(o=o.slice(1)),s!==r-1&&"/"===o.charAt(o.length-1)&&(o=o.slice(0,o.length-1)),t.push(o))}return t.join("/")},t.arrayBufferToString=K,t.assert=(e,t)=>{if(!1===e())throw new n.DCXError(n.DCXError.INVALID_PARAMS,t)},t.asyncIterableFromStream=function(e){return q(this,arguments,(function*(){const t=e.getReader();try{for(;;){const{done:e,value:r}=yield z(t.read());if(e)return yield z(void 0);yield yield z(r)}}finally{t.releaseLock()}}))},t.checkRetriable=function(e,t=$){return!!e&&(Array.isArray(t)?t.some((t=>J(t,e))):J(t,e))},t.chunkArray=function(e,t){return e.reduce(((e,r,s)=>(s%t==0?e.unshift([r]):e[0].push(r),e)),[]).reverse()},t.combineInPlace=function(...e){if(e.length<2)return;const t=e.shift();p(t,...e),e.map((e=>{Object.assign(t,e)}))},t.concatUint8Arrays=function(e,t){const r=new Uint8Array(e.length+t.length);return r.set(e,0),r.set(t,e.length),r},t.consumeStream=(e,t,r)=>{e.on("data",r||E),e.on("end",t||E)},t.createJSONPatch=function(e,t,r){const s=new de;return(r?function(e){return function t(r,s,o){const n=e(r,s,o);return c(n)?n:ne(r,s,o,t)}}(r):ne)(e,t,s)},t.createPatchDocumentBuilder=function(e){return new ce(e)},t.dataToBuffer=function(e){return"string"==typeof e?G(e):e},t.deepCopy=e=>JSON.parse(JSON.stringify(e)),t.endPointOf=e=>{const t=D(e),r=t.scheme,s=t.authority,o="https"===r?443:"http"===r?80:-1;let n;return r&&s&&(n=(r+"://"+s).toLowerCase(),o>=0&&s.indexOf(":")<0&&(n=n+":"+o)),n},t.ensureRelativeHrefStartsWithSlash=e=>{if(e){const t=D(e),r=t.scheme,s=t.authority;r||s||"/"!==e.charAt(0)&&(e="/"+e)}return e},t.escapeURLPath=e=>(String.prototype.normalize?e=e.normalize("NFC"):console.warn("String.normalize not found while escaping URL path. You may be missing a polyfill."),e.length>0&&"/"===e.charAt(0)&&(e=e.substr(1)),U(e,B)),t.expandURITemplate=F,t.flatCopy=e=>{const t={},r=Object.keys(e),s=r.length;for(let o=0;o<s;o++){const s=r[o];t[s]=e[s]}return t},t.generateUuid=()=>o.v4(),t.getDomainFromURL=e=>{if(!e||"string"!=typeof e)return e;const t=(e=(e=(e=(e=e.indexOf("//")>-1?e.split("/")[2]:e.split("/")[0]).split("?")[0]).split("/")[0]).split(":")[0]).split(".");return t.slice(Math.max(t.length-2,0)).join(".")},t.getFirstRegexpCapture=(e,t)=>{if(!e||"string"!=typeof e||!t)return"";let r;return r="string"==typeof t?e.match(t):t.exec(e),r?r[1]:""},t.getLinkHref=ke,t.getLinkHrefTemplated=Se,t.getLinkProperty=Oe,t.getPerformance=Xe,t.getStartIdxOfMimeType=W,t.getSuffixIdxOfMimeType=Y,t.hexVal=k,t.isAnyFunction=e=>"function"==typeof e,t.isArray=c,t.isArrayBuffer=e=>a(e)&&d(e.constructor)&&"ArrayBuffer"===e.constructor.name&&d(e.slice),t.isArrayBufferView=e=>a(e)&&d(e.constructor)&&"DataView"===e.constructor.name&&a(e.buffer)&&d(e.buffer.slice),t.isAsyncFunction=e=>"[object AsyncFunction]"===toString.call(e),t.isBrowser=l,t.isBrowserSDK=()=>!0,t.isBuffer=e=>a(e)&&d(e.constructor)&&"Buffer"===e.constructor.name&&d(e.slice),t.isDefined=e=>null!=e,t.isFunction=d,t.isHexChar=R,t.isJsonContentType=e=>{if("string"!=typeof e)return!1;const t=e.toLowerCase().split("application/");if(t.length<2)return!1;const r=t[1].split(";")[0].trim();return"json"===r||r.endsWith("+json")},t.isNode=h,t.isNodeReadableStream=e=>i(e)&&d(e.on),t.isObject=a,t.isPctEncoding=O,t.isPromise=e=>null!=e&&a(e)&&d(e.then),t.isReadableStream=i,t.isUndefined=e=>null==e,t.isValidAbsolutePath=e=>m(e,!0),t.isValidAdobeURN=e=>/^urn:aaid:[a-zA-Z]{2}:[a-zA-Z0-9]{2,6}:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e),t.isValidPath=m,t.isVoid=e=>null==e,t.isWHATWGReadableStream=e=>i(e)&&d(e.pipeTo),t.isWebWorker=()=>l()&&!!self.WorkerGlobalScope,t.merge=p,t.mergeDeep=_,t.noOp=E,t.normalizeHeaders=e=>{if(null===e||"object"!=typeof e)return{};const t={};for(const[r,s]of Object.entries(e))t[r.toLowerCase()]=c(s)?s.join(";"):s;return t},t.now=()=>Xe().now(),t.objectFromEntries=function(e){const t={};for(const[r,s]of e)t[r]=s;return t},t.objectsEqual=A,t.parse=Ne,t.parseHeaders=e=>{const t={},r=e.split(/\r?\n/);let s,o;for(let e=0;e<r.length;++e){const n=r[e];if(n.length>0){const e=n.charCodeAt(0);if(!s||9!==e&&32!==e){const e=Z.exec(n);e&&e.length>1&&(s=e[1].toLowerCase(),o=e[2]||"",o=o.replace(Q,""),t[s]?t[s]=t[s]+","+o:t[s]=o)}else t[s]=t[s]+" "+n.replace(Q,"")}}return t},t.parseURI=D,t.provideLink=function(e,t={},r){const s="function"==typeof t.selector?t.selector:ue,o=Array.isArray(e)?s(e,r):e;if(!o)throw new n.DCXError(n.DCXError.INVALID_PARAMS,"Could not select appropriate link for usage");return o.templated?"function"==typeof t.expander?t.expander(o.href,r):F(o.href,r):o.href},t.pruneUndefined=pe,t.removeLeadingSlashForPath=e=>(e.length>0&&"/"===e.charAt(0)&&(e=e.substr(1)),e),t.safeGet=function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]},t.stringToBuffer=G,t.timeStamp=(e=!1)=>{let t=(new Date).getTime();return e&&(t-=t%1e3),t},t.validateJSONPatchDocument=function(e){if(!c(e))return[he("doc","Invalid type.")];const t=[];return e.forEach(((e,r)=>{const s=le(e);!0!==s&&s.forEach((e=>{e.property=`doc[${r}].${e.property}`,t.push(e)}))})),!(t.length>0)||t},t.validateJSONPatchOperation=le,t.validateObject=function(e,t,...r){if(t=t?" "+t+" ":" ",!e||"object"!=typeof e)throw new n.DCXError(n.DCXError.INVALID_PARAMS,`Object${t}is invalid.`);try{r.forEach((t=>{te(t[0],e[t[0]],t[1],t[2]||!1,t[3]||[])}))}catch(e){throw new n.DCXError(n.DCXError.INVALID_PARAMS,`Object${t}is invalid. ${e.message.replace("Param","Property")}`,e)}},t.validateParam=te,t.validateParams=re,t.verifyUuid=e=>o.validate(e),t.verifyandGetSnapshotMimetype=e=>{const t=K(e,100),r=Y(t,"+dcxucf"),s=W(t);return r>-1&&s>-1?t.substring(s,r+7):""},t.withRetries=function e(t,r=3){return t().catch((s=>{if(r)return e(t,r-1);throw s}))}},499164:(e,t,r)=>{var s=r(640430).lW;Object.defineProperty(t,"__esModule",{value:!0});var o=r(979672),n=r(45276);const i=e=>a(e)&&(d(e.pipe)||d(e.pipeTo)),a=e=>null!=e&&"object"==typeof e,d=e=>"function"==typeof e,c=e=>Array.isArray(e),h=()=>{try{return"[object process]"===Object.prototype.toString.call(r.g.process)}catch(e){return!1}},l=()=>"object"==typeof self&&self.self===self,u=()=>"browser",p=(...e)=>!e||!Array.isArray(e)||e.length<1?{}:e.reduce(((e,t)=>{const r=a(e)?e:{};if(a(t))for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&(r[e]=t[e]);return r})),_=(e,...t)=>{if(!t.length)return e;const r=t.shift();if(a(e)&&a(r))for(const t in r)a(r[t])&&!c(r[t])?(e[t]||Object.assign(e,{[t]:{}}),_(e[t],r[t])):c(e[t])&&c(r[t])?Object.assign(e,{[t]:r[t]}):Object.assign(e,{[t]:r[t]});return _(e,...t)},f=/^(CON|PRN|AUX|NUL|COM\d|LPT\d)(\..+)?$/,g=/[\u0000-\u001F\u0022\u002A\u003A\u003C\u003E\u003F\u005C\u007F\u007C]/,m=(e,t=!1)=>{try{if(e.length>65535)return!1;const r=(t?e.slice(1):e).split("/");if(!r||0===r.length)return!1;for(const e of r){if(e.length<1||e.length>255)return!1;if(g.test(e))return!1;if(e.endsWith(".")||e.endsWith(" "))return!1;if(f.test(e))return!1;if(e.startsWith("dcx")||e.startsWith(".dcx"))return!1;if("manifest"===e||"mimetype"===e)return!1}return!(t&&(!e.startsWith("/")||e.endsWith("/")))}catch(e){return!1}},E=()=>{},A=(e,t,r)=>{const s={};let o,n=Object.keys(e),i=n.length;for(let d=0;d<i;d++){if(o=n[d],!r||!r[o]){const s=e[o],n=t[o];if(typeof s!=typeof n)return!1;if(a(s)&&a(n)){if(!A(s,n,r))return!1}else if(s!==n)return!1}s[o]=!0}n=Object.keys(t),i=n.length;for(let e=0;e<i;e++)if(o=n[e],!s[o])return!1;return!0},y=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),D=e=>{const t=e.match(y)||[];return{scheme:t[2],authority:t[4],path:t[5],query:t[7],fragment:t[9]}},C="0".charCodeAt(0),I="1".charCodeAt(0),v="9".charCodeAt(0),b="a".charCodeAt(0),T="A".charCodeAt(0),P="f".charCodeAt(0),w="F".charCodeAt(0),R=e=>{const t=e.charCodeAt(0);return t>=C&&t<=v||t>=b&&t<=P||t>=T&&t<=w},O=e=>e.length>=3&&"%"===e.charAt(0)&&R(e.charAt(1))&&R(e.charAt(2)),k=e=>{const t=e.charCodeAt(0);return t>=C&&t<=v?t-C:t>=b&&t<=P?10+t-b:t>=T&&t<=w?10+t-T:0},S="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_.~",N="0123456789ABCDEF",L=e=>{const t=[];for(let r=0;r<128;++r)t.push(-1!==e.indexOf(String.fromCharCode(r)));return t},M=L(S+":/?#[]@!$&'()*+,;="),X=L(S),B=L(S+"/"),x=(e,t)=>{if(e<128&&t[e])return String.fromCharCode(e);let r="%";return r+=N.charAt(e>>4&15),r+=N.charAt(15&e),r},j=e=>{const t=[];for(let r=0;r<e.length;r++){let s=e.charCodeAt(r);s<128?t.push(s):s<2048?t.push(192|s>>6,128|63&s):s<55296||s>=57344?t.push(224|s>>12,128|s>>6&63,128|63&s):++r<e.length&&(s=65536+((1023&s)<<10|1023&e.charCodeAt(r)),t.push(240|s>>18,128|s>>12&63,128|s>>6&63,128|63&s))}return t},U=(e,t)=>{const r=j(e);let s="";for(let e=0;e<r.length;e++)s+=x(r[e],t);return s},V=e=>(e=e.normalize("NFC"),U(e,X)),H=e=>{e=e.normalize("NFC");let t=0,r="";for(;t<e.length;)O(e.substr(t))?(r+=e.substr(t,3),t+=3):r+=U(e.charAt(t++),M);return r},F=(e,t)=>{let r=0,s="",o=!1,n=!1,i=!1,a=!0,d=!0,c=!1,h="",l="",u=",",p=-1;const _=e=>{if(s+=a?l:c||d?u:",",n&&h&&(a||c||d)&&(s+=V(h),(!i||e.length>0)&&(s+="=")),e){let t;t=o?H(e):V(e),p>0&&(t=((e,t)=>{let r=0;for(;r<e.length&&t>0;){if(O(e.substr(r))){let t=(k(e.substr(r+1))<<4)+k(e.substr(r+2));if(r+=3,!(192&~t))for(;r<e.length&&O(e.substr(r))&&(t=(k(e.substr(r+1))<<4)+k(e.substr(r+2)),r+=3,128==(192&t)););}else++r;--t}return e.substr(0,r)})(t,p)),s+=t}a=!1,d=!1};for(;r<e.length;)if("{"===e.charAt(r)){if(++r<e.length){switch(o=!1,n=!1,l="",u=",",i=!1,e.charAt(r++)){case"+":o=!0;break;case"#":l="#",o=!0;break;case".":l=".",u=".";break;case"/":l="/",u="/";break;case";":l=";",u=";",n=i=!0;break;case"?":l="?",u="&",n=!0;break;case"&":l="&",u="&",n=!0;break;default:--r}for(h="",a=!0,d=!0;r<e.length;)if("}"===e.charAt(r)||","===e.charAt(r)||"*"===e.charAt(r)||":"===e.charAt(r)){if(c=!1,p=-1,"*"===e.charAt(r)){if(c=!0,++r>=e.length)break}else if(":"===e.charAt(r)){if(++r>=e.length)break;for(e.charCodeAt(r)>=I&&e.charCodeAt(r)<=v&&(p=0);r<e.length&&e.charCodeAt(r)>=C&&e.charCodeAt(r)<=v&&p<1e4;)p=10*p+(e.charCodeAt(r++)-C);if(r>=e.length)break}for(;r<e.length&&"}"!==e.charAt(r)&&","!==e.charAt(r);)++r;if(h.length>0&&"*"===h.charAt(h.length-1)&&(c=!0,h=h.substr(0,h.length-1)),h.length>0){const e=t?t[h]:void 0;if(e||""===e)if(Array.isArray(e)){p=-1;for(let t=0;t<e.length;t++)_(String(e[t]))}else if("object"==typeof e&&null!==e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&(f=t,g=String(e[t]),s+=a?l:c||d?u:",",n&&h&&a&&!c&&(s+=V(h),(!i||g.length>0)&&(s+="=")),f&&(s+=o?H(f):V(f),s+=c?"=":",",g&&(s+=o?H(g):V(g))),a=!1,d=!1);else _(String(e))}if("}"===e.charAt(r++))break;h="",d=!0}else h+=e.charAt(r++)}}else O(e.substr(r))?(s+=e.substr(r,3),r+=3):s+=U(e.charAt(r++),M);var f,g;return s},Y=(e,t)=>e&&t?e.indexOf(t):-1,W=e=>e?e.search("(text|image|audio|video|ingredient|document|model|application|font)\\/"):-1;function z(e){return this instanceof z?(this.v=e,this):new z(e)}function q(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,o=r.apply(e,t||[]),n=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(e){o[e]&&(s[e]=function(t){return new Promise((function(r,s){n.push([e,t,r,s])>1||a(e,t)}))})}function a(e,t){try{(r=o[e](t)).value instanceof z?Promise.resolve(r.value.v).then(d,c):h(n[0][2],r)}catch(e){h(n[0][3],e)}var r}function d(e){a("next",e)}function c(e){a("throw",e)}function h(e,t){e(t),n.shift(),n.length&&a(n[0][0],n[0][1])}}function K(e,t){return e?(null!=t&&(e=e.slice(0,t)),(new TextDecoder).decode(e)):""}function G(e){return(new TextEncoder).encode(e)}const $=[/^(?!^501$|^507$)^(5\d{2})$|429|423$/],J=(e,t)=>{return"object"==typeof(r=e)&&"function"==typeof r.test?e.test(t.toString()):t===e;var r},Z=/^([^:]+):(.*)$/,Q=/^\s+|\s+$/g,ee=(e,t,r)=>c(t)?new n.DCXError(n.DCXError.INVALID_PARAMS,`Param '${e}' type must be one of: [${t.join(",")}].${r&&r.length>0?" Possible values: "+r.join(", ")+".":""}`):new n.DCXError(n.DCXError.INVALID_PARAMS,`Param '${e}' must be of type '${t}'.${r&&r.length>0?" Possible values: "+r.join(", ")+".":""}`),te=(e,t,r,s=!1,o=[])=>{if(s&&null==t)return!0;if(c(r)){for(const n in r){const i=r[n];try{return te(e,t,i,s,o),!0}catch(e){}}throw ee(e,r,o)}if("null"===r&&null!==t||"undefined"===r&&void 0!==t||"nullish"===r&&null!=t)throw ee(e,r,o);if("null"===r||"undefined"===r||"nullish"===r)return!0;if(!s&&null==t)throw ee(e,r,o);if(r.endsWith("[]")){if(!c(t))throw ee(e,r,o);return t.forEach(((t,s)=>{te(`${e}[${s}]`,t,r.substr(0,r.length-2))})),!0}let n=r.toLowerCase();switch(r){case"integer":case"+number":case"-number":n="number"}if("array"===n){if(!c(t))throw ee(e,r,o)}else if("enum"!==n){if(typeof t!==n)throw ee(e,r,o);if("integer"===r&&("number"!=typeof t||!Number.isInteger(t)))throw ee(e,r,o);if("+number"===r&&("number"!=typeof t||t<0))throw ee(e,r,o);if("-number"===r&&("number"!=typeof t||t>0))throw ee(e,r,o)}if(o.length>0){const s=o.length;let n=!1;for(let e=0;e<s;e++)if(o[e]===t){n=!0;break}if(!n)throw ee(e,r,o)}return!0};function re(...e){return e.map((e=>te(...e)))}function se(e,t){const r={};for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&void 0!==e[t]&&(r[t]=1);for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&void 0!==t[e]&&delete r[e];return Object.keys(r)}function oe(e,t){return{operations:e.operations.concat(t),cost:e.cost+1}}function ne(e,t,r,s=ne){if(e===t)return[];const o=c(e),n=c(t);return o&&n?function(e,t,r,s){const o={"0,0":{operations:[],cost:0}},n=isNaN(e.length)||e.length<=0?0:e.length,i=isNaN(t.length)||t.length<=0?0:t.length,a=function r(n,i){const a=`${n},${i}`;let d=o[a];if(void 0===d){if(n>0&&i>0&&!s(e[n-1],t[i-1],new de).length)d=r(n-1,i-1);else{const s=[];if(n>0){const e=r(n-1,i),t={op:"remove",index:n-1};s.push(oe(e,t))}if(i>0){const e=r(n,i-1),o={op:"add",index:n-1,value:t[i-1]};s.push(oe(e,o))}if(n>0&&i>0){const o=r(n-1,i-1),a={op:"replace",index:n-1,original:e[n-1],value:t[i-1]};s.push(oe(o,a))}d=s.sort(((e,t)=>e.cost-t.cost))[0]}o[a]=d}return d}(n,i).operations,[d]=a.reduce((([e,t],o)=>{if(function(e){return"add"===e.op}(o)){const s=o.index+1+t,i=s<n+t?String(s):"-",a={op:o.op,path:r.add(i).toString(),value:o.value};return[e.concat(a),t+1]}if(function(e){return"remove"===e.op}(o)){const s={op:o.op,path:r.add(String(o.index+t)).toString()};return[e.concat(s),t-1]}const i=r.add(String(o.index+t)),a=s(o.original,o.value,i);return[e.concat(...a),t]}),[[],0]);return d}(e,t,r,s):!o&&!n&&a(e)&&a(t)?function(e,t,r,s){const o=[];return se(e,t).forEach((e=>{o.push({op:"remove",path:r.add(e).toString()})})),se(t,e).forEach((e=>{o.push({op:"add",path:r.add(e).toString(),value:t[e]})})),function(e){const t=e.length,r={};for(let s=0;s<t;s++){const t=e[s];for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&void 0!==t[e]&&(r[e]=(r[e]||0)+1)}for(const e in r)r[e]<t&&delete r[e];return Object.keys(r)}([e,t]).forEach((n=>{o.push(...s(e[n],t[n],r.add(n)))})),o}(e,t,r,s):[{op:"replace",path:r.toString(),value:t}]}function ie(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function ae(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}class de{constructor(e=[""]){this.tokens=e}static fromJSON(e){const t=e.split("/").map(ie);if(""!==t[0])throw new n.DCXError(n.DCXError.INVALID_DATA,`Invalid JSON Pointer: ${e}`);return new de(t)}toString(){return this.tokens.map(ae).join("/")}evaluate(e){let t=null,r="",s=e;for(let e=1,o=this.tokens.length;e<o;e++)t=s,r=this.tokens[e],s=(t||{})[r];return{parent:t,key:r,value:s}}get(e){return this.evaluate(e).value}set(e,t){let r=e;for(let e=1,t=this.tokens.length-1,s=this.tokens[e];e<t;e++)r=(r||{})[s];r&&(r[this.tokens[this.tokens.length-1]]=t)}push(e){this.tokens.push(e)}add(e){const t=this.tokens.concat(String(e));return new de(t)}}class ce{get operations(){return this._operations}constructor(e=[]){this._operations=e}getDocument(){return JSON.stringify(this._operations)}add(e,t){return re(["path",e,"string"]),this._operations.push({op:"add",path:e,value:t}),this}addToList(e,t,r){if(re(["path",e,"string"]),"number"!=typeof r&&"end"!==r&&"-"!==r)throw new n.DCXError(n.DCXError.INVALID_PARAMS,'Index must be a number, or either "end"/"-" to append to end.');return this._operations.push({op:"add",value:t,path:`${e.endsWith("/")?e:e+"/"}${"end"===r?"-":r}`}),this}remove(e){return re(["path",e,"string"]),this._operations.push({op:"remove",path:e}),this}replace(e,t){return re(["path",e,"string"]),this._operations.push({op:"replace",path:e,value:t}),this}move(e,t){return re(["source",e,"string"],["destination",t,"string"]),this._operations.push({op:"move",from:e,path:t}),this}copy(e,t){return re(["source",e,"string"],["destination",t,"string"]),this._operations.push({op:"copy",from:e,path:t}),this}}function he(e,t){return{property:e,issue:t}}function le(e){const t=[];if("object"!=typeof e||null==e||c(e))return t.push(he("*","Operation not an object.")),t;switch("string"!=typeof e.path&&t.push(he("path","Missing or invalid.")),e.op){case"remove":break;case"add":case"replace":null==e.value&&t.push(he("value","Missing or invalid. Required for add/replace."));break;case"move":case"copy":"string"!=typeof e.from&&t.push(he("from","Missing or invalid. Required for move/copy."));break;default:t.push(he("op","Missing or invalid."))}return!(t.length>0)||t}function ue(e,t={mode:"id"}){let r=e[0],s=0;for(const o of e){let e=0;for(const r in o)r in t&&o[r]===t[r]&&e++;e>s&&(s=e,r=o)}return r}function pe(e){if(!a(e))throw new Error("Expecting object");const t={};for(const r in e)null!=e[r]&&(t[r]=e[r]);return t}const _e=/^utf-?8|ascii|utf-?16-?le|ucs-?2|base-?64|latin-?1$/i,fe=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,ge=/\s|\uFEFF|\xA0/,me=/\r?\n[\x20\x09]+/g,Ee=/[;,"]/,Ae=/[;,"]|\s/;function ye(e){return e.replace(fe,"")}function De(e){return ge.test(e)}function Ce(e,t){for(;De(e[t]);)t++;return t}function Ie(e){return Ae.test(e)}class ve{constructor(e){this.refs=[],e&&this.parse(e)}rel(e){const t=[];for(let r=0;r<this.refs.length;r++)this.refs[r].rel===e&&t.push(this.refs[r]);return t}get(e,t){e=e.toLowerCase();const r=[];for(let s=0;s<this.refs.length;s++)this.refs[s][e]===t&&r.push(this.refs[s]);return r}set(e){return this.refs.push(e),this}has(e,t){e=e.toLowerCase();for(let r=0;r<this.refs.length;r++)if(this.refs[r][e]===t)return!0;return!1}parse(e,t=0){let r=t?e.slice(t):e;r=ye(r).replace(me,"");let s=1;const o=r.length;let n=0,i=null;for(;n<o;)if(1===s){if(De(r[n])){n++;continue}if("<"!==r[n])throw new Error('Unexpected character "'+r[n]+'" at offset '+n);{const e=r.indexOf(">",n);if(-1===e)throw new Error("Expected end of URI delimiter at offset "+n);i={uri:r.slice(n+1,e)},this.refs.push(i),n=e,s=2}n++}else if(2===s){if(De(r[n])){n++;continue}if(";"===r[n])s=4,n++;else{if(","!==r[n])throw new Error('Unexpected character "'+r[n]+'" at offset '+n);s=1,n++}}else{if(4!==s)throw new Error('Unknown parser state "'+s+'"');{if(";"===r[n]||De(r[n])){n++;continue}const e=r.indexOf("=",n);if(-1===e)throw new Error("Expected attribute delimiter at offset "+n);const t=ye(r.slice(n,e)).toLowerCase();let a="";if(n=e+1,n=Ce(r,n),'"'===r[n])for(n++;n<o;){if('"'===r[n]){n++;break}"\\"===r[n]&&n++,a+=r[n],n++}else{let e=n+1;for(;!Ee.test(r[e])&&e<o;)e++;a=r.slice(n,e),n=e}if(i&&i[t]&&Te(t));else if(i&&"*"===t[t.length-1])i[t]=we(a);else if(a="rel"===t||"type"===t?a.toLowerCase():a,i&&null!=i[t]){const e=i[t];c(e)?e.push(a):i[t]=[i[t],a]}else{if(!i)throw new Error("Unexpected null ref");i[t]=a}switch(r[n]){case",":s=1;break;case";":s=4}n++}}return i=null,this}toString(){const e=[];let t,r="";for(let s=0;s<this.refs.length;s++)t=this.refs[s],r=Object.keys(this.refs[s]).reduce((function(e,r){return"uri"===r?e:e+"; "+Re(r,t[r])}),"<"+t.uri+">"),e.push(r);return e.join(", ")}}const be=e=>_e.test(e),Te=e=>"rel"===e||"type"===e||"media"===e||"title"===e||"title*"===e,Pe=e=>e.replace(/"/g,'\\"'),we=e=>{const t=/([^']+)?(?:'([^']+)')?(.+)/.exec(e)||[];return{language:t[2].toLowerCase(),encoding:be(t[1])?null:t[1].toLowerCase(),value:be(t[1])?decodeURIComponent(t[3]):t[3]}},Re=(e,t)=>Array.isArray(t)?t.map((t=>Re(e,t))).join("; "):"*"===e[e.length-1]||"string"!=typeof t?((e,t)=>{const r=(t.encoding||"utf-8").toUpperCase(),o=t.language||"en";let n="";return n=s.isBuffer(t.value)&&be(r)?t.value.toString(r):s.isBuffer(t.value)?t.value.toString("hex").replace(/[0-9a-f]{2}/gi,"%$1"):encodeURIComponent(t.value),e+"="+r+"'"+o+"'"+n})(e,t):((e=>"rel"===e||"type"===e||"anchor"===e)(e)?t=Ie(t)?'"'+Pe(t)+'"':Pe(t):Ie(t)&&(t='"'+(t=(t=encodeURIComponent(t)).replace(/%20/g," ").replace(/%2C/g,",").replace(/%3B/g,";"))+'"'),e+"="+t);function Oe(e,t,r,s="id"){const o=Le(e)[t];if(o){if(Array.isArray(o)){const e=o.filter((e=>e.mode===s));return e.length>0?e[0][r]:o.length>0?o[0][r]:void 0}return o[r]}}function ke(e,t,r="id"){const s=Le(e),o=s[t];let i;if(a(o)&&"string"==typeof o.href?i=o.href:Array.isArray(o)&&(i=Oe(s,t,"href",r)),"string"!=typeof i)throw new n.DCXError(n.DCXError.INVALID_PARAMS,"Missing or invalid link href.");return i}function Se(e,t,r,s="id"){const o=ke(Le(e),t,s);return F(o,pe(r))}const Ne=(e,t=0)=>(new ve).parse(e,t);function Le(e){return a(e)?"_links"in e?e._links:"links"in e?e.links:e:{}}let Me;const Xe=()=>{if(Me)return Me;const e=h();return Me=e&&a(r.g.performance)&&d(r.g.performance.now)?r.g.performance:e&&a(r.g.perf_hooks)&&a(r.g.perf_hooks.performance)&&d(r.g.perf_hooks.performance.now)?r.g.perf_hooks.performance:l()&&a(self.performance)&&d(self.performance.now)?self.performance:Date,Me},Be=Object.freeze({__proto__:null,Link:ve,getLinkProperty:Oe,getLinkHref:ke,getLinkHrefTemplated:Se,parse:Ne});t.DEFAULT_RETRY_CODES=$,t.EventEmitter=class{constructor(e){this._handlers={},e.forEach((e=>{this._handlers[e]=[]}))}on(e,t){return this._handlers[e].push(t)-1}emit(e,t){this._handlers[e].forEach((e=>{d(e)&&e(...t)}))}removeHandler(e,t){delete this._handlers[e][t]}removeAllHandlers(e){e?this._handlers[e]=[]:this._handlers={}}},t.JSONPatchPointer=de,t.Link=ve,t.LinkUtils=Be,t.SDKType=u,t.WatchProxy=function(e){if(e.__watch_proxy__)return e;if("watchProperty"in e)throw new Error("Cannot proxy object, watchProperty already exists.");let t={};const r=((e,r)=>{t[e]=t[e]||[],t[e].push(r)}).bind({listeners:t}),s={set:function(e,r,s){try{r in t&&c(t[r])&&t[r].map((t=>t.call(void 0,s,e[r],e)))}catch(e){throw e}return e[r]=s,!0}},{proxy:o,revoke:n}=Proxy.revocable(e,s);return Object.defineProperty(o,"__watch_proxy__",{value:!0,enumerable:!1,configurable:!0}),Object.defineProperty(o,"revokeWatchProxy",{value:()=>(n(),t={},delete e.__watch_proxy__,delete e.revokeWatchProxy,delete e.watchProperty,e),enumerable:!1,configurable:!0}),Object.defineProperty(o,"watchProperty",{value:r,enumerable:!1,configurable:!0}),o},t._toUTF8Array=j,t.appendPathElements=(...e)=>{if(!e||!Array.isArray(e))return"";const t=[],r=e.length;for(let s=0;s<r;s++){let o=e[s];"string"==typeof o&&""!==o&&(0===s&&1!==o.length||"/"===o.charAt(0)&&(o=o.slice(1)),s!==r-1&&"/"===o.charAt(o.length-1)&&(o=o.slice(0,o.length-1)),t.push(o))}return t.join("/")},t.arrayBufferToString=K,t.assert=(e,t)=>{if(!1===e())throw new n.DCXError(n.DCXError.INVALID_PARAMS,t)},t.asyncIterableFromStream=function(e){return q(this,arguments,(function*(){const t=e.getReader();try{for(;;){const{done:e,value:r}=yield z(t.read());if(e)return yield z(void 0);yield yield z(r)}}finally{t.releaseLock()}}))},t.checkRetriable=function(e,t=$){return!!e&&(Array.isArray(t)?t.some((t=>J(t,e))):J(t,e))},t.chunkArray=function(e,t){return e.reduce(((e,r,s)=>(s%t==0?e.unshift([r]):e[0].push(r),e)),[]).reverse()},t.combineInPlace=function(...e){if(e.length<2)return;const t=e.shift();p(t,...e),e.map((e=>{Object.assign(t,e)}))},t.concatUint8Arrays=function(e,t){const r=new Uint8Array(e.length+t.length);return r.set(e,0),r.set(t,e.length),r},t.consumeStream=(e,t,r)=>{e.on("data",r||E),e.on("end",t||E)},t.createJSONPatch=function(e,t,r){const s=new de;return(r?function(e){return function t(r,s,o){const n=e(r,s,o);return c(n)?n:ne(r,s,o,t)}}(r):ne)(e,t,s)},t.createPatchDocumentBuilder=function(e){return new ce(e)},t.dataToBuffer=function(e){return"string"==typeof e?G(e):e},t.deepCopy=e=>JSON.parse(JSON.stringify(e)),t.endPointOf=e=>{const t=D(e),r=t.scheme,s=t.authority,o="https"===r?443:"http"===r?80:-1;let n;return r&&s&&(n=(r+"://"+s).toLowerCase(),o>=0&&s.indexOf(":")<0&&(n=n+":"+o)),n},t.ensureRelativeHrefStartsWithSlash=e=>{if(e){const t=D(e),r=t.scheme,s=t.authority;r||s||"/"!==e.charAt(0)&&(e="/"+e)}return e},t.escapeURLPath=e=>(String.prototype.normalize?e=e.normalize("NFC"):console.warn("String.normalize not found while escaping URL path. You may be missing a polyfill."),e.length>0&&"/"===e.charAt(0)&&(e=e.substr(1)),U(e,B)),t.expandURITemplate=F,t.flatCopy=e=>{const t={},r=Object.keys(e),s=r.length;for(let o=0;o<s;o++){const s=r[o];t[s]=e[s]}return t},t.generateUuid=()=>o.v4(),t.getDomainFromURL=e=>{if(!e||"string"!=typeof e)return e;const t=(e=(e=(e=(e=e.indexOf("//")>-1?e.split("/")[2]:e.split("/")[0]).split("?")[0]).split("/")[0]).split(":")[0]).split(".");return t.slice(Math.max(t.length-2,0)).join(".")},t.getFirstRegexpCapture=(e,t)=>{if(!e||"string"!=typeof e||!t)return"";let r;return r="string"==typeof t?e.match(t):t.exec(e),r?r[1]:""},t.getLinkHref=ke,t.getLinkHrefTemplated=Se,t.getLinkProperty=Oe,t.getPerformance=Xe,t.getStartIdxOfMimeType=W,t.getSuffixIdxOfMimeType=Y,t.hexVal=k,t.isAnyFunction=e=>"function"==typeof e,t.isArray=c,t.isArrayBuffer=e=>a(e)&&d(e.constructor)&&"ArrayBuffer"===e.constructor.name&&d(e.slice),t.isArrayBufferView=e=>a(e)&&d(e.constructor)&&"DataView"===e.constructor.name&&a(e.buffer)&&d(e.buffer.slice),t.isAsyncFunction=e=>"[object AsyncFunction]"===toString.call(e),t.isBrowser=l,t.isBrowserSDK=()=>!0,t.isBuffer=e=>a(e)&&d(e.constructor)&&"Buffer"===e.constructor.name&&d(e.slice),t.isDefined=e=>null!=e,t.isFunction=d,t.isHexChar=R,t.isJsonContentType=e=>{if("string"!=typeof e)return!1;const t=e.toLowerCase().split("application/");if(t.length<2)return!1;const r=t[1].split(";")[0].trim();return"json"===r||r.endsWith("+json")},t.isNode=h,t.isNodeReadableStream=e=>i(e)&&d(e.on),t.isObject=a,t.isPctEncoding=O,t.isPromise=e=>null!=e&&a(e)&&d(e.then),t.isReadableStream=i,t.isUndefined=e=>null==e,t.isValidAbsolutePath=e=>m(e,!0),t.isValidAdobeURN=e=>/^urn:aaid:[a-zA-Z]{2}:[a-zA-Z0-9]{2,6}:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e),t.isValidPath=m,t.isVoid=e=>null==e,t.isWHATWGReadableStream=e=>i(e)&&d(e.pipeTo),t.isWebWorker=()=>l()&&!!self.WorkerGlobalScope,t.merge=p,t.mergeDeep=_,t.noOp=E,t.normalizeHeaders=e=>{if(null===e||"object"!=typeof e)return{};const t={};for(const[r,s]of Object.entries(e))t[r.toLowerCase()]=c(s)?s.join(";"):s;return t},t.now=()=>Xe().now(),t.objectFromEntries=function(e){const t={};for(const[r,s]of e)t[r]=s;return t},t.objectsEqual=A,t.parse=Ne,t.parseHeaders=e=>{const t={},r=e.split(/\r?\n/);let s,o;for(let e=0;e<r.length;++e){const n=r[e];if(n.length>0){const e=n.charCodeAt(0);if(!s||9!==e&&32!==e){const e=Z.exec(n);e&&e.length>1&&(s=e[1].toLowerCase(),o=e[2]||"",o=o.replace(Q,""),t[s]?t[s]=t[s]+","+o:t[s]=o)}else t[s]=t[s]+" "+n.replace(Q,"")}}return t},t.parseURI=D,t.provideLink=function(e,t={},r){const s="function"==typeof t.selector?t.selector:ue,o=Array.isArray(e)?s(e,r):e;if(!o)throw new n.DCXError(n.DCXError.INVALID_PARAMS,"Could not select appropriate link for usage");return o.templated?"function"==typeof t.expander?t.expander(o.href,r):F(o.href,r):o.href},t.pruneUndefined=pe,t.removeLeadingSlashForPath=e=>(e.length>0&&"/"===e.charAt(0)&&(e=e.substr(1)),e),t.safeGet=function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t]},t.stringToBuffer=G,t.timeStamp=(e=!1)=>{let t=(new Date).getTime();return e&&(t-=t%1e3),t},t.validateJSONPatchDocument=function(e){if(!c(e))return[he("doc","Invalid type.")];const t=[];return e.forEach(((e,r)=>{const s=le(e);!0!==s&&s.forEach((e=>{e.property=`doc[${r}].${e.property}`,t.push(e)}))})),!(t.length>0)||t},t.validateJSONPatchOperation=le,t.validateObject=function(e,t,...r){if(t=t?" "+t+" ":" ",!e||"object"!=typeof e)throw new n.DCXError(n.DCXError.INVALID_PARAMS,`Object${t}is invalid.`);try{r.forEach((t=>{te(t[0],e[t[0]],t[1],t[2]||!1,t[3]||[])}))}catch(e){throw new n.DCXError(n.DCXError.INVALID_PARAMS,`Object${t}is invalid. ${e.message.replace("Param","Property")}`,e)}},t.validateParam=te,t.validateParams=re,t.verifyUuid=e=>o.validate(e),t.verifyandGetSnapshotMimetype=e=>{const t=K(e,100),r=Y(t,"+dcxucf"),s=W(t);return r>-1&&s>-1?t.substring(s,r+7):""},t.withRetries=function e(t,r=3){return t().catch((s=>{if(r)return e(t,r-1);throw s}))}},566870:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(617759);class o{constructor(e){this._data=e}getElementsByTagName(e){return this._data.children.filter((t=>"string"!=typeof t&&t.tagName===e)).map(i)}}class n extends o{constructor(e){super(e),this._data=e}setAttribute(e,t){this._data.attributes[e]=t}getAttribute(e){return this._data.attributes[e]}appendChild(e,t={},r=[]){const s={tagName:e,attributes:t,children:r};return this._data.children.push(s),i(s)}}function i(e){return new n(e)}class a extends o{constructor(e){super(e)}parse(e){const t=function(e,t={}){let r=t.pos||0;const s=!!t.keepComments,o=!!t.keepWhitespace,n="<".charCodeAt(0),i=">".charCodeAt(0),a="-".charCodeAt(0),d="/".charCodeAt(0),h="!".charCodeAt(0),l="'".charCodeAt(0),u='"'.charCodeAt(0),p="[".charCodeAt(0),_="]".charCodeAt(0);function f(t){const c=[];for(;e[r];)if(e.charCodeAt(r)===n){if(e.charCodeAt(r+1)===d){const s=r+2;if(r=e.indexOf(">",r),-1===e.substring(s,r).indexOf(t)){const t=e.substring(0,r).split("\n");throw new Error("Unexpected close tag\nLine: "+(t.length-1)+"\nColumn: "+(t[t.length-1].length+1)+"\nChar: "+e[r])}return r+1&&(r+=1),c}if(e.charCodeAt(r+1)===h){if(e.charCodeAt(r+2)===a){const t=r;for(;-1!==r&&(e.charCodeAt(r)!==i||e.charCodeAt(r-1)!==a||e.charCodeAt(r-2)!==a||-1===r);)r=e.indexOf(">",r+1);-1===r&&(r=e.length),s&&c.push(e.substring(t,r+1))}else{if(e.charCodeAt(r+2)===p&&e.charCodeAt(r+8)===p&&"cdata"===e.substr(r+3,5).toLowerCase()){const t=e.indexOf("]]>",r);-1===t?(c.push(e.substr(r+9)),r=e.length):(c.push(e.substring(r+9,t)),r=t+3);continue}{const t=r+1;r+=2;let s=!1;for(;(e.charCodeAt(r)!==i||!0===s)&&e[r];)e.charCodeAt(r)===p?s=!0:!0===s&&e.charCodeAt(r)===_&&(s=!1),r++;c.push(e.substring(t,r))}}r++;continue}const o=A();c.push(o),"?"===o.tagName[0]&&(c.push(...o.children),o.children=[])}else{const e=g();(o||e.trim().length>0)&&c.push(e),r++}return c}function g(){const t=r;return r=e.indexOf("<",r)-1,-2===r&&(r=e.length),e.slice(t,r+1)}function m(){const t=r;for(;-1==="\r\n\t>/= ".indexOf(e[r])&&e[r];)r++;return e.slice(t,r)}const E=t.noChildNodes||["img","br","input","meta","link","hr"];function A(){r++;const t=m(),s={};let o=[];for(;e.charCodeAt(r)!==i&&e[r];){const n=e.charCodeAt(r);if(n>64&&n<91||n>96&&n<123){const n=m();let a,d=e.charCodeAt(r);for(;d&&d!==l&&d!==u&&!(d>64&&d<91||d>96&&d<123)&&d!==i;)r++,d=e.charCodeAt(r);if(d===l||d===u){if(a=y(),-1===r)return{tagName:t,attributes:s,children:o}}else a=null,r--;s[n]=a}r++}if(e.charCodeAt(r-1)!==d)if("script"===t){const t=r+1;r=e.indexOf("<\/script>",r),o=[e.slice(t,r)],r+=9}else if("style"===t){const t=r+1;r=e.indexOf("</style>",r),o=[e.slice(t,r)],r+=8}else-1===E.indexOf(t)?(r++,o=f(t)):r++;else r++;return{tagName:t,attributes:s,children:o}}function y(){const t=e[r],s=r+1;return r=e.indexOf(t,s),e.slice(s,r)}function D(){const r=new RegExp("\\s"+t.attrName+"\\s*=['\"]"+t.attrValue+"['\"]").exec(e);return r?r.index:-1}let C;if(void 0!==t.attrValue)for(t.attrName=t.attrName||"id",C=[];-1!==(r=D());)r=e.lastIndexOf("<",r),-1!==r&&C.push(A()),e=e.substr(r),r=0;else C=t.parseNode?A():f("");return t.simplify?c(Array.isArray(C)?C:[C]):C}(e);return this._data={children:s.isArray(t)?t:[t]},this}getElementsByTagName(e){return super.getElementsByTagName(e)}toString(){return function(e,t=!1){let r="",s=0;function o(e){if(s+=1,e){t&&e.length>0&&"string"!=typeof e[0]&&(r+="\r\n");for(let t=0;t<e.length;t++)"string"==typeof e[t]?r+=e[t].trim():n(e[t]);t&&e.length>0&&"string"!=typeof e[0]&&!r.endsWith("\r\n")&&(r+="\r\n")}s-=1}function n(e){r+=t?"<".padStart(s)+e.tagName:"<"+e.tagName;for(const t in e.attributes)null===e.attributes[t]?r+=" "+t:-1===e.attributes[t].indexOf('"')?r+=" "+t+'="'+e.attributes[t].trim()+'"':r+=" "+t+"='"+e.attributes[t].trim()+"'";"?"!==e.tagName[0]?(r+=">",o(e.children),t&&r.endsWith("\r\n")?r+="</".padStart(s)+e.tagName+">\r\n":r+=t?"</"+e.tagName+">\r\n":"</"+e.tagName+">"):r+=t?"?>\r\n":"?>"}return o(e),r}(this._data.children)}}function d(e){return(new a).parse(e)}function c(e){const t={};if(!e.length)return"";if(1===e.length&&"string"==typeof e[0])return e[0];e.forEach((function(e){if("object"!=typeof e)return;t[e.tagName]||(t[e.tagName]=[]);const r=c(e.children);t[e.tagName].push(r),Object.keys(e.attributes).length&&(r._attributes=e.attributes)}));for(const e in t)1===t[e].length&&(t[e]=t[e][0]);return t}function h(e){return s.isObject(e)&&s.isArray(e.patchDocument)?e.patchDocument:[]}const l="dcx-js";function u(e,t=l,r=(new Date).toISOString(),o=s.generateUuid()){const n=h(this),i=_(o,e,t,r);return s.createPatchDocumentBuilder(n).add("/xmpMM:History/@list/-",i).replace("/xmpMM:InstanceID",o).replace("/xmp:ModifyDate",r).replace("/xmp:MetadataDate",r).operations}function p(e,t,r){const o=h(this);return s.createPatchDocumentBuilder(o).add(`/${e}:${t}`,r).operations}function _(e,t,r,s){return{"stEvt:action":t,"stEvt:when":s,"stEvt:softwareAgent":r,"stEvt:instanceID":e}}function f(e=l,t,r=s.generateUuid(),o=(new Date).toISOString()){return`<rdf:li\n    stEvt:action="${t}"\n    stEvt:instanceID="xmp.iid:${r}"\n    stEvt:when="${o}"\n    stEvt:softwareAgent="${e}"/>`}function g(e=l,t=s.generateUuid(),r=(new Date).toISOString(),o,n){return o||(o=[f(e,"created",t,r)]),`<x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="Adobe XMP Core 7.1.2">\n        <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">\n            <rdf:Description rdf:about=""\n            xmlns:xmp="http://ns.adobe.com/xap/1.0/"\n            xmlns:xmpMM="http://ns.adobe.com/xap/1.0/mm/"\n            ${n?'xmlns:stRef="http://ns.adobe.com/xap/1.0/sType/ResourceRef#"':""}\n            xmlns:stEvt="http://ns.adobe.com/xap/1.0/sType/ResourceEvent#"\n            xmpMM:OriginalDocumentID="xmp.did:${t}"\n            xmp:ModifyDate="${r}"\n            xmp:MetadataDate="${r}"\n            xmp:CreatorTool="${e}"\n            xmp:CreateDate="${r}"\n            xmpMM:DocumentID="xmp.did:${t}"\n            xmpMM:InstanceID="xmp.iid:${t}">\n                <xmpMM:History>\n                    <rdf:Seq>\n                        ${o.join("\n")}\n                    </rdf:Seq>\n                </xmpMM:History>\n                ${n||""}\n            </rdf:Description>\n        </rdf:RDF>\n    </x:xmpmeta>`}function m(e,t,r){const s=e.getElementsByTagName(t),o=e.getAttribute(t);s.length<1&&null==o&&e.setAttribute(t,r)}t.XMLElement=n,t.XMLParser=a,t.appendHistoryEvent=u,t.deleteProperty=function(e,t){const r=h(this);return s.createPatchDocumentBuilder(r).remove(`/${e}:${t}`).operations},t.initializeXMPJSON=function(e=l,t=s.generateUuid(),r=(new Date).toISOString()){return{"xmp:ModifyDate":r,"xmp:MetadataDate":r,"xmp:CreatorTool":e,"@context":{xmpMM:"http://ns.adobe.com/xap/1.0/mm/",stEvt:"http://ns.adobe.com/xap/1.0/sType/ResourceEvent#",xmp:"http://ns.adobe.com/xap/1.0/"},"xmpMM:DocumentID":`xmp.did:${t}`,"xmpMM:History":{"@list":[{"stEvt:softwareAgent":e,"stEvt:action":"created","stEvt:when":r,"stEvt:instanceID":`xmp.iid:${t}`}]},"xmp:CreateDate":r,"@id":"","xmpMM:InstanceID":`xmp.iid:${t}`,"xmpMM:OriginalDocumentID":`xmp.did:${t}`}},t.initializeXMPXML=g,t.makeDerivedWithAction=function(e=l,t,r=s.generateUuid(),o=(new Date).toISOString()){const n=h(this),i=s.createPatchDocumentBuilder(n).add("/@context/stRef","http://ns.adobe.com/xap/1.0/sType/ResourceRef#").add("/@context/xmpMM","http://ns.adobe.com/xap/1.0/mm/").add("/xmpMM:DerivedFrom",{}).copy("/xmpMM:DocumentID","/xmpMM:DerivedFrom/stRef:documentID").copy("/xmp:ModifyDate","/xmpMM:DerivedFrom/stRef:lastModifyDate").copy("/xmpMM:InstanceID","/xmpMM:DerivedFrom/stRef:instanceID").copy("/xmpMM:OriginalDocumentID","/xmpMM:DerivedFrom/stRef:originalDocumentID").replace("/xmpMM:InstanceID",r).replace("/xmpMM:DocumentID",r);return u.call({patchDocument:i.operations},t,e,o,r)},t.makeDerivedWithXML=function(e,t,r,o=(new Date).toISOString()){return e||t||r||(e=s.generateUuid()),`<xmpMM:DerivedFrom\n        stRef:documentID="xmp.did:${t||r||e}"\n        stRef:instanceID="xmp.iid:${r||t||e}"\n        stRef:originalDocumentID="xmp.did:${e||t||r}"\n        stRef:lastModifyDate="${o}"/>`},t.makeHistoryEventXML=f,t.parseXML=d,t.registerNamespace=function(e,t){const r=h(this);return s.createPatchDocumentBuilder(r).add(`/@context/${t}`,e).operations},t.repairXMPXML=function(e,t=l,r=s.generateUuid(),o=(new Date).toISOString()){const n=d(e),i=n.getElementsByTagName("x:xmpmeta");if(i.length<1)return g(t,r,o);const a=i[0].getElementsByTagName("rdf:RDF");if(a.length<1)return g(t,r,o);const c=a[0].getElementsByTagName("rdf:Description");if(c.length<1)return g(t,r,o);const h=c[0];return m(h,"xmp:ModifyDate",o),m(h,"xmp:MetadataDate",o),m(h,"xmp:CreatorTool",t),m(h,"xmp:CreateDate",o),m(h,"xmpMM:DocumentID",`xmp.did:${r}`),m(h,"xmpMM:InstanceID",`xmp.iid:${r}`),m(h,"xmpMM:OriginalDocumentID",`xmp.did:${r}`),function(e){const t=["xmpMM:History","rdf:Seq"];let r=e;for(;t.length>0;){const e=t.shift(),s=r.getElementsByTagName(e);r=s.length>0?s[0]:r.appendChild(e)}}(h),n.toString()},t.setCreatorTool=function(e){return p.call(this,"xmp","CreatorTool",e)},t.setProperty=p,t.updateLastHistoryEvent=function(e,t,r){const o=h(this);if(null==e&&null==t&&null==r)return o;const n=s.createPatchDocumentBuilder(o);let i=_(s.generateUuid(),e,t,r);i=s.pruneUndefined(i);for(const e in i)n.replace(`/xmpMM:History/@list/-/${e}`,i[e]);return n.operations}},168511:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0});var s=r(499164);class o{constructor(e){this._data=e}getElementsByTagName(e){return this._data.children.filter((t=>"string"!=typeof t&&t.tagName===e)).map(i)}}class n extends o{constructor(e){super(e),this._data=e}setAttribute(e,t){this._data.attributes[e]=t}getAttribute(e){return this._data.attributes[e]}appendChild(e,t={},r=[]){const s={tagName:e,attributes:t,children:r};return this._data.children.push(s),i(s)}}function i(e){return new n(e)}class a extends o{constructor(e){super(e)}parse(e){const t=function(e,t={}){let r=t.pos||0;const s=!!t.keepComments,o=!!t.keepWhitespace,n="<".charCodeAt(0),i=">".charCodeAt(0),a="-".charCodeAt(0),d="/".charCodeAt(0),h="!".charCodeAt(0),l="'".charCodeAt(0),u='"'.charCodeAt(0),p="[".charCodeAt(0),_="]".charCodeAt(0);function f(t){const c=[];for(;e[r];)if(e.charCodeAt(r)===n){if(e.charCodeAt(r+1)===d){const s=r+2;if(r=e.indexOf(">",r),-1===e.substring(s,r).indexOf(t)){const t=e.substring(0,r).split("\n");throw new Error("Unexpected close tag\nLine: "+(t.length-1)+"\nColumn: "+(t[t.length-1].length+1)+"\nChar: "+e[r])}return r+1&&(r+=1),c}if(e.charCodeAt(r+1)===h){if(e.charCodeAt(r+2)===a){const t=r;for(;-1!==r&&(e.charCodeAt(r)!==i||e.charCodeAt(r-1)!==a||e.charCodeAt(r-2)!==a||-1===r);)r=e.indexOf(">",r+1);-1===r&&(r=e.length),s&&c.push(e.substring(t,r+1))}else{if(e.charCodeAt(r+2)===p&&e.charCodeAt(r+8)===p&&"cdata"===e.substr(r+3,5).toLowerCase()){const t=e.indexOf("]]>",r);-1===t?(c.push(e.substr(r+9)),r=e.length):(c.push(e.substring(r+9,t)),r=t+3);continue}{const t=r+1;r+=2;let s=!1;for(;(e.charCodeAt(r)!==i||!0===s)&&e[r];)e.charCodeAt(r)===p?s=!0:!0===s&&e.charCodeAt(r)===_&&(s=!1),r++;c.push(e.substring(t,r))}}r++;continue}const o=A();c.push(o),"?"===o.tagName[0]&&(c.push(...o.children),o.children=[])}else{const e=g();(o||e.trim().length>0)&&c.push(e),r++}return c}function g(){const t=r;return r=e.indexOf("<",r)-1,-2===r&&(r=e.length),e.slice(t,r+1)}function m(){const t=r;for(;-1==="\r\n\t>/= ".indexOf(e[r])&&e[r];)r++;return e.slice(t,r)}const E=t.noChildNodes||["img","br","input","meta","link","hr"];function A(){r++;const t=m(),s={};let o=[];for(;e.charCodeAt(r)!==i&&e[r];){const n=e.charCodeAt(r);if(n>64&&n<91||n>96&&n<123){const n=m();let a,d=e.charCodeAt(r);for(;d&&d!==l&&d!==u&&!(d>64&&d<91||d>96&&d<123)&&d!==i;)r++,d=e.charCodeAt(r);if(d===l||d===u){if(a=y(),-1===r)return{tagName:t,attributes:s,children:o}}else a=null,r--;s[n]=a}r++}if(e.charCodeAt(r-1)!==d)if("script"===t){const t=r+1;r=e.indexOf("<\/script>",r),o=[e.slice(t,r)],r+=9}else if("style"===t){const t=r+1;r=e.indexOf("</style>",r),o=[e.slice(t,r)],r+=8}else-1===E.indexOf(t)?(r++,o=f(t)):r++;else r++;return{tagName:t,attributes:s,children:o}}function y(){const t=e[r],s=r+1;return r=e.indexOf(t,s),e.slice(s,r)}function D(){const r=new RegExp("\\s"+t.attrName+"\\s*=['\"]"+t.attrValue+"['\"]").exec(e);return r?r.index:-1}let C;if(void 0!==t.attrValue)for(t.attrName=t.attrName||"id",C=[];-1!==(r=D());)r=e.lastIndexOf("<",r),-1!==r&&C.push(A()),e=e.substr(r),r=0;else C=t.parseNode?A():f("");return t.simplify?c(Array.isArray(C)?C:[C]):C}(e);return this._data={children:s.isArray(t)?t:[t]},this}getElementsByTagName(e){return super.getElementsByTagName(e)}toString(){return function(e,t=!1){let r="",s=0;function o(e){if(s+=1,e){t&&e.length>0&&"string"!=typeof e[0]&&(r+="\r\n");for(let t=0;t<e.length;t++)"string"==typeof e[t]?r+=e[t].trim():n(e[t]);t&&e.length>0&&"string"!=typeof e[0]&&!r.endsWith("\r\n")&&(r+="\r\n")}s-=1}function n(e){r+=t?"<".padStart(s)+e.tagName:"<"+e.tagName;for(const t in e.attributes)null===e.attributes[t]?r+=" "+t:-1===e.attributes[t].indexOf('"')?r+=" "+t+'="'+e.attributes[t].trim()+'"':r+=" "+t+"='"+e.attributes[t].trim()+"'";"?"!==e.tagName[0]?(r+=">",o(e.children),t&&r.endsWith("\r\n")?r+="</".padStart(s)+e.tagName+">\r\n":r+=t?"</"+e.tagName+">\r\n":"</"+e.tagName+">"):r+=t?"?>\r\n":"?>"}return o(e),r}(this._data.children)}}function d(e){return(new a).parse(e)}function c(e){const t={};if(!e.length)return"";if(1===e.length&&"string"==typeof e[0])return e[0];e.forEach((function(e){if("object"!=typeof e)return;t[e.tagName]||(t[e.tagName]=[]);const r=c(e.children);t[e.tagName].push(r),Object.keys(e.attributes).length&&(r._attributes=e.attributes)}));for(const e in t)1===t[e].length&&(t[e]=t[e][0]);return t}function h(e){return s.isObject(e)&&s.isArray(e.patchDocument)?e.patchDocument:[]}const l="dcx-js";function u(e,t=l,r=(new Date).toISOString(),o=s.generateUuid()){const n=h(this),i=_(o,e,t,r);return s.createPatchDocumentBuilder(n).add("/xmpMM:History/@list/-",i).replace("/xmpMM:InstanceID",o).replace("/xmp:ModifyDate",r).replace("/xmp:MetadataDate",r).operations}function p(e,t,r){const o=h(this);return s.createPatchDocumentBuilder(o).add(`/${e}:${t}`,r).operations}function _(e,t,r,s){return{"stEvt:action":t,"stEvt:when":s,"stEvt:softwareAgent":r,"stEvt:instanceID":e}}function f(e=l,t,r=s.generateUuid(),o=(new Date).toISOString()){return`<rdf:li\n    stEvt:action="${t}"\n    stEvt:instanceID="xmp.iid:${r}"\n    stEvt:when="${o}"\n    stEvt:softwareAgent="${e}"/>`}function g(e=l,t=s.generateUuid(),r=(new Date).toISOString(),o,n){return o||(o=[f(e,"created",t,r)]),`<x:xmpmeta xmlns:x="adobe:ns:meta/" x:xmptk="Adobe XMP Core 7.1.2">\n        <rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">\n            <rdf:Description rdf:about=""\n            xmlns:xmp="http://ns.adobe.com/xap/1.0/"\n            xmlns:xmpMM="http://ns.adobe.com/xap/1.0/mm/"\n            ${n?'xmlns:stRef="http://ns.adobe.com/xap/1.0/sType/ResourceRef#"':""}\n            xmlns:stEvt="http://ns.adobe.com/xap/1.0/sType/ResourceEvent#"\n            xmpMM:OriginalDocumentID="xmp.did:${t}"\n            xmp:ModifyDate="${r}"\n            xmp:MetadataDate="${r}"\n            xmp:CreatorTool="${e}"\n            xmp:CreateDate="${r}"\n            xmpMM:DocumentID="xmp.did:${t}"\n            xmpMM:InstanceID="xmp.iid:${t}">\n                <xmpMM:History>\n                    <rdf:Seq>\n                        ${o.join("\n")}\n                    </rdf:Seq>\n                </xmpMM:History>\n                ${n||""}\n            </rdf:Description>\n        </rdf:RDF>\n    </x:xmpmeta>`}function m(e,t,r){const s=e.getElementsByTagName(t),o=e.getAttribute(t);s.length<1&&null==o&&e.setAttribute(t,r)}t.XMLElement=n,t.XMLParser=a,t.appendHistoryEvent=u,t.deleteProperty=function(e,t){const r=h(this);return s.createPatchDocumentBuilder(r).remove(`/${e}:${t}`).operations},t.initializeXMPJSON=function(e=l,t=s.generateUuid(),r=(new Date).toISOString()){return{"xmp:ModifyDate":r,"xmp:MetadataDate":r,"xmp:CreatorTool":e,"@context":{xmpMM:"http://ns.adobe.com/xap/1.0/mm/",stEvt:"http://ns.adobe.com/xap/1.0/sType/ResourceEvent#",xmp:"http://ns.adobe.com/xap/1.0/"},"xmpMM:DocumentID":`xmp.did:${t}`,"xmpMM:History":{"@list":[{"stEvt:softwareAgent":e,"stEvt:action":"created","stEvt:when":r,"stEvt:instanceID":`xmp.iid:${t}`}]},"xmp:CreateDate":r,"@id":"","xmpMM:InstanceID":`xmp.iid:${t}`,"xmpMM:OriginalDocumentID":`xmp.did:${t}`}},t.initializeXMPXML=g,t.makeDerivedWithAction=function(e=l,t,r=s.generateUuid(),o=(new Date).toISOString()){const n=h(this),i=s.createPatchDocumentBuilder(n).add("/@context/stRef","http://ns.adobe.com/xap/1.0/sType/ResourceRef#").add("/@context/xmpMM","http://ns.adobe.com/xap/1.0/mm/").add("/xmpMM:DerivedFrom",{}).copy("/xmpMM:DocumentID","/xmpMM:DerivedFrom/stRef:documentID").copy("/xmp:ModifyDate","/xmpMM:DerivedFrom/stRef:lastModifyDate").copy("/xmpMM:InstanceID","/xmpMM:DerivedFrom/stRef:instanceID").copy("/xmpMM:OriginalDocumentID","/xmpMM:DerivedFrom/stRef:originalDocumentID").replace("/xmpMM:InstanceID",r).replace("/xmpMM:DocumentID",r);return u.call({patchDocument:i.operations},t,e,o,r)},t.makeDerivedWithXML=function(e,t,r,o=(new Date).toISOString()){return e||t||r||(e=s.generateUuid()),`<xmpMM:DerivedFrom\n        stRef:documentID="xmp.did:${t||r||e}"\n        stRef:instanceID="xmp.iid:${r||t||e}"\n        stRef:originalDocumentID="xmp.did:${e||t||r}"\n        stRef:lastModifyDate="${o}"/>`},t.makeHistoryEventXML=f,t.parseXML=d,t.registerNamespace=function(e,t){const r=h(this);return s.createPatchDocumentBuilder(r).add(`/@context/${t}`,e).operations},t.repairXMPXML=function(e,t=l,r=s.generateUuid(),o=(new Date).toISOString()){const n=d(e),i=n.getElementsByTagName("x:xmpmeta");if(i.length<1)return g(t,r,o);const a=i[0].getElementsByTagName("rdf:RDF");if(a.length<1)return g(t,r,o);const c=a[0].getElementsByTagName("rdf:Description");if(c.length<1)return g(t,r,o);const h=c[0];return m(h,"xmp:ModifyDate",o),m(h,"xmp:MetadataDate",o),m(h,"xmp:CreatorTool",t),m(h,"xmp:CreateDate",o),m(h,"xmpMM:DocumentID",`xmp.did:${r}`),m(h,"xmpMM:InstanceID",`xmp.iid:${r}`),m(h,"xmpMM:OriginalDocumentID",`xmp.did:${r}`),function(e){const t=["xmpMM:History","rdf:Seq"];let r=e;for(;t.length>0;){const e=t.shift(),s=r.getElementsByTagName(e);r=s.length>0?s[0]:r.appendChild(e)}}(h),n.toString()},t.setCreatorTool=function(e){return p.call(this,"xmp","CreatorTool",e)},t.setProperty=p,t.updateLastHistoryEvent=function(e,t,r){const o=h(this);if(null==e&&null==t&&null==r)return o;const n=s.createPatchDocumentBuilder(o);let i=_(s.generateUuid(),e,t,r);i=s.pruneUndefined(i);for(const e in i)n.replace(`/xmpMM:History/@list/-/${e}`,i[e]);return n.operations}}}]);
//# sourceMappingURL=vendor-startup-dcx.050f39fdb95b1de0b967.js.map